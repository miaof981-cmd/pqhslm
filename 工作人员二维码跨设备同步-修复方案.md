# 工作人员二维码跨设备同步 - 修复方案

> **问题**：手机上传二维码后，电脑开发者工具看不到  
> **根因**：只存本地storage，不跨设备同步  
> **修复**：改为云存储+云数据库方案

---

## 🔍 问题诊断

### 原有架构（❌ 错误）

```
手机端上传：
  选择图片 → wx.setStorageSync('staff_contact_qrcode', tempPath) → 存到手机本地

电脑端显示：
  wx.getStorageSync('staff_contact_qrcode') → 读电脑本地 → 读不到
```

**根本问题**：本地storage不跨设备同步

---

## ✅ 新架构（云端方案）

```
任何设备上传：
  选择图片 → wx.cloud.uploadFile() → 云存储
           → cloudAPI.uploadStaffQRCode(fileID) → 云数据库 system_settings

任何设备显示：
  cloudAPI.getSystemSettings() → 云数据库 → 读取 fileID → 显示图片
```

**优势**：
- ✅ 跨设备同步（手机、电脑、多人同时访问）
- ✅ 数据持久化（不会丢失）
- ✅ 支持多管理员（任何管理员都能看到最新二维码）

---

## 📝 操作步骤

### 步骤1：创建云数据库集合

1. 打开**微信开发者工具** → **云开发控制台**
2. 点击**数据库**
3. 点击**添加集合**
4. 集合名称：`system_settings`
5. 权限设置：`仅创建者可读写`
6. 点击**确定**

### 步骤2：上传云函数

1. 在开发者工具左侧，找到 `cloudfunctions/systemManager` 文件夹
2. **右键点击** `systemManager` 文件夹
3. 选择 **上传并部署：云端安装依赖**
4. 等待上传完成（约30秒）
5. 看到"上传成功"提示

### 步骤3：初始化数据（可选）

手动在云数据库创建一条记录（可跳过，代码会自动创建）：

```json
{
  "_id": "global",
  "staff_contact_qrcode": "",
  "service_qrcode": "",
  "complaint_qrcode": "",
  "platform_name": "画师联盟",
  "platform_slogan": "专业约稿平台",
  "createdAt": "2025-11-22 19:00:00",
  "updatedAt": "2025-11-22 19:00:00"
}
```

### 步骤4：重新上传二维码

**在手机端**：
1. 打开小程序 → **管理后台**
2. 点击 **系统设置** → **工作人员二维码管理**
3. 点击**选择图片** → 选择二维码
4. 等待上传（会显示"上传中..."）
5. 看到"设置成功"提示

**在电脑端**：
1. 打开开发者工具，进入同一页面
2. 点击**刷新**或重新进入页面
3. **应该能看到手机上传的二维码**✅

---

## 🧪 测试验证

### 测试1：跨设备同步
1. 手机A上传二维码 → 成功
2. 电脑B刷新页面 → 能看到✅
3. 手机C打开页面 → 能看到✅

### 测试2：覆盖更新
1. 手机上传新二维码 → 成功
2. 电脑刷新 → 显示最新二维码✅

### 测试3：售后二维码
1. 在二维码管理页面上传售后二维码
2. 在订单详情页、用户中心查看
3. 应显示最新二维码✅

---

## 📊 修改文件清单

| 文件 | 修改内容 | 状态 |
|------|---------|------|
| `cloudfunctions/systemManager/index.js` | 新建云函数 | ✅ |
| `cloudfunctions/systemManager/package.json` | 云函数配置 | ✅ |
| `miniprogram/utils/cloud-api.js` | 新增上传方法 | ✅ |
| `miniprogram/pages/staff-qrcode-manage/index.js` | 改为云存储方案 | ✅ |

---

## 🔧 云函数功能说明

### systemManager 云函数

**支持操作**：

1. **getSystemSettings**  
   获取系统设置（工作人员二维码、售后二维码等）
   
2. **updateSystemSettings**  
   更新系统设置（仅管理员）
   
3. **uploadStaffQRCode**  
   上传工作人员二维码（fileID + cloudPath）
   
4. **uploadServiceQRCode**  
   上传售后二维码（fileID + cloudPath）

**权限控制**：
- 读取：所有用户
- 写入：仅管理员（检查 `system_admin` 表或 `users.role = 'admin'`）

---

## 🚨 常见问题

### Q1：上传时提示"上传失败"
**原因**：云开发未初始化或环境ID错误  
**解决**：
```javascript
// 检查 app.js 中是否有云初始化
wx.cloud.init({
  env: 'cloud1-2gca1h9d11f4d9d2'
})
```

### Q2：显示空白或默认图片
**原因**：云数据库没有数据  
**解决**：重新上传一次二维码

### Q3：电脑能看到，手机看不到
**原因**：手机端缓存了旧数据  
**解决**：
```javascript
// 在手机端控制台执行
wx.removeStorageSync('staff_contact_qrcode')
wx.removeStorageSync('system_settings')
```

### Q4：提示"仅管理员可操作"
**原因**：当前用户不是管理员  
**解决**：
1. 检查 `system_admin` 表是否有你的 openid
2. 或者 `users` 表中你的记录 `role` 是否为 `'admin'`

---

## 📌 注意事项

1. **云存储容量**：免费版5GB，注意容量监控
2. **旧数据清理**：修复后可手动清理本地storage：
   ```javascript
   wx.removeStorageSync('staff_contact_qrcode')
   wx.removeStorageSync('system_settings')
   ```
3. **图片格式**：支持 jpg、png、webp
4. **文件大小**：建议压缩后上传（< 500KB）

---

## ✅ 修复完成标志

- [x] systemManager 云函数已上传
- [x] system_settings 集合已创建
- [ ] 手机端重新上传二维码
- [ ] 电脑端能看到手机上传的二维码
- [ ] 跨设备同步正常

---

**修复完成后，此问题将彻底解决！**

