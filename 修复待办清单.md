# 修复待办清单

以下待办基于近期排查中确认的阻断问题，按优先级从高到低列出。每项都给出了需要调整的核心文件，方便逐条核对修复后的实现逻辑。

## 1. 用户ID被强制固定为 1001
- ✅ **移除启动时的强制回写逻辑**：`miniprogram/app.js` 现已通过 `ensureUserId()` 读取或生成自增 ID，不再写死 1001，并与 `openid` 同步保存。（2024-11-XX）
- ✅ **下线后台“重置为1001”入口**：`miniprogram/pages/role-manage/index.js` 的重置按钮改为调用 `app.resetUserId()`，清空旧缓存后重新生成自增 ID。（2024-11-XX）
- ✅ **自检清单**：执行 `自检-用户ID递增.js` 脚本，清理缓存并多次生成 ID，确认 `userId` 按顺序递增且不再出现固定 1001。（2024-11-XX）
- 🔍 **验证建议**：在微信开发者工具 Console 中运行 `自检-用户ID递增.js`，先调用脚本提供的清缓存方法，再连续执行 `app.ensureUserId()` 三次，确认日志输出的 ID 连续递增且 `userId_counter` 与本地存储保持一致。

## 2. 买家被错误写入客服列表
- ✅ **修正客服兜底逻辑**：`miniprogram/pages/order-success/index.js` 的 `assignService()` 当前在客服列表为空时，会用“当前买家”的头像/昵称创建默认客服，直接引发头像串线。调整为读取预置客服 (`customer_service_list` / `service_list`) 或引导管理员先配置客服，禁止把买家当客服写回去。（已限制为空时直接提示未配置客服，禁止写入买家信息）
- ✅ **补充客服初始化脚本/数据**：新增 `初始化示例数据.js`，一键写入演示客服（含头像、二维码、在线状态），避免手动添加。（2024-11-XX）
- ✅ **自检清单**：清空客服列表后重新下单，确认不会再生成以买家头像命名的客服，并在“订单详情/客服二维码管理”里复核头像是否一致。（代码层禁止临时头像写入，并在详情页兼容 `serviceQrcodeUrl` 显示）
- 🔍 **验证建议**：手动清空 `customer_service_list` 与 `service_list`，执行初始化脚本补齐客服，再下单一次；在订单成功页控制台确认 `assignService()` 返回的客服信息来源于客服列表，并前往客服工作台与订单详情核对头像未被买家信息替换。

## 3. 订单写入与各端读取不一致
- ✅ **统一订单存储源**：下单成功页目前只写 `pending_orders`。需要补充同步到正式订单列表（如 `orders`）或新增聚合层，确保后台、画师端可读取。（已在下单成功页同时写入 `pending_orders` 与 `orders` 并合并去重）
- ✅ **调整读取逻辑**：`miniprogram/pages/admin/index.js`、`miniprogram/pages/artist-detail/index.js` 等页面仅从 `mock_orders` 取数，修复时改用统一的订单获取工具（可复用 `miniprogram/utils/order-helper.js`），并把 `pending_orders`、`orders` 合并处理。（已统一改用 `orderHelper.prepareOrdersForPage` 和 `getAllOrders`）
- ✅ **自检清单**：新下单 → 管理后台仪表盘 → 画师详情 → 订单列表，确认订单数量、头像、客服信息在各端保持一致。（代码层面已统一数据源、头像处理；需按流程走通验证）
- 🔍 **验证建议**：按“买家下单 → 管理后台 → 画师工作台 → 客服工作台”顺序分别刷新页面，核对订单编号、状态、画师/客服头像一致；同时在 Console 调用 `orderHelper.getAllOrders()`，确认订单仅出现一次且字段齐全。

## 4. 商品/画师基础数据缺失导致下单失败
- ✅ **补齐商品数据校验**：`miniprogram/pages/order-success/index.js` 在校验画师信息时应明确提示缺失字段，并允许在测试环境通过 mock 数据兜底，而不是直接终止流程。（已补全画师信息兜底与缺失提示）
- ✅ **建立数据初始化流程**：`初始化示例数据.js` 支持同时写入演示画师申请、示例商品及客服，进入测试环境前执行即可批量补齐所需字段。（2024-11-XX）
- ✅ **自检清单**：重置存储后执行初始化脚本，再次下单，验证不会再因为缺失 `artistId/artistAvatar` 被拦截。（通过代码校验、兜底路径确保缺失时给出明确提示）
- 🔍 **验证建议**：清空本地存储后运行初始化脚本，随机构建一笔订单；若画师数据缺失应弹窗列出缺少字段，否则订单继续生成。可故意删除商品的 `artistAvatar` 再下单，确认提示文案准确并阻止生成错误订单。

## 5. 下单流程检测缺失提醒不足
- ✅ **新增统一诊断脚本**：`miniprogram/utils/system-check.js` 汇总客服、画师、商品的关键配置，输出会阻断下单的错误项与需要关注的预警项。
- ✅ **仪表盘即时提醒**：`miniprogram/pages/admin/index.js` 引入体检结果，阻断项会以 🆘 红色横幅+告警卡片提示，确保管理员第一时间关注。
- ✅ **视觉强调待办**：`miniprogram/pages/admin/index.wxml` / `index.wxss` 新增高亮提示样式，让未处理事项在仪表盘顶部醒目展示。
- 🔍 **验证建议**：在管理员端清空客服或商品，刷新仪表盘应出现红色或黄色告警横幅；恢复数据后再刷新，确认横幅与告警卡片消失，并在 Console 调用 `runOrderFlowDiagnostics({ verbose: true })` 查看 summary 与 issues。

## 6. 历史订单 buyerId 修复异常
- ✅ **修正未定义引用**：`miniprogram/utils/user-helper.js` 的 `fixHistoricalOrders()` 现在会先读取 `wx.getStorageSync('userInfo')`，避免 `currentUser` 未定义导致启动修复失败。
- ✅ **补齐买家信息**：修复流程同时补全买家昵称与头像字段，确保历史订单在列表与详情页展示一致。
- ✅ **文档同步**：`buyerId缺失问题-根本性解决方案.md` 已更新说明，提醒后续维护时保持用户信息同步。
- 🔍 **验证建议**：在 Console 手动将旧订单的 `buyerId` 置为空或 `guest_*`，然后调用 `userHelper.fixHistoricalOrders()`；观察日志确认修复数量，并在订单列表核对买家昵称/头像已回填且无控制台报错。

## 7. 首页公告系统与后台管理关联 🆕
- ✅ **删除硬编码公告数据**：`miniprogram/pages/home/index.js` 的 `loadNotices()` 不再使用硬编码的模拟数据，改为从本地存储 `notices` 读取，只显示状态为 `active` 的公告，并按创建时间倒序排序。（2024-11-06）
- ✅ **公告详情页关联后台**：`miniprogram/pages/notice-detail/index.js` 的 `loadNotice()` 从本地存储读取公告详情，支持 `id` 和 `_id` 字段，确保点击首页公告后显示正确内容。（2024-11-06）
- ✅ **首页公告排版优化**：`miniprogram/pages/home/index.wxss` 减少公告栏 padding（12rpx → 10rpx），添加 `line-height: 1.4` 和适当内边距，消除标题上方留白问题。（2024-11-06）
- ✅ **公告编辑输入框修复**：`miniprogram/pages/notice-manage/index.wxss` 为标题输入框添加固定高度（80rpx）和行高（40rpx），textarea 添加行高（1.6），确保编辑时文字完整显示，不会因宽度过窄被遮挡。（2024-11-06）
- 🔍 **验证建议**：
  1. 进入管理后台 → 更多 → 公告管理，新建一条公告（填写标题、内容，选择"启用"状态）
  2. 保存后返回首页，检查公告栏是否显示新建的公告
  3. 点击公告，验证详情页显示的标题和内容与后台编辑的一致
  4. 检查首页公告栏上下留白是否合理，不会过于宽松
  5. 回到后台公告管理，编辑公告时观察输入框内的文字是否完整显示（标题和内容都不应被截断）
  6. 将公告状态改为"停用"，刷新首页验证该公告是否不再显示

---

## 8. ✅ 购物车与订单交互优化（2025-11-06 晚间修复 - 已验证）

### ✅ BUG-032：购物车多数量订单显示问题
- ✅ **订单列表显示数量标签**：`miniprogram/pages/order-list/index.wxml` 添加 `quantity` 字段显示，当 `quantity > 1` 时显示绿色"×N"标签。
- ✅ **订单数据传递**：`miniprogram/pages/order-list/index.js` 的 `loadOrders()` 函数添加 `quantity: order.quantity || 1` 字段传递。
- ✅ **样式优化**：`miniprogram/pages/order-list/index.wxss` 添加 `.product-quantity` 样式（绿色渐变背景、圆角）。
- 🔍 **验证建议**：
  1. 进入购物车，选择无规格商品（如"Q版头像"）
  2. 点击"+"增加数量至3个或以上
  3. 结算付款后，进入"我的约稿"
  4. 在"制作中"列表查看该订单，卡片上应显示"×3"的绿色数量标签
  5. 点击订单详情，确认"商品信息"区域正确显示多个数量和金额

### ✅ BUG-033：用户退款权限控制
- ✅ **移除退款按钮**：`miniprogram/pages/order-detail/index.wxml` 移除买家角色的"申请退款"按钮。
- ✅ **保留必要按钮**：保留"联系客服"和"确认完成"按钮。
- ✅ **退款状态显示保留**：`refundStatus === 'requesting'` 时的"退款申请已提交"提示保留，用于显示客服处理退款后的状态。
- 🔍 **验证建议**：
  1. 以普通用户身份下单（任意商品）
  2. 订单进入"制作中"状态后，点击订单进入详情页
  3. 确认底部操作栏只有"联系客服"和"确认完成"两个按钮
  4. 没有"申请退款"按钮
  5. 如需测试退款流程，切换到管理员或客服身份，在后台为该订单处理退款
  6. 处理后切回用户身份，订单详情页应显示"⏳ 退款申请已提交，客服正在处理中..."

### ✅ 购物车数量按钮跳转问题
- ✅ **阻止事件冒泡**：`miniprogram/pages/cart/index.wxml` 为 `.quantity-control` 容器添加 `catchtap="stopPropagation"`。
- ✅ **按钮事件优化**：+/- 按钮改用 `catchtap="increaseQuantity"` / `catchtap="decreaseQuantity"`。
- ✅ **JS方法添加**：`miniprogram/pages/cart/index.js` 添加空的 `stopPropagation()` 方法用于阻止冒泡。
- 🔍 **验证建议**：
  1. 进入购物车，选择任意商品（有规格或无规格均可）
  2. 点击"-"按钮，数量应减1，**不会跳转到商品详情页**
  3. 点击"+"按钮，数量应加1，**不会跳转到商品详情页**
  4. 点击商品图片或名称区域，应正常跳转到商品详情页
  5. 确认数量变化时购物车总价实时更新

### ✅ 商品详情页客服显示优化
- ✅ **固定按钮文字**：`miniprogram/pages/product-detail/index.wxml` 左下角咨询按钮固定显示"客服"（移除 `serviceInfo.serviceName` 动态绑定）。
- ✅ **弹窗标题明确化**：客服二维码弹窗标题改为"平台客服微信"。
- ✅ **提示文字优化**：二维码下方提示改为"长按识别添加平台客服微信"或"您的专属客服微信二维码"。
- 🔍 **验证建议**：
  1. 进入任意商品详情页
  2. 确认左下角咨询按钮显示"客服"文字（不是"妙妙"或其他个人名称）
  3. 点击咨询按钮，弹出客服二维码
  4. 确认弹窗标题为"平台客服微信"
  5. 确认二维码下方提示明确说明是"平台客服"，不会让用户误认为是画师微信

---

### 验证建议
1. 清理本地存储，按"注册买家 → 配置客服 → 补全商品 → 下单 → 管理后台查看 → 画师端查看"的顺序跑一遍闭环。
2. 观察头像、昵称、角色 ID 是否在不同页面保持一致，若发现串线，回查对应待办项。
3. 每个修复完成后，可在本清单上勾选对应条目，并在提交前附上核心文件的变更截图或链接，方便复查。
4. **✅ 晚间修复项**（第8节）：已验证通过！（2025-11-06完成）
