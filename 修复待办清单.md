# 修复待办清单

以下待办基于近期排查中确认的阻断问题，按优先级从高到低列出。每项都给出了需要调整的核心文件，方便逐条核对修复后的实现逻辑。

## 1. 用户ID被强制固定为 1001
- ✅ **移除启动时的强制回写逻辑**：`miniprogram/app.js` 现已通过 `ensureUserId()` 读取或生成自增 ID，不再写死 1001，并与 `openid` 同步保存。（2024-11-XX）
- ✅ **下线后台“重置为1001”入口**：`miniprogram/pages/role-manage/index.js` 的重置按钮改为调用 `app.resetUserId()`，清空旧缓存后重新生成自增 ID。（2024-11-XX）
- ✅ **自检清单**：执行 `自检-用户ID递增.js` 脚本，清理缓存并多次生成 ID，确认 `userId` 按顺序递增且不再出现固定 1001。（2024-11-XX）

## 2. 买家被错误写入客服列表
- ✅ **修正客服兜底逻辑**：`miniprogram/pages/order-success/index.js` 的 `assignService()` 当前在客服列表为空时，会用“当前买家”的头像/昵称创建默认客服，直接引发头像串线。调整为读取预置客服 (`customer_service_list` / `service_list`) 或引导管理员先配置客服，禁止把买家当客服写回去。（已限制为空时直接提示未配置客服，禁止写入买家信息）
- ✅ **补充客服初始化脚本/数据**：新增 `初始化示例数据.js`，一键写入演示客服（含头像、二维码、在线状态），避免手动添加。（2024-11-XX）
- ✅ **自检清单**：清空客服列表后重新下单，确认不会再生成以买家头像命名的客服，并在“订单详情/客服二维码管理”里复核头像是否一致。（代码层禁止临时头像写入，并在详情页兼容 `serviceQrcodeUrl` 显示）

## 3. 订单写入与各端读取不一致
- ✅ **统一订单存储源**：下单成功页目前只写 `pending_orders`。需要补充同步到正式订单列表（如 `orders`）或新增聚合层，确保后台、画师端可读取。（已在下单成功页同时写入 `pending_orders` 与 `orders` 并合并去重）
- ✅ **调整读取逻辑**：`miniprogram/pages/admin/index.js`、`miniprogram/pages/artist-detail/index.js` 等页面仅从 `mock_orders` 取数，修复时改用统一的订单获取工具（可复用 `miniprogram/utils/order-helper.js`），并把 `pending_orders`、`orders` 合并处理。（已统一改用 `orderHelper.prepareOrdersForPage` 和 `getAllOrders`）
- ✅ **自检清单**：新下单 → 管理后台仪表盘 → 画师详情 → 订单列表，确认订单数量、头像、客服信息在各端保持一致。（代码层面已统一数据源、头像处理；需按流程走通验证）

## 4. 商品/画师基础数据缺失导致下单失败
- ✅ **补齐商品数据校验**：`miniprogram/pages/order-success/index.js` 在校验画师信息时应明确提示缺失字段，并允许在测试环境通过 mock 数据兜底，而不是直接终止流程。（已补全画师信息兜底与缺失提示）
- ✅ **建立数据初始化流程**：`初始化示例数据.js` 支持同时写入演示画师申请、示例商品及客服，进入测试环境前执行即可批量补齐所需字段。（2024-11-XX）
- ✅ **自检清单**：重置存储后执行初始化脚本，再次下单，验证不会再因为缺失 `artistId/artistAvatar` 被拦截。（通过代码校验、兜底路径确保缺失时给出明确提示）

## 5. 下单流程检测缺失提醒不足
- ✅ **新增统一诊断脚本**：`miniprogram/utils/system-check.js` 汇总客服、画师、商品的关键配置，输出会阻断下单的错误项与需要关注的预警项。
- ✅ **仪表盘即时提醒**：`miniprogram/pages/admin/index.js` 引入体检结果，阻断项会以 🆘 红色横幅+告警卡片提示，确保管理员第一时间关注。
- ✅ **视觉强调待办**：`miniprogram/pages/admin/index.wxml` / `index.wxss` 新增高亮提示样式，让未处理事项在仪表盘顶部醒目展示。

---

### 验证建议
1. 清理本地存储，按“注册买家 → 配置客服 → 补全商品 → 下单 → 管理后台查看 → 画师端查看”的顺序跑一遍闭环。
2. 观察头像、昵称、角色 ID 是否在不同页面保持一致，若发现串线，回查对应待办项。
3. 每个修复完成后，可在本清单上勾选对应条目，并在提交前附上核心文件的变更截图或链接，方便复查。
