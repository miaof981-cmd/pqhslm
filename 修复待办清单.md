# 修复待办清单

以下待办基于近期排查中确认的阻断问题，按优先级从高到低列出。每项都给出了需要调整的核心文件，方便逐条核对修复后的实现逻辑。

## 1. 用户ID被强制固定为 1001
- [ ] **移除启动时的强制回写逻辑**：`miniprogram/app.js` 顶部 `onLaunch` 中硬编码 `userId = 1001`，会覆盖任何已存在账号，导致买家、客服、画师信息串号。需要恢复为“按缓存/自增生成”的正常流程。
- [ ] **下线后台“重置为1001”入口**：`miniprogram/pages/role-manage/index.js` 的 `resetUserId` 会把 ID 再次写回 1001，修复时改成调用 `app.resetUserId()` 生成全新 ID，或仅保留在开发模式。
- [ ] **自检清单**：清理缓存后依次注册多个账号，确认 `wx.getStorageSync('userId')`、`mock_users` 中不会再出现全部为 1001 的情况。

## 2. 买家被错误写入客服列表
- [ ] **修正客服兜底逻辑**：`miniprogram/pages/order-success/index.js` 的 `assignService()` 当前在客服列表为空时，会用“当前买家”的头像/昵称创建默认客服，直接引发头像串线。调整为读取预置客服 (`customer_service_list` / `service_list`) 或引导管理员先配置客服，禁止把买家当客服写回去。
- [ ] **补充客服初始化脚本/数据**：结合 `添加测试客服.js` 等脚本，为联调环境提供至少一条正式客服数据（含 `serviceId`、`avatar`、`qrcode`）。
- [ ] **自检清单**：清空客服列表后重新下单，确认不会再生成以买家头像命名的客服，并在“订单详情/客服二维码管理”里复核头像是否一致。

## 3. 订单写入与各端读取不一致
- [ ] **统一订单存储源**：下单成功页目前只写 `pending_orders`。需要补充同步到正式订单列表（如 `orders`）或新增聚合层，确保后台、画师端可读取。
- [ ] **调整读取逻辑**：`miniprogram/pages/admin/index.js`、`miniprogram/pages/artist-detail/index.js` 等页面仅从 `mock_orders` 取数，修复时改用统一的订单获取工具（可复用 `miniprogram/utils/order-helper.js`），并把 `pending_orders`、`orders` 合并处理。
- [ ] **自检清单**：新下单 → 管理后台仪表盘 → 画师详情 → 订单列表，确认订单数量、头像、客服信息在各端保持一致。

## 4. 商品/画师基础数据缺失导致下单失败
- [ ] **补齐商品数据校验**：`miniprogram/pages/order-success/index.js` 在校验画师信息时应明确提示缺失字段，并允许在测试环境通过 mock 数据兜底，而不是直接终止流程。
- [ ] **建立数据初始化流程**：利用 `检查商品数据.js`、`测试商品管理.js` 等脚本，在进入下单流程前批量写入带 `artistId`、`artistAvatar` 的商品，且确保对应画师在 `artist_applications` 中有审核记录。
- [ ] **自检清单**：重置存储后执行初始化脚本，再次下单，验证不会再因为缺失 `artistId/artistAvatar` 被拦截。

---

### 验证建议
1. 清理本地存储，按“注册买家 → 配置客服 → 补全商品 → 下单 → 管理后台查看 → 画师端查看”的顺序跑一遍闭环。
2. 观察头像、昵称、角色 ID 是否在不同页面保持一致，若发现串线，回查对应待办项。
3. 每个修复完成后，可在本清单上勾选对应条目，并在提交前附上核心文件的变更截图或链接，方便复查。
