# 客服头像显示问题排查报告

## 🔍 问题根源

### 字段名不一致导致的数据丢失

**客服数据存储**（`service-qr-manage/index.js`）：
```javascript
{
  userId: '1001',
  name: '妙妙',
  avatar: 'data:image/...',  // ✅ 字段名是 avatar
  qrcodeUrl: '...',
  isActive: true
}
```

**订单数据读取**（`order-list/index.js` - 修复前）：
```javascript
serviceAvatar = service.avatarUrl || '/assets/default-avatar.png'
                       ^^^^^^^^^ ❌ 错误！应该是 avatar
```

**其他地方的正确用法**：
- `order-success/index.js`: ✅ `service.avatar`
- `admin/index.js`: ✅ `service.avatar`

---

## 📊 影响范围

### 客服头像显示位置

1. **我的订单页面** (`order-list/index.wxml`)
   - 人员信息区：显示画师和客服
   - 状态：❌ 不显示（已修复）

2. **订单详情页** (`order-detail/index.wxml`)
   - 对接客服区域
   - 状态：⚠️ 依赖订单数据，如果订单创建时正确保存则显示

3. **画师工作台** (`workspace/index.wxml`)
   - 订单卡片显示客服信息
   - 状态：⚠️ 依赖订单数据

4. **客服工作台** (`service-workspace/index.wxml`)
   - 不显示客服自己的头像（正常）

5. **管理后台** (`admin/index.wxml`)
   - 不显示头像，只显示客服名称（正常）

---

## ✅ 修复方案

### 1. 统一字段读取逻辑

```javascript
// 修复后（兼容两种字段名）
serviceAvatar = service.avatar || service.avatarUrl || '/assets/default-avatar.png'
                       ^^^^^^       ^^^^^^^^^^          ^^^^^^^^^^^^^^^^^^^^
                       优先使用      兼容旧数据          兜底默认值
```

### 2. 优先使用订单中已保存的数据

```javascript
// 1️⃣ 优先：订单创建时保存的客服信息
if (order.serviceName && order.serviceName !== '待分配') {
  serviceName = order.serviceName
  serviceAvatar = order.serviceAvatar
}
// 2️⃣ 兜底：从客服列表查找
else if (order.serviceId) {
  const service = serviceList.find(s => s.userId === order.serviceId)
  if (service) {
    serviceName = service.name
    serviceAvatar = service.avatar || service.avatarUrl
  }
}
```

---

## 🧪 验证方法

### 验证脚本（复制到控制台执行）

```javascript
console.log('\n========================================')
console.log('👤 客服头像数据完整性检查')
console.log('========================================\n')

// 1. 检查客服列表数据
const serviceList = wx.getStorageSync('customer_service_list') || []
console.log(`📋 客服列表: ${serviceList.length} 个\n`)

serviceList.forEach((service, index) => {
  console.log(`客服 ${index + 1}: ${service.name}`)
  console.log(`  - userId: ${service.userId}`)
  console.log(`  - avatar: ${service.avatar ? '✅ 有' : '❌ 无'}`)
  console.log(`  - avatarUrl: ${service.avatarUrl ? '✅ 有' : '❌ 无'}`)
  if (service.avatar) {
    const avatarType = service.avatar.substring(0, 20)
    console.log(`  - 头像类型: ${avatarType}...`)
  }
  console.log('')
})

// 2. 检查订单中的客服头像
const orders = wx.getStorageSync('orders') || []
const pendingOrders = wx.getStorageSync('pending_orders') || []
const allOrders = [...orders, ...pendingOrders]

console.log(`📦 订单列表: ${allOrders.length} 个\n`)

let missingAvatarCount = 0
allOrders.forEach((order, index) => {
  if (order.serviceId) {
    const hasAvatar = order.serviceAvatar && order.serviceAvatar !== '/assets/default-avatar.png'
    if (!hasAvatar) {
      console.log(`❌ 订单 ${order.id} 客服头像缺失`)
      console.log(`   - serviceId: ${order.serviceId}`)
      console.log(`   - serviceName: ${order.serviceName}`)
      console.log(`   - serviceAvatar: ${order.serviceAvatar}`)
      missingAvatarCount++
    }
  }
})

if (missingAvatarCount > 0) {
  console.log(`\n⚠️ 发现 ${missingAvatarCount} 个订单的客服头像缺失`)
  console.log('建议：重新下单测试')
} else {
  console.log('\n✅ 所有订单客服头像完整')
}

// 3. 检查字段名一致性
console.log('\n========================================')
console.log('🔧 字段名一致性检查')
console.log('========================================\n')

const hasAvatarField = serviceList.some(s => s.avatar)
const hasAvatarUrlField = serviceList.some(s => s.avatarUrl)

console.log(`avatar 字段: ${hasAvatarField ? '✅ 使用中' : '❌ 未使用'}`)
console.log(`avatarUrl 字段: ${hasAvatarUrlField ? '⚠️ 混用' : '✅ 未使用'}`)

if (hasAvatarField && !hasAvatarUrlField) {
  console.log('\n✅ 字段命名一致')
} else if (hasAvatarField && hasAvatarUrlField) {
  console.log('\n⚠️ 字段命名混用，建议统一为 avatar')
} else {
  console.log('\n❌ 未找到头像字段')
}

console.log('\n========================================\n')
```

---

## 📝 修改文件清单

### 已修复
- ✅ `miniprogram/pages/order-list/index.js`
  - 修复客服头像读取逻辑
  - 兼容 `avatar` 和 `avatarUrl` 两种字段名

### 无需修改（已正确）
- ✅ `miniprogram/pages/order-success/index.js` - 使用 `service.avatar`
- ✅ `miniprogram/pages/admin/index.js` - 使用 `service.avatar`
- ✅ `miniprogram/pages/service-qr-manage/index.js` - 存储为 `avatar`

---

## 🎯 后续建议

### 1. 统一字段命名规范
建议在整个项目中统一使用 `avatar` 作为头像字段名，避免 `avatarUrl` 混用。

### 2. 数据迁移（可选）
如果有旧数据使用 `avatarUrl`，可以执行一次性迁移：
```javascript
// 迁移脚本（可选）
const serviceList = wx.getStorageSync('customer_service_list') || []
const updated = serviceList.map(service => {
  if (service.avatarUrl && !service.avatar) {
    return { ...service, avatar: service.avatarUrl }
  }
  return service
})
wx.setStorageSync('customer_service_list', updated)
console.log('✅ 客服数据迁移完成')
```

### 3. 新订单测试
修复后，重新下单测试，确保客服头像正确显示。

---

## ✅ 预期效果

修复后，客服头像应该在以下位置正确显示：
1. ✅ 我的订单页面 - 人员信息区
2. ✅ 订单详情页 - 对接客服区域
3. ✅ 画师工作台 - 订单卡片

