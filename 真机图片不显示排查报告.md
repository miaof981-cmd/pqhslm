# 真机图片不显示问题 - 完整排查报告

## 问题现象
- ✅ 模拟器：图片正常显示
- ❌ 真机预览：图片显示灰色占位符
- ✅ 文本数据：正常同步

---

## 六步排查结果

### ✅ 第1步：路径格式检查

**检查方法**：在模拟器控制台运行 `check-image-paths.js`

**预期结果**：
```
✅ 云存储路径：cloud://env-xxxxx.7777-env-xxxxx/artist-applications/...
```

**异常情况**：
```
❌ 临时路径：wxfile://tmp_abc123.jpg
❌ 本地路径：/assets/image.jpg
```

**检查脚本**：
```javascript
// 在模拟器控制台运行
const cloudAPI = require('../../utils/cloud-api.js')

async function checkPaths() {
  const res = await cloudAPI.getArtistApplicationList({ pageSize: 1 })
  const app = cloudAPI.safeArray(res)[0]
  
  console.log('图片路径检查:')
  app.finishedWorks?.forEach((url, i) => {
    console.log(`${i + 1}. ${url}`)
    console.log(`   类型: ${url.startsWith('cloud://') ? '✅ 云存储' : '❌ 错误'}`)
  })
}

checkPaths()
```

---

### ✅ 第2步：云存储上传验证

**检查点**：上传时的控制台日志

**正确日志**：
```
✅ 图片上传成功 (1/4): cloud://env-xxxxx.7777-env-xxxxx/...
✅ 图片上传成功 (2/4): cloud://env-xxxxx.7777-env-xxxxx/...
上传成功 4/4
```

**异常日志**：
```
❌ 图片上传失败: {success: false, message: "..."}
```

**代码位置**：`miniprogram/pages/apply/index.js:157`

---

### ✅ 第3步：数据库写入验证

**检查方法**：云开发控制台 → 数据库 → `artist_applications` 集合

**正确数据**：
```json
{
  "_id": "xxx",
  "finishedWorks": [
    "cloud://env-xxxxx.7777-env-xxxxx/artist-applications/finishedWorks/1732268800000_0.jpg",
    "cloud://env-xxxxx.7777-env-xxxxx/artist-applications/finishedWorks/1732268800000_1.jpg"
  ]
}
```

**异常数据**：
```json
{
  "finishedWorks": [
    "wxfile://tmp_abc123.jpg",  // ❌ 临时路径
    "/local/path.jpg"            // ❌ 本地路径
  ]
}
```

---

### ✅ 第4步：云存储权限检查

**检查位置**：云开发控制台 → 存储 → 权限设置

**必需配置**：
```json
{
  "read": true,   // ✅ 必须开启公开读
  "write": false  // ❌ 禁止公开写（安全）
}
```

**操作步骤**：
1. 打开 [微信云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择你的环境 → 存储
3. 点击"权限设置"
4. 将"所有用户可读"设置为**开启**

---

### ⚠️ 第5步：合法域名配置（通常不需要）

**检查位置**：微信公众平台 → 开发 → 开发设置 → 服务器域名

**说明**：使用云存储时，微信会自动添加云存储域名到白名单，**通常无需手动配置**。

如果出现域名问题，会看到错误：
```
downloadFile:fail url not in domain list
```

---

### 🎯 第6步：真机需要 getTempFileURL（最关键！）

**问题根源**：
- 模拟器：可以直接渲染 `cloud://` 路径
- 真机：**必须先转换为临时 HTTPS URL**

**修复方案**：在显示图片前调用 `wx.cloud.getTempFileURL()`

**已修复文件**：`miniprogram/pages/artist-application-detail/index.js`

**修复代码**：
```javascript
// 将 cloud:// 路径转换为临时 HTTPS URL
async convertCloudImagesToTempUrls(fileIDs) {
  if (!Array.isArray(fileIDs) || fileIDs.length === 0) {
    return []
  }

  const cloudFileIDs = fileIDs.filter(id => id && id.startsWith('cloud://'))
  
  if (cloudFileIDs.length === 0) {
    return fileIDs
  }

  try {
    const result = await wx.cloud.getTempFileURL({
      fileList: cloudFileIDs
    })

    const urlMap = new Map()
    result.fileList.forEach(item => {
      if (item.status === 0) {
        urlMap.set(item.fileID, item.tempFileURL)
      }
    })

    return fileIDs.map(id => urlMap.has(id) ? urlMap.get(id) : id)
  } catch (error) {
    console.error('❌ 转换云存储路径失败:', error)
    return fileIDs
  }
}

// 在加载申请详情时调用
async loadApplication() {
  const application = // ... 从云端获取
  
  // 🎯 关键：转换图片路径
  application.finishedWorks = await this.convertCloudImagesToTempUrls(application.finishedWorks || [])
  application.processImages = await this.convertCloudImagesToTempUrls(application.processImages || [])
  
  this.setData({ application })
}
```

---

## 修复总结

### ✅ 已修复的问题

1. **上传到云存储**（`pages/apply/index.js`）
   - 图片上传后保存 `fileID` 而非临时路径
   
2. **真机路径转换**（`pages/artist-application-detail/index.js`）
   - 加载详情时自动转换 `cloud://` 为临时 HTTPS URL

### 📋 验证清单

- [ ] 在模拟器上传图片，查看控制台是否有 "✅ 图片上传成功: cloud://..." 日志
- [ ] 在云开发控制台数据库中检查图片路径是否为 `cloud://` 开头
- [ ] 在云开发控制台存储中检查文件是否成功上传
- [ ] 在真机预览时检查控制台是否有 "✅ 云存储路径转换成功" 日志
- [ ] 在真机预览时图片是否正常显示

---

## 常见问题

### Q1：模拟器显示，真机不显示
**A**：需要调用 `getTempFileURL` 转换路径（已修复）

### Q2：上传后立即在申请页面看不到
**A**：申请页面显示的是临时预览，正常现象

### Q3：云存储权限错误
**A**：设置"所有用户可读"权限

### Q4：临时 URL 有效期多久？
**A**：默认 2 小时，过期后需要重新获取

### Q5：每次都要调用 getTempFileURL 吗？
**A**：是的，但可以在前端缓存 URL，在有效期内复用

---

## 下一步测试

1. **清除旧数据**
   - 在云开发控制台删除所有包含临时路径的旧申请

2. **重新提交申请**
   - 在模拟器提交一个新申请
   - 观察控制台上传日志

3. **真机验证**
   - 在手机端查看申请详情
   - 检查图片是否正常显示

4. **查看日志**
   ```
   ✅ 图片上传成功: cloud://...
   ✅ 申请提交成功
   ✅ 云存储路径转换成功: 4 个文件
   📸 图片路径已转换为临时URL
   ```

---

## 技术原理

### 为什么模拟器能显示 cloud:// 路径？

**模拟器**：
- 直接访问本地云存储缓存
- 无需网络请求
- 支持直接渲染 `cloud://` 协议

**真机**：
- 必须通过 HTTPS 下载
- 需要先转换为临时 URL
- 不支持直接渲染 `cloud://` 协议

### getTempFileURL 工作原理

```
cloud://xxx → 调用 getTempFileURL → https://xxx.tcb.qcloud.la/xxx?sign=xxx
                                       ↑
                                   临时签名URL
                                  （2小时有效期）
```

---

## 代码文件清单

**已修改的文件**：
1. `miniprogram/pages/apply/index.js` - 图片上传到云存储
2. `miniprogram/utils/cloud-api.js` - 新增 uploadFile 方法
3. `miniprogram/pages/artist-application-detail/index.js` - 路径转换逻辑
4. `cloudfunctions/artistManager/index.js` - 支持完整申请字段

**需要手动操作**：
1. 上传 `artistManager` 云函数
2. 设置云存储"所有用户可读"权限

---

## 总结

**核心问题**：真机无法直接渲染 `cloud://` 路径

**解决方案**：使用 `wx.cloud.getTempFileURL()` 转换为临时 HTTPS URL

**修复状态**：✅ 已完成

**测试要求**：在真机重新提交申请并验证图片显示

