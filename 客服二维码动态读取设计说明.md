# 客服二维码动态读取设计说明

## 设计原则

**核心理念**：订单固化客服关系，二维码动态读取最新数据

## 数据流程

### 订单创建时（order-success/index.js）

```javascript
{
  serviceId: 'KF001',           // ✅ 保存：固化客服分配关系
  serviceName: '客服小王',      // ✅ 保存：便于查看历史
  serviceAvatar: 'xxx.png',     // ✅ 保存：便于显示
  serviceQrcodeUrl: '',         // ❌ 留空：强制动态读取
}
```

### 订单详情页读取时（qrcode-helper.js）

```
优先级顺序：
1️⃣ 客服列表[serviceId].qrCode         ← 最新二维码（优先）
2️⃣ 订单字段.serviceQRCode             ← 历史二维码（兜底：客服被删除）
3️⃣ 系统设置.serviceQrcode             ← 默认二维码
4️⃣ 遗留存储 service_qrcode            ← 最后兜底
```

## 使用场景

### ✅ 场景1：客服更换二维码

```
2024-01-01: 客服KF001上传二维码A
2024-01-05: 用户下单 → 订单绑定KF001（不保存二维码）
2024-02-01: 客服KF001更新为二维码B
2024-02-10: 用户查看订单 → 显示二维码B ✓
```

### ✅ 场景2：换客服

```
2024-01-01: 客服KF001负责订单
2024-02-01: 管理员手动更换为KF002
            - 更新订单的 serviceId = KF002
2024-02-10: 用户查看订单 → 显示KF002的二维码 ✓
```

### ✅ 场景3：客服离职

```
2024-01-01: 客服KF001负责订单
2024-02-01: 客服KF001从列表删除
2024-02-10: 用户查看订单 
            1. 尝试从客服列表读取 → 找不到
            2. 回退到订单字段读取 → 找到历史二维码（如果有）
            3. 再回退到系统默认二维码 → 显示默认客服
```

## 字段兼容性

支持多种客服二维码字段名（从客服列表读取时）：

- `qrCode`
- `qrcode`
- `qrcodeUrl`
- `serviceQrcode`
- `serviceQrcodeUrl`
- `serviceQrCode`
- `wechatQrcode`
- `qrcodeNumber`

## 优势

1. **二维码保持最新**：客服更新二维码后，所有历史订单自动显示新的
2. **不污染历史数据**：订单表不保存易变的二维码URL
3. **兼容客服变更**：支持换客服、客服离职等场景
4. **多层兜底机制**：客服删除后仍有系统默认二维码

## 注意事项

⚠️ **不要在订单创建时保存 serviceQrcodeUrl**

如果误保存了二维码URL，会导致：
- 订单详情页优先读取订单字段
- 客服更新二维码后，订单仍显示旧的
- 失去动态读取的优势

## 修改历史

- 2025-11-10: 调整策略为动态读取（避免固化）
- 之前版本：订单创建时保存二维码（已废弃）

