# åç«¯æ¥å…¥å‡†å¤‡æ–‡æ¡£

> **æ›´æ–°æ—¶é—´**: 2025-11-11  
> **é€‚ç”¨åœºæ™¯**: ä»æœ¬åœ°mockæ•°æ®è¿ç§»åˆ°çœŸå®åç«¯API

---

## ğŸ“‹ ç›®å½•

1. [å½“å‰æ•°æ®å­˜å‚¨ç»“æ„](#1-å½“å‰æ•°æ®å­˜å‚¨ç»“æ„)
2. [æ ¸å¿ƒä¸šåŠ¡é€»è¾‘](#2-æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)
3. [æ•°æ®å­—æ®µè§„èŒƒ](#3-æ•°æ®å­—æ®µè§„èŒƒ)
4. [éœ€è¦æ›¿æ¢çš„APIä½ç½®](#4-éœ€è¦æ›¿æ¢çš„apiä½ç½®)
5. [è¿ç§»ç­–ç•¥å»ºè®®](#5-è¿ç§»ç­–ç•¥å»ºè®®)
6. [å…³é”®æ³¨æ„äº‹é¡¹](#6-å…³é”®æ³¨æ„äº‹é¡¹)

---

## 1. å½“å‰æ•°æ®å­˜å‚¨ç»“æ„

### 1.1 ç”¨æˆ·ç›¸å…³

| Storage Key | æ•°æ®ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------------|---------|------|------|
| `userId` | String | ç”¨æˆ·IDï¼ˆ1001èµ·ï¼‰ | `"1001"` |
| `openid` | String | æ¨¡æ‹Ÿå¾®ä¿¡OpenID | `"openid-1001-timestamp"` |
| `userInfo` | Object | ç”¨æˆ·ä¿¡æ¯ | `{nickName, avatarUrl, ...}` |
| `userRoles` | Array | ç”¨æˆ·è§’è‰²åˆ—è¡¨ | `["customer", "artist"]` |
| `hasLoggedIn` | Boolean | ç™»å½•çŠ¶æ€ | `true` |
| `users` | Array | æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ | `[{userId, nickName, ...}]` |

**ç”¨æˆ·ä¿¡æ¯ç»“æ„**ï¼š
```javascript
{
  userId: "1001",
  nickName: "ç”¨æˆ·æ˜µç§°",
  avatarUrl: "å¤´åƒURLæˆ–base64",
  openid: "openid-1001-timestamp",
  phone: "æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰",
  memberLevel: "æ™®é€šä¼šå‘˜",
  memberExpireTime: "2025-12-31 23:59:59"
}
```

---

### 1.2 è®¢å•ç›¸å…³

| Storage Key | æ•°æ®ç±»å‹ | è¯´æ˜ | çŠ¶æ€å€¼ |
|------------|---------|------|-------|
| `pending_orders` | Array | å¾…å¤„ç†è®¢å• | `unpaid`, `paid`, `inProgress`, `waitingConfirm` |
| `completed_orders` | Array | å·²å®Œæˆè®¢å• | `completed` |
| `mock_orders` | Array | æ¨¡æ‹Ÿè®¢å•ï¼ˆç”¨äºæµ‹è¯•ï¼‰ | æ‰€æœ‰çŠ¶æ€ |

**è®¢å•å­—æ®µç»“æ„**ï¼š
```javascript
{
  // åŸºç¡€ä¿¡æ¯
  id: "202511081234567890",           // è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰
  orderNumber: "202511081234567890",  // è®¢å•ç¼–å·ï¼ˆå¤‡ç”¨ï¼‰
  
  // å•†å“ä¿¡æ¯
  productId: "product_001",
  productName: "å•†å“åç§°",
  productImage: "å›¾ç‰‡URLæˆ–base64",
  spec: "è§„æ ¼1/è§„æ ¼2",                 // è§„æ ¼ç»„åˆï¼ˆæ˜¾ç¤ºç”¨ï¼‰
  specs: [{spec1, spec2, price, quantity}],  // è§„æ ¼è¯¦æƒ…ï¼ˆå¤šè§„æ ¼ï¼‰
  quantity: 1,                         // æ•°é‡
  price: "88.00",                      // å•ä»·ï¼ˆå­—ç¬¦ä¸²ï¼‰
  totalAmount: 88.00,                  // æ€»é‡‘é¢ï¼ˆæ•°å­—ï¼‰
  
  // æ—¶é—´ä¿¡æ¯ï¼ˆâš ï¸ æ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼‰
  createTime: "2025-11-08 10:28:30",   // ä¸‹å•æ—¶é—´
  startDate: "2025-11-08 10:28:30",    // å¼€å§‹æ—¶é—´ï¼ˆå¤‡ç”¨ï¼‰
  createdAt: "2025-11-08 10:28:30",    // åˆ›å»ºæ—¶é—´ï¼ˆå¤‡ç”¨ï¼‰
  deadline: "2025-11-15 10:28:00",     // æˆªç¨¿æ—¶é—´
  completedAt: "2025-11-15 09:00:00",  // å®Œæˆæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  deliveryDays: 7,                     // å‡ºç¨¿å¤©æ•°
  
  // ç”¨æˆ·ä¿¡æ¯
  buyerId: "1001",                     // ä¹°å®¶ID
  buyerName: "ä¹°å®¶æ˜µç§°",
  buyerAvatar: "ä¹°å®¶å¤´åƒURL",
  buyerPhone: "13800138000",           // ä¹°å®¶æ‰‹æœºï¼ˆå¯é€‰ï¼‰
  buyerOpenId: "openid-1001-xxx",      // ä¹°å®¶OpenIDï¼ˆå¯é€‰ï¼‰
  
  // ç”»å¸ˆä¿¡æ¯
  artistId: "1002",                    // ç”»å¸ˆç”¨æˆ·ID
  artistName: "ç”»å¸ˆæ˜µç§°",
  artistAvatar: "ç”»å¸ˆå¤´åƒURL",
  artistNumber: "001",                 // ğŸ¯ ç”»å¸ˆç‹¬ç«‹ç¼–å·ï¼ˆé‡è¦ï¼ï¼‰
  
  // å®¢æœä¿¡æ¯
  serviceId: "1003",                   // å®¢æœç”¨æˆ·ID
  serviceName: "å®¢æœæ˜µç§°",
  serviceAvatar: "å®¢æœå¤´åƒURL",
  serviceQrcodeUrl: "å®¢æœäºŒç»´ç URL",
  serviceQrcodeNumber: "å®¢æœç¼–å·",
  serviceStatus: "assigned",           // assigned | pending
  needsService: false,
  
  // è®¢å•çŠ¶æ€ï¼ˆâš ï¸ æ ¸å¿ƒå­—æ®µï¼‰
  status: "inProgress",                // è®¢å•çŠ¶æ€ï¼ˆè§çŠ¶æ€è¡¨ï¼‰
  statusText: "è¿›è¡Œä¸­",                // çŠ¶æ€æ–‡æœ¬ï¼ˆæ˜¾ç¤ºç”¨ï¼‰
  refundStatus: null,                  // é€€æ¬¾çŠ¶æ€ï¼ˆrefunding | refundedï¼‰
  
  // è¿›åº¦ç›¸å…³
  wasOverdue: false,                   // æ˜¯å¦æ›¾ç»è„±ç¨¿
  overdueDays: 0,                      // è„±ç¨¿å¤©æ•°
  
  // ç¾¤èŠä¿¡æ¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
  groupName: "ã€è®¢å•202511...ã€‘ä¹°å®¶æ˜µç§°-ç”»å¸ˆæ˜µç§°",
  
  // å…¶ä»–
  urgent: false,                       // æ˜¯å¦åŠ æ€¥
  items: []                            // å¤šå•†å“è®¢å•ï¼ˆè´­ç‰©è½¦ï¼‰
}
```

**è®¢å•çŠ¶æ€å€¼ï¼ˆstatusï¼‰**ï¼š
```javascript
// ç»ˆæ­¢æ€ï¼ˆä¸å¯å†å˜æ›´ï¼‰
'completed'      // å·²å®Œæˆ
'refunded'       // å·²é€€æ¬¾
'cancelled'      // å·²å–æ¶ˆ

// è¿›è¡Œä¸­çŠ¶æ€
'unpaid'         // å¾…æ”¯ä»˜
'paid'           // å·²æ”¯ä»˜
'inProgress'     // åˆ¶ä½œä¸­
'processing'     // å¤„ç†ä¸­ï¼ˆå¤‡ç”¨ï¼‰
'waitingConfirm' // å¾…ç¡®è®¤
'nearDeadline'   // ä¸´è¿‘æˆªç¨¿
'overdue'        // å·²è„±ç¨¿

// é€€æ¬¾ä¸­
'refunding'      // é€€æ¬¾å¤„ç†ä¸­
```

---

### 1.3 å•†å“ç›¸å…³

| Storage Key | æ•°æ®ç±»å‹ | è¯´æ˜ |
|------------|---------|------|
| `mock_products` | Array | å•†å“åˆ—è¡¨ |
| `product_counter` | Number | å•†å“IDè®¡æ•°å™¨ |

**å•†å“å­—æ®µç»“æ„**ï¼š
```javascript
{
  id: "product_001",                   // å•†å“IDï¼ˆå”¯ä¸€ï¼‰
  name: "å•†å“åç§°",
  description: "å•†å“æè¿°",
  images: ["å›¾ç‰‡1_base64", "å›¾ç‰‡2_base64"],  // å›¾ç‰‡æ•°ç»„ï¼ˆbase64æˆ–URLï¼‰
  descriptionImages: ["æè¿°å›¾1", "æè¿°å›¾2"],
  
  // ä»·æ ¼ï¼ˆå•è§„æ ¼ï¼‰
  price: 88,                           // å•ä»·
  originalPrice: 128,                  // åŸä»·ï¼ˆå¯é€‰ï¼‰
  
  // ä»·æ ¼ï¼ˆå¤šè§„æ ¼ï¼‰
  hasPricing: true,                    // æ˜¯å¦æœ‰å¤šè§„æ ¼å®šä»·
  pricingMethod: "combined",           // combined | separate
  spec1Name: "å°ºå¯¸",                   // ä¸€çº§è§„æ ¼å
  spec1Values: ["åŠèº«", "å…¨èº«"],       // ä¸€çº§è§„æ ¼å€¼
  spec2Name: "é£æ ¼",                   // äºŒçº§è§„æ ¼åï¼ˆå¯é€‰ï¼‰
  spec2Values: ["Qç‰ˆ", "å†™å®"],        // äºŒçº§è§„æ ¼å€¼ï¼ˆå¯é€‰ï¼‰
  pricing: [                           // ä»·æ ¼çŸ©é˜µ
    {spec1: "åŠèº«", spec2: "Qç‰ˆ", price: 88},
    {spec1: "åŠèº«", spec2: "å†™å®", price: 128}
  ],
  
  // åº“å­˜
  stock: 99,                           // åº“å­˜æ•°é‡
  sales: 0,                            // é”€é‡
  
  // åˆ†ç±»
  categoryId: "category_001",
  categoryName: "åˆ†ç±»åç§°",
  
  // ç”»å¸ˆä¿¡æ¯
  artistId: "1002",                    // ç”»å¸ˆç”¨æˆ·ID
  artistName: "ç”»å¸ˆæ˜µç§°",
  artistAvatar: "ç”»å¸ˆå¤´åƒURL",
  artistNumber: "001",                 // ğŸ¯ ç”»å¸ˆç‹¬ç«‹ç¼–å·
  
  // å…¶ä»–
  deliveryDays: 7,                     // å‡ºç¨¿å¤©æ•°
  status: "active",                    // active | inactive
  createdAt: "2025-11-08 10:00:00",
  views: 0                             // æµè§ˆé‡ï¼ˆå·²åºŸå¼ƒï¼‰
}
```

---

### 1.4 ç”»å¸ˆç”³è¯·ç›¸å…³

| Storage Key | æ•°æ®ç±»å‹ | è¯´æ˜ |
|------------|---------|------|
| `artist_applications` | Array | ç”»å¸ˆç”³è¯·åˆ—è¡¨ |
| `artist_number_counter` | Number | ç”»å¸ˆç¼–å·è®¡æ•°å™¨ï¼ˆ001èµ·ï¼‰ |

**ç”³è¯·å­—æ®µç»“æ„**ï¼š
```javascript
{
  id: "app_timestamp",
  userId: "1001",                      // ç”³è¯·äººç”¨æˆ·ID
  openid: "openid-1001-xxx",
  
  // å¾®ä¿¡ä¿¡æ¯
  nickName: "å¾®ä¿¡æ˜µç§°",
  avatarUrl: "å¾®ä¿¡å¤´åƒ",
  
  // ç”³è¯·ä¿¡æ¯
  name: "çœŸå®å§“å",
  age: "25",
  wechat: "å¾®ä¿¡å·",
  idealPrice: "100",                   // ç†æƒ³ç¨¿é…¬
  minPrice: "50",                      // æœ€ä½ä»·æ ¼
  finishedWorks: ["ä½œå“å›¾1", "ä½œå“å›¾2"],  // å®Œæˆä½œå“ï¼ˆbase64ï¼‰
  processImages: ["è¿‡ç¨‹å›¾1", "è¿‡ç¨‹å›¾2"],  // åˆ›ä½œè¿‡ç¨‹å›¾ï¼ˆbase64ï¼‰
  
  // çŠ¶æ€
  status: "pending",                   // pending | approved | rejected
  submitTime: "2025-11-08 10:00:00",
  reviewTime: "2025-11-08 12:00:00",   // å®¡æ ¸æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  reviewNote: "å®¡æ ¸å¤‡æ³¨",               // å®¡æ ¸å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
  
  // å®¡æ ¸é€šè¿‡ååˆ†é…
  artistNumber: "001"                  // ğŸ¯ ç”»å¸ˆç‹¬ç«‹ç¼–å·ï¼ˆé‡è¦ï¼ï¼‰
}
```

---

### 1.5 è´¢åŠ¡ç›¸å…³

| Storage Key | æ•°æ®ç±»å‹ | è¯´æ˜ |
|------------|---------|------|
| `service_income_ledger` | Array | å®¢æœæ”¶å…¥è´¦æœ¬ |
| `staff_income_ledger` | Array | ç®¡ç†å‘˜åˆ†æˆè´¦æœ¬ |
| `reward_records` | Array | æ‰“èµè®°å½• |
| `withdraw_records` | Array | æç°è®°å½• |

**æ”¶å…¥è®°å½•ç»“æ„**ï¼š
```javascript
// å®¢æœ/ç®¡ç†å‘˜åˆ†æˆ
{
  id: "income_timestamp",
  userId: "1003",                      // å®¢æœ/ç®¡ç†å‘˜ID
  orderId: "202511081234567890",
  incomeType: "service",               // service | admin_share
  amount: "5.00",                      // åˆ†æˆé‡‘é¢
  orderAmount: "88.00",                // è®¢å•é‡‘é¢
  note: "è®¢å•åˆ†æˆ",
  createTime: "2025-11-08 10:00:00",
  orderCompletedAt: "2025-11-08 10:00:00"
}

// æ‰“èµè®°å½•
{
  id: "reward_timestamp",
  artistId: "1002",                    // ç”»å¸ˆID
  customerId: "1001",                  // æ‰“èµäººID
  orderId: "202511081234567890",       // å…³è”è®¢å•ï¼ˆå¯é€‰ï¼‰
  productName: "å•†å“åç§°",
  amount: "10.00",                     // æ‰“èµé‡‘é¢
  message: "ç”»å¾—çœŸå¥½ï¼",               // ç•™è¨€ï¼ˆå¯é€‰ï¼‰
  time: "2025-11-08 10:00:00"
}

// æç°è®°å½•
{
  id: "withdraw_timestamp",
  userId: "1002",                      // æç°äººID
  amount: "100.00",                    // æç°é‡‘é¢
  bankName: "ä¸­å›½é“¶è¡Œ",
  bankCard: "6217********1234",
  realName: "çœŸå®å§“å",
  status: "completed",                 // pending | processing | completed | rejected
  time: "2025-11-08 10:00:00",
  completedTime: "2025-11-08 12:00:00",
  note: "æç°å¤‡æ³¨"
}
```

---

### 1.6 å…¶ä»–æ•°æ®

| Storage Key | æ•°æ®ç±»å‹ | è¯´æ˜ |
|------------|---------|------|
| `categories` | Array | åˆ†ç±»åˆ—è¡¨ |
| `notices` | Array | å…¬å‘Šåˆ—è¡¨ |
| `banners` | Array | è½®æ’­å›¾åˆ—è¡¨ |
| `service_qrcodes` | Object | å®¢æœäºŒç»´ç ï¼ˆ`{userId: {imageUrl, updateTime}}`ï¼‰ |
| `buyer_shows` | Array | ä¹°å®¶ç§€åˆ—è¡¨ |

---

## 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 2.1 ç”¨æˆ·IDåŒè½¨åˆ¶ï¼ˆâš ï¸ é‡è¦ï¼ï¼‰

**æ¦‚å¿µ**ï¼š
- **ç”¨æˆ·IDï¼ˆuserIdï¼‰**: å…¨å±€å”¯ä¸€ï¼Œ1001èµ·ï¼Œè‡ªå¢
- **ç”»å¸ˆç¼–å·ï¼ˆartistNumberï¼‰**: ç”»å¸ˆä¸“å±ï¼Œ001èµ·ï¼Œè‡ªå¢ï¼Œä»…å®¡æ ¸é€šè¿‡ååˆ†é…

**åˆ†é…é€»è¾‘**ï¼š
```javascript
// ç”¨æˆ·æ³¨å†Œæ—¶
userId = generateUserId()  // 1001, 1002, 1003...

// ç”»å¸ˆç”³è¯·é€šè¿‡æ—¶
artistNumber = generateArtistNumber()  // 001, 002, 003...
```

**æ˜¾ç¤ºä¼˜å…ˆçº§**ï¼š
- ç”»å¸ˆç›¸å…³ï¼šä¼˜å…ˆæ˜¾ç¤º `artistNumber`ï¼Œé™çº§æ˜¾ç¤º `userId`
- ç”¨æˆ·ç›¸å…³ï¼šå§‹ç»ˆæ˜¾ç¤º `userId`

**åç«¯è®¾è®¡å»ºè®®**ï¼š
```sql
-- usersè¡¨
CREATE TABLE users (
  user_id VARCHAR(20) PRIMARY KEY,     -- 1001, 1002...
  nickname VARCHAR(50),
  avatar_url TEXT,
  ...
);

-- artistsè¡¨ï¼ˆç”»å¸ˆé¢å¤–ä¿¡æ¯ï¼‰
CREATE TABLE artists (
  artist_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id VARCHAR(20) REFERENCES users(user_id),
  artist_number VARCHAR(10) UNIQUE,    -- 001, 002...ï¼ˆé‡è¦ï¼ï¼‰
  status ENUM('pending', 'approved', 'rejected'),
  ...
);
```

---

### 2.2 è®¢å•çŠ¶æ€æµè½¬

```mermaid
graph LR
    A[unpaid å¾…æ”¯ä»˜] --> B[paid å·²æ”¯ä»˜]
    B --> C[inProgress åˆ¶ä½œä¸­]
    C --> D[waitingConfirm å¾…ç¡®è®¤]
    D --> E[completed å·²å®Œæˆ]
    
    C --> F[nearDeadline ä¸´è¿‘æˆªç¨¿]
    F --> G[overdue å·²è„±ç¨¿]
    
    C -.é€€æ¬¾.-> H[refunding é€€æ¬¾ä¸­]
    H --> I[refunded å·²é€€æ¬¾]
    
    style E fill:#4CAF50
    style I fill:#E74C3C
```

**ç»ˆæ­¢æ€**ï¼ˆä¸å¯å†å˜æ›´ï¼‰ï¼š
- `completed` - å·²å®Œæˆ
- `refunded` - å·²é€€æ¬¾
- `cancelled` - å·²å–æ¶ˆ

**çŠ¶æ€è®¡ç®—é€»è¾‘**ï¼ˆè‡ªåŠ¨ï¼‰ï¼š
```javascript
// åœ¨ utils/order-status.js ä¸­å®ç°
function calculateOrderStatus(order) {
  // 1. ç»ˆæ­¢æ€ä¿æŠ¤
  if (['completed', 'refunded', 'cancelled'].includes(order.status)) {
    return order  // ä¸ä¿®æ”¹
  }
  
  // 2. æ—¶é—´åˆ¤æ–­
  const now = Date.now()
  const deadline = parseDate(order.deadline).getTime()
  const diffDays = Math.ceil((deadline - now) / 86400000)
  
  if (diffDays < 0) return 'overdue'      // å·²è„±ç¨¿
  if (diffDays <= 2) return 'nearDeadline'  // ä¸´è¿‘æˆªç¨¿
  return order.status  // ä¿æŒåŸçŠ¶æ€
}
```

---

### 2.3 è®¢å•åˆ†æˆè®¡ç®—

**åˆ†æˆè§„åˆ™**ï¼ˆæŒ‰æ•°é‡è®¡ç®—ï¼‰ï¼š
```javascript
// è®¢å•å®Œæˆæ—¶è§¦å‘åˆ†æˆ
const orderAmount = order.totalAmount
const quantity = order.quantity

// å®¢æœåˆ†æˆï¼šÂ¥5/ä»¶
const serviceFee = 5 * quantity

// ç®¡ç†å‘˜åˆ†æˆï¼šæ ¹æ®é…ç½®
const adminShareRate = getAdminShareRate()  // é»˜è®¤5%
const adminFee = orderAmount * adminShareRate * quantity

// ç”»å¸ˆæ”¶å…¥
const artistIncome = orderAmount - serviceFee - adminFee
```

**åç«¯è®¾è®¡å»ºè®®**ï¼š
- è®¢å•å®Œæˆæ—¶è§¦å‘åˆ†æˆè®¡ç®—
- è®°å½•åˆ°ç‹¬ç«‹çš„ `income_ledger` è¡¨
- æ”¯æŒåˆ†æˆè§„åˆ™é…ç½®

---

### 2.4 åº“å­˜ç®¡ç†

**æ‰£å‡æ—¶æœº**ï¼š
- ä¸‹å•æˆåŠŸæ—¶ â†’ ç«‹å³æ‰£å‡åº“å­˜
- é€€æ¬¾æˆåŠŸæ—¶ â†’ è‡ªåŠ¨å›é€€åº“å­˜

**å®ç°**ï¼š
```javascript
// ä¸‹å•æ—¶
await decreaseStock(productId, quantity)

// é€€æ¬¾æ—¶
await increaseStock(productId, quantity)
```

**åç«¯è®¾è®¡å»ºè®®**ï¼š
- ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯åº“å­˜ä¸€è‡´æ€§
- æ”¯æŒåº“å­˜é¢„è­¦ï¼ˆä½äºé˜ˆå€¼æ—¶æé†’ï¼‰

---

### 2.5 æ—¶é—´æ ¼å¼æ ‡å‡†ï¼ˆâš ï¸ iOSå…¼å®¹ï¼‰

**å­˜å‚¨æ ¼å¼**ï¼š
```javascript
"2025-11-08 10:28:30"  // yyyy-MM-dd HH:mm:ss
```

**è§£ææ–¹æ³•**ï¼š
```javascript
// âŒ é”™è¯¯ï¼ˆiOSä¸æ”¯æŒï¼‰
new Date("2025-11-08 10:28:30")

// âœ… æ­£ç¡®ï¼ˆiOSå…¼å®¹ï¼‰
parseDate("2025-11-08 10:28:30")  // å†…éƒ¨è½¬æ¢ä¸º "2025/11/08 10:28:30"
```

**åç«¯è¿”å›å»ºè®®**ï¼š
- æ•°æ®åº“å­˜å‚¨ï¼š`DATETIME` ç±»å‹
- APIè¿”å›ï¼šISO 8601 æ ¼å¼ `2025-11-08T10:28:30+08:00`
- å‰ç«¯è‡ªè¡Œè½¬æ¢ä¸ºå±•ç¤ºæ ¼å¼

---

## 3. æ•°æ®å­—æ®µè§„èŒƒ

### 3.1 å¿…å¡«å­—æ®µ vs å¯é€‰å­—æ®µ

**è®¢å•å¿…å¡«**ï¼š
```javascript
{
  id,           // è®¢å•å·
  productId,    // å•†å“ID
  productName,  // å•†å“åç§°
  price,        // å•ä»·
  quantity,     // æ•°é‡
  totalAmount,  // æ€»é‡‘é¢
  createTime,   // ä¸‹å•æ—¶é—´
  deadline,     // æˆªç¨¿æ—¶é—´
  buyerId,      // ä¹°å®¶ID
  artistId,     // ç”»å¸ˆID
  status        // è®¢å•çŠ¶æ€
}
```

**è®¢å•å¯é€‰**ï¼š
```javascript
{
  serviceId,        // å®¢æœIDï¼ˆå¯ååˆ†é…ï¼‰
  completedAt,      // å®Œæˆæ—¶é—´ï¼ˆå®Œæˆåæ‰æœ‰ï¼‰
  refundStatus,     // é€€æ¬¾çŠ¶æ€ï¼ˆé€€æ¬¾æ—¶æ‰æœ‰ï¼‰
  wasOverdue,       // æ˜¯å¦è„±ç¨¿ï¼ˆå®Œæˆåæ‰çŸ¥é“ï¼‰
  groupName         // ç¾¤åï¼ˆå‰ç«¯è‡ªåŠ¨ç”Ÿæˆï¼‰
}
```

---

### 3.2 å­—æ®µç±»å‹çº¦å®š

| å­—æ®µç±»å‹ | å‰ç«¯ç±»å‹ | åç«¯ç±»å‹ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| ç”¨æˆ·ID | String | VARCHAR(20) | `"1001"` |
| è®¢å•å· | String | VARCHAR(30) | `"202511081234567890"` |
| é‡‘é¢ | Number | DECIMAL(10,2) | `88.00` |
| æ•°é‡ | Number | INT | `1` |
| æ—¶é—´ | String | DATETIME | `"2025-11-08 10:28:30"` |
| å›¾ç‰‡ | String | TEXT/VARCHAR | base64æˆ–URL |
| æ•°ç»„ | Array | JSON | `["item1", "item2"]` |

---

### 3.3 ç‰¹æ®Šå­—æ®µè¯´æ˜

**1. å›¾ç‰‡å­—æ®µ**ï¼š
- å½“å‰ï¼šå­˜å‚¨base64å­—ç¬¦ä¸²ï¼ˆåŒ…å« `data:image/png;base64,` å‰ç¼€ï¼‰
- å»ºè®®ï¼šæ”¹ä¸ºå­˜å‚¨URLï¼ˆä¸Šä¼ åˆ°äº‘å­˜å‚¨/CDNï¼‰
- å…¼å®¹ï¼šæ”¯æŒä¸¤ç§æ ¼å¼æ··åˆ

**2. è§„æ ¼å­—æ®µ**ï¼š
- `spec`ï¼šè§„æ ¼ç»„åˆå­—ç¬¦ä¸²ï¼ˆå¦‚ `"åŠèº«/Qç‰ˆ"`ï¼‰ï¼Œç”¨äºæ˜¾ç¤º
- `specs`ï¼šè§„æ ¼è¯¦æƒ…æ•°ç»„ï¼Œç”¨äºé€»è¾‘å¤„ç†

**3. çŠ¶æ€å­—æ®µ**ï¼š
- `status`ï¼šä¸»çŠ¶æ€ï¼ˆå¿…å¡«ï¼‰
- `statusText`ï¼šçŠ¶æ€æ–‡æœ¬ï¼ˆå‰ç«¯ç”Ÿæˆï¼Œå¯é€‰ï¼‰
- `refundStatus`ï¼šé€€æ¬¾å­çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

---

## 4. éœ€è¦æ›¿æ¢çš„APIä½ç½®

### 4.1 ç”¨æˆ·æ¨¡å—

**æ–‡ä»¶**: `pages/login/index.js`

```javascript
// å½“å‰ï¼ˆæœ¬åœ°mockï¼‰
wx.login({
  success: (res) => {
    const code = res.code
    // ç”Ÿæˆæ¨¡æ‹ŸuserId
    const userId = generateUserId()
    wx.setStorageSync('userId', userId)
  }
})

// æ›¿æ¢ä¸ºï¼ˆè°ƒç”¨åç«¯ï¼‰
wx.login({
  success: async (res) => {
    const { code } = res
    // è°ƒç”¨åç«¯ç™»å½•æ¥å£
    const { userId, token } = await api.login({ code })
    wx.setStorageSync('userId', userId)
    wx.setStorageSync('token', token)
  }
})
```

**æ¶‰åŠå‡½æ•°**ï¼š
- `handleLogin()` - ç™»å½•
- `ensureUserId()` - ç¡®ä¿ç”¨æˆ·IDå­˜åœ¨

---

### 4.2 è®¢å•æ¨¡å—

**æ–‡ä»¶**: `utils/order-helper.js`

```javascript
// å½“å‰ï¼ˆæœ¬åœ°Storageï¼‰
getAllOrders() {
  const pending = wx.getStorageSync('pending_orders') || []
  const completed = wx.getStorageSync('completed_orders') || []
  return [...pending, ...completed]
}

// æ›¿æ¢ä¸ºï¼ˆè°ƒç”¨åç«¯ï¼‰
async getAllOrders() {
  const response = await api.get('/orders')
  return response.data.orders
}
```

**éœ€è¦æ›¿æ¢çš„æ–‡ä»¶**ï¼š
- `pages/order-success/index.js` - åˆ›å»ºè®¢å•
- `pages/order-detail/index.js` - è®¢å•è¯¦æƒ…ã€ç¡®è®¤ã€é€€æ¬¾
- `pages/order-list/index.js` - è®¢å•åˆ—è¡¨
- `pages/admin/index.js` - ç®¡ç†åå°è®¢å•
- `pages/service-workspace/index.js` - å®¢æœå·¥ä½œå°
- `pages/workspace/index.js` - ç”»å¸ˆå·¥ä½œå°

**å…³é”®API**ï¼š
```javascript
// è®¢å•CRUD
api.createOrder(orderData)        // åˆ›å»ºè®¢å•
api.getOrderById(orderId)         // è·å–è®¢å•è¯¦æƒ…
api.updateOrderStatus(orderId, status)  // æ›´æ–°è®¢å•çŠ¶æ€
api.getOrderList(filters)         // è·å–è®¢å•åˆ—è¡¨
api.completeOrder(orderId)        // å®Œæˆè®¢å•
api.refundOrder(orderId, reason)  // é€€æ¬¾
```

---

### 4.3 å•†å“æ¨¡å—

**æ–‡ä»¶**: `pages/product-edit/index.js`

```javascript
// å½“å‰ï¼ˆæœ¬åœ°Storageï¼‰
saveProduct() {
  const products = wx.getStorageSync('mock_products') || []
  products.push(this.data.product)
  wx.setStorageSync('mock_products', products)
}

// æ›¿æ¢ä¸ºï¼ˆè°ƒç”¨åç«¯ï¼‰
async saveProduct() {
  const response = await api.createProduct(this.data.product)
  wx.showToast({ title: 'å•†å“å·²å‘å¸ƒ' })
}
```

**éœ€è¦æ›¿æ¢çš„æ–‡ä»¶**ï¼š
- `pages/product-edit/index.js` - åˆ›å»º/ç¼–è¾‘å•†å“
- `pages/home/index.js` - å•†å“åˆ—è¡¨
- `pages/product-detail/index.js` - å•†å“è¯¦æƒ…
- `pages/admin/index.js` - ç®¡ç†åå°å•†å“ç®¡ç†

**å…³é”®API**ï¼š
```javascript
api.createProduct(productData)     // åˆ›å»ºå•†å“
api.updateProduct(productId, data) // æ›´æ–°å•†å“
api.getProductById(productId)      // è·å–å•†å“è¯¦æƒ…
api.getProductList(filters)        // è·å–å•†å“åˆ—è¡¨
api.deleteProduct(productId)       // åˆ é™¤å•†å“
api.updateStock(productId, quantity)  // æ›´æ–°åº“å­˜
```

---

### 4.4 ç”»å¸ˆç”³è¯·æ¨¡å—

**æ–‡ä»¶**: `pages/apply/index.js`

```javascript
// å½“å‰ï¼ˆæœ¬åœ°Storageï¼‰
submitApplication() {
  const applications = wx.getStorageSync('artist_applications') || []
  applications.push(applicationData)
  wx.setStorageSync('artist_applications', applications)
}

// æ›¿æ¢ä¸ºï¼ˆè°ƒç”¨åç«¯ï¼‰
async submitApplication() {
  const response = await api.submitArtistApplication(applicationData)
  wx.showToast({ title: 'ç”³è¯·å·²æäº¤' })
}
```

**éœ€è¦æ›¿æ¢çš„æ–‡ä»¶**ï¼š
- `pages/apply/index.js` - æäº¤ç”³è¯·
- `pages/review-manage/index.js` - ç”³è¯·å®¡æ ¸
- `pages/artist-application-detail/index.js` - ç”³è¯·è¯¦æƒ…

**å…³é”®API**ï¼š
```javascript
api.submitArtistApplication(data)  // æäº¤ç”³è¯·
api.getApplicationList(filters)    // è·å–ç”³è¯·åˆ—è¡¨
api.approveApplication(appId, artistNumber)  // å®¡æ ¸é€šè¿‡ï¼ˆåˆ†é…ç¼–å·ï¼‰
api.rejectApplication(appId, reason)  // å®¡æ ¸æ‹’ç»
```

---

### 4.5 è´¢åŠ¡æ¨¡å—

**æ–‡ä»¶**: `utils/service-income.js`, `utils/staff-finance.js`

```javascript
// å½“å‰ï¼ˆæœ¬åœ°Storageï¼‰
recordIncome(userId, orderId, amount) {
  const ledger = wx.getStorageSync('service_income_ledger') || []
  ledger.push({ userId, orderId, amount, createTime: now() })
  wx.setStorageSync('service_income_ledger', ledger)
}

// æ›¿æ¢ä¸ºï¼ˆè°ƒç”¨åç«¯ï¼‰
async recordIncome(userId, orderId, amount) {
  await api.createIncomeRecord({ userId, orderId, amount })
}
```

**éœ€è¦æ›¿æ¢çš„æ–‡ä»¶**ï¼š
- `pages/income-detail/index.js` - æ”¶å…¥æ˜ç»†
- `pages/withdraw/index.js` - æç°ç”³è¯·
- `pages/withdraw-records/index.js` - æç°è®°å½•
- `pages/reward-records/index.js` - æ‰“èµè®°å½•

**å…³é”®API**ï¼š
```javascript
api.getIncomeList(userId, filters)  // è·å–æ”¶å…¥åˆ—è¡¨
api.getBalance(userId)              // è·å–ä½™é¢
api.submitWithdraw(data)            // æäº¤æç°
api.getWithdrawList(userId)         // è·å–æç°è®°å½•
api.createReward(data)              // åˆ›å»ºæ‰“èµ
```

---

## 5. è¿ç§»ç­–ç•¥å»ºè®®

### 5.1 æ¸è¿›å¼è¿ç§»ï¼ˆæ¨èï¼‰

**é˜¶æ®µ1ï¼šåŒå†™æ¨¡å¼**ï¼ˆ2-3å¤©ï¼‰
```javascript
// åŒæ—¶å†™å…¥æœ¬åœ°Storageå’Œåç«¯API
async createOrder(orderData) {
  // 1. å†™å…¥æœ¬åœ°ï¼ˆä¿è¯ç°æœ‰åŠŸèƒ½ï¼‰
  saveToLocalStorage(orderData)
  
  try {
    // 2. å†™å…¥åç«¯ï¼ˆæ–°å¢ï¼‰
    await api.createOrder(orderData)
  } catch (error) {
    console.warn('åç«¯å†™å…¥å¤±è´¥ï¼Œä»…ä½¿ç”¨æœ¬åœ°æ•°æ®', error)
  }
}
```

**é˜¶æ®µ2ï¼šåŒè¯»æ¨¡å¼**ï¼ˆ3-5å¤©ï¼‰
```javascript
// ä¼˜å…ˆè¯»å–åç«¯ï¼Œé™çº§åˆ°æœ¬åœ°
async getAllOrders() {
  try {
    // 1. å°è¯•ä»åç«¯è¯»å–
    const response = await api.getOrderList()
    return response.data.orders
  } catch (error) {
    console.warn('åç«¯è¯»å–å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°', error)
    // 2. é™çº§åˆ°æœ¬åœ°Storage
    return getFromLocalStorage()
  }
}
```

**é˜¶æ®µ3ï¼šçº¯åç«¯æ¨¡å¼**ï¼ˆç¨³å®šåï¼‰
```javascript
// å®Œå…¨ä½¿ç”¨åç«¯API
async getAllOrders() {
  const response = await api.getOrderList()
  return response.data.orders
}
```

---

### 5.2 æ•°æ®è¿ç§»è„šæœ¬

**ç”¨æˆ·æ•°æ®è¿ç§»**ï¼š
```javascript
// ä¸€æ¬¡æ€§è„šæœ¬ï¼šè¿ç§»æœ¬åœ°ç”¨æˆ·åˆ°åç«¯
async function migrateUsers() {
  const users = wx.getStorageSync('users') || []
  
  for (const user of users) {
    try {
      await api.createUser(user)
      console.log(`âœ… ç”¨æˆ· ${user.userId} å·²è¿ç§»`)
    } catch (error) {
      console.error(`âŒ ç”¨æˆ· ${user.userId} è¿ç§»å¤±è´¥`, error)
    }
  }
}
```

**è®¢å•æ•°æ®è¿ç§»**ï¼š
```javascript
async function migrateOrders() {
  const pending = wx.getStorageSync('pending_orders') || []
  const completed = wx.getStorageSync('completed_orders') || []
  const allOrders = [...pending, ...completed]
  
  for (const order of allOrders) {
    try {
      await api.createOrder(order)
      console.log(`âœ… è®¢å• ${order.id} å·²è¿ç§»`)
    } catch (error) {
      console.error(`âŒ è®¢å• ${order.id} è¿ç§»å¤±è´¥`, error)
    }
  }
}
```

---

### 5.3 APIå°è£…å±‚è®¾è®¡

**åˆ›å»ºç»Ÿä¸€APIæœåŠ¡**ï¼š

```javascript
// utils/api.js
const BASE_URL = 'https://your-api.com'

class ApiService {
  constructor() {
    this.baseURL = BASE_URL
  }
  
  // ç»Ÿä¸€è¯·æ±‚æ–¹æ³•
  async request(method, url, data = {}, options = {}) {
    const token = wx.getStorageSync('token')
    
    return new Promise((resolve, reject) => {
      wx.request({
        url: `${this.baseURL}${url}`,
        method,
        data,
        header: {
          'Content-Type': 'application/json',
          'Authorization': token ? `Bearer ${token}` : '',
          ...options.headers
        },
        success: (res) => {
          if (res.statusCode === 200) {
            resolve(res.data)
          } else {
            reject(new Error(res.data.message || 'è¯·æ±‚å¤±è´¥'))
          }
        },
        fail: reject
      })
    })
  }
  
  // ä¾¿æ·æ–¹æ³•
  get(url, params) {
    return this.request('GET', url, params)
  }
  
  post(url, data) {
    return this.request('POST', url, data)
  }
  
  put(url, data) {
    return this.request('PUT', url, data)
  }
  
  delete(url, params) {
    return this.request('DELETE', url, params)
  }
  
  // ========== ç”¨æˆ·æ¨¡å— ==========
  
  login(code) {
    return this.post('/auth/login', { code })
  }
  
  getUserInfo(userId) {
    return this.get(`/users/${userId}`)
  }
  
  updateUserInfo(userId, data) {
    return this.put(`/users/${userId}`, data)
  }
  
  // ========== è®¢å•æ¨¡å— ==========
  
  createOrder(orderData) {
    return this.post('/orders', orderData)
  }
  
  getOrderById(orderId) {
    return this.get(`/orders/${orderId}`)
  }
  
  getOrderList(filters = {}) {
    return this.get('/orders', filters)
  }
  
  updateOrderStatus(orderId, status) {
    return this.put(`/orders/${orderId}/status`, { status })
  }
  
  completeOrder(orderId) {
    return this.post(`/orders/${orderId}/complete`)
  }
  
  refundOrder(orderId, reason) {
    return this.post(`/orders/${orderId}/refund`, { reason })
  }
  
  // ========== å•†å“æ¨¡å— ==========
  
  createProduct(productData) {
    return this.post('/products', productData)
  }
  
  getProductById(productId) {
    return this.get(`/products/${productId}`)
  }
  
  getProductList(filters = {}) {
    return this.get('/products', filters)
  }
  
  updateProduct(productId, data) {
    return this.put(`/products/${productId}`, data)
  }
  
  updateStock(productId, quantity) {
    return this.put(`/products/${productId}/stock`, { quantity })
  }
  
  // ========== ç”»å¸ˆç”³è¯· ==========
  
  submitArtistApplication(data) {
    return this.post('/artists/apply', data)
  }
  
  getApplicationList(filters = {}) {
    return this.get('/artists/applications', filters)
  }
  
  approveApplication(appId, artistNumber) {
    return this.post(`/artists/applications/${appId}/approve`, { artistNumber })
  }
  
  rejectApplication(appId, reason) {
    return this.post(`/artists/applications/${appId}/reject`, { reason })
  }
  
  // ========== è´¢åŠ¡æ¨¡å— ==========
  
  getIncomeList(userId, filters = {}) {
    return this.get(`/income/${userId}`, filters)
  }
  
  getBalance(userId) {
    return this.get(`/income/${userId}/balance`)
  }
  
  submitWithdraw(data) {
    return this.post('/withdraw', data)
  }
  
  createReward(data) {
    return this.post('/rewards', data)
  }
}

export default new ApiService()
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// pages/order-success/index.js
import api from '../../utils/api'

async saveOrderToServer() {
  try {
    const response = await api.createOrder(this.data.orderInfo)
    console.log('âœ… è®¢å•å·²ä¿å­˜åˆ°æœåŠ¡å™¨', response)
  } catch (error) {
    console.error('âŒ è®¢å•ä¿å­˜å¤±è´¥', error)
    wx.showToast({ title: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', icon: 'none' })
  }
}
```

---

### 5.4 ç¯å¢ƒé…ç½®

**åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š

```javascript
// config/env.js
const ENV = {
  // å¼€å‘ç¯å¢ƒ
  dev: {
    apiBaseUrl: 'http://localhost:3000',
    imageBaseUrl: 'http://localhost:3000/images',
    useMockData: true  // å¼€å‘æ—¶ä½¿ç”¨mockæ•°æ®
  },
  
  // ç”Ÿäº§ç¯å¢ƒ
  prod: {
    apiBaseUrl: 'https://api.yourdomain.com',
    imageBaseUrl: 'https://cdn.yourdomain.com/images',
    useMockData: false  // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®åç«¯
  }
}

// æ ¹æ®ç¼–è¯‘ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©
const currentEnv = process.env.NODE_ENV === 'production' ? 'prod' : 'dev'

module.exports = ENV[currentEnv]
```

**æ¡ä»¶æ¸²æŸ“**ï¼š
```javascript
import config from '../../config/env'

async getAllOrders() {
  if (config.useMockData) {
    // ä½¿ç”¨æœ¬åœ°mockæ•°æ®
    return wx.getStorageSync('pending_orders') || []
  } else {
    // ä½¿ç”¨çœŸå®åç«¯
    const response = await api.getOrderList()
    return response.data.orders
  }
}
```

---

## 6. å…³é”®æ³¨æ„äº‹é¡¹

### 6.1 å®‰å…¨é—®é¢˜

**1. Tokenç®¡ç†**ï¼š
```javascript
// ç™»å½•æ—¶ä¿å­˜token
wx.setStorageSync('token', token)

// è¯·æ±‚æ—¶æºå¸¦token
wx.request({
  header: {
    'Authorization': `Bearer ${wx.getStorageSync('token')}`
  }
})

// Tokenè¿‡æœŸå¤„ç†
if (res.statusCode === 401) {
  wx.removeStorageSync('token')
  wx.navigateTo({ url: '/pages/login/index' })
}
```

**2. æ•æ„Ÿæ•°æ®åŠ å¯†**ï¼š
- ç”¨æˆ·æ‰‹æœºå·
- é“¶è¡Œå¡å·
- æ”¯ä»˜å¯†ç 

**3. æƒé™éªŒè¯**ï¼š
```javascript
// åç«¯å¿…é¡»éªŒè¯ç”¨æˆ·æƒé™
if (!hasPermission(userId, 'admin')) {
  return { code: 403, message: 'æ— æƒé™' }
}
```

---

### 6.2 æ€§èƒ½ä¼˜åŒ–

**1. åˆ†é¡µåŠ è½½**ï¼š
```javascript
// è®¢å•åˆ—è¡¨åˆ†é¡µ
async loadOrders(page = 1, pageSize = 20) {
  const response = await api.getOrderList({
    page,
    pageSize,
    filters: this.data.filters
  })
  
  this.setData({
    orders: page === 1 ? response.data : [...this.data.orders, ...response.data],
    hasMore: response.hasMore
  })
}
```

**2. ç¼“å­˜ç­–ç•¥**ï¼š
```javascript
// å•†å“åˆ—è¡¨ç¼“å­˜5åˆ†é’Ÿ
async getProductList() {
  const cacheKey = 'product_list_cache'
  const cached = wx.getStorageSync(cacheKey)
  
  if (cached && Date.now() - cached.timestamp < 5 * 60 * 1000) {
    return cached.data
  }
  
  const response = await api.getProductList()
  wx.setStorageSync(cacheKey, {
    data: response.data,
    timestamp: Date.now()
  })
  
  return response.data
}
```

**3. å›¾ç‰‡ä¼˜åŒ–**ï¼š
- ä½¿ç”¨CDNåŠ é€Ÿ
- å›¾ç‰‡æ‡’åŠ è½½
- ç¼©ç•¥å›¾ + åŸå›¾åˆ†ç¦»

---

### 6.3 æ•°æ®ä¸€è‡´æ€§

**1. ä¹è§‚é”ï¼ˆè®¢å•çŠ¶æ€æ›´æ–°ï¼‰**ï¼š
```javascript
// å‰ç«¯
await api.updateOrderStatus(orderId, newStatus, currentVersion)

// åç«¯
UPDATE orders 
SET status = ?, version = version + 1 
WHERE id = ? AND version = ?
```

**2. åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆè®¢å•å®Œæˆ+åˆ†æˆï¼‰**ï¼š
```javascript
// åç«¯ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
BEGIN TRANSACTION;

-- 1. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE orders SET status = 'completed' WHERE id = ?;

-- 2. è®°å½•å®¢æœåˆ†æˆ
INSERT INTO income_ledger (user_id, order_id, amount) VALUES (?, ?, ?);

-- 3. è®°å½•ç®¡ç†å‘˜åˆ†æˆ
INSERT INTO income_ledger (user_id, order_id, amount) VALUES (?, ?, ?);

COMMIT;
```

---

### 6.4 é”™è¯¯å¤„ç†

**ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼š
```javascript
// utils/api.js
async request(method, url, data) {
  try {
    const response = await wx.request(...)
    
    // ä¸šåŠ¡é”™è¯¯
    if (response.data.code !== 0) {
      throw new Error(response.data.message)
    }
    
    return response.data
    
  } catch (error) {
    // ç½‘ç»œé”™è¯¯
    console.error('APIè¯·æ±‚å¤±è´¥', error)
    
    // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
    wx.showToast({
      title: error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
      icon: 'none'
    })
    
    throw error
  }
}
```

**é”™è¯¯ç è§„èŒƒ**ï¼š
```javascript
// åç«¯é”™è¯¯ç è®¾è®¡
{
  "code": 0,        // 0=æˆåŠŸ
  "message": "OK",
  "data": {}
}

// é”™è¯¯æƒ…å†µ
{
  "code": 1001,     // ä¸šåŠ¡é”™è¯¯ç 
  "message": "è®¢å•ä¸å­˜åœ¨",
  "data": null
}

// å¸¸è§é”™è¯¯ç 
1001 - è®¢å•ä¸å­˜åœ¨
1002 - åº“å­˜ä¸è¶³
1003 - æƒé™ä¸è¶³
2001 - å‚æ•°é”™è¯¯
3001 - ç”¨æˆ·æœªç™»å½•
3002 - Tokenè¿‡æœŸ
```

---

### 6.5 æ—¥å¿—ç›‘æ§

**å‰ç«¯æ—¥å¿—ä¸ŠæŠ¥**ï¼š
```javascript
// utils/logger.js
function logError(message, error, context = {}) {
  // 1. æ§åˆ¶å°è¾“å‡º
  console.error(message, error, context)
  
  // 2. ä¸ŠæŠ¥åˆ°åç«¯
  api.post('/logs/error', {
    message,
    error: error.message,
    stack: error.stack,
    context,
    timestamp: new Date().toISOString(),
    userId: wx.getStorageSync('userId')
  }).catch(() => {
    // ä¸ŠæŠ¥å¤±è´¥ä¹Ÿä¸è¦å½±å“ä¸»æµç¨‹
  })
}
```

**å…³é”®èŠ‚ç‚¹åŸ‹ç‚¹**ï¼š
```javascript
// è®¢å•åˆ›å»ºåŸ‹ç‚¹
logEvent('order_created', {
  orderId: order.id,
  productId: order.productId,
  amount: order.totalAmount,
  userId: order.buyerId
})

// æ”¯ä»˜æˆåŠŸåŸ‹ç‚¹
logEvent('payment_success', {
  orderId: order.id,
  amount: order.totalAmount
})
```

---

## 7. æµ‹è¯•å»ºè®®

### 7.1 æ¥å£æµ‹è¯•æ¸…å•

**ç”¨æˆ·æ¨¡å—**ï¼š
- [ ] ç™»å½•æ¥å£
- [ ] è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**è®¢å•æ¨¡å—**ï¼š
- [ ] åˆ›å»ºè®¢å•
- [ ] è·å–è®¢å•åˆ—è¡¨ï¼ˆæŒ‰çŠ¶æ€ç­›é€‰ï¼‰
- [ ] è·å–è®¢å•è¯¦æƒ…
- [ ] æ›´æ–°è®¢å•çŠ¶æ€
- [ ] å®Œæˆè®¢å•ï¼ˆè§¦å‘åˆ†æˆï¼‰
- [ ] ç”³è¯·é€€æ¬¾
- [ ] ç¡®è®¤é€€æ¬¾

**å•†å“æ¨¡å—**ï¼š
- [ ] åˆ›å»ºå•†å“
- [ ] è·å–å•†å“åˆ—è¡¨ï¼ˆæŒ‰åˆ†ç±»ç­›é€‰ï¼‰
- [ ] è·å–å•†å“è¯¦æƒ…
- [ ] æ›´æ–°å•†å“
- [ ] åˆ é™¤å•†å“
- [ ] æ›´æ–°åº“å­˜

**ç”»å¸ˆç”³è¯·**ï¼š
- [ ] æäº¤ç”³è¯·
- [ ] è·å–ç”³è¯·åˆ—è¡¨
- [ ] å®¡æ ¸é€šè¿‡ï¼ˆåˆ†é…ç¼–å·ï¼‰
- [ ] å®¡æ ¸æ‹’ç»

---

### 7.2 å‹åŠ›æµ‹è¯•

**å¹¶å‘è®¢å•åˆ›å»º**ï¼š
```javascript
// æ¨¡æ‹Ÿ100ä¸ªç”¨æˆ·åŒæ—¶ä¸‹å•åŒä¸€å•†å“
async function stressTest() {
  const promises = []
  for (let i = 0; i < 100; i++) {
    promises.push(api.createOrder({
      productId: 'product_001',
      quantity: 1
    }))
  }
  
  const results = await Promise.all(promises)
  console.log('æˆåŠŸ:', results.filter(r => r.code === 0).length)
  console.log('å¤±è´¥:', results.filter(r => r.code !== 0).length)
}
```

**åº“å­˜ä¸€è‡´æ€§æµ‹è¯•**ï¼š
- 10ä¸ªå¹¶å‘ä¸‹å•åŒä¸€å•†å“ï¼ˆåº“å­˜=5ï¼‰
- é¢„æœŸï¼š5ä¸ªæˆåŠŸï¼Œ5ä¸ªæç¤ºåº“å­˜ä¸è¶³

---

## 8. å¸¸è§é—®é¢˜FAQ

### Q1: æœ¬åœ°Storageæ•°æ®å¦‚ä½•æ¸…ç†ï¼Ÿ

**A**: å¯ä»¥åœ¨åç«¯å®Œå…¨è¿ç§»åï¼Œä¸€æ¬¡æ€§æ¸…ç†ï¼š

```javascript
// æ¸…ç†è„šæœ¬
function clearLocalData() {
  wx.removeStorageSync('pending_orders')
  wx.removeStorageSync('completed_orders')
  wx.removeStorageSync('mock_orders')
  wx.removeStorageSync('mock_products')
  wx.removeStorageSync('artist_applications')
  
  console.log('âœ… æœ¬åœ°æ•°æ®å·²æ¸…ç†')
}
```

ä½†å»ºè®®ä¿ç•™ä¸€æ®µæ—¶é—´ä½œä¸ºé™çº§æ–¹æ¡ˆã€‚

---

### Q2: ç”»å¸ˆç¼–å·å¦‚ä½•ä¿è¯å”¯ä¸€ï¼Ÿ

**A**: åç«¯ä½¿ç”¨æ•°æ®åº“è‡ªå¢ID + æ ¼å¼åŒ–ï¼š

```sql
-- åˆ›å»ºç”»å¸ˆè¡¨
CREATE TABLE artists (
  id INT PRIMARY KEY AUTO_INCREMENT,  -- 1, 2, 3...
  artist_number VARCHAR(10) UNIQUE,   -- 001, 002, 003...ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
  user_id VARCHAR(20),
  ...
);

-- ç”Ÿæˆç¼–å·ï¼ˆåç«¯é€»è¾‘ï¼‰
artistNumber = String(id).padStart(3, '0')  // 001, 002, 003
```

---

### Q3: å›¾ç‰‡å¦‚ä½•ä¸Šä¼ ï¼Ÿ

**A**: æ¨èä½¿ç”¨äº‘å­˜å‚¨ï¼ˆå¦‚ä¸ƒç‰›äº‘ã€é˜¿é‡Œäº‘OSSï¼‰ï¼š

```javascript
// å‰ç«¯ä¸Šä¼ å›¾ç‰‡
async function uploadImage(filePath) {
  // 1. è·å–ä¸Šä¼ å‡­è¯
  const { token } = await api.getUploadToken()
  
  // 2. ä¸Šä¼ åˆ°äº‘å­˜å‚¨
  return new Promise((resolve, reject) => {
    wx.uploadFile({
      url: 'https://upload.qiniup.com',
      filePath,
      name: 'file',
      formData: { token },
      success: (res) => {
        const data = JSON.parse(res.data)
        resolve(data.url)  // è¿”å›å›¾ç‰‡URL
      },
      fail: reject
    })
  })
}

// ä½¿ç”¨
const imageUrl = await uploadImage(tempFilePath)
orderData.productImage = imageUrl  // å­˜å‚¨URLè€Œébase64
```

---

### Q4: å¦‚ä½•å¤„ç†ç½‘ç»œå¼‚å¸¸ï¼Ÿ

**A**: ä½¿ç”¨é‡è¯•æœºåˆ¶ + é™çº§æ–¹æ¡ˆï¼š

```javascript
async function requestWithRetry(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn()
    } catch (error) {
      console.warn(`è¯·æ±‚å¤±è´¥ï¼Œç¬¬${i + 1}æ¬¡é‡è¯•`, error)
      
      if (i === maxRetries - 1) {
        // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°
        return getFromLocalStorage()
      }
      
      // ç­‰å¾…åé‡è¯•
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)))
    }
  }
}

// ä½¿ç”¨
const orders = await requestWithRetry(() => api.getOrderList())
```

---

## 10. æ•°æ®åº“æ˜ å°„è¡¨ï¼ˆâš ï¸ åç«¯å¿…è¯»ï¼‰

### 10.1 è¡¨ç»“æ„è®¾è®¡

#### **users è¡¨**ï¼ˆç”¨æˆ·ä¸»è¡¨ï¼‰

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id VARCHAR(20) UNIQUE NOT NULL,       -- ç”¨æˆ·IDï¼ˆ1001èµ·ï¼‰
  openid VARCHAR(100) UNIQUE,                -- å¾®ä¿¡OpenID
  nickname VARCHAR(100),                      -- æ˜µç§°
  avatar_url TEXT,                            -- å¤´åƒURL
  phone VARCHAR(20),                          -- æ‰‹æœºå·
  member_level VARCHAR(20) DEFAULT 'æ™®é€šä¼šå‘˜',
  member_expire_time DATETIME,                -- ä¼šå‘˜è¿‡æœŸæ—¶é—´
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_user_id (user_id),
  INDEX idx_openid (openid)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### **user_roles è¡¨**ï¼ˆç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼‰

```sql
CREATE TABLE user_roles (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id VARCHAR(20) NOT NULL,              -- å…³è”users.user_id
  role VARCHAR(20) NOT NULL,                 -- customer | artist | service | admin
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_user_role (user_id, role),
  INDEX idx_user_id (user_id),
  INDEX idx_role (role),
  
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### **artists è¡¨**ï¼ˆç”»å¸ˆé¢å¤–ä¿¡æ¯ï¼‰

```sql
CREATE TABLE artists (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id VARCHAR(20) UNIQUE NOT NULL,       -- å…³è”users.user_id
  artist_number VARCHAR(10) UNIQUE NOT NULL, -- ç”»å¸ˆç¼–å·ï¼ˆ001èµ·ï¼‰âš ï¸
  status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
  
  -- ç”³è¯·ä¿¡æ¯
  real_name VARCHAR(50),
  age INT,
  wechat VARCHAR(50),
  ideal_price DECIMAL(10,2),
  min_price DECIMAL(10,2),
  finished_works JSON,                       -- å®Œæˆä½œå“å›¾ç‰‡æ•°ç»„
  process_images JSON,                       -- åˆ›ä½œè¿‡ç¨‹å›¾ç‰‡æ•°ç»„
  
  -- å®¡æ ¸ä¿¡æ¯
  submit_time DATETIME,
  review_time DATETIME,
  review_note TEXT,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_user_id (user_id),
  INDEX idx_artist_number (artist_number),
  INDEX idx_status (status),
  
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### **products è¡¨**ï¼ˆå•†å“è¡¨ï¼‰

```sql
CREATE TABLE products (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_id VARCHAR(50) UNIQUE NOT NULL,    -- å•†å“ID
  name VARCHAR(200) NOT NULL,
  description TEXT,
  images JSON,                               -- å•†å“å›¾ç‰‡æ•°ç»„
  description_images JSON,                   -- æè¿°å›¾ç‰‡æ•°ç»„
  
  -- ä»·æ ¼ï¼ˆå•è§„æ ¼ï¼‰
  price DECIMAL(10,2),
  original_price DECIMAL(10,2),
  
  -- ä»·æ ¼ï¼ˆå¤šè§„æ ¼ï¼‰
  has_pricing BOOLEAN DEFAULT FALSE,
  pricing_method VARCHAR(20),                -- combined | separate
  spec1_name VARCHAR(50),
  spec1_values JSON,
  spec2_name VARCHAR(50),
  spec2_values JSON,
  pricing JSON,                              -- ä»·æ ¼çŸ©é˜µ
  
  -- åº“å­˜
  stock INT DEFAULT 0,
  sales INT DEFAULT 0,
  
  -- åˆ†ç±»
  category_id VARCHAR(50),
  category_name VARCHAR(100),
  
  -- ç”»å¸ˆä¿¡æ¯
  artist_user_id VARCHAR(20),                -- å…³è”users.user_id
  artist_name VARCHAR(100),
  artist_number VARCHAR(10),                 -- ç”»å¸ˆç¼–å·âš ï¸
  
  delivery_days INT DEFAULT 7,
  status ENUM('active', 'inactive') DEFAULT 'active',
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_product_id (product_id),
  INDEX idx_artist_user_id (artist_user_id),
  INDEX idx_category_id (category_id),
  INDEX idx_status (status),
  
  FOREIGN KEY (artist_user_id) REFERENCES users(user_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### **orders è¡¨**ï¼ˆè®¢å•è¡¨ï¼‰âš ï¸ æ ¸å¿ƒè¡¨

```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id VARCHAR(50) UNIQUE NOT NULL,      -- è®¢å•å·
  order_number VARCHAR(50),                  -- è®¢å•ç¼–å·ï¼ˆå¤‡ç”¨ï¼‰
  
  -- å•†å“ä¿¡æ¯
  product_id VARCHAR(50),
  product_name VARCHAR(200),
  product_image TEXT,
  spec VARCHAR(100),                         -- è§„æ ¼ç»„åˆï¼ˆæ˜¾ç¤ºç”¨ï¼‰
  specs JSON,                                -- è§„æ ¼è¯¦æƒ…
  quantity INT DEFAULT 1,
  price DECIMAL(10,2),                       -- å•ä»·
  total_amount DECIMAL(10,2),                -- æ€»é‡‘é¢
  
  -- æ—¶é—´ä¿¡æ¯
  create_time DATETIME NOT NULL,             -- ä¸‹å•æ—¶é—´âš ï¸
  start_date DATETIME,                       -- å¼€å§‹æ—¶é—´ï¼ˆå¤‡ç”¨ï¼‰
  created_at DATETIME,                       -- åˆ›å»ºæ—¶é—´ï¼ˆå¤‡ç”¨ï¼‰
  deadline DATETIME NOT NULL,                -- æˆªç¨¿æ—¶é—´âš ï¸
  completed_at DATETIME,                     -- å®Œæˆæ—¶é—´
  delivery_days INT DEFAULT 7,
  
  -- ç”¨æˆ·ä¿¡æ¯
  buyer_id VARCHAR(20) NOT NULL,             -- ä¹°å®¶ID
  buyer_name VARCHAR(100),
  buyer_avatar TEXT,
  buyer_phone VARCHAR(20),
  buyer_openid VARCHAR(100),
  
  -- ç”»å¸ˆä¿¡æ¯
  artist_id VARCHAR(20) NOT NULL,            -- ç”»å¸ˆç”¨æˆ·ID
  artist_name VARCHAR(100),
  artist_avatar TEXT,
  artist_number VARCHAR(10),                 -- ç”»å¸ˆç¼–å·âš ï¸
  
  -- å®¢æœä¿¡æ¯
  service_id VARCHAR(20),
  service_name VARCHAR(100),
  service_avatar TEXT,
  service_qrcode_url TEXT,
  service_status VARCHAR(20),                -- assigned | pending
  needs_service BOOLEAN DEFAULT FALSE,
  
  -- è®¢å•çŠ¶æ€ï¼ˆâš ï¸ æ ¸å¿ƒå­—æ®µï¼‰
  status VARCHAR(20) NOT NULL,               -- unpaid, paid, inProgress, completed, refunded...
  status_text VARCHAR(50),
  refund_status VARCHAR(20),                 -- refunding | refunded
  
  -- è¿›åº¦ç›¸å…³
  was_overdue BOOLEAN DEFAULT FALSE,
  overdue_days INT DEFAULT 0,
  
  -- ç¾¤èŠä¿¡æ¯
  group_name VARCHAR(200),
  
  -- å…¶ä»–
  urgent BOOLEAN DEFAULT FALSE,
  items JSON,                                -- å¤šå•†å“è®¢å•
  
  -- ç‰ˆæœ¬æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰
  version INT DEFAULT 1,
  
  created_at_db DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_order_id (order_id),
  INDEX idx_buyer_id (buyer_id),
  INDEX idx_artist_id (artist_id),
  INDEX idx_service_id (service_id),
  INDEX idx_status (status),                 -- âš ï¸ é‡è¦ç´¢å¼•
  INDEX idx_create_time (create_time),       -- âš ï¸ é‡è¦ç´¢å¼•
  INDEX idx_deadline (deadline),             -- âš ï¸ é‡è¦ç´¢å¼•
  
  FOREIGN KEY (buyer_id) REFERENCES users(user_id) ON DELETE RESTRICT,
  FOREIGN KEY (artist_id) REFERENCES users(user_id) ON DELETE RESTRICT,
  FOREIGN KEY (service_id) REFERENCES users(user_id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### **income_ledger è¡¨**ï¼ˆæ”¶å…¥è´¦æœ¬ï¼‰

```sql
CREATE TABLE income_ledger (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  ledger_id VARCHAR(50) UNIQUE NOT NULL,
  
  user_id VARCHAR(20) NOT NULL,              -- æ”¶å…¥æ‰€å±äºº
  order_id VARCHAR(50),                      -- å…³è”è®¢å•
  income_type VARCHAR(20) NOT NULL,          -- service | admin_share | reward
  amount DECIMAL(10,2) NOT NULL,
  order_amount DECIMAL(10,2),
  note TEXT,
  
  create_time DATETIME NOT NULL,
  order_completed_at DATETIME,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_user_id (user_id),
  INDEX idx_order_id (order_id),
  INDEX idx_income_type (income_type),
  INDEX idx_create_time (create_time),       -- âš ï¸ é‡è¦ç´¢å¼•
  
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
  FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### **withdraw_records è¡¨**ï¼ˆæç°è®°å½•ï¼‰

```sql
CREATE TABLE withdraw_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  withdraw_id VARCHAR(50) UNIQUE NOT NULL,
  
  user_id VARCHAR(20) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  bank_name VARCHAR(50),
  bank_card VARCHAR(50),
  real_name VARCHAR(50),
  
  status ENUM('pending', 'processing', 'completed', 'rejected') DEFAULT 'pending',
  time DATETIME NOT NULL,
  completed_time DATETIME,
  note TEXT,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_time (time),
  
  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 10.2 å…³è”å…³ç³»å›¾

```
users (ç”¨æˆ·ä¸»è¡¨)
  â”œâ”€ 1:N â†’ user_roles (ç”¨æˆ·è§’è‰²)
  â”œâ”€ 1:1 â†’ artists (ç”»å¸ˆä¿¡æ¯)
  â”œâ”€ 1:N â†’ products (åˆ›å»ºçš„å•†å“)
  â”œâ”€ 1:N â†’ orders (ä½œä¸ºä¹°å®¶)
  â”œâ”€ 1:N â†’ orders (ä½œä¸ºç”»å¸ˆ)
  â”œâ”€ 1:N â†’ orders (ä½œä¸ºå®¢æœ)
  â”œâ”€ 1:N â†’ income_ledger (æ”¶å…¥è®°å½•)
  â””â”€ 1:N â†’ withdraw_records (æç°è®°å½•)

orders (è®¢å•è¡¨)
  â”œâ”€ N:1 â†’ users (ä¹°å®¶)
  â”œâ”€ N:1 â†’ users (ç”»å¸ˆ)
  â”œâ”€ N:1 â†’ users (å®¢æœï¼Œå¯é€‰)
  â”œâ”€ N:1 â†’ products (å•†å“)
  â””â”€ 1:N â†’ income_ledger (äº§ç”Ÿçš„åˆ†æˆ)
```

---

### 10.3 MongoDB é›†åˆæ˜ å°„ï¼ˆå¦‚ä½¿ç”¨MongoDBï¼‰

```javascript
// users é›†åˆ
{
  _id: ObjectId,
  userId: "1001",              // ç´¢å¼•
  openid: "openid-xxx",        // ç´¢å¼•
  nickname: String,
  avatarUrl: String,
  phone: String,
  roles: ["customer", "artist"],  // è§’è‰²æ•°ç»„
  memberLevel: String,
  memberExpireTime: ISODate,
  createdAt: ISODate,
  updatedAt: ISODate
}

// artists é›†åˆ
{
  _id: ObjectId,
  userId: "1002",              // ç´¢å¼•ï¼Œå”¯ä¸€
  artistNumber: "001",         // ç´¢å¼•ï¼Œå”¯ä¸€
  status: "approved",
  realName: String,
  age: Number,
  // ... å…¶ä»–å­—æ®µ
  submitTime: ISODate,
  reviewTime: ISODate
}

// orders é›†åˆ
{
  _id: ObjectId,
  orderId: "202511081234567890",  // ç´¢å¼•ï¼Œå”¯ä¸€
  productId: String,
  productName: String,
  quantity: Number,
  totalAmount: Number,
  createTime: ISODate,         // ç´¢å¼•
  deadline: ISODate,           // ç´¢å¼•
  buyerId: "1001",             // ç´¢å¼•
  artistId: "1002",            // ç´¢å¼•
  serviceId: "1003",
  status: "inProgress",        // ç´¢å¼•
  version: Number,             // ä¹è§‚é”
  // ... å…¶ä»–å­—æ®µ
  createdAt: ISODate,
  updatedAt: ISODate
}
```

---

## 11. APIå±‚ç»Ÿä¸€è¿”å›ç»“æ„ä¼˜åŒ–

### 11.1 åç«¯ç»Ÿä¸€è¿”å›æ ¼å¼

```javascript
// æˆåŠŸå“åº”
{
  "code": 0,
  "message": "OK",
  "data": {
    // å®é™…æ•°æ®
  }
}

// å¤±è´¥å“åº”
{
  "code": 1001,
  "message": "è®¢å•ä¸å­˜åœ¨",
  "data": null
}
```

### 11.2 å‰ç«¯APIå±‚ä¼˜åŒ–ï¼ˆâš ï¸ æ¨èï¼‰

```javascript
// utils/api.js
class ApiService {
  constructor() {
    this.baseURL = 'https://your-api.com'
  }
  
  // âœ… ä¼˜åŒ–åçš„ç»Ÿä¸€è¯·æ±‚æ–¹æ³•
  async request(method, url, data = {}, options = {}) {
    const token = wx.getStorageSync('token')
    
    try {
      const res = await new Promise((resolve, reject) => {
        wx.request({
          url: `${this.baseURL}${url}`,
          method,
          data,
          header: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : '',
            ...options.headers
          },
          success: resolve,
          fail: reject
        })
      })
      
      // âœ… ç»Ÿä¸€æ‹¦æˆªè¿”å›ç»“æœ
      const { code, message, data: payload } = res.data
      
      if (code !== 0) {
        throw new Error(message || 'è¯·æ±‚å¤±è´¥')
      }
      
      // âœ… è¿”å›å¹²å‡€çš„ data å¯¹è±¡
      return payload
      
    } catch (err) {
      // âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
      this.handleError(err)
      throw err
    }
  }
  
  // âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
  handleError(error) {
    console.error('APIè¯·æ±‚å¤±è´¥:', error)
    
    // Tokenè¿‡æœŸ
    if (error.message.includes('Token') || error.message.includes('ç™»å½•')) {
      wx.removeStorageSync('token')
      wx.showToast({
        title: 'è¯·é‡æ–°ç™»å½•',
        icon: 'none'
      })
      setTimeout(() => {
        wx.navigateTo({ url: '/pages/login/index' })
      }, 1500)
      return
    }
    
    // æ™®é€šä¸šåŠ¡é”™è¯¯
    wx.showToast({
      title: error.message || 'ç½‘ç»œé”™è¯¯',
      icon: 'none',
      duration: 2000
    })
  }
  
  // ä¾¿æ·æ–¹æ³•
  get(url, params) {
    return this.request('GET', url, params)
  }
  
  post(url, data) {
    return this.request('POST', url, data)
  }
  
  put(url, data) {
    return this.request('PUT', url, data)
  }
  
  delete(url, params) {
    return this.request('DELETE', url, params)
  }
}

export default new ApiService()
```

### 11.3 ä½¿ç”¨ç¤ºä¾‹

```javascript
// âŒ ä¼˜åŒ–å‰ï¼ˆæ¯ä¸ªé¡µé¢éƒ½å†™try/catchï¼‰
try {
  const response = await api.getOrderList()
  if (response.code !== 0) {
    wx.showToast({ title: response.message, icon: 'none' })
    return
  }
  const orders = response.data.orders
  this.setData({ orders })
} catch (error) {
  wx.showToast({ title: 'ç½‘ç»œé”™è¯¯', icon: 'none' })
}

// âœ… ä¼˜åŒ–åï¼ˆç›´æ¥è·å–å¹²å‡€æ•°æ®ï¼‰
try {
  const orders = await api.getOrderList()  // ç›´æ¥è¿”å›data.orders
  this.setData({ orders })
} catch (error) {
  // é”™è¯¯å·²åœ¨APIå±‚ç»Ÿä¸€å¤„ç†ï¼Œå¯é€‰æ‹©æ€§è¡¥å……ä¸šåŠ¡é€»è¾‘
}
```

---

## 12. åˆ†æˆé€»è¾‘åç«¯äº‹åŠ¡åŒ–

### 12.1 äº‘å‡½æ•°/åç«¯äº‹åŠ¡å®ç°

```javascript
// äº‘å‡½æ•°ï¼šcompleteOrder
exports.main = async (event) => {
  const { orderId } = event
  const db = cloud.database()
  
  // âœ… ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
  const transaction = await db.startTransaction()
  
  try {
    // 1. æŸ¥è¯¢è®¢å•
    const { data: order } = await transaction.collection('orders')
      .doc(orderId)
      .get()
    
    if (!order) {
      throw new Error('è®¢å•ä¸å­˜åœ¨')
    }
    
    if (order.status === 'completed') {
      throw new Error('è®¢å•å·²å®Œæˆï¼Œè¯·å‹¿é‡å¤æ“ä½œ')
    }
    
    // 2. è®¡ç®—åˆ†æˆ
    const quantity = order.quantity
    const orderAmount = order.totalAmount
    
    const serviceFee = 5 * quantity          // å®¢æœåˆ†æˆï¼šÂ¥5/ä»¶
    const adminShareRate = 0.05              // ç®¡ç†å‘˜åˆ†æˆç‡ï¼š5%
    const adminFee = orderAmount * adminShareRate
    const artistIncome = orderAmount - serviceFee - adminFee
    
    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    await transaction.collection('orders')
      .doc(orderId)
      .update({
        data: {
          status: 'completed',
          completedAt: new Date(),
          updatedAt: new Date()
        }
      })
    
    // 4. è®°å½•å®¢æœåˆ†æˆ
    if (order.serviceId) {
      await transaction.collection('income_ledger')
        .add({
          data: {
            userId: order.serviceId,
            orderId: orderId,
            incomeType: 'service',
            amount: serviceFee,
            orderAmount: orderAmount,
            note: `è®¢å•åˆ†æˆï¼ˆ${quantity}ä»¶ Ã— Â¥5ï¼‰`,
            createTime: new Date(),
            orderCompletedAt: new Date()
          }
        })
    }
    
    // 5. è®°å½•ç®¡ç†å‘˜åˆ†æˆ
    const adminUsers = await getAdminUsers()  // è·å–ç®¡ç†å‘˜åˆ—è¡¨
    for (const admin of adminUsers) {
      await transaction.collection('income_ledger')
        .add({
          data: {
            userId: admin.userId,
            orderId: orderId,
            incomeType: 'admin_share',
            amount: adminFee,
            orderAmount: orderAmount,
            note: `è®¢å•åˆ†æˆï¼ˆ${adminShareRate * 100}%ï¼‰`,
            createTime: new Date(),
            orderCompletedAt: new Date()
          }
        })
    }
    
    // 6. æäº¤äº‹åŠ¡
    await transaction.commit()
    
    return {
      code: 0,
      message: 'è®¢å•å·²å®Œæˆ',
      data: {
        orderId,
        serviceFee,
        adminFee,
        artistIncome
      }
    }
    
  } catch (error) {
    // å›æ»šäº‹åŠ¡
    await transaction.rollback()
    
    return {
      code: 1001,
      message: error.message,
      data: null
    }
  }
}
```

### 12.2 å‰ç«¯è°ƒç”¨

```javascript
// pages/order-detail/index.js
async confirmOrder() {
  try {
    const result = await api.post('/orders/complete', {
      orderId: this.data.orderId
    })
    
    wx.showToast({
      title: 'è®¢å•å·²å®Œæˆ',
      icon: 'success'
    })
    
    // åˆ·æ–°è®¢å•è¯¦æƒ…
    this.loadOrderDetail()
    
  } catch (error) {
    // é”™è¯¯å·²åœ¨APIå±‚å¤„ç†
  }
}
```

---

## 13. HTTPè§¦å‘å™¨ç­¾åéªŒè¯

### 13.1 äº‘å‡½æ•°å…¥å£éªŒè¯

```javascript
// äº‘å‡½æ•°å…¥å£
exports.main = async (event) => {
  // âœ… éªŒè¯Token
  const token = event.headers.Authorization?.replace('Bearer ', '')
  
  if (!token) {
    return {
      statusCode: 401,
      body: JSON.stringify({
        code: 3001,
        message: 'Tokenç¼ºå¤±',
        data: null
      })
    }
  }
  
  // âœ… éªŒè¯Tokenæœ‰æ•ˆæ€§
  try {
    const decoded = verifyToken(token)
    event.userId = decoded.userId  // æ³¨å…¥userIdä¾›åç»­ä½¿ç”¨
  } catch (error) {
    return {
      statusCode: 401,
      body: JSON.stringify({
        code: 3002,
        message: 'Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ',
        data: null
      })
    }
  }
  
  // âœ… éªŒè¯userIdä¸æ“ä½œä¸€è‡´ï¼ˆé‡è¦ï¼ï¼‰
  const { userId } = event.body || {}
  if (userId && userId !== event.userId) {
    return {
      statusCode: 403,
      body: JSON.stringify({
        code: 1003,
        message: 'æ— æƒé™æ“ä½œå…¶ä»–ç”¨æˆ·æ•°æ®',
        data: null
      })
    }
  }
  
  // ç»§ç»­ä¸šåŠ¡é€»è¾‘
  return await handleBusinessLogic(event)
}

// TokenéªŒè¯å‡½æ•°
function verifyToken(token) {
  // ä½¿ç”¨JWTæˆ–å…¶ä»–æ–¹å¼éªŒè¯
  const jwt = require('jsonwebtoken')
  return jwt.verify(token, process.env.JWT_SECRET)
}
```

### 13.2 ç­¾åéªŒè¯ï¼ˆå¯é€‰ï¼Œæ›´é«˜å®‰å…¨æ€§ï¼‰

```javascript
// ä½¿ç”¨HMAC-SHA256ç­¾å
function generateSignature(params, secret) {
  const crypto = require('crypto')
  const sortedKeys = Object.keys(params).sort()
  const str = sortedKeys.map(k => `${k}=${params[k]}`).join('&')
  return crypto.createHmac('sha256', secret).update(str).digest('hex')
}

// å‰ç«¯ç”Ÿæˆç­¾å
const params = {
  userId: '1001',
  orderId: '202511081234567890',
  timestamp: Date.now()
}
const signature = generateSignature(params, SECRET_KEY)

await api.post('/orders/complete', {
  ...params,
  signature
})

// åç«¯éªŒè¯ç­¾å
function verifySignature(params, signature, secret) {
  const expectedSignature = generateSignature(params, secret)
  return signature === expectedSignature
}
```

---

## 14. æ—¶é—´æ ‡å‡†åŒ–å…¨å±€å·¥å…·

### 14.1 åˆ›å»ºæ—¶é—´å·¥å…·ç±»

```javascript
// utils/date-formatter.js

/**
 * æ—¶é—´æ ¼å¼åŒ–å·¥å…·
 * ç»Ÿä¸€å¤„ç†å‰ç«¯å±•ç¤ºã€åç«¯äº¤äº’ã€iOSå…¼å®¹
 */

// å¡«å……0
function pad(num) {
  return num < 10 ? `0${num}` : `${num}`
}

/**
 * ISOæ ¼å¼ â†’ å±•ç¤ºæ ¼å¼
 * "2025-11-08T10:28:30+08:00" â†’ "2025-11-08 10:28:30"
 */
export function formatDateToDisplay(isoStr) {
  if (!isoStr) return ''
  
  const d = new Date(isoStr)
  if (isNaN(d.getTime())) return ''
  
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`
}

/**
 * ISOæ ¼å¼ â†’ çŸ­æ ¼å¼ï¼ˆæœˆ-æ—¥ æ—¶:åˆ†ï¼‰
 * "2025-11-08T10:28:30+08:00" â†’ "11-08 10:28"
 */
export function formatDateToShort(isoStr) {
  if (!isoStr) return ''
  
  const d = new Date(isoStr)
  if (isNaN(d.getTime())) return ''
  
  return `${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`
}

/**
 * æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸² â†’ ISOæ ¼å¼ï¼ˆå…¼å®¹iOSï¼‰
 * "2025-11-08 10:28:30" â†’ "2025-11-08T10:28:30+08:00"
 */
export function parseToISO(dateStr) {
  if (!dateStr) return null
  
  // iOSå…¼å®¹ï¼šæ›¿æ¢ - ä¸º /
  const iosCompatible = dateStr.replace(/-/g, '/')
  const d = new Date(iosCompatible)
  
  if (isNaN(d.getTime())) return null
  
  return d.toISOString()
}

/**
 * ç›¸å¯¹æ—¶é—´
 * "2025-11-08T10:28:30+08:00" â†’ "3å°æ—¶å‰"
 */
export function formatRelativeTime(isoStr) {
  if (!isoStr) return ''
  
  const now = Date.now()
  const target = new Date(isoStr).getTime()
  const diff = now - target
  
  if (diff < 60000) return 'åˆšåˆš'
  if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`
  if (diff < 2592000000) return `${Math.floor(diff / 86400000)}å¤©å‰`
  
  return formatDateToDisplay(isoStr)
}

/**
 * è®¡ç®—å‰©ä½™æ—¶é—´
 * deadline â†’ "å‰©ä½™2å¤©3å°æ—¶"
 */
export function calculateTimeLeft(deadlineISO) {
  if (!deadlineISO) return ''
  
  const now = Date.now()
  const deadline = new Date(deadlineISO).getTime()
  const diff = deadline - now
  
  if (diff < 0) return 'å·²æˆªç¨¿'
  
  const days = Math.floor(diff / 86400000)
  const hours = Math.floor((diff % 86400000) / 3600000)
  
  if (days > 0) {
    return `å‰©ä½™${days}å¤©${hours}å°æ—¶`
  }
  
  return `å‰©ä½™${hours}å°æ—¶`
}
```

### 14.2 ä½¿ç”¨ç¤ºä¾‹

```javascript
// pages/order-list/index.js
import { formatDateToShort, calculateTimeLeft } from '../../utils/date-formatter'

async loadOrders() {
  const orders = await api.getOrderList()
  
  const formattedOrders = orders.map(order => ({
    ...order,
    // âœ… ç»Ÿä¸€æ ¼å¼åŒ–å±•ç¤º
    createTimeDisplay: formatDateToShort(order.createTime),
    deadlineDisplay: formatDateToShort(order.deadline),
    timeLeft: calculateTimeLeft(order.deadline)
  }))
  
  this.setData({ orders: formattedOrders })
}
```

---

## 15. ç‰ˆæœ¬ç®¡ç†ä¸é™çº§ç­–ç•¥

### 15.1 Gitåˆ†æ”¯ç®¡ç†æ–¹æ¡ˆ

```bash
# ä¸»åˆ†æ”¯
main              # ç”Ÿäº§ç¯å¢ƒï¼ˆä½¿ç”¨æœ¬åœ°mockï¼‰

# è¿ç§»åˆ†æ”¯
feature/backend-migration    # åç«¯æ¥å…¥å¼€å‘åˆ†æ”¯

# æäº¤è§„èŒƒ
[API MIGRATION] ç”¨æˆ·ç™»å½•æ¥å£è¿ç§»
[API MIGRATION] è®¢å•åˆ—è¡¨æ¥å£è¿ç§»
[API MIGRATION] å•†å“åˆ›å»ºæ¥å£è¿ç§»
```

**å·¥ä½œæµç¨‹**ï¼š
```bash
# 1. åˆ›å»ºè¿ç§»åˆ†æ”¯
git checkout -b feature/backend-migration

# 2. é€æ¨¡å—è¿ç§»ï¼Œæ¯ä¸ªæ¨¡å—æäº¤
git add utils/api.js pages/login/index.js
git commit -m "[API MIGRATION] ç”¨æˆ·ç™»å½•æ¥å£è¿ç§»"

# 3. å……åˆ†æµ‹è¯•ååˆå¹¶åˆ°main
git checkout main
git merge feature/backend-migration

# 4. å‡ºç°é—®é¢˜æ—¶å¿«é€Ÿå›æ»š
git revert <commit-hash>
```

### 15.2 é…ç½®å¼€å…³ç®¡ç†

```javascript
// config/env.js
const ENV = {
  dev: {
    apiBaseUrl: 'http://localhost:3000',
    useMockData: true,     // âœ… å¼€å…³ï¼šæ˜¯å¦ä½¿ç”¨mockæ•°æ®
    enableCache: false,
    logLevel: 'debug'
  },
  
  prod: {
    apiBaseUrl: 'https://api.yourdomain.com',
    useMockData: false,    // âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®API
    enableCache: true,
    logLevel: 'error'
  }
}

const currentEnv = process.env.NODE_ENV === 'production' ? 'prod' : 'dev'

module.exports = {
  ...ENV[currentEnv],
  
  // âœ… ç´§æ€¥é™çº§å¼€å…³ï¼ˆæ‰‹åŠ¨æ§åˆ¶ï¼‰
  // è‹¥è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é‡å¤§æ¥å£å¼‚å¸¸ï¼Œä¿®æ”¹æ­¤å€¼ä¸ºtrueå¯ç«‹åˆ»å›é€€è‡³æœ¬åœ°mocké€»è¾‘
  emergencyFallback: false
}
```

### 15.3 é™çº§ç­–ç•¥å®ç°

```javascript
// utils/api.js
import config from '../config/env'

class ApiService {
  async getOrderList(filters = {}) {
    // âœ… é™çº§ç­–ç•¥ï¼šä¼˜å…ˆåç«¯ï¼Œå¼‚å¸¸æ—¶é™çº§åˆ°æœ¬åœ°
    if (config.useMockData || config.emergencyFallback) {
      console.log('ğŸ“¦ ä½¿ç”¨æœ¬åœ°mockæ•°æ®')
      return this.getMockOrderList(filters)
    }
    
    try {
      const response = await this.request('GET', '/orders', filters)
      return response
    } catch (error) {
      console.warn('âš ï¸ åç«¯è¯·æ±‚å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°mock', error)
      
      // è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°
      return this.getMockOrderList(filters)
    }
  }
  
  // æœ¬åœ°mocké€»è¾‘ï¼ˆä¿ç•™ï¼‰
  getMockOrderList(filters = {}) {
    const pending = wx.getStorageSync('pending_orders') || []
    const completed = wx.getStorageSync('completed_orders') || []
    return [...pending, ...completed]
  }
}
```

**âš™ï¸ æ€»ç»“**ï¼š
> è‹¥è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é‡å¤§æ¥å£å¼‚å¸¸ï¼Œä¿ç•™ `config.useMockData = true` æˆ– `config.emergencyFallback = true` å¼€å…³å¯ç«‹åˆ»å›é€€è‡³æœ¬åœ°mocké€»è¾‘ï¼Œç¡®ä¿çº¿ä¸ŠæœåŠ¡ä¸ä¸­æ–­ã€‚

---

## 16. æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ä¸ç´¢å¼•

### 16.1 æ•°æ®åº“ç´¢å¼•ï¼ˆâš ï¸ å¿…åŠ ï¼‰

```sql
-- orders è¡¨å…³é”®ç´¢å¼•
CREATE INDEX idx_buyer_id ON orders(buyer_id);
CREATE INDEX idx_artist_id ON orders(artist_id);
CREATE INDEX idx_status ON orders(status);
CREATE INDEX idx_create_time ON orders(create_time);
CREATE INDEX idx_deadline ON orders(deadline);

-- å¤åˆç´¢å¼•ï¼ˆå¸¸ç”¨ç»„åˆæŸ¥è¯¢ï¼‰
CREATE INDEX idx_status_create_time ON orders(status, create_time DESC);
CREATE INDEX idx_buyer_status ON orders(buyer_id, status);
CREATE INDEX idx_artist_status ON orders(artist_id, status);

-- users è¡¨ç´¢å¼•
CREATE INDEX idx_user_id ON users(user_id);
CREATE INDEX idx_openid ON users(openid);

-- income_ledger è¡¨ç´¢å¼•
CREATE INDEX idx_user_id ON income_ledger(user_id);
CREATE INDEX idx_create_time ON income_ledger(create_time DESC);

-- MongoDBç´¢å¼•
db.orders.createIndex({ buyerId: 1 })
db.orders.createIndex({ artistId: 1 })
db.orders.createIndex({ status: 1 })
db.orders.createIndex({ createTime: -1 })
db.orders.createIndex({ deadline: 1 })
db.orders.createIndex({ status: 1, createTime: -1 })  // å¤åˆç´¢å¼•
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›ç´¢å¼•ï¼Ÿ**
- `buyerId` / `artistId`ï¼šç”¨æˆ·æŸ¥è¯¢"æˆ‘çš„è®¢å•"
- `status`ï¼šæŒ‰çŠ¶æ€ç­›é€‰ï¼ˆåˆ¶ä½œä¸­ã€å·²å®Œæˆã€å·²é€€æ¬¾ï¼‰
- `createTime`ï¼šè®¢å•åˆ—è¡¨æŒ‰æ—¶é—´å€’åº
- `deadline`ï¼šè®¡ç®—ä¸´è¿‘æˆªç¨¿ã€å·²è„±ç¨¿çŠ¶æ€
- å¤åˆç´¢å¼•ï¼šæå‡ç»„åˆæŸ¥è¯¢æ€§èƒ½ï¼ˆå¦‚"æˆ‘çš„åˆ¶ä½œä¸­è®¢å•"ï¼‰

### 16.2 ç¼“å­˜ç­–ç•¥

```javascript
// utils/cache-manager.js
class CacheManager {
  constructor() {
    this.caches = new Map()
  }
  
  // è®¾ç½®ç¼“å­˜
  set(key, data, ttl = 5 * 60 * 1000) {  // é»˜è®¤5åˆ†é’Ÿ
    this.caches.set(key, {
      data,
      expireTime: Date.now() + ttl
    })
  }
  
  // è·å–ç¼“å­˜
  get(key) {
    const cache = this.caches.get(key)
    
    if (!cache) return null
    
    // æ£€æŸ¥è¿‡æœŸ
    if (Date.now() > cache.expireTime) {
      this.caches.delete(key)
      return null
    }
    
    return cache.data
  }
  
  // æ¸…é™¤ç¼“å­˜
  clear(key) {
    if (key) {
      this.caches.delete(key)
    } else {
      this.caches.clear()
    }
  }
}

export default new CacheManager()
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// utils/api.js
import cache from './cache-manager'

async getProductList() {
  const cacheKey = 'product_list'
  
  // å…ˆæŸ¥ç¼“å­˜
  const cached = cache.get(cacheKey)
  if (cached) {
    console.log('âœ… ä½¿ç”¨ç¼“å­˜æ•°æ®')
    return cached
  }
  
  // è¯·æ±‚åç«¯
  const data = await this.request('GET', '/products')
  
  // å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
  cache.set(cacheKey, data, 5 * 60 * 1000)
  
  return data
}
```

---

## 17. æµ‹è¯•æ•°æ®æ³¨å…¥

### 17.1 è°ƒè¯•æ¥å£ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```javascript
// äº‘å‡½æ•°ï¼šseedTestData
exports.main = async (event) => {
  const { type, count = 10 } = event
  
  // âœ… ä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
  if (process.env.ENV !== 'dev') {
    return {
      code: 403,
      message: 'ç”Ÿäº§ç¯å¢ƒä¸å¯ç”¨',
      data: null
    }
  }
  
  const db = cloud.database()
  
  switch (type) {
    case 'orders':
      // æ‰¹é‡æ’å…¥æµ‹è¯•è®¢å•
      const orders = []
      for (let i = 0; i < count; i++) {
        orders.push({
          orderId: `TEST${Date.now()}${i}`,
          productName: `æµ‹è¯•å•†å“${i}`,
          buyerId: '1001',
          artistId: '1002',
          status: ['unpaid', 'inProgress', 'completed'][Math.floor(Math.random() * 3)],
          totalAmount: Math.floor(Math.random() * 200) + 50,
          createTime: new Date(Date.now() - Math.random() * 30 * 86400000),
          deadline: new Date(Date.now() + Math.random() * 7 * 86400000)
        })
      }
      
      await db.collection('orders').add({ data: orders })
      
      return {
        code: 0,
        message: `å·²æ’å…¥ ${count} æ¡æµ‹è¯•è®¢å•`,
        data: { count }
      }
      
    case 'users':
      // æ‰¹é‡æ’å…¥æµ‹è¯•ç”¨æˆ·
      // ...
      break
      
    default:
      return {
        code: 400,
        message: 'æœªçŸ¥ç±»å‹',
        data: null
      }
  }
}
```

### 17.2 å‰ç«¯è°ƒç”¨ï¼ˆå¼€å‘å·¥å…·ï¼‰

```javascript
// pages/debug/seed.js
async seedOrders() {
  try {
    await api.post('/debug/seed', {
      type: 'orders',
      count: 50
    })
    
    wx.showToast({
      title: 'æµ‹è¯•æ•°æ®å·²æ³¨å…¥',
      icon: 'success'
    })
  } catch (error) {
    console.error(error)
  }
}
```

---

## 18. å®‰å…¨åŠ å›º

### 18.1 userIdä¸Tokenä¸€è‡´æ€§éªŒè¯ï¼ˆâš ï¸ é‡è¦ï¼‰

**é—®é¢˜**ï¼šæ¶æ„ç”¨æˆ·å¯èƒ½ä¼ªé€ è¯·æ±‚ï¼Œç¯¡æ”¹userIdæ“ä½œä»–äººæ•°æ®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåç«¯å¿…é¡»éªŒè¯Tokenä¸­çš„userIdä¸è¯·æ±‚å‚æ•°ä¸€è‡´ã€‚

```javascript
// äº‘å‡½æ•°ä¸­é—´ä»¶
function verifyUserIdConsistency(event) {
  const tokenUserId = event.userId  // ä»Tokenè§£æå‡ºçš„userId
  const requestUserId = event.body?.userId || event.queryStringParameters?.userId
  
  if (requestUserId && requestUserId !== tokenUserId) {
    throw new Error('æ— æƒé™æ“ä½œå…¶ä»–ç”¨æˆ·æ•°æ®')
  }
  
  return true
}

// ä½¿ç”¨
exports.main = async (event) => {
  // éªŒè¯Token
  const decoded = verifyToken(event.headers.Authorization)
  event.userId = decoded.userId
  
  // âœ… éªŒè¯userIdä¸€è‡´æ€§
  verifyUserIdConsistency(event)
  
  // ç»§ç»­ä¸šåŠ¡é€»è¾‘
  return await handleBusiness(event)
}
```

### 18.2 æ•æ„Ÿä¿¡æ¯è„±æ•

```javascript
// è¿”å›ç”¨æˆ·ä¿¡æ¯æ—¶è„±æ•
function sanitizeUserInfo(user) {
  return {
    ...user,
    phone: user.phone ? user.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '',
    bankCard: user.bankCard ? user.bankCard.replace(/\d{12}(\d{4})/, '****$1') : ''
  }
}
```

### 18.3 APIè®¿é—®é¢‘ç‡é™åˆ¶

```javascript
// ç®€æ˜“é™æµä¸­é—´ä»¶
const requestCounts = new Map()

function rateLimit(userId, limit = 100, window = 60000) {
  const now = Date.now()
  const key = `${userId}_${Math.floor(now / window)}`
  
  const count = requestCounts.get(key) || 0
  
  if (count >= limit) {
    throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•')
  }
  
  requestCounts.set(key, count + 1)
  
  // æ¸…ç†è¿‡æœŸè®°å½•
  setTimeout(() => requestCounts.delete(key), window)
}

// ä½¿ç”¨
exports.main = async (event) => {
  rateLimit(event.userId, 100, 60000)  // æ¯åˆ†é’Ÿ100æ¬¡
  // ...
}
```

---

## 19. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

âœ… **æ•°æ®ç»“æ„æ¸…æ™°**ï¼šæ‰€æœ‰Storage Keyå’Œå­—æ®µç»“æ„å·²æ•´ç†  
âœ… **æ•°æ®åº“æ˜ å°„å®Œæ•´**ï¼šMySQL/MongoDBè¡¨ç»“æ„ã€ç´¢å¼•ã€å…³è”å…³ç³»å·²å®šä¹‰  
âœ… **ä¸šåŠ¡é€»è¾‘æ˜ç¡®**ï¼šè®¢å•æµè½¬ã€åˆ†æˆè®¡ç®—ã€åº“å­˜ç®¡ç†éƒ½æœ‰è¯´æ˜  
âœ… **è¿ç§»ç­–ç•¥ç¨³å¦¥**ï¼šæ¸è¿›å¼è¿ç§»ï¼ŒåŒå†™â†’åŒè¯»â†’çº¯åç«¯  
âœ… **APIè®¾è®¡è§„èŒƒ**ï¼šç»Ÿä¸€å°è£…å±‚ã€è¿”å›ç»“æ„ä¼˜åŒ–ã€é”™è¯¯å¤„ç†é›†ä¸­  
âœ… **å®‰å…¨åŠ å›ºå®Œå–„**ï¼šTokenéªŒè¯ã€userIdä¸€è‡´æ€§æ£€æŸ¥ã€è„±æ•ã€é™æµ  
âœ… **æ€§èƒ½ä¼˜åŒ–åˆ°ä½**ï¼šæ•°æ®åº“ç´¢å¼•ã€ç¼“å­˜ç­–ç•¥ã€åˆ†é¡µåŠ è½½  
âœ… **æ—¶é—´æ ‡å‡†ç»Ÿä¸€**ï¼šiOSå…¼å®¹å·¥å…·ç±»ã€æ ¼å¼åŒ–ç»Ÿä¸€  
âœ… **é™çº§ç­–ç•¥å®Œå¤‡**ï¼šé…ç½®å¼€å…³ã€ç´§æ€¥å›é€€æœºåˆ¶

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åç«¯è®¾è®¡**ï¼š
   - æ ¹æ®ç¬¬10ç« è®¾è®¡æ•°æ®åº“è¡¨ç»“æ„ï¼ˆMySQL/MongoDBï¼‰
   - æ·»åŠ å¿…è¦ç´¢å¼•ï¼ˆç¬¬16ç« ï¼‰
   - è®¾è®¡APIæ¥å£ï¼ˆç¬¬4ç« ï¼‰

2. **åˆ›å»ºåŸºç¡€è®¾æ–½**ï¼š
   - å®ç° `utils/api.js` ç»Ÿä¸€æ¥å£ï¼ˆç¬¬11ç« ï¼‰
   - åˆ›å»º `utils/date-formatter.js` æ—¶é—´å·¥å…·ï¼ˆç¬¬14ç« ï¼‰
   - é…ç½® `config/env.js` ç¯å¢ƒç®¡ç†ï¼ˆç¬¬15ç« ï¼‰
   - å®ç°äº‘å‡½æ•°/åç«¯äº‹åŠ¡ï¼ˆç¬¬12-13ç« ï¼‰

3. **é€æ¨¡å—è¿ç§»**ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š
   - **ç¬¬1å‘¨**ï¼šç”¨æˆ·ç™»å½•ã€Tokenç®¡ç†
   - **ç¬¬2å‘¨**ï¼šè®¢å•CRUDã€çŠ¶æ€æ›´æ–°
   - **ç¬¬3å‘¨**ï¼šå•†å“ç®¡ç†ã€åº“å­˜åŒæ­¥
   - **ç¬¬4å‘¨**ï¼šç”»å¸ˆç”³è¯·ã€è´¢åŠ¡æ¨¡å—
   - **ç¬¬5å‘¨**ï¼šæµ‹è¯•æ•°æ®æ³¨å…¥ã€å‹åŠ›æµ‹è¯•

4. **å……åˆ†æµ‹è¯•**ï¼š
   - æ¥å£åŠŸèƒ½æµ‹è¯•ï¼ˆç¬¬7ç« ï¼‰
   - å‹åŠ›æµ‹è¯•ï¼ˆå¹¶å‘è®¢å•ã€åº“å­˜ä¸€è‡´æ€§ï¼‰
   - å®‰å…¨æµ‹è¯•ï¼ˆTokenã€æƒé™éªŒè¯ï¼‰
   - æ€§èƒ½æµ‹è¯•ï¼ˆåˆ†é¡µã€ç¼“å­˜ã€ç´¢å¼•æ•ˆæœï¼‰

5. **ç›‘æ§ä¸Šçº¿**ï¼š
   - éƒ¨ç½²åå¯†åˆ‡å…³æ³¨æ—¥å¿—å’Œé”™è¯¯ç‡
   - ä¿ç•™é™çº§å¼€å…³ï¼ˆ`emergencyFallback`ï¼‰
   - åˆ†æ‰¹ç°åº¦å‘å¸ƒï¼Œé€æ­¥åˆ‡æ¢ç”¨æˆ·

---

## 20. è¡¥å……è¯´æ˜ï¼ˆæ ¹æ®åé¦ˆä¼˜åŒ–ï¼‰

### 20.1 å…³äºæ•°æ®åº“é€‰å‹

**MySQL** vs **MongoDB**ï¼š
- **MySQL**ï¼šé€‚åˆå¼ºä¸€è‡´æ€§éœ€æ±‚ï¼ˆè®¢å•ã€è´¢åŠ¡ï¼‰ï¼Œæ”¯æŒäº‹åŠ¡å’Œå¤æ‚å…³è”æŸ¥è¯¢
- **MongoDB**ï¼šé€‚åˆçµæ´»ç»“æ„ï¼ˆå•†å“è§„æ ¼JSONï¼‰ï¼Œæ°´å¹³æ‰©å±•æ€§å¥½

**æ¨èæ–¹æ¡ˆ**ï¼š
- æ ¸å¿ƒæ•°æ®ï¼ˆç”¨æˆ·ã€è®¢å•ã€è´¢åŠ¡ï¼‰â†’ **MySQL**
- çµæ´»æ•°æ®ï¼ˆå•†å“ã€å…¬å‘Šã€é…ç½®ï¼‰â†’ **MongoDB**
- æ··åˆä½¿ç”¨ï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿

### 20.2 å…³äºå›¾ç‰‡å­˜å‚¨

**å½“å‰é—®é¢˜**ï¼šbase64å­˜å‚¨å ç”¨å¤§é‡ç©ºé—´ï¼Œä¼ è¾“æ…¢ã€‚

**æ¨èæ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨äº‘å­˜å‚¨ï¼ˆè…¾è®¯äº‘COSã€é˜¿é‡Œäº‘OSSã€ä¸ƒç‰›äº‘ï¼‰
2. å‰ç«¯ä¸Šä¼ æµç¨‹ï¼š
   ```javascript
   // 1. é€‰æ‹©å›¾ç‰‡
   wx.chooseImage({
     success: async (res) => {
       const tempFilePath = res.tempFilePaths[0]
       
       // 2. è·å–ä¸Šä¼ å‡­è¯
       const { token, key } = await api.getUploadToken()
       
       // 3. ä¸Šä¼ åˆ°äº‘å­˜å‚¨
       const imageUrl = await uploadToCloud(tempFilePath, token, key)
       
       // 4. ä¿å­˜URLåˆ°æ•°æ®åº“
       productData.images.push(imageUrl)
     }
   })
   ```
3. å›¾ç‰‡å¤„ç†ï¼š
   - åŸå›¾ï¼šå­˜å‚¨åŸå§‹URL
   - ç¼©ç•¥å›¾ï¼šäº‘å­˜å‚¨è‡ªåŠ¨ç”Ÿæˆï¼ˆæ·»åŠ å‚æ•°å¦‚ `?imageView2/1/w/200/h/200`ï¼‰
   - CDNåŠ é€Ÿï¼šé…ç½®CDNåŸŸå

### 20.3 å…³äºåˆ†æˆè§„åˆ™é…ç½®åŒ–

å½“å‰åˆ†æˆè§„åˆ™ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼ˆå®¢æœÂ¥5/ä»¶ï¼Œç®¡ç†å‘˜5%ï¼‰ï¼Œå»ºè®®æ”¹ä¸ºé…ç½®è¡¨ï¼š

```sql
CREATE TABLE system_config (
  id INT PRIMARY KEY AUTO_INCREMENT,
  config_key VARCHAR(50) UNIQUE NOT NULL,
  config_value TEXT,
  description VARCHAR(200),
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ’å…¥é»˜è®¤é…ç½®
INSERT INTO system_config (config_key, config_value, description) VALUES
('service_fee_per_item', '5.00', 'å®¢æœåˆ†æˆï¼ˆå…ƒ/ä»¶ï¼‰'),
('admin_share_rate', '0.05', 'ç®¡ç†å‘˜åˆ†æˆæ¯”ä¾‹'),
('withdraw_min_amount', '100.00', 'æœ€ä½æç°é‡‘é¢'),
('withdraw_fee_rate', '0.01', 'æç°æ‰‹ç»­è´¹æ¯”ä¾‹');
```

åç«¯è¯»å–é…ç½®ï¼š
```javascript
async function getServiceFee() {
  const config = await db.query('SELECT config_value FROM system_config WHERE config_key = ?', ['service_fee_per_item'])
  return parseFloat(config.config_value) || 5.00
}
```

### 20.4 å…³äºæ¶ˆæ¯æ¨é€

è®¢å•çŠ¶æ€å˜æ›´æ—¶ï¼Œéœ€è¦é€šçŸ¥ç›¸å…³ç”¨æˆ·ï¼š

**å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯**ï¼š
```javascript
// è®¢å•å®Œæˆé€šçŸ¥ç”»å¸ˆ
await api.sendTemplateMessage({
  touser: artist.openid,
  template_id: 'TEMPLATE_ID',
  data: {
    first: { value: 'æ‚¨çš„è®¢å•å·²å®Œæˆ' },
    keyword1: { value: order.orderNumber },
    keyword2: { value: order.productName },
    keyword3: { value: `Â¥${order.totalAmount}` },
    remark: { value: 'è¯·å‰å¾€å·¥ä½œå°æŸ¥çœ‹æ”¶å…¥è¯¦æƒ…' }
  }
})
```

**å»ºè®®**ï¼š
- è®¢å•æ”¯ä»˜æˆåŠŸ â†’ é€šçŸ¥ç”»å¸ˆ
- è®¢å•å®Œæˆ â†’ é€šçŸ¥ä¹°å®¶å’Œç”»å¸ˆ
- ç”³è¯·å®¡æ ¸é€šè¿‡ â†’ é€šçŸ¥ç”»å¸ˆ
- æç°å®Œæˆ â†’ é€šçŸ¥ç”³è¯·äºº

---

**ç¥æ¥å…¥é¡ºåˆ©ï¼æœ‰é—®é¢˜éšæ—¶æ²Ÿé€šã€‚**

