# 二次测试问题修复清单

## 📊 总体情况

- **已修复**: 5个（问题2, 7, 8英文, 10, 11）
- **需要修复**: 6个（问题4, 5, 6, 8续, 9, 12）
- **等待诊断**: 1个（问题3）
- **等待后端**: 1个（问题1）

**修复率**: 5/12 = 41.7%

---

## 🔴 高优先级（立即修复）

### 问题9：画师端订单排序和筛选问题 ⚠️

**现象**:
1. "全部"分类中，进行中的订单没有优先排在前面
2. 中间夹杂着已完成和已退款订单
3. 点击"进行中"分类，只显示一个订单（应该显示所有进行中的订单）

**根本原因**:
`miniprogram/utils/order-helper.js` 的 `prepareOrdersForPage()` 函数（第416行）没有过滤终态订单。

**当前代码**:
```javascript
function prepareOrdersForPage(options = {}) {
  const { role, userId } = options
  
  // 1. 获取所有订单
  let allOrders = getAllOrders()
  
  // 2. 根据角色筛选
  if (role === 'artist') {
    allOrders = allOrders.filter(order => toKey(order.artistId) === toKey(userId))
  }
  // ... 没有过滤终态订单
  
  // 3. 标准化订单
  return normalizeOrders(allOrders, options)
}
```

**修复方案**:
在角色筛选后，增加终态订单过滤：

```javascript
function prepareOrdersForPage(options = {}) {
  const { role, userId, includeCompleted = false } = options
  
  // 1. 获取所有订单
  let allOrders = getAllOrders()
  
  // 2. 根据角色筛选
  if (role === 'artist') {
    allOrders = allOrders.filter(order => toKey(order.artistId) === toKey(userId))
  }
  // ...
  
  // 🎯 3. 过滤终态订单（除非明确要求包含）
  if (!includeCompleted) {
    const TERMINAL_STATES = ['completed', 'refunded', 'cancelled']
    allOrders = allOrders.filter(order => !TERMINAL_STATES.includes(order.status))
  }
  
  // 4. 标准化订单
  return normalizeOrders(allOrders, options)
}
```

**影响范围**:
- `miniprogram/pages/workspace/index.js` - 画师/客服工作台
- `miniprogram/pages/artist-dashboard/index.js` - 画师仪表盘
- `miniprogram/pages/service-workspace/index.js` - 客服工作台

**风险**: 🔴 高 - 影响画师工作流程

---

### 问题4 & 6 & 10：仪表盘数据统计不一致 ⚠️

**现象**:
1. 仪表盘显示待处理订单数量比实际多1个
2. 画师排行榜数据为0
3. 画师列表和业绩排行订单和收入都为0
4. 确认收货后，画师排行榜仍然显示0

**可能原因**:
1. **订单计数问题**: 可能包含了测试订单或重复订单
2. **画师ID匹配问题**: 类型不一致（string vs number）
3. **已完成订单未计入**: 统计逻辑只统计进行中的订单，没有统计已完成的
4. **订单金额字段不一致**: `price` vs `totalAmount` vs `totalPrice`

**需要检查的位置**:
- `miniprogram/pages/admin/index.js` 第180-270行 - 仪表盘统计逻辑
- 画师排行榜计算逻辑
- 订单金额字段的统一性

**修复方案**:
1. 统一订单金额字段读取逻辑
2. 确保画师ID类型一致（统一转为string）
3. 画师排行榜应统计已完成订单，而不是进行中订单
4. 添加详细的调试日志

**风险**: 🔴 高 - 影响数据准确性和决策

---

## 🟡 中优先级（尽快修复）

### 问题5：后台显示未分配客服但实际已分配 ⚠️

**现象**:
管理后台显示"存在待分配客服的订单"，但实际订单已分配客服。

**根本原因**:
`miniprogram/pages/admin/index.js` 第1195-1210行的判断逻辑过于宽松，将包含"待分配"、"客服"等关键词的 `serviceName` 都视为未分配。

**当前代码**:
```javascript
const placeholders = ['客服', '客服人员', '待分配', '未分配', 'customer service', 'service']
const serviceMissing = !serviceId && !serviceQRCode && 
  (!serviceName || isPlaceholderServiceName(serviceName))
```

**问题**: 如果客服名字叫"阿客服"或"小客服"，也会被误判为未分配。

**修复方案**:
应该主要检查 `serviceId` 和 `serviceAvatar` 是否存在且有效：

```javascript
const serviceMissing = 
  !order.serviceId || 
  !order.serviceAvatar || 
  order.serviceAvatar.startsWith('http://tmp/') || 
  order.serviceAvatar.startsWith('/assets/')
```

**风险**: 🟡 中 - 显示误报，不影响功能，但会造成困扰

---

### 问题8（续）：管理后台修改分类后显示未分类 ⚠️

**现象**:
在管理后台修改商品分类后，首页橱窗点击进去有正常分类，但管理后台显示"未分类"。

**可能原因**:
1. 商品的 `category` 字段没有同步更新
2. 或者 `categoryName` 字段没有同步更新
3. 分类ID类型不一致（string vs number）

**需要检查的位置**:
- `miniprogram/pages/category-manage/index.js` - 分类修改逻辑
- `miniprogram/pages/product-manage/index.js` - 商品分类显示逻辑
- `miniprogram/pages/admin/index.js` - 管理后台商品列表

**修复方案**:
1. 确保修改分类时同时更新 `category` 和 `categoryName`
2. 统一分类ID类型（建议统一为string）
3. 添加分类名称缓存刷新逻辑

**风险**: 🟡 中 - 显示问题，不影响功能

---

### 问题12：搜索画师商品不显示 ⚠️

**现象**:
搜索"1画师"的商品（蓝色橱窗）搜索不显示。

**已有修复**:
- `miniprogram/pages/search/index.js` 第113-122行：动态从用户表获取画师名字
- 第125-133行：获取画师编号用于搜索

**可能原因**:
1. 商品的 `isOnSale` 状态为 false
2. 商品的 `artistId` 不匹配
3. 搜索关键词"1画师"没有匹配到画师编号或名字
4. 商品被其他条件过滤掉了（如分类、标签）

**需要验证**:
1. 该画师的商品是否 `isOnSale = true`
2. 该画师的 `artistId` 是否正确
3. 该画师的 `artistNumber` 是否为 "001" 或 "1"
4. 搜索关键词匹配逻辑是否正确

**风险**: 🟡 中 - 影响搜索体验

---

## ⏳ 等待诊断工具

### 问题3：订单链路断点 ⏳

**现象**:
有的订单不在画师及用户列表中，不显示客服二维码，不显示在橱窗商品中。

**需要诊断**:
1. 订单的 `artistId` 是否正确
2. 订单的 `serviceId` 是否正确
3. 订单的 `productId` 是否正确
4. 商品的 `isOnSale` 状态
5. 商品的 `artistId` 是否匹配

**建议**: 使用管理后台的"诊断工具"扫描这些订单，生成详细报告。

---

## 🔵 等待后端

### 问题1：小程序ID验证 🔵

**状态**: 等待后端解决

---

## ✅ 已修复

### 问题2：画师改名后搜索不到橱窗 ✅

**修复位置**: `miniprogram/pages/user-center/index.js` 第334-346行

**修复内容**: 修改昵称时同步更新所有商品的 `artistName`

---

### 问题7：橱窗外显示销量0 ✅

**状态**: 已修复（用户反馈）

---

### 问题8：管理后台英文显示 ✅

**状态**: 已修复（分类异常导致）

---

### 问题10：图片没有贴合容器 ✅

**状态**: 已修复（用户反馈：妙修复了）

---

### 问题11：配置了客服但显示未配置 ✅

**状态**: 已修复（动态刷新）

---

## 📋 修复优先级排序

1. **🔴 立即修复**:
   - 问题9：画师端订单排序和筛选（影响工作流程）
   - 问题4/6/10：仪表盘数据统计（影响数据准确性）

2. **🟡 尽快修复**:
   - 问题5：后台误报未分配客服（显示问题）
   - 问题8：分类同步更新（显示问题）
   - 问题12：搜索功能验证（体验问题）

3. **🟢 可以延后**:
   - 问题3：等待诊断工具结果
   - 问题1：等待后端

---

## 🛠️ 建议修复顺序

1. **第一批（今天）**:
   - 修复问题9（画师端订单筛选）
   - 修复问题5（后台误报客服）

2. **第二批（明天）**:
   - 修复问题4/6/10（仪表盘统计）
   - 验证问题12（搜索功能）

3. **第三批（后天）**:
   - 修复问题8（分类同步）
   - 运行诊断工具检查问题3

---

## 📝 备注

- 所有修复完成后，建议进行全面回归测试
- 特别关注订单状态流转和数据统计的准确性
- 建议增加单元测试覆盖关键业务逻辑

