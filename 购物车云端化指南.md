# 购物车云端化指南

**创建时间**：2025-11-22  
**任务优先级**：P2  
**预计工作量**：2-3天

---

## 一、概述

### 目标

将购物车数据从本地存储迁移到云数据库，实现多设备同步和数据持久化。

### 当前状态

- ✅ 已新增 CloudAPI 购物车方法（6个）
- ⏳ 待创建 `cartManager` 云函数
- ⏳ 待创建 `carts` 云数据库集合
- ⏳ 待迁移前端页面逻辑

---

## 二、云数据库设计

### 集合名称：`carts`

### 数据结构

```javascript
{
  _id: "cart_item_id",          // 自动生成
  userId: "1001",                // 用户ID（索引）
  productId: "product_123",      // 商品ID（索引）
  productName: "商品名称",
  productImage: "https://...",   // 商品图片URL
  artistName: "画师名称",
  price: "99.00",                // 单价（字符串格式）
  quantity: 2,                   // 数量
  spec1: "红色",                 // 规格1
  spec2: "大号",                 // 规格2
  deliveryDays: 7,               // 交付天数
  selected: false,               // 是否选中（用于结算）
  addTime: "2025-11-22T10:30:00.000Z", // 添加时间（ISO格式）
  updateTime: "2025-11-22T10:30:00.000Z", // 更新时间（ISO格式）
  _openid: "user_openid"         // 用户openid（权限控制）
}
```

### 索引配置

| 字段 | 类型 | 说明 |
|------|------|------|
| `userId` | 升序索引 | 快速查询用户购物车 |
| `productId` | 升序索引 | 查询特定商品的购物车项 |
| `addTime` | 降序索引 | 按添加时间排序 |

### 权限设置

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**说明**：仅允许用户访问自己的购物车数据

---

## 三、云函数设计

### 文件位置

`cloudfunctions/cartManager/index.js`

### 功能清单

| Action | 说明 | 参数 | 返回 |
|--------|------|------|------|
| `getList` | 获取购物车列表 | `userId`（可选） | `{ success, data: [...] }` |
| `add` | 添加商品到购物车 | `cartItem` | `{ success, data: { cartItemId } }` |
| `update` | 更新购物车项 | `cartItemId`, `updates` | `{ success, data: { updated } }` |
| `remove` | 删除购物车项 | `cartItemId` | `{ success, data: { deleted } }` |
| `batchRemove` | 批量删除 | `cartItemIds` | `{ success, data: { count } }` |
| `clear` | 清空购物车 | `userId`（可选） | `{ success, data: { count } }` |

### 云函数代码示例

```javascript
// cloudfunctions/cartManager/index.js
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()
const _ = db.command

exports.main = async (event, context) => {
  const { action, userId, cartItem, cartItemId, updates, cartItemIds } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    switch (action) {
      case 'getList':
        return await getCartList(OPENID, userId)
      case 'add':
        return await addToCart(OPENID, userId, cartItem)
      case 'update':
        return await updateCartItem(OPENID, cartItemId, updates)
      case 'remove':
        return await removeFromCart(OPENID, cartItemId)
      case 'batchRemove':
        return await batchRemoveFromCart(OPENID, cartItemIds)
      case 'clear':
        return await clearCart(OPENID, userId)
      default:
        return { success: false, message: '未知操作' }
    }
  } catch (error) {
    console.error('[cartManager] 错误:', error)
    return { success: false, message: error.message }
  }
}

// 获取购物车列表
async function getCartList(openid, userId) {
  const res = await db.collection('carts')
    .where({ _openid: openid })
    .orderBy('addTime', 'desc')
    .get()
  
  return { success: true, data: res.data || [] }
}

// 添加商品到购物车
async function addToCart(openid, userId, cartItem) {
  const now = new Date().toISOString()
  
  // 检查是否已存在相同商品和规格
  const existingRes = await db.collection('carts')
    .where({
      _openid: openid,
      productId: cartItem.productId,
      spec1: cartItem.spec1 || '',
      spec2: cartItem.spec2 || ''
    })
    .get()
  
  if (existingRes.data && existingRes.data.length > 0) {
    // 已存在，增加数量
    const existing = existingRes.data[0]
    await db.collection('carts').doc(existing._id).update({
      data: {
        quantity: _.inc(cartItem.quantity || 1),
        updateTime: now
      }
    })
    return { success: true, data: { cartItemId: existing._id, action: 'updated' } }
  } else {
    // 不存在，添加新项
    const res = await db.collection('carts').add({
      data: {
        _openid: openid,
        userId: userId || '',
        productId: cartItem.productId,
        productName: cartItem.productName || '',
        productImage: cartItem.productImage || '',
        artistName: cartItem.artistName || '',
        price: cartItem.price || '0.00',
        quantity: cartItem.quantity || 1,
        spec1: cartItem.spec1 || '',
        spec2: cartItem.spec2 || '',
        deliveryDays: cartItem.deliveryDays || 7,
        selected: false,
        addTime: now,
        updateTime: now
      }
    })
    return { success: true, data: { cartItemId: res._id, action: 'added' } }
  }
}

// 更新购物车项
async function updateCartItem(openid, cartItemId, updates) {
  const now = new Date().toISOString()
  
  const res = await db.collection('carts')
    .where({
      _id: cartItemId,
      _openid: openid
    })
    .update({
      data: {
        ...updates,
        updateTime: now
      }
    })
  
  return { success: true, data: { updated: res.stats.updated } }
}

// 删除购物车项
async function removeFromCart(openid, cartItemId) {
  const res = await db.collection('carts')
    .where({
      _id: cartItemId,
      _openid: openid
    })
    .remove()
  
  return { success: true, data: { deleted: res.stats.removed } }
}

// 批量删除购物车项
async function batchRemoveFromCart(openid, cartItemIds) {
  const res = await db.collection('carts')
    .where({
      _id: _.in(cartItemIds),
      _openid: openid
    })
    .remove()
  
  return { success: true, data: { count: res.stats.removed } }
}

// 清空购物车
async function clearCart(openid, userId) {
  const res = await db.collection('carts')
    .where({ _openid: openid })
    .remove()
  
  return { success: true, data: { count: res.stats.removed } }
}
```

---

## 四、前端迁移步骤

### 1. 修改 `miniprogram/pages/cart/index.js`

#### 修改前（本地存储）

```javascript
async loadCart() {
  let cartItems = wx.getStorageSync('cart_items') || []
  // ...
}
```

#### 修改后（云端）

```javascript
async loadCart() {
  const cloudAPI = require('../../utils/cloud-api.js')
  const res = await cloudAPI.getCartList()
  let cartItems = res.success ? (res.data || []) : []
  // ...
}
```

### 2. 修改 `miniprogram/pages/product-detail/index.js`

#### 修改前（本地存储）

```javascript
addToCartDirect(product, spec1Name, spec2Name, quantity, price) {
  let cartItems = wx.getStorageSync('cart_items') || []
  // ...
  wx.setStorageSync('cart_items', cartItems)
}
```

#### 修改后（云端）

```javascript
async addToCartDirect(product, spec1Name, spec2Name, quantity, price) {
  const cloudAPI = require('../../utils/cloud-api.js')
  
  const cartItem = {
    productId: product.id,
    productName: product.name,
    productImage: product.images && product.images[0] ? product.images[0] : '',
    artistName: product.artistName || '画师',
    price: price.toFixed(2),
    quantity: quantity,
    spec1: spec1Name,
    spec2: spec2Name,
    deliveryDays: product.deliveryDays || 7
  }
  
  const res = await cloudAPI.addToCart(cartItem)
  if (!res.success) {
    wx.showToast({ title: '添加失败', icon: 'none' })
    return
  }
  // ...
}
```

### 3. 修改购物车操作

| 操作 | 本地存储方法 | 云端方法 |
|------|-------------|---------|
| 加载购物车 | `wx.getStorageSync('cart_items')` | `cloudAPI.getCartList()` |
| 添加商品 | `wx.setStorageSync('cart_items', ...)` | `cloudAPI.addToCart(cartItem)` |
| 更新数量 | `wx.setStorageSync('cart_items', ...)` | `cloudAPI.updateCartItem(id, { quantity })` |
| 删除商品 | `wx.setStorageSync('cart_items', ...)` | `cloudAPI.removeFromCart(id)` |
| 结算清空 | `wx.setStorageSync('cart_items', ...)` | `cloudAPI.batchRemoveFromCart(ids)` |

---

## 五、部署步骤

### 步骤 1：创建云数据库集合

1. 打开腾讯云开发控制台
2. 进入"云数据库"
3. 点击"新建集合"
4. 集合名称：`carts`
5. 权限设置：
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": "doc._openid == auth.openid"
   }
   ```

### 步骤 2：创建索引

在 `carts` 集合中创建以下索引：

1. **userId 索引**
   - 字段：`userId`
   - 类型：升序
   - 唯一：否

2. **productId 索引**
   - 字段：`productId`
   - 类型：升序
   - 唯一：否

3. **addTime 索引**
   - 字段：`addTime`
   - 类型：降序
   - 唯一：否

### 步骤 3：创建云函数

1. 在 `cloudfunctions/` 目录下创建 `cartManager/` 文件夹
2. 创建 `index.js` 文件（复制上面的云函数代码）
3. 创建 `package.json` 文件：

```json
{
  "name": "cartManager",
  "version": "1.0.0",
  "description": "购物车管理云函数",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

### 步骤 4：上传云函数

```bash
# 进入云函数目录
cd cloudfunctions/cartManager

# 安装依赖
npm install

# 返回项目根目录
cd ../..

# 使用微信开发者工具上传云函数
# 或使用 CLI
cloudbase functions:deploy cartManager
```

### 步骤 5：测试云函数

在控制台测试云函数：

```javascript
// 测试添加购物车
{
  "action": "add",
  "userId": "1001",
  "cartItem": {
    "productId": "test_product_1",
    "productName": "测试商品",
    "price": "99.00",
    "quantity": 1
  }
}

// 测试获取购物车
{
  "action": "getList",
  "userId": "1001"
}
```

### 步骤 6：迁移前端代码

按照"前端迁移步骤"逐个修改相关页面

### 步骤 7：数据迁移（可选）

如果需要迁移现有购物车数据：

```javascript
// 在控制台或页面中执行一次性迁移脚本
async function migrateCart() {
  const oldCart = wx.getStorageSync('cart_items') || []
  const cloudAPI = require('../../utils/cloud-api.js')
  
  for (const item of oldCart) {
    await cloudAPI.addToCart(item)
  }
  
  console.log(`✅ 已迁移 ${oldCart.length} 个购物车项`)
  // 迁移完成后清空本地缓存
  // wx.removeStorageSync('cart_items')
}
```

---

## 六、验证清单

### 功能验证

- [ ] 添加商品到购物车
- [ ] 查看购物车列表
- [ ] 修改商品数量
- [ ] 删除商品
- [ ] 全选/取消全选
- [ ] 结算并清空已选商品
- [ ] 多设备同步（在不同设备登录同一账号）

### 性能验证

- [ ] 购物车加载速度（< 2秒）
- [ ] 添加商品响应速度（< 1秒）
- [ ] 更新数量响应速度（< 1秒）
- [ ] 批量操作响应速度（< 3秒）

### 边界测试

- [ ] 添加大量商品（50+）
- [ ] 相同商品不同规格
- [ ] 网络断开时的错误处理
- [ ] 云函数调用失败时的降级策略

---

## 七、回滚方案

如果云端化后出现问题，可以快速回滚到本地存储：

### 临时回滚（保留云端代码）

在 `cloud-api.js` 中添加降级逻辑：

```javascript
async getCartList(options = {}) {
  try {
    const res = await this.callFunction('cartManager', {
      action: 'getList',
      ...options
    })
    if (res.success) return res
  } catch (error) {
    console.warn('[购物车] 云端获取失败，使用本地缓存')
  }
  
  // 降级到本地存储
  const localCart = wx.getStorageSync('cart_items') || []
  return { success: true, data: localCart }
}
```

### 完全回滚

1. 恢复 `pages/cart/index.js` 和 `pages/product-detail/index.js` 的原始代码
2. 保留 `cartManager` 云函数（不删除）
3. 待问题修复后再次迁移

---

## 八、后续优化

### P3 优先级

1. **离线支持**
   - 添加本地缓存作为离线副本
   - 网络恢复后自动同步

2. **智能推荐**
   - 根据购物车内容推荐相关商品
   - 基于浏览历史推荐

3. **过期清理**
   - 定时清理超过30天未结算的购物车项
   - 商品下架后自动移除

4. **性能优化**
   - 添加购物车数量缓存
   - 减少不必要的云函数调用

---

## 九、总结

### 优势

1. **多设备同步**：云端购物车，换设备也能看到
2. **数据安全**：不再依赖本地存储，数据更安全
3. **可扩展性**：便于未来添加购物车相关功能
4. **符合规范**：符合严格云端模式要求

### 劣势

1. **网络依赖**：离线时无法查看购物车（可通过降级优化）
2. **调用开销**：每次操作都需要调用云函数（可添加缓存）

### 预计工作量

| 任务 | 预计时间 |
|------|---------|
| 创建云函数 | 2 小时 |
| 创建数据库集合 | 30 分钟 |
| 修改前端代码 | 4 小时 |
| 测试验证 | 2 小时 |
| **总计** | **约 1 天** |

---

**文档结束**

**创建时间**：2025-11-22  
**下一步行动**：按照部署步骤执行购物车云端化

