# 下一步操作指南

> **当前状态**：数据库准备完成 ✅  
> **已完成**：13个集合 + 26个索引  
> **下一步**：初始化管理员 + 数据迁移测试

---

## ✅ 已完成内容

### 1. 集合创建（13个）

**公开展示类（5个）**：
- ✅ products - 商品表
- ✅ banners - 轮播图
- ✅ notices - 公告
- ✅ categories - 分类
- ✅ service_qrcodes - 客服二维码

**云函数控制类（8个）**：
- ✅ users - 用户表
- ✅ orders - 订单表
- ✅ buyer_shows - 买家秀
- ✅ artist_applications - 画师申请
- ✅ income_ledger - 收入账本
- ✅ withdraw_records - 提现记录
- ✅ reward_records - 打赏记录
- ✅ system_admin - 管理员表

### 2. 索引创建（26个）

- ✅ artist_applications：3个索引
- ✅ income_ledger：4个索引
- ✅ orders：10个索引
- ✅ products：4个索引
- ✅ users：2个索引
- ✅ withdraw_records：3个索引

---

## 📋 下一步操作

### 步骤1：初始化管理员账户 ⚠️ 重要

**为什么需要？**
- 云函数权限控制依赖管理员表
- 需要先添加第一个管理员，才能使用管理后台

**操作步骤**：

#### 1.1 获取您的 openid

在微信开发者工具的控制台执行：

```javascript
// 方式一：获取当前用户的openid
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('您的openid:', res.result.openid)
    // 复制这个openid，待会要用
  }
})
```

**如果没有login云函数，使用方式二**：

```javascript
// 方式二：在app.js的onLaunch中查看
// 打开 miniprogram/app.js，在onLaunch中添加：
console.log('当前openid:', wx.getStorageSync('openid'))
```

#### 1.2 手动添加管理员记录

1. 打开云开发控制台 → 数据库
2. 点击 `system_admin` 集合
3. 点击"添加记录"按钮
4. 切换到"导入"或"手动输入"模式
5. 输入以下数据（**替换openid为您的真实openid**）：

```json
{
  "_openid": "您的openid粘贴在这里",
  "isAdmin": true,
  "adminLevel": "super",
  "nickName": "超级管理员",
  "createdAt": "2025-11-12 10:00:00"
}
```

6. 点击"确定"
7. 刷新集合，应该能看到新增的管理员记录

✅ **完成后，您就是第一个管理员了！**

---

### 步骤2：数据迁移测试（可选）

**情况A：有本地测试数据需要迁移**

如果您在开发过程中已经有了订单、商品等测试数据，可以迁移到云数据库。

**操作方式**：
1. 在开发者工具控制台执行迁移脚本
2. 我可以为您生成迁移脚本

**是否需要迁移测试数据？** 回复"需要迁移"，我会生成脚本。

---

**情况B：从零开始，无需迁移**

如果是全新项目，可以跳过迁移，直接进入下一步。

---

### 步骤3：切换API模式

当管理员初始化完成后，需要修改代码，让前端开始使用云数据库。

#### 3.1 修改环境配置

打开 `miniprogram/config/env.js`：

```javascript
const currentEnv = 'dev'  // 当前是开发环境

module.exports = {
  // ...
  useMockData: true,  // ← 改为 false 开始使用云数据库
  // ...
}
```

**建议**：先保持 `useMockData: true`，等云函数开发完成后再切换。

---

### 步骤4：开发云函数API（核心工作）

由于users、orders等8个集合设置为"仅创建者可读写"，前端无法直接读取，必须开发云函数。

**需要开发的云函数**：

#### 4.1 用户模块
- `getUserList` - 获取用户列表（管理员查看所有，普通用户只看自己）
- `updateUserInfo` - 更新用户信息

#### 4.2 订单模块
- `getOrderList` - 获取订单列表（多角色权限）
- `createOrder` - 创建订单
- `updateOrderStatus` - 更新订单状态

#### 4.3 财务模块
- `getIncomeList` - 获取收入列表
- `submitWithdraw` - 提交提现申请
- `approveWithdraw` - 审核提现（管理员）

#### 4.4 画师申请
- `submitApplication` - 提交申请
- `getApplicationList` - 获取申请列表
- `approveApplication` - 审核申请（管理员）

**参考代码**：查看《云函数示例-权限控制.js》

---

### 步骤5：前端API调用替换

将前端的Storage读取改为云函数调用。

**示例**：

```javascript
// 修改前（读取本地Storage）
const orders = wx.getStorageSync('pending_orders') || []

// 修改后（调用云函数）
wx.cloud.callFunction({
  name: 'getOrderList',
  data: { status: 'inProgress' },
  success: res => {
    const orders = res.result.data
    // 使用订单数据
  }
})
```

---

## 🎯 推荐工作顺序

### 第1周：云函数基础

1. ✅ **完成**：数据库准备（集合+索引）
2. ⏳ **今天**：初始化管理员账户
3. ⏳ **本周**：开发3个最基础的云函数
   - getUserList（用户列表）
   - getOrderList（订单列表）
   - createOrder（创建订单）

### 第2周：完善云函数

4. 开发剩余云函数（财务、画师申请等）
5. 测试云函数权限控制
6. 前端逐步替换API调用

### 第3周：数据迁移与测试

7. 迁移测试数据到云数据库
8. 全面测试各角色权限
9. 性能优化和错误处理

### 第4周：上线准备

10. 修改 `useMockData: false`
11. 完整功能测试
12. 准备正式上线

---

## 📝 当前任务清单

**立即执行**：
- [ ] 初始化管理员账户（步骤1）

**本周内**：
- [ ] 决定是否需要数据迁移（步骤2）
- [ ] 开发第一个云函数 getUserList（步骤4.1）
- [ ] 测试云函数是否能正确返回数据

**后续任务**：
- [ ] 开发其他云函数
- [ ] 前端API调用替换
- [ ] 切换到云数据库模式

---

## 🆘 需要帮助？

**接下来我可以帮您**：

1. **生成数据迁移脚本**（如果需要）
2. **开发云函数代码**（逐个实现）
3. **前端API调用改造**（批量替换）

**请告诉我**：
- "开始开发云函数" → 我会从第一个云函数开始
- "需要迁移数据" → 我会生成迁移脚本
- "先初始化管理员" → 我会指导详细步骤

---

**恭喜您完成了后端接入的第一大步！💪**

