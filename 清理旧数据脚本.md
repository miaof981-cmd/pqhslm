# 清理旧数据脚本

## 🎯 为什么需要清理

旧数据中的图片路径是**临时路径**（`http://tmp/wxfile_xxxxx.jpg`），已经失效。
新代码使用**base64永久路径**（`data:image/jpeg;base64,xxx`），不会失效。

必须清理旧数据，重新创建商品，才能使用新的永久路径。

---

## 🧹 清理脚本

### 方法1: 清理所有数据（推荐）

在微信开发者工具的**控制台**中执行：

```javascript
// 清理所有旧数据
wx.removeStorageSync('mock_products')
wx.removeStorageSync('cart_items')
wx.removeStorageSync('pending_orders')
wx.removeStorageSync('completed_orders')

console.log('✅ 已清理所有旧数据（包含临时路径）')
console.log('请重新创建商品，图片将自动转换为永久路径')
```

### 方法2: 只清理商品数据

如果不想清理订单，只清理商品：

```javascript
// 只清理商品数据
wx.removeStorageSync('mock_products')
wx.removeStorageSync('cart_items')

console.log('✅ 已清理商品和购物车数据')
console.log('订单数据已保留')
```

### 方法3: 查看数据后再决定

先查看现有数据：

```javascript
// 查看所有数据
console.log('=== 本地存储数据检查 ===')

const products = wx.getStorageSync('mock_products') || []
console.log('\n【商品数据】')
console.log('数量:', products.length)
products.forEach(p => {
  console.log(`- ${p.name}`)
  console.log('  图片:', p.images?.[0]?.substring(0, 50) + '...')
  console.log('  是否临时路径:', p.images?.[0]?.includes('tmp'))
})

const cart = wx.getStorageSync('cart_items') || []
console.log('\n【购物车数据】')
console.log('数量:', cart.length)

const orders = wx.getStorageSync('pending_orders') || []
console.log('\n【订单数据】')
console.log('数量:', orders.length)

// 如果确认要清理，执行：
// wx.removeStorageSync('mock_products')
// wx.removeStorageSync('cart_items')
// wx.removeStorageSync('pending_orders')
```

---

## ✅ 验证新图片路径

清理数据后，重新创建商品，然后验证：

```javascript
// 验证新商品的图片路径
const products = wx.getStorageSync('mock_products') || []
if (products.length > 0) {
  const lastProduct = products[0]
  console.log('=== 新商品图片验证 ===')
  console.log('商品名称:', lastProduct.name)
  console.log('图片路径:', lastProduct.images[0]?.substring(0, 100) + '...')
  console.log('是否 base64:', lastProduct.images[0]?.startsWith('data:image'))
  console.log('是否临时路径:', lastProduct.images[0]?.includes('tmp'))
  
  if (lastProduct.images[0]?.startsWith('data:image')) {
    console.log('✅ 图片已转换为永久路径（base64）')
    console.log('✅ 小程序重启后仍然有效')
  } else {
    console.log('❌ 图片仍是临时路径，请检查代码')
  }
} else {
  console.log('⚠️ 暂无商品数据，请先创建商品')
}
```

---

## 🧪 完整测试流程

### 1. 清理旧数据
```javascript
wx.removeStorageSync('mock_products')
wx.removeStorageSync('cart_items')
wx.removeStorageSync('pending_orders')
console.log('✅ 已清理')
```

### 2. 重新编译小程序
- 点击"编译"按钮

### 3. 创建新商品
- 进入"工作台" → "商品管理" → "上传商品"
- 选择图片（会自动转换为 base64）
- 填写商品信息
- 发布商品

### 4. 查看控制台日志
应该看到：
```
✅ 图片转换成功，大小: 123.45 KB
✅ 图片已转换为永久路径（base64），不会失效
```

### 5. 验证图片路径
```javascript
const products = wx.getStorageSync('mock_products') || []
console.log('图片路径:', products[0].images[0].substring(0, 50))
// 应该输出: data:image/jpeg;base64,/9j/4AAQSkZJRg...
```

### 6. 重启测试
- 停止小程序
- 重新编译
- 查看商品图片是否仍然显示 ✅

---

## 📊 预期结果

### 修复前（临时路径）
```
图片路径: http://tmp/wxfile_abc123.jpg
是否 base64: false  ❌
是否临时路径: true  ❌
重启后: 图片不显示  ❌
```

### 修复后（永久路径）
```
图片路径: data:image/jpeg;base64,/9j/4AAQSkZJRg...
是否 base64: true  ✅
是否临时路径: false  ✅
重启后: 图片正常显示  ✅
```

---

## ⚠️ 注意事项

1. **清理数据会删除所有商品和订单**
   - 如果有重要数据，请先备份
   - 或者只清理商品数据，保留订单

2. **图片大小建议**
   - 单张图片建议 < 500KB
   - 总共不超过 9 张
   - 本地存储总限制 10MB

3. **如果图片太大**
   - 选择图片时已自动压缩（`compressed`）
   - 如果仍然太大，可以在上传前手动压缩

4. **旧订单的图片**
   - 旧订单中的图片路径仍是临时路径
   - 如果需要显示，需要重新下单
   - 或者手动清理订单数据

---

## 🎉 完成

执行清理脚本后，重新创建商品，图片就永远不会失效了！

