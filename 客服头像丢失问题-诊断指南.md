# å®¢æœå¤´åƒä¸¢å¤±é—®é¢˜ - è¯Šæ–­æŒ‡å—

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- âœ… è®¢å•æˆåŠŸé¡µé¢ï¼šå®¢æœå¤´åƒæ­£å¸¸æ˜¾ç¤º
- âŒ è®¢å•åˆ—è¡¨é¡µé¢ï¼šå®¢æœå¤´åƒä¸ºç©ºï¼ˆç°è‰²é»˜è®¤å¤´åƒï¼‰

**å½±å“èŒƒå›´ï¼š**
- è®¢å•åˆ—è¡¨é¡µé¢ï¼ˆ`order-list/index`ï¼‰
- å¯èƒ½å½±å“å…¶ä»–é¡µé¢ï¼ˆç”»å¸ˆå·¥ä½œå°ã€å®¢æœå·¥ä½œå°ã€ç®¡ç†åå°ï¼‰

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥è®¢å•ä¿å­˜æ—¶çš„æ•°æ®

åœ¨æ§åˆ¶å°è¿è¡Œä»¥ä¸‹è„šæœ¬ï¼Œæ£€æŸ¥è®¢å•ä¸­æ˜¯å¦æ­£ç¡®ä¿å­˜äº†å®¢æœå¤´åƒï¼š

```javascript
// æ£€æŸ¥æœ€æ–°è®¢å•çš„å®¢æœå¤´åƒ
const orders = wx.getStorageSync('pending_orders') || []
const latest = orders[orders.length - 1]

console.log('ğŸ“¦ æœ€æ–°è®¢å•:', latest.id)
console.log('å®¢æœå:', latest.serviceName)
console.log('å®¢æœå¤´åƒ:', latest.serviceAvatar)
console.log('å®¢æœå¤´åƒé•¿åº¦:', latest.serviceAvatar ? latest.serviceAvatar.length : 0)
```

**é¢„æœŸç»“æœï¼š**
- `serviceAvatar` åº”è¯¥æ˜¯ä¸€ä¸ª URL å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼š`https://thirdwx.qlogo.cn/...`ï¼‰
- é•¿åº¦åº”è¯¥ > 0

**å¦‚æœä¸ºç©ºï¼š**
- é—®é¢˜åœ¨**è®¢å•ä¿å­˜é˜¶æ®µ**ï¼ˆ`order-success/index.js`ï¼‰
- æ£€æŸ¥ `assignService()` è¿”å›çš„ `serviceAvatar` æ˜¯å¦æ­£ç¡®

---

### æ­¥éª¤2ï¼šæ£€æŸ¥å®¢æœåˆ—è¡¨æ•°æ®

```javascript
// æ£€æŸ¥å®¢æœåˆ—è¡¨
const services = wx.getStorageSync('customer_service_list') || []
console.log('å®¢æœæ€»æ•°:', services.length)

services.forEach((s, i) => {
  console.log(`\nå®¢æœ${i+1}:`, s.name || s.nickName)
  console.log('  userId:', s.userId || s.id)
  console.log('  avatar:', s.avatar)
  console.log('  avatarUrl:', s.avatarUrl)
  console.log('  isActive:', s.isActive)
})
```

**é¢„æœŸç»“æœï¼š**
- è‡³å°‘æœ‰1ä¸ªå®¢æœ
- å®¢æœçš„ `avatar` æˆ– `avatarUrl` å­—æ®µåº”è¯¥æœ‰å€¼

**å¦‚æœä¸ºç©ºï¼š**
- é—®é¢˜åœ¨**å®¢æœæ•°æ®æº**
- éœ€è¦åœ¨å®¢æœç®¡ç†é¡µé¢è®¾ç½®å®¢æœå¤´åƒ

---

### æ­¥éª¤3ï¼šæ£€æŸ¥å½’ä¸€åŒ–è¿‡ç¨‹ï¼ˆå·²æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼‰

åˆ·æ–°è®¢å•åˆ—è¡¨é¡µé¢ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š

```
ğŸ” [order-helper] è®¢å• 202511051624265956 åŸå§‹æ•°æ®:
  - serviceName: å¦™å¦™
  - serviceAvatar: https://thirdwx.qlogo.cn/...
  - è®¡ç®—çŠ¶æ€å serviceAvatar: https://thirdwx.qlogo.cn/...
  - æœ€ç»ˆ serviceAvatar: https://thirdwx.qlogo.cn/...
  - rawServiceAvatar: https://thirdwx.qlogo.cn/...
```

**åˆ†æï¼š**
- **åŸå§‹æ•°æ®ä¸ºç©º** â†’ é—®é¢˜åœ¨æ­¥éª¤1ï¼ˆè®¢å•ä¿å­˜ï¼‰
- **è®¡ç®—çŠ¶æ€åä¸ºç©º** â†’ `calculateOrderStatus()` æ¸…ç©ºäº†å­—æ®µ
- **æœ€ç»ˆç»“æœä¸ºç©º** â†’ å½’ä¸€åŒ–é€»è¾‘æœ‰é—®é¢˜

---

## ğŸ› å¯èƒ½çš„é—®é¢˜åŸå› 

### åŸå› 1ï¼šè®¢å•ä¿å­˜æ—¶å®¢æœå¤´åƒæœªæ­£ç¡®è·å–

**ä½ç½®ï¼š** `miniprogram/pages/order-success/index.js` ç¬¬156-183è¡Œ

```javascript
assignService() {
  // ...
  const assignedService = finalActiveServices[randomIndex]
  
  return {
    serviceId: assignedService.userId || assignedService.id,
    serviceName: assignedService.name || assignedService.nickName || 'åœ¨çº¿å®¢æœ',
    serviceAvatar: assignedService.avatar || assignedService.avatarUrl || '',  // âš ï¸ å¯èƒ½ä¸ºç©º
    // ...
  }
}
```

**é—®é¢˜ï¼š**
- `assignedService.avatar` å’Œ `assignedService.avatarUrl` éƒ½ä¸ºç©º
- è¿”å›ç©ºå­—ç¬¦ä¸² `''`

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿å®¢æœåˆ—è¡¨ä¸­æœ‰å¤´åƒæ•°æ®
- æˆ–è€…ä½¿ç”¨é»˜è®¤å¤´åƒï¼ˆä½†ä¸æ¨èï¼Œåº”è¯¥åœ¨WXMLå±‚å…œåº•ï¼‰

---

### åŸå› 2ï¼šå®¢æœåˆ—è¡¨æ•°æ®ç»“æ„ä¸ä¸€è‡´

**é—®é¢˜ï¼š**
å®¢æœæ•°æ®å¯èƒ½æœ‰å¤šç§å­—æ®µåï¼š
- `avatar` vs `avatarUrl`
- `userId` vs `id`
- `name` vs `nickName`

**è§£å†³æ–¹æ¡ˆï¼š**
ç»Ÿä¸€å®¢æœæ•°æ®ç»“æ„ï¼Œç¡®ä¿æ‰€æœ‰å®¢æœéƒ½æœ‰ `avatar` æˆ– `avatarUrl` å­—æ®µã€‚

---

### åŸå› 3ï¼šå½’ä¸€åŒ–é€»è¾‘è¦†ç›–äº†åŸå§‹æ•°æ®

**ä½ç½®ï¼š** `miniprogram/utils/order-helper.js` ç¬¬100-113è¡Œ

```javascript
// === 6ï¸âƒ£ æœ€åå†æ¬¡ç¡®ä¿ä¸è¦†ç›–åŸå€¼ï¼ˆä½†ä¸æ¢å¤é”™è¯¯å€¼ï¼‰===
if (rawServiceAvatar) {
  processed.serviceAvatar = rawServiceAvatar  // âš ï¸ å¦‚æœ rawServiceAvatar æ˜¯ç©ºå­—ç¬¦ä¸² ''
}
```

**é—®é¢˜ï¼š**
- å¦‚æœåŸå§‹è®¢å•çš„ `serviceAvatar` æ˜¯ç©ºå­—ç¬¦ä¸² `''`ï¼ˆè€Œä¸æ˜¯ `undefined` æˆ– `null`ï¼‰
- `if (rawServiceAvatar)` ä¼šåˆ¤æ–­ä¸º `false`
- å¯¼è‡´å³ä½¿ç¬¬5æ­¥è¡¥å……äº†å®¢æœå¤´åƒï¼Œä¹Ÿä¼šè¢«æ¸…ç©º

**è§£å†³æ–¹æ¡ˆï¼š**
ä¿®æ”¹åˆ¤æ–­æ¡ä»¶ï¼š
```javascript
if (rawServiceAvatar && rawServiceAvatar !== '') {
  processed.serviceAvatar = rawServiceAvatar
}
```

---

### åŸå› 4ï¼š`calculateOrderStatus` è¿”å›çš„å¯¹è±¡ç¼ºå°‘å­—æ®µ

**ä½ç½®ï¼š** `miniprogram/utils/order-status.js` ç¬¬115-121è¡Œ

```javascript
return {
  ...order,  // âš ï¸ å±•å¼€åŸå§‹è®¢å•
  status,
  statusText,
  urgent
}
```

**é—®é¢˜ï¼š**
- ç†è®ºä¸Š `...order` åº”è¯¥ä¿ç•™æ‰€æœ‰å­—æ®µ
- ä½†å¦‚æœ `order.serviceAvatar` æœ¬èº«å°±æ˜¯ç©ºçš„ï¼Œå±•å¼€åä»ç„¶æ˜¯ç©ºçš„

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿è®¢å•ä¿å­˜æ—¶ `serviceAvatar` ä¸ä¸ºç©º

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ç©ºå­—ç¬¦ä¸²åˆ¤æ–­ï¼ˆæ¨èï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š** `miniprogram/utils/order-helper.js` ç¬¬111-113è¡Œ

```javascript
// å½“å‰ä»£ç ï¼š
if (rawServiceAvatar) {
  processed.serviceAvatar = rawServiceAvatar
}

// ä¿®æ”¹ä¸ºï¼š
if (rawServiceAvatar && rawServiceAvatar !== '') {
  processed.serviceAvatar = rawServiceAvatar
}
```

**åŸå› ï¼š**
- ç©ºå­—ç¬¦ä¸² `''` åœ¨ `if` åˆ¤æ–­ä¸­ä¸º `false`
- ä½†å®é™…ä¸Šæˆ‘ä»¬æƒ³è¦çš„æ˜¯"å¦‚æœæœ‰éç©ºå€¼ï¼Œå°±æ¢å¤"
- æ˜ç¡®æ’é™¤ç©ºå­—ç¬¦ä¸²

---

### æ–¹æ¡ˆ2ï¼šç¡®ä¿å®¢æœåˆ—è¡¨æœ‰å¤´åƒæ•°æ®

**æ­¥éª¤ï¼š**
1. æ£€æŸ¥ `customer_service_list` ä¸­æ‰€æœ‰å®¢æœæ˜¯å¦æœ‰ `avatar` æˆ– `avatarUrl`
2. å¦‚æœæ²¡æœ‰ï¼Œåœ¨å®¢æœç®¡ç†é¡µé¢è®¾ç½®
3. æˆ–è€…åœ¨ `assignService()` ä¸­ä½¿ç”¨é»˜è®¤å¤´åƒï¼š

```javascript
serviceAvatar: assignedService.avatar || assignedService.avatarUrl || DEFAULT_AVATAR_DATA
```

---

### æ–¹æ¡ˆ3ï¼šå¢å¼ºç¬¬5æ­¥çš„è¡¥å……é€»è¾‘

**ä¿®æ”¹æ–‡ä»¶ï¼š** `miniprogram/utils/order-helper.js` ç¬¬74-98è¡Œ

```javascript
// å½“å‰ä»£ç ï¼š
if ((!processed.serviceName || processed.serviceName === 'å¾…åˆ†é…' || processed.serviceName === 'å®¢æœæœªåˆ†é…') && services.length > 0) {
  // è¡¥å……å®¢æœä¿¡æ¯
}

// ä¿®æ”¹ä¸ºï¼š
// è¡¥å……å®¢æœåç§°æˆ–å¤´åƒï¼ˆåªè¦æœ‰ä¸€ä¸ªä¸ºç©ºå°±å°è¯•è¡¥å……ï¼‰
if ((!processed.serviceName || processed.serviceName === 'å¾…åˆ†é…' || processed.serviceName === 'å®¢æœæœªåˆ†é…' || !processed.serviceAvatar) && services.length > 0) {
  let matched = null
  
  // ä¼˜å…ˆé€šè¿‡ serviceId åŒ¹é…
  if (processed.serviceId) {
    matched = services.find(
      s => String(s.userId) === String(processed.serviceId) || String(s.id) === String(processed.serviceId)
    )
  }
  
  // å¦‚æœæ²¡æœ‰ serviceId æˆ–åŒ¹é…å¤±è´¥ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªåœ¨çº¿å®¢æœ
  if (!matched) {
    matched = services.find(s => s.isActive) || services[0]
  }
  
  if (matched) {
    // åªè¡¥å……ç¼ºå¤±çš„å­—æ®µ
    if (!processed.serviceId) {
      processed.serviceId = matched.userId || matched.id
    }
    if (!processed.serviceName || processed.serviceName === 'å¾…åˆ†é…' || processed.serviceName === 'å®¢æœæœªåˆ†é…') {
      processed.serviceName = matched.name || matched.nickName || 'åœ¨çº¿å®¢æœ'
    }
    if (!processed.serviceAvatar) {
      processed.serviceAvatar = matched.avatar || matched.avatarUrl || ''
    }
  }
}
```

---

## ğŸ”§ ç«‹å³æ‰§è¡Œçš„ä¿®å¤è„šæœ¬

å¦‚æœç¡®è®¤æ˜¯è®¢å•æ•°æ®ä¸­å®¢æœå¤´åƒä¸ºç©ºï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹è„šæœ¬ä¿®å¤ï¼š

```javascript
// ä¿®å¤æ‰€æœ‰è®¢å•çš„å®¢æœå¤´åƒ
console.log('=== ä¿®å¤å®¢æœå¤´åƒ ===\n')

const orders = wx.getStorageSync('pending_orders') || []
const services = wx.getStorageSync('customer_service_list') || []

if (services.length === 0) {
  console.log('âŒ å®¢æœåˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•ä¿®å¤')
} else {
  let fixedCount = 0
  
  orders.forEach(order => {
    // å¦‚æœå®¢æœå¤´åƒä¸ºç©ºæˆ–ç©ºå­—ç¬¦ä¸²
    if (!order.serviceAvatar || order.serviceAvatar === '') {
      if (order.serviceId) {
        // é€šè¿‡ serviceId åŒ¹é…å®¢æœ
        const matched = services.find(
          s => String(s.userId) === String(order.serviceId) || String(s.id) === String(order.serviceId)
        )
        if (matched && (matched.avatar || matched.avatarUrl)) {
          order.serviceAvatar = matched.avatar || matched.avatarUrl
          fixedCount++
          console.log(`âœ… ä¿®å¤è®¢å• ${order.id} çš„å®¢æœå¤´åƒ`)
        }
      } else if (order.serviceName && order.serviceName !== 'å¾…åˆ†é…') {
        // é€šè¿‡ serviceName åŒ¹é…å®¢æœ
        const matched = services.find(
          s => s.name === order.serviceName || s.nickName === order.serviceName
        )
        if (matched && (matched.avatar || matched.avatarUrl)) {
          order.serviceId = matched.userId || matched.id
          order.serviceAvatar = matched.avatar || matched.avatarUrl
          fixedCount++
          console.log(`âœ… ä¿®å¤è®¢å• ${order.id} çš„å®¢æœå¤´åƒ`)
        }
      }
    }
  })
  
  wx.setStorageSync('pending_orders', orders)
  console.log(`\nâœ… ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ ${fixedCount} ä¸ªè®¢å•`)
  console.log('ğŸ”„ è¯·åˆ·æ–°è®¢å•åˆ—è¡¨é¡µé¢')
}
```

---

## ğŸ“Š è¯Šæ–­æ£€æŸ¥æ¸…å•

- [ ] æ­¥éª¤1ï¼šè®¢å•ä¸­æ˜¯å¦ä¿å­˜äº† `serviceAvatar`ï¼Ÿ
- [ ] æ­¥éª¤2ï¼šå®¢æœåˆ—è¡¨ä¸­æ˜¯å¦æœ‰ `avatar` æˆ– `avatarUrl`ï¼Ÿ
- [ ] æ­¥éª¤3ï¼šå½’ä¸€åŒ–è¿‡ç¨‹ä¸­ `serviceAvatar` æ˜¯å¦è¢«æ¸…ç©ºï¼Ÿ
- [ ] æ£€æŸ¥ `assignService()` è¿”å›çš„æ•°æ®ç»“æ„
- [ ] æ£€æŸ¥ `order-helper.js` çš„ç©ºå­—ç¬¦ä¸²åˆ¤æ–­
- [ ] è¿è¡Œä¿®å¤è„šæœ¬æ¢å¤æ—§è®¢å•æ•°æ®

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **è¿è¡Œè¯Šæ–­è„šæœ¬**ï¼ˆæ­¥éª¤1-3ï¼‰
2. **æ ¹æ®è¯Šæ–­ç»“æœé€‰æ‹©ä¿®å¤æ–¹æ¡ˆ**
3. **è¿è¡Œä¿®å¤è„šæœ¬**ï¼ˆå¦‚æœéœ€è¦ï¼‰
4. **æµ‹è¯•æ–°è®¢å•**ï¼šé‡æ–°ä¸‹å•ï¼Œç¡®è®¤å®¢æœå¤´åƒæ­£ç¡®æ˜¾ç¤º
5. **æ¸…ç†è°ƒè¯•æ—¥å¿—**ï¼šä¿®å¤å®Œæˆåç§»é™¤ `order-helper.js` ä¸­çš„è°ƒè¯•ä»£ç 

