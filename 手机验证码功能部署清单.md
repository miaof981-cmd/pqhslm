# 手机验证码功能 - 部署清单

## 📋 功能说明

在画师申请表单中添加手机验证码验证功能，提高申请真实性。

---

## ✅ 一、云端配置（必须手动操作）

### 1. 创建数据库集合

在微信云开发控制台 → 数据库中创建集合：

#### 集合名称：`sms_codes`

**字段说明**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| `_id` | string | 自动生成 |
| `phone` | string | 手机号 |
| `code` | string | 6位验证码 |
| `openid` | string | 用户openid |
| `verified` | boolean | 是否已验证 |
| `createdAt` | date | 创建时间 |
| `expiresAt` | date | 过期时间（5分钟） |
| `verifiedAt` | date | 验证时间（可选） |

**索引配置**：
| 索引字段 | 类型 | 唯一性 |
|---------|------|--------|
| `phone` | 升序 | 非唯一 |
| `createdAt` | 降序 | 非唯一 |

**权限设置**：
- 读：仅创建者可读
- 写：仅创建者可写

---

### 2. 上传云函数

上传以下云函数到云端：

#### `smsManager` 云函数
- 右键 `cloudfunctions/smsManager`
- 选择"上传并部署：云端安装依赖"
- 等待上传完成

#### 更新 `artistManager` 云函数
- 右键 `cloudfunctions/artistManager`  
- 选择"上传并部署：云端安装依赖"
- 等待上传完成

---

## 🎯 二、功能使用流程

### 用户操作流程

1. **填写基本信息**
   - 真实姓名
   - 年龄
   - 微信号

2. **手机验证**
   - 输入手机号
   - 点击"发送验证码"
   - 查看短信（开发测试阶段会弹窗显示）
   - 输入验证码

3. **完成申请**
   - 上传作品
   - 勾选同意条款
   - 点击提交

### 验证流程

```
用户输入手机号 
  ↓
点击"发送验证码"
  ↓
云函数生成6位随机码
  ↓
保存到数据库（5分钟有效）
  ↓
[测试环境] 弹窗显示验证码
[生产环境] 发送短信
  ↓
用户输入验证码
  ↓
点击提交申请
  ↓
先验证验证码是否正确
  ↓
验证通过 → 提交申请
验证失败 → 提示错误
```

---

## ⚠️ 三、开发测试模式

当前为**开发测试模式**，验证码会通过弹窗显示，不会真实发送短信。

### 测试步骤

1. 输入任意手机号（符合格式即可）
2. 点击"发送验证码"
3. 弹窗会显示验证码（例如：123456）
4. 复制验证码填入输入框
5. 提交申请

### 测试验证码示例

```
手机号：13800138000
验证码：在弹窗中查看（6位数字）
有效期：5分钟
```

---

## 🚀 四、生产环境配置（上线时必须）

### 方案1：使用微信云开发短信服务

1. **开通服务**
   - 云开发控制台 → 扩展能力 → 短信服务
   - 开通短信服务
   - 配置签名和模板

2. **修改代码**
   - 打开 `cloudfunctions/smsManager/index.js`
   - 找到第46行左右的注释代码
   - 取消注释：
   ```javascript
   await cloud.openapi.cloudbase.sendSms({
     env: cloud.DYNAMIC_CURRENT_ENV,
     content: `【联盟小程序】您的验证码是：${code}，5分钟内有效，请勿泄露。`,
     phoneNumberSet: [phone]
   })
   ```
   - **删除第61行**：`debugCode: code`（不能返回验证码）

3. **重新上传云函数**

---

### 方案2：使用第三方短信平台

如果使用阿里云、腾讯云短信服务：

1. 在云函数 `package.json` 中添加 SDK
2. 在 `sendVerificationCode` 函数中调用第三方API
3. 参考各平台官方文档

---

## 🔒 五、安全注意事项

### 必须实现的安全措施

✅ **已实现**：
- 60秒内不能重复发送
- 验证码5分钟有效期
- 验证后标记为已使用
- 手机号格式验证

⚠️ **建议增强**：
- [ ] 单个手机号每天限制发送次数（如10次）
- [ ] 单个IP每天限制发送次数
- [ ] 验证失败3次后锁定1小时
- [ ] 添加图形验证码（防机器人）

---

## 📊 六、数据库查询示例

### 查看验证码记录

```javascript
// 查询某个手机号的验证码
db.collection('sms_codes')
  .where({ phone: '13800138000' })
  .orderBy('createdAt', 'desc')
  .get()
```

### 清理过期验证码

```javascript
// 删除7天前的记录
const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
db.collection('sms_codes')
  .where({
    createdAt: db.command.lt(sevenDaysAgo)
  })
  .remove()
```

---

## 🎨 七、前端UI说明

### 验证码输入框

- 手机号输入框（带格式验证）
- 发送验证码按钮
  - 未发送：显示"发送验证码"
  - 倒计时中：显示"60s后重新发送"
  - 可重发：显示"重新发送"
- 验证码输入框（6位数字）

### 倒计时逻辑

```javascript
点击发送 → 禁用按钮 → 60秒倒计时 → 启用按钮
```

---

## 🐛 八、常见问题

### Q1：验证码收不到？
**A**：开发测试阶段验证码通过弹窗显示，不会发送真实短信

### Q2：提示"验证码已过期"？
**A**：验证码有效期5分钟，请重新获取

### Q3：提示"验证码已发送，请60秒后再试"？
**A**：防止频繁发送，请等待60秒

### Q4：生产环境如何发送真实短信？
**A**：参考"四、生产环境配置"章节

---

## 📝 九、代码文件清单

### 新增文件
- `cloudfunctions/smsManager/index.js` - 短信云函数
- `cloudfunctions/smsManager/package.json` - 依赖配置

### 修改文件
- `miniprogram/utils/cloud-api.js` - 新增验证码API
- `miniprogram/pages/apply/index.js` - 验证码逻辑
- `cloudfunctions/artistManager/index.js` - 保存手机号

---

## ✅ 十、部署检查清单

- [ ] 创建 `sms_codes` 数据库集合
- [ ] 配置集合索引
- [ ] 上传 `smsManager` 云函数
- [ ] 更新 `artistManager` 云函数
- [ ] 测试发送验证码（查看弹窗）
- [ ] 测试提交申请（验证码正确）
- [ ] 测试提交申请（验证码错误）
- [ ] 测试60秒防重复发送
- [ ] 测试验证码5分钟过期

---

## 🎉 完成！

现在手机验证码功能已经集成完成！

**开发测试阶段**：验证码会弹窗显示
**上线前必须**：配置真实短信服务并删除 `debugCode` 返回

