# 妙妙工作清单

> **更新时间**：2025-11-06  
> **使用说明**：此清单为唯一动态工作台，AI创建的报告都在"待阅览报告"区，看完即删

---

## 📌 待阅览报告区

> 👇 以下是AI生成的分析/修复报告，阅读后请删除对应行，避免报告堆积

- 📄 **后端接入准备文档已创建**：
  - **文件位置**：项目根目录 `后端接入准备文档.md`
  - **文档内容**：
    1. 当前数据存储结构（所有Storage Key和字段说明）
    2. 核心业务逻辑（订单流转、分成计算、库存管理、用户ID双轨制）
    3. 数据字段规范（必填/可选、类型约定、特殊字段）
    4. 需要替换的API位置（48个文件的详细列表）
    5. 迁移策略建议（渐进式迁移：双写→双读→纯后端）
    6. 关键注意事项（安全、性能、一致性、错误处理、日志监控）
    7. 测试建议和FAQ
  - **核心要点**：
    - 用户ID双轨制（userId vs artistNumber）
    - 订单终止态保护机制
    - iOS时间格式兼容（必须用parseDate）
    - 订单分成按数量计算
    - 库存实时扣减和回退
  - **API封装示例**：完整的 `utils/api.js` 代码
  - **迁移脚本**：用户/订单数据迁移示例
  - **适用场景**：从本地mock迁移到真实后端
- ✅ **iOS日期格式全局排查修复（最终版）**：
  - **问题**：`formatTimeForDisplay` 函数仍使用 `new Date(timestamp)` 导致iOS报错
  - **全局排查**：共修复5个文件中的15处日期解析问题
  - **修复清单**：
    1. `pages/admin/index.js` - `formatTimeForDisplay` 改用 `parseDate()`
    2. `pages/income-detail/index.js` - 4处：timestamp计算、formatTime、排序（2处）
    3. `pages/user-center/index.js` - 3处：申请排序（2处）、formatTime
    4. `pages/home/index.js` - 1处：公告排序
    5. 工具函数（`utils/order-status.js`、`utils/group-helper.js`）已正确处理
  - **验证方法**：所有linter检查通过，控制台无iOS日期警告
  - **影响范围**：所有涉及日期字符串解析的页面
  - **核心原则**：任何传入日期字符串的 `new Date()` 都必须改用 `parseDate()`
- ✅ **管理后台订单列表双重修复（根因彻底解决）**：
  - **问题1**：iOS日期格式报错 `new Date("11/06 10:28")` 无法解析
    - **根因1**：`formatTime` 只输出月-日时:分（无年份），然后**覆盖**原始 `createTime`/`deadline`
    - **后果1**：`filterOrdersByTime` 无法解析不完整的日期，导致订单被错误过滤
    - **修复1**：分离显示字段和逻辑字段
      - `createTime` / `deadline` 保留完整时间字符串（用于逻辑判断）
      - `createTimeDisplay` / `deadlineDisplay` 仅用于显示（月-日 时:分）
      - WXML使用 `*Display` 字段显示
  - **问题2**：点击订单标签后显示"加载中"但没有刷新，需手动点"全部"
    - **根因2**：`timeFilter` 默认值为 `'today'`，导致只显示今天的订单
    - **后果2**：测试订单如果不是今天创建，被 `filterOrdersByTime` 过滤掉
    - **修复2**：订单列表不应用时间筛选（`timeFilter` 仅用于仪表盘统计）
  - **影响文件**：
    - pages/admin/index.js（3处修改：formatTime逻辑、字段分离、移除时间筛选）
    - pages/admin/index.wxml（显示字段改为 `*Display`）
  - **验证步骤**：
    1. 点击订单标签 → 应立即显示所有历史订单（不限今日）
    2. 控制台应无iOS日期格式警告
    3. 时间显示正常：下单时间/截稿时间格式为 `11-06 10:28`
- ✅ **管理后台订单标签切换刷新优化**：
  - **需求1**：每次点击"订单"标签自动加载最新订单
  - **需求2**：立即显示"加载中"，不闪现"暂无订单"
  - **需求3**：保证渲染顺序：先setData再loadOrders()
  - **需求4**：标签切换时都触发刷新
  - **原有实现**：switchMainTab已设置orderLoading+orders清空，但互斥锁可能阻止重复加载
  - **优化点**：switchMainTab中增加`orderInFlight: false`重置互斥锁
  - **效果**：快速切换标签时也能保证重新加载，避免因互斥锁未释放导致的加载跳过
  - **影响文件**：pages/admin/index.js (switchMainTab函数)
  - **测试建议**：快速切换标签多次，每次都应显示"加载中"并正确加载订单
- ✅ **iOS日期格式兼容性修复（全局排查）**：
  - **问题**：`new Date("2025-11-06 10:28")` 在iOS下无法解析（iOS仅支持斜线`/`分隔或ISO格式`T`连接）
  - **影响范围**：所有使用日期字符串的页面和工具函数
  - **修复策略**：存储格式保持 `YYYY-MM-DD HH:mm`，解析时统一使用 `parseDate()` 将 `-` 替换为 `/`
  - **核心修复**：
    1. `order-status.js`：导出 `parseDate()` 函数（已有，新增导出）
    2. `admin/index.js`：添加 `parseDate()` 并在3处使用（时间筛选、逾期计算、排序）
    3. `user-manage/index.js`：订单时间比较使用 `parseDate()`
    4. `service-workspace/index.js`、`workspace/index.js`：申请排序使用 `parseDate()`
    5. `order-detail/index.js`：截稿时间计算使用 `parseDate()`
    6. `artist-detail/index.js`：本月订单筛选使用 `parseDate()`
    7. `income-detail/index.js`：收入记录时间戳使用 `parseDate()`
    8. `report/index.js`：订单时间范围判断使用 `parseDate()`（4处）
    9. `notice-manage/index.js`：公告排序使用 `parseDate()`
  - **已验证**：所有文件无linter错误，iOS兼容性已保证
  - **影响文件**：9个页面文件 + 1个工具文件
  - **测试建议**：在iOS真机或Safari调试器中测试所有涉及日期的功能（订单列表、时间筛选、排序等）
- ✅ **BUG-045画师ID显示&订单刷新（根因闭环修复）**：
  - **问题1**：商品详情页显示用户ID(1001)而非画师编号(001)
  - **根因1**：字段来源不一致+类型不统一+赋值时机晚+WXML判断不严
  - **修复1**：多来源兜底（applications+profiles+approvedProfile）+类型统一(padStart)+一次性setData+严格判断
  - **问题2**：管理后台订单列表首次加载显示"暂无订单"，需手动点击"全部"
  - **根因2**：filterStatus未初始化+时序竞态+缺少互斥锁+orders初始值问题
  - **修复2**：初始化orderFilter:'all'+新增orderInFlight互斥锁+一次性setData+safeLoadOrders函数
  - **影响文件**：product-detail/index.js+wxml、admin/index.js
  - **快检清单**：《快检清单-画师ID和订单刷新.md》（5分钟内定位）
  - **验证步骤**：商品详情页应显示"编号:001"；管理后台点订单立即显示"加载中"，无需手动点击筛选器
- ✅ **BUG-044画师ID双轨制实现（三阶段工作法）**：
  - **需求**：用户ID（1001...）与画师ID（001...）独立系统，画师相关显示优先使用画师编号
  - **问题**：管理后台画师排行榜显示用户ID（1001）而非画师编号（001）
  - **阶段一**：诊断WXML显示错误 + 数据/函数缺失
  - **阶段二**：设计双轨制方案（优先artistNumber，降级userId + 斜体样式）
  - **阶段三**：实现generateArtistRanking()函数 + switchRankingType()函数 + WXML降级显示
  - **影响文件**：admin/index.js、admin/index.wxml、admin/index.wxss
  - **验证步骤**：管理后台→商品管理→画师排行榜，应显示"编号 001"或"ID 1001"（斜体）
- ✅ **WXML语法错误修复**：
  - **错误**：`wx:elif` 和 `wx:for` 不能同时出现在同一标签
  - **后果**：导致 `wx:else` 找不到对应的 `wx:if`，编译失败
  - **修复**：用 `<block wx:elif>` 包裹条件，内部 `<view>` 使用 `wx:for`
  - **影响文件**：admin/index.wxml (订单列表部分)
  - **验证步骤**：编译通过，管理后台订单列表正常显示
- ✅ **BUG-043画师ID显示&搜索修复**：
  - **问题1**：商品详情页没显示画师编号
  - **问题2**：搜索页无法通过画师编号搜索
  - **修复1**：显示逻辑增加降级（优先artistNumber，降级userId）
  - **修复2**：搜索函数修复undefined错误
  - **修复3**：数据初始化避免undefined
  - **影响文件**：product-detail/index.wxml、product-detail/index.js、search/index.js
  - **验证步骤**：查看商品详情页应显示"编号:001"或"ID:1001"，搜索001应能找到商品
- ✅ **管理后台订单列表加载时序彻底修复**：
  - **根因**：订单独立加载状态缺失，异步加载与UI渲染时序冲突
  - **修复1**：新增`orderLoading`独立状态，与全局`loading`解耦
  - **修复2**：WXML增加加载中/空状态分离显示（`wx:if/wx:elif/wx:else`）
  - **修复3**：`loadOrders`开始设`orderLoading=true`，筛选完成后设`false`
  - **修复4**：`switchMainTab`订单标签切换直接调`loadOrders()`
  - **修复5**：`goToOrders/goToRefunds`仪表盘跳转增加数据检查
  - **影响文件**：admin/index.js、admin/index.wxml、admin/index.wxss
  - **解决场景**：初次点击订单、退款后刷新、仪表盘跳转
- ✅ **画师编号搜索+库存管理修复**：
  - 搜索功能：支持通过画师编号搜索商品（search/index.js）
  - 库存扣减：下单时立即扣减库存，防止超卖（order-success/index.js）
  - 库存回退：退款时自动回退库存（admin/index.js + service-workspace/index.js）
  - 核心逻辑：product-sales.js新增decreaseStock/increaseStock函数

---

## 🔴 当前正在做

> ⚠️ 一次只专注一项任务，完成后告诉AI移入"今日完成"

**暂无任务**

---

## 📋 待办事项

### 🐛 Bug修复

📄 **详细清单**：[修复待办清单.md](./修复待办清单.md) | [BUG修复清单.md](./BUG修复清单.md)

**快速提醒：**
- 🎉 14个Bug全部修复完成！

---

### 🆕 新功能开发

**待开发功能：**
- [ ] 画师业绩时间筛选（本月/本年/全部）
- [ ] 后台买家秀管理页面（显示所有买家秀、发布者、订单号，支持删除和隐藏）

---

### 🤝 等待AI/协作

**暂无阻塞项**

---

## ✅ 今日完成

> 📅 此区域记录当日完成事项，次日自动清空

**2025-11-06：**
- ✅ 重构业绩统计为角色收入统计
- ✅ 优化收入统计为表格形式+时间筛选
- ✅ 修复自定义日期选择器
- ✅ 管理后台优化完成（售后二维码、收入统计、删除系统设置/资源管理、公告管理）
- ✅ 修复分类管理和公告管理权限检查问题（userRole → userRoles）
- ✅ 账单流水页面优化（压缩卡片、提升信息密度、移除提现记录独立页面）
- ✅ BUG-01 仪表盘重复显示提现：已删除管理后台仪表盘的个人收入提现卡片
- ✅ BUG-02 订单管理首次加载失败：在切换到订单标签时强制应用筛选条件
- ✅ BUG-03 订单数量不实时更新：下单后清除用户中心订单数量缓存
- ✅ 首页公告系统完善：
  - 首页公告与后台管理关联（从本地存储读取，不再硬编码）
  - 公告详情页从后台读取
  - 修复首页公告标题留白问题
  - 修复公告编辑页面输入框宽度问题
- ✅ 画师详情页优化：
  - 删除评分和粉丝数据
  - 修复头像显示（从users列表读取）
  - 业绩只显示订单数和成交额（删除完成率和好评率）
  - 评价列表关联买家秀，显示真实晒稿图片
  - 联系画师功能（弹出联系方式，可复制微信号）
  - 移除关注按钮
- ✅ 修复画师编辑弹窗在平板端底部按钮显示不全的问题（flexbox布局优化）
- ✅ 修复用户中心更新头像时未同步到users列表的问题
- ✅ 修复商品详情页文字对齐问题（统一行高和垂直居中）
- ✅ **修复分成计算BUG**：订单分成现在正确按数量计算
  - 客服分成：¥2/件 × 数量
  - 管理员分成：¥X/件 × 数量（X根据配置）
  - 修复前：8件商品只扣5元
  - 修复后：8件商品扣40元（5元×8）
- ✅ **优化用户信息更新流程**：
  - 合并"更新头像"和"修改昵称"为"更新用户信息"按钮
  - 点击后跳转到登录页面重新获取微信头像和昵称
  - 确保头像信息一定能正确获取
- ✅ **修复画师收入计算核心BUG**：
  - 修复前：不论数量多少，固定扣除¥5
  - 修复后：按数量正确计算（¥5×数量）
  - 影响范围：账单流水、提现页、用户中心、收入报告
  - 防止画师多收、客服管理员少收的财务漏洞
- ✅ **批量修复14个Bug**：
  - 001 商品图片变形：商品详情页图片改为aspectFit
  - 003 搜索栏画师搜索：支持按画师名字搜索
  - 005 分类管理同步：与橱窗上传时分类对应
  - 006 画师跳转：修复排版和画师不存在问题
  - 010 客服二维码：订单详情增加系统设置兜底
  - 016 图片删除按钮：商品描述图片添加删除样式
  - 022 退款防抖：防止重复点击
  - 024 退款状态：添加已退款状态
  - 025 订单复制：修复时间乱码（iOS兼容）
  - 027 多客服限制：移除1001开发环境限制
  - 028 仪表盘筛选：今日订单筛选应用时间过滤
  - 029 画师昵称：管理后台从users列表获取昵称
  - 033 买家秀：图片渲染+按钮跳转修复
  - 034 首页筛选：出稿时间响应+价格筛选功能

---

## 📚 快速操作指令

**当你说出以下指令时，AI会自动更新此清单：**

- `"这个验证通过了"` → AI删除对应验证项
- `"进入下一项"` → AI从待办区选最高优先级任务移入"当前正在做"
- `"这个Bug修好了"` → AI将当前任务移至"等待验证"
- `"这个报告看完了"` → AI删除"待阅览报告区"对应行
- `"新增待办：xxx"` → AI添加到对应分类
- `"暂停这个任务"` → AI将当前任务移回待办区并标注原因

---

## 🎯 下一步行动

**请告诉我你想做哪一项，我会更新"当前正在做"区域。**

需要查看详细待办请前往 → [修复待办清单.md](./修复待办清单.md)
