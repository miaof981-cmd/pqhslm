# 妙妙工作清单

> **更新时间**：2025-11-06  
> **使用说明**：此清单为唯一动态工作台，AI创建的报告都在"待阅览报告"区，看完即删

---

## 📌 待阅览报告区

> 👇 以下是AI生成的分析/修复报告，阅读后请删除对应行，避免报告堆积

- 📄 **诊断报告-链路断点分析.md**：订单重复+ID类型不一致根因分析

- ✅ **订单创建成功页客服二维码显示修复**：
  - **问题**：配置了客服，下单后显示"客服二维码暂未配置，请稍后联系"
  - **根因**：`assignService()`返回`serviceQrcodeUrl: ''`（为动态读取留空），但order-success页面直接使用空值，未调用动态读取逻辑
  - **修复方案**：
    - 引入`qrcode-helper.js`的`resolveServiceQRCode`函数
    - 订单成功页面加载时调用动态读取逻辑
    - 从客服列表中通过`serviceId`实时读取最新二维码
  - **读取优先级**（qrcode-helper逻辑）：
    1. 从`customer_service_list`通过`serviceId`查找客服
    2. 读取客服的`qrCode/qrcode/qrcodeUrl`等字段
    3. 降级到系统默认二维码
  - **影响文件**：pages/order-success/index.js
  - **验证步骤**：
    1. 确保管理后台已配置客服并上传二维码
    2. 用户端下单
    3. 订单成功页应显示客服二维码（不再提示"暂未配置"）

- ✅ **商品分类异常问题治本修复（三层防御）**：
  - **表现问题**：管理后台商品列表显示 "画师：测试一下emoticon"（异常英文）
  - **根本原因**：category字段被污染（写入了 emoticon、cat_xxx、portrait 等异常英文）
  - **污染源推测**：
    - 微信API返回的脏数据（和之前artistName问题同源）
    - 对象引用污染或数据合并时的字段混淆
    - 草稿恢复时的数据错误传递
  - **治本方案**：三层防御机制（拦截所有写入点）
    - **第1层：提交拦截**（product-edit `submitForm`）：
      - 保存商品前验证 `formData.category`
      - 检测异常英文（emoticon、portrait、cat_xxx、纯英文+数字）
      - 验证分类是否存在于系统分类列表
      - 异常则清空并提示用户重新选择
    - **第2层：加载拦截**（product-edit `loadProduct`）：
      - 编辑商品时加载数据前验证 `product.category`
      - 发现异常自动清空，提示"检测到分类异常，请重新选择"
      - 防止脏数据循环传播
    - **第3层：草稿拦截**（product-edit `loadDraft`）：
      - 恢复草稿时验证 `draft.formData.category`
      - 异常则清空，提示"草稿中分类异常，请重新选择"
      - 阻止草稿中的脏数据污染新商品
  - **显示优化**：管理后台商品列表添加分隔符
    - 修改前：`画师：测试一下emoticon`（混在一起）
    - 修改后：`画师：测试一下 | emoticon`（分隔符+分类背景色）
  - **诊断工具增强**：
    - 新增"⚠️ 分类异常"检测项
    - 自动检测category字段中的非法英文
    - 验证分类是否存在于系统列表
    - 一键修复会清空异常分类（需画师手动重选）
  - **影响文件**：
    - pages/product-edit/index.js（新增 `validateAndCleanCategory`、三处拦截点）
    - pages/admin/index.wxml（添加分隔符）
    - pages/admin/index.wxss（分隔符+分类样式）
    - pages/debug-order/*（诊断工具升级）
  - **修复效果**：
    - ✅ 新上传商品：category 一定合法或为空
    - ✅ 编辑商品：脏数据自动清空
    - ✅ 草稿恢复：异常分类自动拦截
    - ✅ 系统性防御，根除污染源
  - **验证步骤**：
    1. 打开诊断工具查看"分类异常"统计
    2. 编辑有异常分类的商品，会提示"检测到分类异常"
    3. 重新选择正确分类并保存
    4. 以后新上传的商品分类永远正确

- ✅ **修复商品图片显示裁剪错误**：
  - **问题**：商品图片/二维码只显示边角，正方形图片上传后被裁剪
  - **根因**：CSS的 `object-fit: cover` 和 `object-position: center` 与小程序 `<image>` 标签的 `mode` 属性冲突
  - **修复范围**：13个页面，移除所有 `object-fit` 和 `object-position` CSS属性
  - **影响文件**：
    - pages/admin/index.wxss（3处：商品卡片、订单缩略图、头像）
    - pages/cart/index.wxss
    - pages/order-list/index.wxss
    - pages/order-detail/index.wxss
    - pages/product-manage/index.wxss
    - pages/product-edit/index.wxss（2处：规格图、上传图）
    - pages/product-detail/index.wxss（轮播图）
    - pages/artist-products-manage/index.wxss
    - pages/artist-dashboard/index.wxss
    - pages/artist-detail/index.wxss
    - pages/login/index.wxss（头像预览）
    - pages/home/index.wxss（之前已修复）
  - **修复方式**：小程序 `<image>` 标签只使用 `mode="aspectFill"` 控制图片显示，不使用CSS属性
  - **已提交**：commit c16053d，已推送到main分支

- ✅ **修复诊断工具+画师端+统计数据5大问题**：
  - **问题1**：诊断工具显示订单未分配客服（实际已分配）
    - 根因：只检查`serviceId`字段
    - 修复：检查3字段（serviceId OR serviceName OR serviceQRCode）
  - **问题2**：管理后台修改分类后，诊断工具显示"未分类"
    - 根因：未验证`categoryName`与分类ID匹配
    - 修复：检查分类ID存在性+categoryName一致性
  - **问题3**：画师端"全部"中进行中订单未优先显示
    - 修复：提高inProgress优先级（1→3）+ deadline二级排序
  - **问题4**：点击"进行中"筛选只显示部分订单
    - 修复："进行中"=所有未完成订单（排除completed/refunded/cancelled）
  - **问题5**：管理后台画师统计显示0订单0收入
    - 根因：artistId类型不匹配（字符串vs数字）
    - 修复：使用String()确保类型一致 + 添加调试日志
  - **附加优化**：画师端"待处理"=所有未完成订单总数
  - **影响文件**：pages/debug-order/index.js, pages/admin/index.js, pages/workspace/index.js
  - **已提交**：commit c7e8403，已推送到main分支

- ✅ **修复管理后台仪表盘客服分配警告**：
  - **问题**：仪表盘红色提示"存在待分配客服的订单 - 共有2笔"，但订单实际已分配
  - **根因**：`collectAlerts()`函数只检查`serviceId`和`serviceName`，未检查`serviceQRCode`
  - **修复位置**：pages/admin/index.js 第1161行
  - **修复逻辑**：
    ```javascript
    // 原：serviceMissing = !serviceId && (!serviceName || isPlaceholderServiceName(serviceName))
    // 新：serviceMissing = !serviceId && !serviceQRCode && (!serviceName || isPlaceholderServiceName(serviceName))
    ```
  - **预期效果**：只要订单有serviceId、serviceName或serviceQRCode任一字段，仪表盘就不报警
  - **已提交**：commit d3c99ac，已推送到main分支

- ✅ **修复首页分类显示+搜索功能增强（三次修复）**：
  - **问题1**：管理后台修改分类后，首页显示"未分类"（但商品详情有正常分类）
    - 根因：`getCategoryNameById()`类型不匹配（category.id是字符串，categoryId可能是数字）
    - 修复：utils/category-service.js 使用String()确保类型一致
  - **问题2**：画师名下有多个商品时，部分商品（如"蓝色"）搜不到
    - **第一次修复（commit 4c61f91）**：
      - 原因1：搜索页面未过滤下架商品
      - 原因2：搜索维度不够
      - 修复：只加载已上架商品 + 新增商品ID和规格名搜索
    - **第二次修复（commit ba7cfa6）**：⭐ 根本解决
      - **三阶段工作法分析**：
        - 诊断：数据结构理解错误，只提取了`spec.name`（"颜色"），未提取`spec.values[].name`（"蓝色"）
        - 设计：深度遍历specs结构，提取规格名+规格值两层数据
        - 实施：遍历`spec.values`数组，提取所有`value.name`
      - **规格数据结构**：
        ```javascript
        specs = [{
          name: "颜色",           // spec.name ← 只提取这个（错误）
          values: [              // spec.values ← 需要深入这里！
            {name: "蓝色"},      // ← "蓝色"在这里
            {name: "红色"}
          ]
        }]
        ```
  - **完整搜索维度（8个）**：
    1. 商品名称 ✅
    2. 商品ID ✅
    3. 分类名称 ✅
    4. 画师名字 ✅
    5. 画师编号 ✅
    6. 标签 ✅
    7. 规格名（如"颜色"、"尺寸"）✅
    8. **规格值（如"蓝色"、"大号"）✅ ← 关键修复**
  - **影响文件**：
    - miniprogram/utils/category-service.js
    - miniprogram/pages/search/index.js
  - **预期效果**：
    - 首页商品分类正常显示
    - 搜"蓝色" → 找到所有有"蓝色"规格的商品 ✅
    - 搜"大号" → 找到所有有"大号"规格的商品 ✅
    - 搜"Q版" → 找到所有有"Q版"规格的商品 ✅
    - **第三次修复（commit 116763e）**：⭐ 类型匹配+状态兼容
      - **问题**：画师1有5个商品，搜索只显示4个，"蓝色"（price=0）被漏掉
      - **根因排查**：
        1. ❌ price=0不是问题：parseFloat(0)正常处理
        2. ✅ artistId类型不匹配：使用==比较，类型不一致
        3. ✅ status判断不全：未兼容'上架'/'已上架'/'onSale'等中文值
        4. ✅ id过滤过严：!!item.id会过滤id=0的情况
      - **修复**：
        1. artistId统一String()比较（3处）
        2. status兼容9种值：isOnSale/status的true/undefined/null/'上架'/'已上架'/'onSale'/active/online
        3. id过滤优化：允许id=0，只过滤undefined/null/''
        4. 调试日志：输出加载的商品信息和过滤原因
    - **第四次修复（commit e081cc4）**：⭐⭐ 根本解决（三阶段工作法）
      - **问题**：蓝色商品确实上架，首页能看到，但搜索页看不到
      - **阶段一-诊断**：对比首页和搜索页代码
        ```javascript
        // 首页
        .filter(p => p.isOnSale !== false)  // 只要不是false就显示
        
        // 搜索页（第三次修复后）
        isOnSale === true || undefined || null || '上架' || ...  // 明确枚举
        ```
      - **根因**：如果isOnSale是数字1或字符串'1'/'true'：
        * 首页：`1 !== false` → true ✅ 通过
        * 搜索页：`1 === true` → false ❌ 不通过
      - **阶段二-设计**：保持搜索页和首页完全一致
      - **阶段三-实施**：统一使用 `p.isOnSale !== false`
      - **优势**：
        1. 简单直接，不易出错
        2. 兼容所有真值（true/1/'1'/'true'/undefined/null）
        3. 与首页逻辑完全一致
    - **诊断工具嵌入（commit abc3ebe → fb01bf6）**：🔍 手机端可用的实时诊断
      - **背景**：助理用手机测试，搜索画师编号"1"时"蓝色"商品不显示
      - **问题**：无法使用开发者工具控制台，需要直接在手机上看诊断结果
      - **实施**：
        1. 在 `loadProducts()` 中嵌入诊断记录器
        2. 实时记录"蓝色"商品在3个过滤步骤中的状态
        3. 搜索关键词"诊断"/"debug"/"排查"触发弹窗
        4. 弹窗显示：商品统计、"蓝色"详情、画师编号提取、搜索索引
      - **触发方式**：在搜索框输入"诊断"，按回车或搜索
      - **输出内容**：
        * 总商品数、过滤后数量
        * "蓝色"商品的artistId、artistNumber、searchTokens
        * 是否包含搜索关键词"1"
        * 画师1的其他商品对比
      - **优势**：
        1. 无需控制台，手机端直接可见
        2. 可复制诊断结果发给开发者
        3. 实时数据，不依赖外部脚本
  - **已提交**：commit 4c61f91（部分）+ ba7cfa6（规格）+ 116763e（类型）+ e081cc4（统一逻辑）+ abc3ebe（基准）+ fb01bf6（诊断嵌入），已推送到main分支

- ✅ **画师改名后搜索不到橱窗（深层排查+全面修复）**：
  - **问题背景**：用户反馈"画师改名后搜索不到橱窗"，虽然 `user-center/index.js` 已经在改名时同步更新了 `mock_products` 的 `artistName`，但问题依然存在
  - **深层排查**：
    1. **搜索页面（search/index.js）**：
       - ❌ 旧逻辑：`artistName = product.artistName || ''`，只有为空时才从 `users` 读取
       - 问题：优先使用商品的 `artistName`（可能是旧数据或缓存）
    2. **首页（home/index.js）**：
       - ❌ 旧逻辑：`artistName: p.artistName || p.artist?.name || '画师'`
       - 问题：同样优先使用商品的 `artistName`
    3. **管理后台（admin/index.js）**：
       - ❌ 旧逻辑：优先级为 `申请记录 > 用户信息 > 商品自带名称`
       - 问题：`if (!artistName && userMap.has(...))` 只有当申请记录没有名字时才读 `users`
  - **根本原因**：
    - 即使改名时更新了 `mock_products`，但多个页面都是"优先使用商品的 artistName"
    - 如果商品的 `artistName` 有值（即使是旧值），就不会再去 `users` 列表查找最新昵称
    - 可能存在缓存、数据不同步、或页面未重新加载等情况，导致搜索索引使用的是旧名字
  - **修复方案**（三阶段工作法）：
    - **阶段一-诊断**：通过 grep 和 codebase_search 找到所有使用 `artistName` 的地方
    - **阶段二-设计**：统一策略：**总是优先从 `users` 列表读取最新昵称**
    - **阶段三-实施**：
      1. **search/index.js**：
         ```javascript
         // ✅ 新逻辑
         if (product.artistId) {
           const artist = users.find(...)
           artistName = artist ? (artist.nickName || artist.name || '') : (product.artistName || '')
         } else {
           artistName = product.artistName || ''
         }
         ```
      2. **home/index.js**：
         ```javascript
         // ✅ 新逻辑
         let artistName = p.artistName || p.artist?.name || '画师'
         if (p.artistId) {
           const artist = users.find(...)
           if (artist) {
             artistName = artist.nickName || artist.name || artistName
           }
         }
         ```
      3. **admin/index.js**：
         ```javascript
         // ✅ 新逻辑：调整优先级为 users > artist_applications > product.artistName
         if (artistId && userMap.has(artistId)) {
           const user = userMap.get(artistId)
           artistName = user.nickname || user.nickName || user.name || ''
         }
         if (!artistName && artistId && artistMap.has(artistId)) {
           const application = artistMap.get(artistId)
           artistName = application.name || application.realName || ''
         }
         ```
  - **修复效果**：
    1. ✅ 总是使用 `users` 列表中的最新昵称
    2. ✅ 即使 `product.artistName` 是旧数据，也能正确显示和搜索新名字
    3. ✅ 保证搜索索引的实时性，无需手动刷新或清除缓存
  - **影响范围**：3个核心页面（搜索、首页、管理后台）
  - **已提交**：commit 00b1c00，已推送到main分支

- ✅ **全局诊断工具（V2增强版：订单+商品双重检测）**：
  - **新增功能**：商品画师名字错误检测+一键修复
  - **问题1**：商品列表显示奇怪英文（emoticon、cat_xxx、portrait）
  - **问题2**：订单跨端不可见（订单artistId与商品artistId不匹配）
  - **设计思路**：全局扫描订单+商品，自动检测5类问题
  - **功能亮点**：
    1. 📊 问题分类统计（商品不存在、画师ID不匹配、**画师名字错误**、客服未分配、字段缺失）
    2. 🛒 问题商品明细（显示错误名字 → 正确名字，带删除线+绿色高亮）
    3. 🚨 问题订单明细（显示订单号、商品名、买家/画师/商品ID、问题标签）
    4. 📋 一键复制诊断报告（可直接发给管理员）
    5. 🔧 一键修复所有问题（批量修复订单+商品）
  - **入口位置**：管理后台 → 更多 → 🔍 诊断工具
  - **使用场景**：远程用户截图发送，快速定位+修复数据异常
  - **影响文件**：
    - pages/debug-order/index.wxml（新增商品问题显示）
    - pages/debug-order/index.js（新增商品扫描+修复逻辑）
    - pages/debug-order/index.wxss（新增错误/正确样式）
  - **核心逻辑**：
    - **订单检测**：遍历所有订单，检查productId、artistId、serviceId
    - **商品检测**：检测artistName是否为英文/数字/下划线组合，从users/applications重新读取正确名字
  - **修复功能**：
    - 商品：从users/applications读取正确画师名字，更新mock_products
    - 订单：从商品重新读取artistId，批量更新4个数据源（orders/pending/completed/mock）
  - **验证步骤**：打开诊断工具 → 查看"画师名字错误"统计 → 点击"一键修复" → 刷新商品列表

- ✅ **商品图片渲染Bug全局修复（根因彻底解决）**：
  - **问题**：小图缩左上角成小块、大图未铺满有空白、不同图片显示效果不一致
  - **根因**：图片压缩逻辑保留原始宽高比 + 容器固定尺寸 = 渲染错位
  - **修复1-显示端**：统一mode="aspectFill" + object-fit: cover
    - product-detail轮播图：mode="aspectFit" → mode="aspectFill"
    - product-detail购买弹窗：mode="aspectFit" → mode="aspectFill"
    - swiper-image：object-fit: contain → object-fit: cover
  - **修复2-上传端（核心）**：压缩时统一裁剪为正方形
    - 原逻辑：maxWidth=1200，等比缩放（保留原始比例）
    - 新逻辑：取短边居中裁剪 → 输出1200x1200正方形
    - 使用9参数drawImage实现居中裁剪
  - **影响文件**：
    - pages/product-detail/index.wxml（2处mode修改）
    - pages/product-detail/index.wxss（object-fit修改）
    - pages/product-edit/index.js（压缩逻辑重构）
  - **验证步骤**：
    1. 上传任意尺寸图片（300x200、1920x1080、800x800）
    2. 控制台应输出：`📐 图片裁剪: 原始WxH → 裁剪SxS → 输出1200x1200`
    3. 商品列表/详情页图片应完整填充容器，无留白无拉伸
  - **技术要点**：
    - 正方形裁剪公式：`sourceSize = Math.min(width, height)`
    - 居中裁剪偏移：`offsetX = (width - sourceSize) / 2`
    - canvas 9参数：`drawImage(src, sx, sy, sW, sH, dx, dy, dW, dH)`
- 📄 **后端接入安全审查完成**（三段式分析，20000字）：
  - **文件位置**：项目根目录 `后端接入前安全审查报告.md`
  - **审查范围**：核心设计风险（5项） + 后端协议建议（6项）
  - **工作方法**：三段式（分析问题 → 设计方案 → 实施建议）
  - **审查结果**：
    - **风险1-订单支付状态**：✅ 部分采纳（状态流转已完善，需补充支付渠道）
    - **风险2-会员商品联动**：✅ 采纳核心建议（实时校验+定时任务，不采纳冗余缓存）
    - **风险3-客服二维码分配**：✅ 采纳并发控制（Redis原子计数，不采纳资源锁定）
    - **风险4-审计日志**：✅ 强烈采纳（必须实现，安全合规必需）
    - **风险5-权限模型**：✅ 强烈采纳（后端接入核心基础）
    - **建议1-6（API分层/统一协议/幂等设计等）**：✅ 完全采纳
  - **采纳统计**：27项建议，24项采纳（89%），3项不采纳（有详细理由）
  - **优先级排序**：P0必须项4个、P1应该项4个、P2可选项3个、P3视情况2个
  - **实施时间表**：4周接入计划（权限→事务→审计→支付）
  - **核心补充设计**：
    - 审计日志表（admin_audit_log）完整SQL
    - 权限验证中间件（authMiddleware）完整代码
    - 数据库事务示例（订单完成原子操作）
    - 金额"分"存储规范（避免浮点误差）
    - 图片结构化返回（URL+宽高+大小+缩略图）
    - 异常报警规则（大量退款/异地登录/大额提现）
  - **不采纳项说明**：
    - 会员状态缓存字段（冗余设计，实时判断即可）
    - 客服资源锁定机制（业务逻辑不适用）
    - 前端查询权限（严重安全风险）
- ✅ **iOS日期格式全局排查修复（最终版）**：
  - **问题**：`formatTimeForDisplay` 函数仍使用 `new Date(timestamp)` 导致iOS报错
  - **全局排查**：共修复5个文件中的15处日期解析问题
  - **修复清单**：
    1. `pages/admin/index.js` - `formatTimeForDisplay` 改用 `parseDate()`
    2. `pages/income-detail/index.js` - 4处：timestamp计算、formatTime、排序（2处）
    3. `pages/user-center/index.js` - 3处：申请排序（2处）、formatTime
    4. `pages/home/index.js` - 1处：公告排序
    5. 工具函数（`utils/order-status.js`、`utils/group-helper.js`）已正确处理
  - **验证方法**：所有linter检查通过，控制台无iOS日期警告
  - **影响范围**：所有涉及日期字符串解析的页面
  - **核心原则**：任何传入日期字符串的 `new Date()` 都必须改用 `parseDate()`
- ✅ **管理后台订单列表双重修复（根因彻底解决）**：
  - **问题1**：iOS日期格式报错 `new Date("11/06 10:28")` 无法解析
    - **根因1**：`formatTime` 只输出月-日时:分（无年份），然后**覆盖**原始 `createTime`/`deadline`
    - **后果1**：`filterOrdersByTime` 无法解析不完整的日期，导致订单被错误过滤
    - **修复1**：分离显示字段和逻辑字段
      - `createTime` / `deadline` 保留完整时间字符串（用于逻辑判断）
      - `createTimeDisplay` / `deadlineDisplay` 仅用于显示（月-日 时:分）
      - WXML使用 `*Display` 字段显示
  - **问题2**：点击订单标签后显示"加载中"但没有刷新，需手动点"全部"
    - **根因2**：`timeFilter` 默认值为 `'today'`，导致只显示今天的订单
    - **后果2**：测试订单如果不是今天创建，被 `filterOrdersByTime` 过滤掉
    - **修复2**：订单列表不应用时间筛选（`timeFilter` 仅用于仪表盘统计）
  - **影响文件**：
    - pages/admin/index.js（3处修改：formatTime逻辑、字段分离、移除时间筛选）
    - pages/admin/index.wxml（显示字段改为 `*Display`）
  - **验证步骤**：
    1. 点击订单标签 → 应立即显示所有历史订单（不限今日）
    2. 控制台应无iOS日期格式警告
    3. 时间显示正常：下单时间/截稿时间格式为 `11-06 10:28`
- ✅ **管理后台订单标签切换刷新优化**：
  - **需求1**：每次点击"订单"标签自动加载最新订单
  - **需求2**：立即显示"加载中"，不闪现"暂无订单"
  - **需求3**：保证渲染顺序：先setData再loadOrders()
  - **需求4**：标签切换时都触发刷新
  - **原有实现**：switchMainTab已设置orderLoading+orders清空，但互斥锁可能阻止重复加载
  - **优化点**：switchMainTab中增加`orderInFlight: false`重置互斥锁
  - **效果**：快速切换标签时也能保证重新加载，避免因互斥锁未释放导致的加载跳过
  - **影响文件**：pages/admin/index.js (switchMainTab函数)
  - **测试建议**：快速切换标签多次，每次都应显示"加载中"并正确加载订单
- ✅ **iOS日期格式兼容性修复（全局排查）**：
  - **问题**：`new Date("2025-11-06 10:28")` 在iOS下无法解析（iOS仅支持斜线`/`分隔或ISO格式`T`连接）
  - **影响范围**：所有使用日期字符串的页面和工具函数
  - **修复策略**：存储格式保持 `YYYY-MM-DD HH:mm`，解析时统一使用 `parseDate()` 将 `-` 替换为 `/`
  - **核心修复**：
    1. `order-status.js`：导出 `parseDate()` 函数（已有，新增导出）
    2. `admin/index.js`：添加 `parseDate()` 并在3处使用（时间筛选、逾期计算、排序）
    3. `user-manage/index.js`：订单时间比较使用 `parseDate()`
    4. `service-workspace/index.js`、`workspace/index.js`：申请排序使用 `parseDate()`
    5. `order-detail/index.js`：截稿时间计算使用 `parseDate()`
    6. `artist-detail/index.js`：本月订单筛选使用 `parseDate()`
    7. `income-detail/index.js`：收入记录时间戳使用 `parseDate()`
    8. `report/index.js`：订单时间范围判断使用 `parseDate()`（4处）
    9. `notice-manage/index.js`：公告排序使用 `parseDate()`
  - **已验证**：所有文件无linter错误，iOS兼容性已保证
  - **影响文件**：9个页面文件 + 1个工具文件
  - **测试建议**：在iOS真机或Safari调试器中测试所有涉及日期的功能（订单列表、时间筛选、排序等）
- ✅ **BUG-045画师ID显示&订单刷新（根因闭环修复）**：
  - **问题1**：商品详情页显示用户ID(1001)而非画师编号(001)
  - **根因1**：字段来源不一致+类型不统一+赋值时机晚+WXML判断不严
  - **修复1**：多来源兜底（applications+profiles+approvedProfile）+类型统一(padStart)+一次性setData+严格判断
  - **问题2**：管理后台订单列表首次加载显示"暂无订单"，需手动点击"全部"
  - **根因2**：filterStatus未初始化+时序竞态+缺少互斥锁+orders初始值问题
  - **修复2**：初始化orderFilter:'all'+新增orderInFlight互斥锁+一次性setData+safeLoadOrders函数
  - **影响文件**：product-detail/index.js+wxml、admin/index.js
  - **快检清单**：《快检清单-画师ID和订单刷新.md》（5分钟内定位）
  - **验证步骤**：商品详情页应显示"编号:001"；管理后台点订单立即显示"加载中"，无需手动点击筛选器
- ✅ **BUG-044画师ID双轨制实现（三阶段工作法）**：
  - **需求**：用户ID（1001...）与画师ID（001...）独立系统，画师相关显示优先使用画师编号
  - **问题**：管理后台画师排行榜显示用户ID（1001）而非画师编号（001）
  - **阶段一**：诊断WXML显示错误 + 数据/函数缺失
  - **阶段二**：设计双轨制方案（优先artistNumber，降级userId + 斜体样式）
  - **阶段三**：实现generateArtistRanking()函数 + switchRankingType()函数 + WXML降级显示
  - **影响文件**：admin/index.js、admin/index.wxml、admin/index.wxss
  - **验证步骤**：管理后台→商品管理→画师排行榜，应显示"编号 001"或"ID 1001"（斜体）
- ✅ **WXML语法错误修复**：
  - **错误**：`wx:elif` 和 `wx:for` 不能同时出现在同一标签
  - **后果**：导致 `wx:else` 找不到对应的 `wx:if`，编译失败
  - **修复**：用 `<block wx:elif>` 包裹条件，内部 `<view>` 使用 `wx:for`
  - **影响文件**：admin/index.wxml (订单列表部分)
  - **验证步骤**：编译通过，管理后台订单列表正常显示
- ✅ **BUG-043画师ID显示&搜索修复**：
  - **问题1**：商品详情页没显示画师编号
  - **问题2**：搜索页无法通过画师编号搜索
  - **修复1**：显示逻辑增加降级（优先artistNumber，降级userId）
  - **修复2**：搜索函数修复undefined错误
  - **修复3**：数据初始化避免undefined
  - **影响文件**：product-detail/index.wxml、product-detail/index.js、search/index.js
  - **验证步骤**：查看商品详情页应显示"编号:001"或"ID:1001"，搜索001应能找到商品
- ✅ **管理后台订单列表加载时序彻底修复**：
  - **根因**：订单独立加载状态缺失，异步加载与UI渲染时序冲突
  - **修复1**：新增`orderLoading`独立状态，与全局`loading`解耦
  - **修复2**：WXML增加加载中/空状态分离显示（`wx:if/wx:elif/wx:else`）
  - **修复3**：`loadOrders`开始设`orderLoading=true`，筛选完成后设`false`
  - **修复4**：`switchMainTab`订单标签切换直接调`loadOrders()`
  - **修复5**：`goToOrders/goToRefunds`仪表盘跳转增加数据检查
  - **影响文件**：admin/index.js、admin/index.wxml、admin/index.wxss
  - **解决场景**：初次点击订单、退款后刷新、仪表盘跳转
- ✅ **画师编号搜索+库存管理修复**：
  - 搜索功能：支持通过画师编号搜索商品（search/index.js）
  - 库存扣减：下单时立即扣减库存，防止超卖（order-success/index.js）
  - 库存回退：退款时自动回退库存（admin/index.js + service-workspace/index.js）
  - 核心逻辑：product-sales.js新增decreaseStock/increaseStock函数

---

## 🔴 当前正在做

> ⚠️ 一次只专注一项任务，完成后告诉AI移入"今日完成"

**后端接入准备（阶段一）**
- ✅ 创建5个基础工具类
- ✅ 创建详细教程文档
- ⏳ 待执行：云开发控制台创建12个集合（见教程）
- ⏳ 待执行：创建数据库索引26个（见对照表）
- ⏳ 待执行：数据迁移（可选）

---

## 📋 待办事项

### 🐛 Bug修复

📄 **详细清单**：[修复待办清单.md](./修复待办清单.md) | [BUG修复清单.md](./BUG修复清单.md)

**快速提醒：**
- 🎉 14个Bug全部修复完成！

---

### 🆕 新功能开发

**待开发功能：**
- [ ] 画师业绩时间筛选（本月/本年/全部）
- [ ] 后台买家秀管理页面（显示所有买家秀、发布者、订单号，支持删除和隐藏）

---

### 🤝 等待AI/协作

**暂无阻塞项**

---

## ✅ 今日完成

> 📅 此区域记录当日完成事项，次日自动清空

**2025-11-11：**
- ✅ 新增"清空测试数据"功能（管理后台→更多）
- ✅ 订单ID重复问题（治本修复）
- ✅ ID类型不一致问题（治本修复）
- ✅ 二次确认+保留必要数据

**历史记录：**
- ✅ 重构业绩统计为角色收入统计
- ✅ 优化收入统计为表格形式+时间筛选
- ✅ 修复自定义日期选择器
- ✅ 管理后台优化完成（售后二维码、收入统计、删除系统设置/资源管理、公告管理）
- ✅ 修复分类管理和公告管理权限检查问题（userRole → userRoles）
- ✅ 账单流水页面优化（压缩卡片、提升信息密度、移除提现记录独立页面）
- ✅ BUG-01 仪表盘重复显示提现：已删除管理后台仪表盘的个人收入提现卡片
- ✅ BUG-02 订单管理首次加载失败：在切换到订单标签时强制应用筛选条件
- ✅ BUG-03 订单数量不实时更新：下单后清除用户中心订单数量缓存
- ✅ 首页公告系统完善：
  - 首页公告与后台管理关联（从本地存储读取，不再硬编码）
  - 公告详情页从后台读取
  - 修复首页公告标题留白问题
  - 修复公告编辑页面输入框宽度问题
- ✅ 画师详情页优化：
  - 删除评分和粉丝数据
  - 修复头像显示（从users列表读取）
  - 业绩只显示订单数和成交额（删除完成率和好评率）
  - 评价列表关联买家秀，显示真实晒稿图片
  - 联系画师功能（弹出联系方式，可复制微信号）
  - 移除关注按钮
- ✅ 修复画师编辑弹窗在平板端底部按钮显示不全的问题（flexbox布局优化）
- ✅ 修复用户中心更新头像时未同步到users列表的问题
- ✅ 修复商品详情页文字对齐问题（统一行高和垂直居中）
- ✅ **修复分成计算BUG**：订单分成现在正确按数量计算
  - 客服分成：¥2/件 × 数量
  - 管理员分成：¥X/件 × 数量（X根据配置）
  - 修复前：8件商品只扣5元
  - 修复后：8件商品扣40元（5元×8）
- ✅ **优化用户信息更新流程**：
  - 合并"更新头像"和"修改昵称"为"更新用户信息"按钮
  - 点击后跳转到登录页面重新获取微信头像和昵称
  - 确保头像信息一定能正确获取
- ✅ **修复画师收入计算核心BUG**：
  - 修复前：不论数量多少，固定扣除¥5
  - 修复后：按数量正确计算（¥5×数量）
  - 影响范围：账单流水、提现页、用户中心、收入报告
  - 防止画师多收、客服管理员少收的财务漏洞
- ✅ **批量修复14个Bug**：
  - 001 商品图片变形：商品详情页图片改为aspectFit
  - 003 搜索栏画师搜索：支持按画师名字搜索
  - 005 分类管理同步：与橱窗上传时分类对应
  - 006 画师跳转：修复排版和画师不存在问题
  - 010 客服二维码：订单详情增加系统设置兜底
  - 016 图片删除按钮：商品描述图片添加删除样式
  - 022 退款防抖：防止重复点击
  - 024 退款状态：添加已退款状态
  - 025 订单复制：修复时间乱码（iOS兼容）
  - 027 多客服限制：移除1001开发环境限制
  - 028 仪表盘筛选：今日订单筛选应用时间过滤
  - 029 画师昵称：管理后台从users列表获取昵称
  - 033 买家秀：图片渲染+按钮跳转修复
  - 034 首页筛选：出稿时间响应+价格筛选功能

---

## 📚 快速操作指令

**当你说出以下指令时，AI会自动更新此清单：**

- `"这个验证通过了"` → AI删除对应验证项
- `"进入下一项"` → AI从待办区选最高优先级任务移入"当前正在做"
- `"这个Bug修好了"` → AI将当前任务移至"等待验证"
- `"这个报告看完了"` → AI删除"待阅览报告区"对应行
- `"新增待办：xxx"` → AI添加到对应分类
- `"暂停这个任务"` → AI将当前任务移回待办区并标注原因

---

## 🎯 下一步行动

**请告诉我你想做哪一项，我会更新"当前正在做"区域。**

需要查看详细待办请前往 → [修复待办清单.md](./修复待办清单.md)
