# 🔧 数据库索引修复指南

> **问题**：P0-2 数据库索引字段名错误  
> **影响**：查询性能下降、唯一性约束失效  
> **操作时间**：约5-10分钟  
> **必须完成**：上线前必须修复

---

## 📋 错误索引清单

| 集合 | 错误字段 | 正确字段 | 索引类型 | 影响 |
|------|---------|---------|---------|------|
| orders | orderId | id | 非唯一 | 订单查询性能下降 |
| orders | orderId | id | 唯一 | 订单号重复风险 |
| income_ledger | orderId | id | 非唯一 | 收入记录查询慢 |
| withdraw_records | orderId | id | 唯一 | 提现记录可能重复 |
| users | openid | _openid | 唯一 | 用户登录冲突 |

---

## 🛠️ 修复步骤

### 第一步：打开云开发控制台

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入小程序后台
3. 左侧菜单选择【云开发】→【数据库】

---

### 第二步：删除错误索引

#### 2.1 orders 集合

1. 点击进入 `orders` 集合
2. 切换到【索引管理】标签
3. 找到以下2个索引并删除：
   - `orderId` (非唯一索引)
   - `orderId` (唯一索引)

#### 2.2 income_ledger 集合

1. 点击进入 `income_ledger` 集合
2. 切换到【索引管理】标签
3. 删除索引：`orderId` (非唯一索引)

#### 2.3 withdraw_records 集合

1. 点击进入 `withdraw_records` 集合
2. 切换到【索引管理】标签
3. 删除索引：`orderId` (唯一索引)

#### 2.4 users 集合

1. 点击进入 `users` 集合
2. 切换到【索引管理】标签
3. 删除索引：`openid` (唯一索引)

---

### 第三步：创建正确索引

#### 3.1 orders 集合

创建2个索引：

**索引1：id（非唯一）**
```json
{
  "字段名": "id",
  "索引类型": "非唯一",
  "升序/降序": "升序"
}
```

**索引2：id（唯一）**
```json
{
  "字段名": "id",
  "索引类型": "唯一",
  "升序/降序": "升序"
}
```

#### 3.2 income_ledger 集合

**索引：id（非唯一）**
```json
{
  "字段名": "id",
  "索引类型": "非唯一",
  "升序/降序": "升序"
}
```

#### 3.3 withdraw_records 集合

**索引：id（唯一）**
```json
{
  "字段名": "id",
  "索引类型": "唯一",
  "升序/降序": "升序"
}
```

#### 3.4 users 集合

**索引：_openid（唯一）**
```json
{
  "字段名": "_openid",
  "索引类型": "唯一",
  "升序/降序": "升序"
}
```

---

### 第四步：创建 sequences 集合（用于 userId 自增）

1. 在数据库页面点击【创建集合】
2. 集合名称：`sequences`
3. 创建后，点击【添加记录】
4. 输入以下JSON：

```json
{
  "_id": "userId",
  "value": 1001,
  "description": "User ID sequence"
}
```

5. 点击【确定】保存

---

### 第五步：验证索引

#### 5.1 验证 orders 集合

在云开发控制台执行查询：
```javascript
db.collection('orders').where({id: 'test'}).get()
```

查看执行计划，确认使用了 `id` 索引。

#### 5.2 验证 users 集合

```javascript
db.collection('users').where({_openid: 'test'}).get()
```

查看执行计划，确认使用了 `_openid` 索引。

#### 5.3 验证 sequences 集合

```javascript
db.collection('sequences').where({_id: 'userId'}).get()
```

确认返回 `{_id: 'userId', value: 1001}`。

---

## ✅ 完成检查清单

- [ ] 删除 orders.orderId 索引（非唯一）
- [ ] 删除 orders.orderId 索引（唯一）
- [ ] 删除 income_ledger.orderId 索引
- [ ] 删除 withdraw_records.orderId 索引
- [ ] 删除 users.openid 索引
- [ ] 创建 orders.id 索引（非唯一）
- [ ] 创建 orders.id 索引（唯一）
- [ ] 创建 income_ledger.id 索引
- [ ] 创建 withdraw_records.id 索引
- [ ] 创建 users._openid 索引
- [ ] 创建 sequences 集合
- [ ] 添加 userId 序列记录
- [ ] 验证所有索引正常工作

---

## ⚠️ 注意事项

1. **删除索引前备份**：建议先导出数据库备份
2. **低峰期操作**：选择用户较少时操作，避免影响查询
3. **逐个验证**：每修复一个集合，立即验证是否生效
4. **保留其他索引**：只删除/修改上述列出的错误索引，其他索引保持不变

---

## 🚨 紧急回滚

如果修复后出现问题，可以回滚：

1. 删除新创建的 `id` 和 `_openid` 索引
2. 重新创建原来的 `orderId` 和 `openid` 索引
3. 联系技术支持排查问题

---

**修复完成后，请在此标记**：✅ 已完成（日期：__________）

**操作人**：__________  
**验证人**：__________

