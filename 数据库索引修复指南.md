# 🔧 数据库索引修复指南

> **问题**：P0-2 数据库索引字段名错误  
> **影响**：查询性能下降、唯一性约束失效  
> **操作时间**：约5-10分钟  
> **必须完成**：上线前必须修复

---

## 📋 错误索引清单

| 集合 | 错误字段 | 正确字段 | 索引类型 | 影响 |
|------|---------|---------|---------|------|
| orders | orderId | id | 非唯一 | 订单查询性能下降 |
| orders | orderId | id | 唯一 | 订单号重复风险 |
| income_ledger | orderId | id | 非唯一 | 收入记录查询慢 |
| withdraw_records | orderId | id | 唯一 | 提现记录可能重复 |
| users | openid | _openid | 唯一 | 用户登录冲突 |

---

## 🛠️ 修复步骤

### 第一步：打开云开发控制台

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入小程序后台
3. 左侧菜单选择【云开发】→【数据库】

---

### 第二步：删除错误索引

#### 2.1 orders 集合

1. 点击进入 `orders` 集合
2. 切换到【索引管理】标签
3. 找到并删除索引：
   - `orderId_1` (唯一索引) ← 删除这个

#### 2.2 income_ledger 集合

1. 点击进入 `income_ledger` 集合
2. 切换到【索引管理】标签
3. 删除索引：`orderId_1` (非唯一索引) ← 删除这个

#### 2.3 withdraw_records 集合

1. 点击进入 `withdraw_records` 集合
2. 切换到【索引管理】标签
3. 删除索引：`orderId_1` (如果存在) ← 实际名称应为 orderId_1

#### 2.4 users 集合

1. 点击进入 `users` 集合
2. 切换到【索引管理】标签
3. 检查是否有 `openid_1` 或类似索引（如果存在则删除）
   > **说明**：users集合当前已有 `_openid_1` 索引，这是正确的，无需删除

---

### 第三步：创建正确索引

#### 3.1 orders 集合

创建1个索引：

**索引：id_1（唯一）**
```json
{
  "字段名": "id",
  "索引类型": "唯一",
  "升序/降序": "升序"
}
```

> **说明**：腾讯云数据库会自动为唯一索引创建非唯一索引，所以只需创建唯一索引即可。

#### 3.2 income_ledger 集合

**索引：id_1（非唯一）**
```json
{
  "字段名": "id",
  "索引类型": "非唯一",
  "升序/降序": "升序"
}
```

> **说明**：收入记录可能有多条关联同一订单，所以使用非唯一索引。

#### 3.3 withdraw_records 集合

**索引：id_1（唯一）**
```json
{
  "字段名": "id",
  "索引类型": "唯一",
  "升序/降序": "升序"
}
```

> **说明**：提现记录ID应唯一，使用唯一索引。

#### 3.4 users 集合

**✅ 无需操作**

users 集合已有正确的 `_openid_1` 索引（唯一），无需创建新索引。

---

### 第四步：创建 sequences 集合（用于 userId 自增）

1. 在数据库页面点击【创建集合】
2. 集合名称：`sequences`
3. 创建后，点击【添加记录】
4. 输入以下JSON：

```json
{
  "_id": "userId",
  "value": 1001,
  "description": "User ID sequence"
}
```

5. 点击【确定】保存

---

### 第五步：验证索引（可选，建议使用备选方案）

> **💡 说明**：云开发控制台的查询功能可能不明显或不存在，建议直接使用下面的**备选方案**进行验证。

#### 5.1 验证 orders 集合（控制台方式 - 可跳过）

**访问路径**：
1. 打开**微信开发者工具**
2. 点击顶部工具栏的【云开发】按钮（云朵图标）
3. 进入【数据库】标签页
4. 找到 `orders` 集合并点击
5. **关键步骤**：在右侧中间位置，找到三个标签页：
   - **记录列表**
   - **索引管理**（你当前看到的）
   - **数据权限** 或其他
6. 点击 **【记录列表】** 标签，进入后会看到：
   - 顶部有筛选条件输入框
   - 或者有"查询"、"高级查询"按钮
   
> **💡 重要提示**：
> - 如果没有找到"查询"功能，可以直接使用**备选方案**（在小程序代码中验证）
> - 云开发控制台的查询功能主要用于开发测试，不是必须的
> - 索引创建后会自动生效，无需手动测试查询

**测试查询语句**（如果找到了查询输入框）：
```javascript
db.collection('orders').where({id: 'test'}).get()
```

**如果没有找到查询功能，直接跳过此步骤**，索引创建后会自动生效。

#### 5.2 验证 userId 自增功能

**操作步骤**：
1. 在小程序中点击【登录】
2. 查看**微信开发者工具控制台**（底部Console面板）是否有 `userId` 生成日志
3. 返回云开发控制台 → 数据库 → `sequences` 集合
4. 查看 `userId` 记录的 `value` 字段是否递增（如从 1001 → 1002 → 1003）

**预期结果**：
- 控制台输出：`🆕 生成新用户ID 1002` （数字递增）
- `sequences` 集合中 `value` 字段自动 +1

**验证查询**（在云开发控制台数据库查询中执行）：
```javascript
db.collection('sequences').where({_id: 'userId'}).get()
```

确认返回：
```json
{
  "_id": "userId",
  "value": 1001,  // 或更大的数字（如果已有用户注册）
  "description": "User ID sequence"
}
```

#### 5.3 ⭐ 推荐验证方案（最简单直接）

在 `miniprogram/app.js` 的 `onLaunch` 中临时添加：

```javascript
// ✅ 临时测试代码（验证完成后删除）
onLaunch() {
  // ... 现有代码 ...
  
  // 测试 orders 索引
  wx.cloud.database().collection('orders')
    .where({ id: 'test_order_123' })
    .get()
    .then(res => console.log('✅ orders 索引测试通过', res))
    .catch(err => console.error('❌ orders 索引测试失败', err))
  
  // 测试 sequences 集合
  wx.cloud.database().collection('sequences')
    .where({ _id: 'userId' })
    .get()
    .then(res => console.log('✅ sequences 集合存在', res.data))
    .catch(err => console.error('❌ sequences 集合不存在', err))
}
```

运行小程序后查看控制台输出，验证完成后**务必删除**此测试代码。

---

## 🎯 简化版操作流程（推荐新手使用）

如果觉得上面的步骤太复杂，可以按照这个简化流程：

### ✅ 必做步骤

1. **删除旧索引**（在云开发 → 数据库 → orders → 索引管理）：
   - 找到 `orderId_1`，点击【删除】
   - 找到 `income_ledger` 集合中的 `orderId_1`，点击【删除】

2. **创建新索引**（同样在索引管理页面）：
   - 在 `orders` 集合中，点击【添加索引】
     - 字段名：`id`
     - 索引类型：唯一
     - 升序
   - 在 `income_ledger` 集合中，点击【添加索引】
     - 字段名：`id`
     - 索引类型：非唯一
     - 升序

3. **创建 sequences 集合**（在数据库页面点击【创建集合】）：
   - 集合名：`sequences`
   - 创建后，点击【添加记录】，粘贴：
     ```json
     {
       "_id": "userId",
       "value": 1001,
       "description": "User ID sequence"
     }
     ```

4. **验证**：
   - 在小程序中点击【登录】
   - 看到新用户注册成功 → 说明 `sequences` 正常
   - 在订单列表能正常加载 → 说明 `orders` 索引正常

### ⚠️ 注意事项

- `users` 集合已有正确的 `_openid_1` 索引，**无需操作**
- 索引创建后会**立即生效**，无需重启
- 如果删除索引时提示"索引不存在"，直接跳过即可

完成！🎉

---

## ✅ 完成检查清单（已根据实际数据库对齐）

### 🔴 必须操作
- [ ] 删除 `orders.orderId_1` 索引（唯一）
- [ ] 删除 `income_ledger.orderId_1` 索引（非唯一）
- [ ] 创建 `orders.id` 索引（唯一） → 自动命名为 `id_1`
- [ ] 创建 `income_ledger.id` 索引（非唯一） → 自动命名为 `id_1`

### 🟡 可选操作
- [ ] 检查 `withdraw_records` 集合是否有 `orderId_1`，如有则删除并创建 `id_1`
- [ ] `users` 集合已有 `_openid_1` ✅ 无需操作

### 🟢 序列表操作
- [ ] 创建 `sequences` 集合
- [ ] 添加 userId 序列记录：`{_id: 'userId', value: 1001, description: 'User ID sequence'}`

### 🔵 验证测试
- [ ] 验证 `orders` 集合按 `id` 查询性能
- [ ] 验证 `income_ledger` 集合按 `id` 查询性能
- [ ] 验证 `userId` 自增功能（登录测试）
- [ ] 验证订单创建流程完整性

---

## ⚠️ 注意事项

1. **删除索引前备份**：建议先导出数据库备份
2. **低峰期操作**：选择用户较少时操作，避免影响查询
3. **逐个验证**：每修复一个集合，立即验证是否生效
4. **保留其他索引**：只删除/修改上述列出的错误索引，其他索引保持不变

---

## 🚨 紧急回滚

如果修复后出现问题，可以回滚：

1. 删除新创建的 `id` 和 `_openid` 索引
2. 重新创建原来的 `orderId` 和 `openid` 索引
3. 联系技术支持排查问题

---

**修复完成后，请在此标记**：✅ 已完成（日期：__________）

**操作人**：__________  
**验证人**：__________

