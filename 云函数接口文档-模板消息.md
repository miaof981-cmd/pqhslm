# 云函数接口文档 - 模板消息推送

## 📋 概述

当画师上传作品后，系统自动向客户发送模板消息，提醒客户确认订单。

---

## 🔧 云函数名称

`sendTemplateMessage`

---

## 📥 输入参数

### 请求数据结构

```javascript
{
  type: 'orderComplete',           // 消息类型
  toUser: 'oXXXX-xxxxxxxxxxxxxx',  // 接收者的 openid（买家）
  data: {
    orderId: '202510271529058195',   // 订单号
    productName: '商品名称',          // 商品名称
    artistName: '画师昵称',           // 画师昵称
    completeTime: '2025-10-27 15:29', // 完成时间
    page: 'pages/order-detail/index?id=202510271529058195&source=customer'  // 跳转页面
  }
}
```

### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | 是 | 消息类型，固定为 `orderComplete` |
| toUser | String | 是 | 接收者的 openid（买家的 openid） |
| data.orderId | String | 是 | 订单号 |
| data.productName | String | 是 | 商品名称 |
| data.artistName | String | 是 | 画师昵称 |
| data.completeTime | String | 是 | 作品完成时间 |
| data.page | String | 是 | 点击消息后跳转的小程序页面路径 |

---

## 📤 返回数据

### 成功响应

```javascript
{
  errcode: 0,
  errmsg: 'ok',
  msgid: 3442332234234  // 消息ID
}
```

### 失败响应

```javascript
{
  errcode: 40001,
  errmsg: 'invalid credential'
}
```

---

## 🎨 模板消息格式

### 模板内容示例

```
您的作品已完成
━━━━━━━━━━━━━━━━
订单号：202510271529058195
商品名称：Q版头像定制
画师：画师小明
完成时间：2025-10-27 15:29
━━━━━━━━━━━━━━━━
请点击查看详情并确认完成
```

### 模板字段映射

| 字段名 | 对应参数 | 示例 |
|--------|----------|------|
| 订单号 | data.orderId | 202510271529058195 |
| 商品名称 | data.productName | Q版头像定制 |
| 画师 | data.artistName | 画师小明 |
| 完成时间 | data.completeTime | 2025-10-27 15:29 |

---

## 💻 云函数实现示例

### 云函数代码（Node.js）

```javascript
// cloudfunctions/sendTemplateMessage/index.js

const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

exports.main = async (event, context) => {
  const { type, toUser, data } = event
  
  // 获取小程序的 access_token
  const { access_token } = await cloud.openapi.getAccessToken()
  
  try {
    // 根据消息类型选择模板
    let templateId = ''
    let templateData = {}
    
    if (type === 'orderComplete') {
      // 订单完成模板ID（需要在微信公众平台申请）
      templateId = 'YOUR_TEMPLATE_ID_HERE'
      
      // 组装模板数据
      templateData = {
        thing1: { value: data.orderId },           // 订单号
        thing2: { value: data.productName },       // 商品名称
        thing3: { value: data.artistName },        // 画师
        time4: { value: data.completeTime },       // 完成时间
        thing5: { value: '请点击查看详情并确认完成' }  // 温馨提示
      }
    }
    
    // 发送模板消息
    const result = await cloud.openapi.subscribeMessage.send({
      touser: toUser,
      page: data.page,
      data: templateData,
      templateId: templateId,
      miniprogramState: 'formal'  // 正式版：formal，开发版：developer，体验版：trial
    })
    
    console.log('模板消息发送成功:', result)
    
    return {
      success: true,
      errcode: result.errCode,
      errmsg: result.errMsg,
      msgid: result.msgId
    }
    
  } catch (err) {
    console.error('模板消息发送失败:', err)
    
    return {
      success: false,
      errcode: err.errCode || -1,
      errmsg: err.errMsg || err.message
    }
  }
}
```

---

## 📝 前端调用示例

### 在订单详情页调用

```javascript
// miniprogram/pages/order-detail/index.js

sendOrderCompleteNotice(order) {
  console.log('📨 准备发送模板消息通知')
  
  wx.cloud.callFunction({
    name: 'sendTemplateMessage',
    data: {
      type: 'orderComplete',
      toUser: order.buyerOpenId,  // 买家的 openid
      data: {
        orderId: order.id,
        productName: order.productName,
        artistName: order.artistName,
        completeTime: order.workUploadTime,
        page: `pages/order-detail/index?id=${order.id}&source=customer`
      }
    },
    success: res => {
      console.log('✅ 模板消息发送成功:', res)
      
      if (res.result.success) {
        wx.showToast({
          title: '已通知客户',
          icon: 'success'
        })
      } else {
        wx.showToast({
          title: '通知发送失败',
          icon: 'none'
        })
      }
    },
    fail: err => {
      console.error('❌ 云函数调用失败:', err)
      wx.showToast({
        title: '通知发送失败',
        icon: 'none'
      })
    }
  })
}
```

---

## 🔐 权限配置

### 1. 申请订阅消息模板

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入"功能" → "订阅消息"
3. 选择"公共模板库"
4. 搜索"订单完成通知"或类似模板
5. 添加模板并获取模板ID

### 2. 配置云函数权限

在 `cloudfunctions/sendTemplateMessage/config.json` 中配置：

```json
{
  "permissions": {
    "openapi": [
      "subscribeMessage.send"
    ]
  }
}
```

### 3. 用户授权

在发送模板消息前，需要用户授权：

```javascript
// 在下单页面或订单详情页
wx.requestSubscribeMessage({
  tmplIds: ['YOUR_TEMPLATE_ID_HERE'],
  success: (res) => {
    if (res['YOUR_TEMPLATE_ID_HERE'] === 'accept') {
      console.log('用户已授权接收模板消息')
      // 保存授权状态
    }
  }
})
```

---

## 🎯 业务流程

### 完整流程图

```
画师上传作品
    ↓
系统标记订单状态（workUploaded = true）
    ↓
弹窗询问："是否立即通知客户？"
    ↓
[立即通知] → 调用 sendOrderCompleteNotice()
    ↓
调用云函数 sendTemplateMessage
    ↓
云函数发送模板消息
    ↓
客户收到微信服务通知
    ↓
客户点击通知 → 跳转到订单详情页
    ↓
客户点击"确认完成"
    ↓
订单状态变更为"已完成"
```

---

## ⚠️ 注意事项

### 1. 模板消息限制

- 用户必须先授权才能接收消息
- 每次授权只能发送一次消息
- 建议在下单时就请求授权

### 2. 模板字段限制

- `thing` 类型：最多 20 个汉字
- `time` 类型：格式为 `YYYY-MM-DD HH:mm:ss`
- `number` 类型：纯数字
- `phrase` 类型：固定词组

### 3. 跳转路径

- 路径必须是已发布的小程序页面
- 路径格式：`pages/xxx/index?param=value`
- 不需要加 `/` 前缀

### 4. 测试环境

- 开发环境：`miniprogramState: 'developer'`
- 体验版：`miniprogramState: 'trial'`
- 正式版：`miniprogramState: 'formal'`

---

## 🧪 测试方法

### 1. 本地测试

```javascript
// 在控制台执行
const testData = {
  type: 'orderComplete',
  toUser: 'oXXXX-测试用户openid',
  data: {
    orderId: '202510271529058195',
    productName: '测试商品',
    artistName: '测试画师',
    completeTime: '2025-10-27 15:29',
    page: 'pages/order-detail/index?id=202510271529058195&source=customer'
  }
}

wx.cloud.callFunction({
  name: 'sendTemplateMessage',
  data: testData,
  success: console.log,
  fail: console.error
})
```

### 2. 查看发送记录

在微信公众平台 → "功能" → "订阅消息" → "发送记录" 中查看。

---

## 📊 数据统计

建议在云函数中记录发送日志：

```javascript
// 记录到数据库
const db = cloud.database()
await db.collection('message_logs').add({
  data: {
    type: 'orderComplete',
    toUser: toUser,
    orderId: data.orderId,
    sendTime: new Date(),
    success: true,
    errcode: result.errCode
  }
})
```

---

## 🔄 后续优化

### 1. 批量发送

如果一个画师完成多个订单，可以批量发送：

```javascript
async function batchSendNotice(orders) {
  const promises = orders.map(order => 
    wx.cloud.callFunction({
      name: 'sendTemplateMessage',
      data: { /* ... */ }
    })
  )
  
  const results = await Promise.all(promises)
  console.log('批量发送完成:', results)
}
```

### 2. 失败重试

```javascript
async function sendWithRetry(data, maxRetry = 3) {
  for (let i = 0; i < maxRetry; i++) {
    try {
      const res = await wx.cloud.callFunction({
        name: 'sendTemplateMessage',
        data: data
      })
      
      if (res.result.success) {
        return res
      }
    } catch (err) {
      if (i === maxRetry - 1) throw err
      await sleep(1000 * (i + 1))  // 延迟重试
    }
  }
}
```

---

## 📞 常见问题

### Q1: 用户没有收到消息？

**A:** 检查以下几点：
1. 用户是否已授权？
2. 模板ID是否正确？
3. openid是否正确？
4. 云函数是否部署成功？

### Q2: 提示"模板参数错误"？

**A:** 检查模板字段类型和长度限制。

### Q3: 如何获取用户的 openid？

**A:** 在下单时保存：
```javascript
// 下单时
const { openid } = await wx.cloud.callFunction({
  name: 'login'
})

order.buyerOpenId = openid
```

---

## 📚 相关文档

- [微信订阅消息官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [云开发模板消息API](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/open/subscribeMessage/subscribeMessage.send.html)

---

**最后更新**: 2025-10-27

