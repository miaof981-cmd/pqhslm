# äº‘å‡½æ•°æ¥å£æ–‡æ¡£ - æ¨¡æ¿æ¶ˆæ¯æ¨é€

## ğŸ“‹ æ¦‚è¿°

å½“ç”»å¸ˆä¸Šä¼ ä½œå“åï¼Œç³»ç»Ÿè‡ªåŠ¨å‘å®¢æˆ·å‘é€æ¨¡æ¿æ¶ˆæ¯ï¼Œæé†’å®¢æˆ·ç¡®è®¤è®¢å•ã€‚

---

## ğŸ”§ äº‘å‡½æ•°åç§°

`sendTemplateMessage`

---

## ğŸ“¥ è¾“å…¥å‚æ•°

### è¯·æ±‚æ•°æ®ç»“æ„

```javascript
{
  type: 'orderComplete',           // æ¶ˆæ¯ç±»å‹
  toUser: 'oXXXX-xxxxxxxxxxxxxx',  // æ¥æ”¶è€…çš„ openidï¼ˆä¹°å®¶ï¼‰
  data: {
    orderId: '202510271529058195',   // è®¢å•å·
    productName: 'å•†å“åç§°',          // å•†å“åç§°
    artistName: 'ç”»å¸ˆæ˜µç§°',           // ç”»å¸ˆæ˜µç§°
    completeTime: '2025-10-27 15:29', // å®Œæˆæ—¶é—´
    page: 'pages/order-detail/index?id=202510271529058195&source=customer'  // è·³è½¬é¡µé¢
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| type | String | æ˜¯ | æ¶ˆæ¯ç±»å‹ï¼Œå›ºå®šä¸º `orderComplete` |
| toUser | String | æ˜¯ | æ¥æ”¶è€…çš„ openidï¼ˆä¹°å®¶çš„ openidï¼‰ |
| data.orderId | String | æ˜¯ | è®¢å•å· |
| data.productName | String | æ˜¯ | å•†å“åç§° |
| data.artistName | String | æ˜¯ | ç”»å¸ˆæ˜µç§° |
| data.completeTime | String | æ˜¯ | ä½œå“å®Œæˆæ—¶é—´ |
| data.page | String | æ˜¯ | ç‚¹å‡»æ¶ˆæ¯åè·³è½¬çš„å°ç¨‹åºé¡µé¢è·¯å¾„ |

---

## ğŸ“¤ è¿”å›æ•°æ®

### æˆåŠŸå“åº”

```javascript
{
  errcode: 0,
  errmsg: 'ok',
  msgid: 3442332234234  // æ¶ˆæ¯ID
}
```

### å¤±è´¥å“åº”

```javascript
{
  errcode: 40001,
  errmsg: 'invalid credential'
}
```

---

## ğŸ¨ æ¨¡æ¿æ¶ˆæ¯æ ¼å¼

### æ¨¡æ¿å†…å®¹ç¤ºä¾‹

```
æ‚¨çš„ä½œå“å·²å®Œæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è®¢å•å·ï¼š202510271529058195
å•†å“åç§°ï¼šQç‰ˆå¤´åƒå®šåˆ¶
ç”»å¸ˆï¼šç”»å¸ˆå°æ˜
å®Œæˆæ—¶é—´ï¼š2025-10-27 15:29
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯·ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¹¶ç¡®è®¤å®Œæˆ
```

### æ¨¡æ¿å­—æ®µæ˜ å°„

| å­—æ®µå | å¯¹åº”å‚æ•° | ç¤ºä¾‹ |
|--------|----------|------|
| è®¢å•å· | data.orderId | 202510271529058195 |
| å•†å“åç§° | data.productName | Qç‰ˆå¤´åƒå®šåˆ¶ |
| ç”»å¸ˆ | data.artistName | ç”»å¸ˆå°æ˜ |
| å®Œæˆæ—¶é—´ | data.completeTime | 2025-10-27 15:29 |

---

## ğŸ’» äº‘å‡½æ•°å®ç°ç¤ºä¾‹

### äº‘å‡½æ•°ä»£ç ï¼ˆNode.jsï¼‰

```javascript
// cloudfunctions/sendTemplateMessage/index.js

const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

exports.main = async (event, context) => {
  const { type, toUser, data } = event
  
  // è·å–å°ç¨‹åºçš„ access_token
  const { access_token } = await cloud.openapi.getAccessToken()
  
  try {
    // æ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©æ¨¡æ¿
    let templateId = ''
    let templateData = {}
    
    if (type === 'orderComplete') {
      // è®¢å•å®Œæˆæ¨¡æ¿IDï¼ˆéœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·ï¼‰
      templateId = 'YOUR_TEMPLATE_ID_HERE'
      
      // ç»„è£…æ¨¡æ¿æ•°æ®
      templateData = {
        thing1: { value: data.orderId },           // è®¢å•å·
        thing2: { value: data.productName },       // å•†å“åç§°
        thing3: { value: data.artistName },        // ç”»å¸ˆ
        time4: { value: data.completeTime },       // å®Œæˆæ—¶é—´
        thing5: { value: 'è¯·ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¹¶ç¡®è®¤å®Œæˆ' }  // æ¸©é¦¨æç¤º
      }
    }
    
    // å‘é€æ¨¡æ¿æ¶ˆæ¯
    const result = await cloud.openapi.subscribeMessage.send({
      touser: toUser,
      page: data.page,
      data: templateData,
      templateId: templateId,
      miniprogramState: 'formal'  // æ­£å¼ç‰ˆï¼šformalï¼Œå¼€å‘ç‰ˆï¼šdeveloperï¼Œä½“éªŒç‰ˆï¼štrial
    })
    
    console.log('æ¨¡æ¿æ¶ˆæ¯å‘é€æˆåŠŸ:', result)
    
    return {
      success: true,
      errcode: result.errCode,
      errmsg: result.errMsg,
      msgid: result.msgId
    }
    
  } catch (err) {
    console.error('æ¨¡æ¿æ¶ˆæ¯å‘é€å¤±è´¥:', err)
    
    return {
      success: false,
      errcode: err.errCode || -1,
      errmsg: err.errMsg || err.message
    }
  }
}
```

---

## ğŸ“ å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### åœ¨è®¢å•è¯¦æƒ…é¡µè°ƒç”¨

```javascript
// miniprogram/pages/order-detail/index.js

sendOrderCompleteNotice(order) {
  console.log('ğŸ“¨ å‡†å¤‡å‘é€æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥')
  
  wx.cloud.callFunction({
    name: 'sendTemplateMessage',
    data: {
      type: 'orderComplete',
      toUser: order.buyerOpenId,  // ä¹°å®¶çš„ openid
      data: {
        orderId: order.id,
        productName: order.productName,
        artistName: order.artistName,
        completeTime: order.workUploadTime,
        page: `pages/order-detail/index?id=${order.id}&source=customer`
      }
    },
    success: res => {
      console.log('âœ… æ¨¡æ¿æ¶ˆæ¯å‘é€æˆåŠŸ:', res)
      
      if (res.result.success) {
        wx.showToast({
          title: 'å·²é€šçŸ¥å®¢æˆ·',
          icon: 'success'
        })
      } else {
        wx.showToast({
          title: 'é€šçŸ¥å‘é€å¤±è´¥',
          icon: 'none'
        })
      }
    },
    fail: err => {
      console.error('âŒ äº‘å‡½æ•°è°ƒç”¨å¤±è´¥:', err)
      wx.showToast({
        title: 'é€šçŸ¥å‘é€å¤±è´¥',
        icon: 'none'
      })
    }
  })
}
```

---

## ğŸ” æƒé™é…ç½®

### 1. ç”³è¯·è®¢é˜…æ¶ˆæ¯æ¨¡æ¿

1. ç™»å½•[å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥"åŠŸèƒ½" â†’ "è®¢é˜…æ¶ˆæ¯"
3. é€‰æ‹©"å…¬å…±æ¨¡æ¿åº“"
4. æœç´¢"è®¢å•å®Œæˆé€šçŸ¥"æˆ–ç±»ä¼¼æ¨¡æ¿
5. æ·»åŠ æ¨¡æ¿å¹¶è·å–æ¨¡æ¿ID

### 2. é…ç½®äº‘å‡½æ•°æƒé™

åœ¨ `cloudfunctions/sendTemplateMessage/config.json` ä¸­é…ç½®ï¼š

```json
{
  "permissions": {
    "openapi": [
      "subscribeMessage.send"
    ]
  }
}
```

### 3. ç”¨æˆ·æˆæƒ

åœ¨å‘é€æ¨¡æ¿æ¶ˆæ¯å‰ï¼Œéœ€è¦ç”¨æˆ·æˆæƒï¼š

```javascript
// åœ¨ä¸‹å•é¡µé¢æˆ–è®¢å•è¯¦æƒ…é¡µ
wx.requestSubscribeMessage({
  tmplIds: ['YOUR_TEMPLATE_ID_HERE'],
  success: (res) => {
    if (res['YOUR_TEMPLATE_ID_HERE'] === 'accept') {
      console.log('ç”¨æˆ·å·²æˆæƒæ¥æ”¶æ¨¡æ¿æ¶ˆæ¯')
      // ä¿å­˜æˆæƒçŠ¶æ€
    }
  }
})
```

---

## ğŸ¯ ä¸šåŠ¡æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
ç”»å¸ˆä¸Šä¼ ä½œå“
    â†“
ç³»ç»Ÿæ ‡è®°è®¢å•çŠ¶æ€ï¼ˆworkUploaded = trueï¼‰
    â†“
å¼¹çª—è¯¢é—®ï¼š"æ˜¯å¦ç«‹å³é€šçŸ¥å®¢æˆ·ï¼Ÿ"
    â†“
[ç«‹å³é€šçŸ¥] â†’ è°ƒç”¨ sendOrderCompleteNotice()
    â†“
è°ƒç”¨äº‘å‡½æ•° sendTemplateMessage
    â†“
äº‘å‡½æ•°å‘é€æ¨¡æ¿æ¶ˆæ¯
    â†“
å®¢æˆ·æ”¶åˆ°å¾®ä¿¡æœåŠ¡é€šçŸ¥
    â†“
å®¢æˆ·ç‚¹å‡»é€šçŸ¥ â†’ è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
    â†“
å®¢æˆ·ç‚¹å‡»"ç¡®è®¤å®Œæˆ"
    â†“
è®¢å•çŠ¶æ€å˜æ›´ä¸º"å·²å®Œæˆ"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ¨¡æ¿æ¶ˆæ¯é™åˆ¶

- ç”¨æˆ·å¿…é¡»å…ˆæˆæƒæ‰èƒ½æ¥æ”¶æ¶ˆæ¯
- æ¯æ¬¡æˆæƒåªèƒ½å‘é€ä¸€æ¬¡æ¶ˆæ¯
- å»ºè®®åœ¨ä¸‹å•æ—¶å°±è¯·æ±‚æˆæƒ

### 2. æ¨¡æ¿å­—æ®µé™åˆ¶

- `thing` ç±»å‹ï¼šæœ€å¤š 20 ä¸ªæ±‰å­—
- `time` ç±»å‹ï¼šæ ¼å¼ä¸º `YYYY-MM-DD HH:mm:ss`
- `number` ç±»å‹ï¼šçº¯æ•°å­—
- `phrase` ç±»å‹ï¼šå›ºå®šè¯ç»„

### 3. è·³è½¬è·¯å¾„

- è·¯å¾„å¿…é¡»æ˜¯å·²å‘å¸ƒçš„å°ç¨‹åºé¡µé¢
- è·¯å¾„æ ¼å¼ï¼š`pages/xxx/index?param=value`
- ä¸éœ€è¦åŠ  `/` å‰ç¼€

### 4. æµ‹è¯•ç¯å¢ƒ

- å¼€å‘ç¯å¢ƒï¼š`miniprogramState: 'developer'`
- ä½“éªŒç‰ˆï¼š`miniprogramState: 'trial'`
- æ­£å¼ç‰ˆï¼š`miniprogramState: 'formal'`

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æœ¬åœ°æµ‹è¯•

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
const testData = {
  type: 'orderComplete',
  toUser: 'oXXXX-æµ‹è¯•ç”¨æˆ·openid',
  data: {
    orderId: '202510271529058195',
    productName: 'æµ‹è¯•å•†å“',
    artistName: 'æµ‹è¯•ç”»å¸ˆ',
    completeTime: '2025-10-27 15:29',
    page: 'pages/order-detail/index?id=202510271529058195&source=customer'
  }
}

wx.cloud.callFunction({
  name: 'sendTemplateMessage',
  data: testData,
  success: console.log,
  fail: console.error
})
```

### 2. æŸ¥çœ‹å‘é€è®°å½•

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å° â†’ "åŠŸèƒ½" â†’ "è®¢é˜…æ¶ˆæ¯" â†’ "å‘é€è®°å½•" ä¸­æŸ¥çœ‹ã€‚

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

å»ºè®®åœ¨äº‘å‡½æ•°ä¸­è®°å½•å‘é€æ—¥å¿—ï¼š

```javascript
// è®°å½•åˆ°æ•°æ®åº“
const db = cloud.database()
await db.collection('message_logs').add({
  data: {
    type: 'orderComplete',
    toUser: toUser,
    orderId: data.orderId,
    sendTime: new Date(),
    success: true,
    errcode: result.errCode
  }
})
```

---

## ğŸ”„ åç»­ä¼˜åŒ–

### 1. æ‰¹é‡å‘é€

å¦‚æœä¸€ä¸ªç”»å¸ˆå®Œæˆå¤šä¸ªè®¢å•ï¼Œå¯ä»¥æ‰¹é‡å‘é€ï¼š

```javascript
async function batchSendNotice(orders) {
  const promises = orders.map(order => 
    wx.cloud.callFunction({
      name: 'sendTemplateMessage',
      data: { /* ... */ }
    })
  )
  
  const results = await Promise.all(promises)
  console.log('æ‰¹é‡å‘é€å®Œæˆ:', results)
}
```

### 2. å¤±è´¥é‡è¯•

```javascript
async function sendWithRetry(data, maxRetry = 3) {
  for (let i = 0; i < maxRetry; i++) {
    try {
      const res = await wx.cloud.callFunction({
        name: 'sendTemplateMessage',
        data: data
      })
      
      if (res.result.success) {
        return res
      }
    } catch (err) {
      if (i === maxRetry - 1) throw err
      await sleep(1000 * (i + 1))  // å»¶è¿Ÿé‡è¯•
    }
  }
}
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç”¨æˆ·æ˜¯å¦å·²æˆæƒï¼Ÿ
2. æ¨¡æ¿IDæ˜¯å¦æ­£ç¡®ï¼Ÿ
3. openidæ˜¯å¦æ­£ç¡®ï¼Ÿ
4. äº‘å‡½æ•°æ˜¯å¦éƒ¨ç½²æˆåŠŸï¼Ÿ

### Q2: æç¤º"æ¨¡æ¿å‚æ•°é”™è¯¯"ï¼Ÿ

**A:** æ£€æŸ¥æ¨¡æ¿å­—æ®µç±»å‹å’Œé•¿åº¦é™åˆ¶ã€‚

### Q3: å¦‚ä½•è·å–ç”¨æˆ·çš„ openidï¼Ÿ

**A:** åœ¨ä¸‹å•æ—¶ä¿å­˜ï¼š
```javascript
// ä¸‹å•æ—¶
const { openid } = await wx.cloud.callFunction({
  name: 'login'
})

order.buyerOpenId = openid
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡è®¢é˜…æ¶ˆæ¯å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [äº‘å¼€å‘æ¨¡æ¿æ¶ˆæ¯API](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/open/subscribeMessage/subscribeMessage.send.html)

---

**æœ€åæ›´æ–°**: 2025-10-27

