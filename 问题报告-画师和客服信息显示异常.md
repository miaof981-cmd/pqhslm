# 问题报告 - 画师和客服信息显示异常

## 📋 问题现象

### 1. 画师信息显示不一致
- **现象**：同一个画师（妙妙）上传的商品，在不同订单中显示不一致
  - 有的订单显示"妙妙" + 头像 ✅
  - 有的订单显示"画师"或"匿名画师" + 默认头像 ❌
  
### 2. 客服信息显示不一致
- **现象**：客服名称和头像显示不一致
  - 有的订单显示客服名称 + 头像 ✅
  - 有的订单显示"待分配" + 默认头像 ❌

### 3. 旧订单图片不显示
- **现象**：旧订单的商品图片显示空白
  - 新下单的订单图片正常显示 ✅
  - 之前下单的订单图片不显示 ❌

---

## 🔍 问题分析

### 根本原因
**订单数据中的画师和客服信息不完整或缺失**

1. **新订单**：下单时会保存完整的画师和客服信息 → 显示正常
2. **旧订单**：可能缺少以下字段：
   - `artistName` (画师名称)
   - `artistAvatar` (画师头像)
   - `serviceName` (客服名称)
   - `serviceAvatar` (客服头像)
   - `productId` (商品ID)
   - `productImage` (商品图片)

### 数据流向
```
订单创建 (order-success/index.js)
    ↓
保存到本地存储 (pending_orders)
    ↓
读取订单 (order-helper.js: prepareOrdersForPage)
    ↓
标准化处理 (order-helper.js: normalizeOrders)
    ↓
页面显示 (order-list/index.js)
```

---

## 📂 涉及的文件（按优先级排序）

### 🔴 核心文件（必须检查）

#### 1. `miniprogram/utils/order-helper.js`
**作用**：统一处理所有订单数据的入口
**关键函数**：
- `normalizeOrders()` - 第21-71行：标准化订单数据
- `prepareOrdersForPage()` - 第73-107行：为页面准备订单

**我的修改**：
- 添加了从商品表读取画师信息的逻辑（第27-61行）
- 优先通过 `productId` 匹配商品
- 如果没有 `productId`，通过 `productName` 匹配

**需要验证**：
- 商品表是否正确读取？
- 匹配逻辑是否生效？
- 画师信息是否正确补充到订单？

---

#### 2. `miniprogram/utils/order-status.js`
**作用**：处理订单状态和客服信息
**关键函数**：
- `withServiceFallback()` - 第205-245行：补充客服信息

**需要验证**：
- 客服列表是否正确读取？
- 客服信息是否正确匹配？
- 兜底逻辑是否合理？

---

#### 3. `miniprogram/pages/order-list/index.js`
**作用**：用户端订单列表页面
**关键函数**：
- `loadOrders()` - 第44-208行：加载订单数据

**我的修改**：
- 简化了画师信息处理（第76-79行）
- 直接使用 `order-helper` 处理好的数据

**需要验证**：
- 从 `order-helper` 获取的数据是否完整？
- 画师名称、头像、客服名称、头像是否正确显示？

---

### 🟡 数据源文件（需要检查）

#### 4. `miniprogram/pages/order-success/index.js`
**作用**：订单创建和保存
**关键函数**：
- `saveOrderToLocal()` - 第105-205行：保存订单到本地

**需要验证**：
- 新订单是否保存了完整的画师信息？
- 新订单是否保存了 `productId`？
- 新订单是否保存了客服信息？

---

#### 5. `miniprogram/pages/product-detail/index.js`
**作用**：商品详情页，下单前的数据准备
**关键位置**：
- 第575-588行：获取商品图片
- 第590-593行：获取画师信息

**需要验证**：
- 商品图片路径是否正确？
- 画师信息是否正确传递？

---

### 🟢 其他相关文件（可选检查）

#### 6. `miniprogram/pages/workspace/index.js`
**作用**：画师端工作台
**需要验证**：画师端是否也使用 `order-helper.js`？

#### 7. `miniprogram/pages/service-workspace/index.js`
**作用**：客服端工作台
**需要验证**：客服端是否也使用 `order-helper.js`？

#### 8. `miniprogram/pages/admin/index.js`
**作用**：管理端后台
**需要验证**：管理端是否也使用 `order-helper.js`？

---

## 🧪 调试建议

### 步骤1：检查商品表数据
在控制台运行：
```javascript
const products = wx.getStorageSync('products') || []
console.log('商品总数:', products.length)
products.forEach(p => {
  console.log('商品:', p.name)
  console.log('  - ID:', p.id)
  console.log('  - 画师:', p.artistName)
  console.log('  - 头像:', p.artistAvatar ? '有' : '无')
  console.log('  - 图片:', p.images?.length || 0, '张')
})
```

### 步骤2：检查订单数据
在控制台运行：
```javascript
const orders = wx.getStorageSync('pending_orders') || []
console.log('订单总数:', orders.length)
orders.forEach(o => {
  console.log('订单:', o.id)
  console.log('  - 商品名:', o.productName)
  console.log('  - productId:', o.productId || '无')
  console.log('  - 画师名:', o.artistName || '无')
  console.log('  - 画师头像:', o.artistAvatar || '无')
  console.log('  - 客服名:', o.serviceName || '无')
  console.log('  - 客服头像:', o.serviceAvatar || '无')
  console.log('  - 商品图片:', o.productImage ? '有' : '无')
})
```

### 步骤3：检查 order-helper 处理结果
在 `miniprogram/utils/order-helper.js` 第30行添加调试：
```javascript
return orders.map(order => {
  console.log('处理前:', order.id, {
    artistName: order.artistName,
    artistAvatar: order.artistAvatar ? '有' : '无',
    productId: order.productId
  })
  
  // ... 原有处理逻辑 ...
  
  console.log('处理后:', processedOrder.id, {
    artistName: processedOrder.artistName,
    artistAvatar: processedOrder.artistAvatar ? '有' : '无'
  })
  
  return processedOrder
})
```

---

## 🎯 期望的修复效果

修复后，所有订单应该：
1. ✅ 显示正确的画师名称（如"妙妙"）
2. ✅ 显示正确的画师头像
3. ✅ 显示正确的客服名称
4. ✅ 显示正确的客服头像
5. ✅ 显示商品图片（包括旧订单）
6. ✅ 四个端口（用户、画师、客服、管理）显示一致

---

## 📝 我的修复尝试

### 尝试1：在 order-list/index.js 中从商品表读取
- **结果**：被用户回退
- **原因**：用户希望在统一的地方处理

### 尝试2：在 order-helper.js 中统一处理
- **位置**：`miniprogram/utils/order-helper.js` 第37-61行
- **逻辑**：
  1. 读取商品表
  2. 通过 `productId` 或 `productName` 匹配商品
  3. 补充画师名称、头像、商品图片
- **状态**：已实施，待验证

### 尝试3：简化 order-list/index.js
- **位置**：`miniprogram/pages/order-list/index.js` 第76-79行
- **逻辑**：直接使用 `order-helper` 处理好的数据
- **状态**：已实施，待验证

---

## ❓ 可能的问题点

### 问题1：商品表中没有画师信息
**检查**：商品创建时是否保存了 `artistName` 和 `artistAvatar`？

### 问题2：productId 或 productName 不匹配
**检查**：
- 订单的 `productName` 是否与商品表的 `name` 完全一致？
- 旧订单是否有 `productId` 字段？

### 问题3：order-helper 的逻辑未生效
**检查**：
- `prepareOrdersForPage` 是否被正确调用？
- `normalizeOrders` 是否正确执行？
- 商品表是否为空？

### 问题4：客服信息的 withServiceFallback 未生效
**检查**：
- 客服列表是否正确读取？
- `serviceId` 是否正确？

---

## 🔧 给另一个AI的建议

1. **先运行调试脚本**，确认数据源是否完整
2. **检查 order-helper.js**，确认逻辑是否正确执行
3. **检查匹配逻辑**，确认 `productId` 或 `productName` 能否正确匹配
4. **检查兜底逻辑**，确认默认值是否合理
5. **检查四端一致性**，确认所有页面都使用 `prepareOrdersForPage`

---

**报告时间**: 2025-11-04  
**状态**: 待另一个AI检查和修复

