# 云数据库创建详细教程

> **适用人群**：第一次使用微信云开发数据库  
> **预计时间**：20-30分钟  
> **云环境ID**：cloud1-2gca1h9d11f4d9d2

---

## 📱 第一部分：打开云开发控制台

### 步骤1：打开微信开发者工具

1. 启动**微信开发者工具**
2. 打开你的小程序项目（联盟新程序升级）
3. 等待项目加载完成

### 步骤2：进入云开发控制台

**方式一（推荐）：**
1. 在微信开发者工具顶部菜单栏
2. 找到并点击 **"云开发"** 按钮（通常在 "编译" 按钮右侧）
3. 会打开一个新的云开发控制台窗口

**方式二：**
1. 点击左侧工具栏的 **"云开发"** 图标（云朵形状）
2. 在弹出的面板中点击 **"控制台"**

### 步骤3：确认云环境

1. 在云开发控制台左上角，确认环境ID为：`cloud1-2gca1h9d11f4d9d2`
2. 如果不是，点击环境名称下拉框切换

---

## 📦 第二部分：创建数据库集合（共12个）

### 什么是集合？
集合就像Excel的工作表，每个集合存储一类数据。例如：
- `users` 集合 → 存储用户信息
- `orders` 集合 → 存储订单信息

### 步骤1：进入数据库页面

1. 在云开发控制台左侧菜单
2. 点击 **"数据库"** 图标（表格形状）
3. 进入数据库管理界面

### 步骤2：创建第一个集合（users）

#### 2.1 点击创建集合
1. 在数据库页面，找到 **"集合名称"** 下拉框旁边
2. 点击 **"+"** 按钮 或 **"创建集合"** 按钮
3. 弹出创建集合对话框

#### 2.2 填写集合名称
1. 在 **"集合名称"** 输入框中输入：`users`
2. ⚠️ **注意**：必须全部小写，不能有空格或特殊字符

#### 2.3 设置权限 ⚠️ 重要！

**对于 users 集合**：
1. 在 **"权限设置"** 下拉框中
2. 选择：**"所有用户可读，仅创建者可写"**
3. 原因：订单列表、商品列表需要读取其他用户的昵称头像

#### 2.4 确认创建
1. 检查集合名称是否正确（`users`）
2. 检查权限是否为"仅创建者可读写"
3. 点击 **"确定"** 按钮
4. 等待创建成功（通常1-2秒）

✅ **成功标志**：左侧集合列表出现 `users` 集合

---

### 步骤3：重复创建其余11个集合

**重复步骤2的操作，依次创建以下集合：**

| 序号 | 集合名称 | 用途 | 权限设置 ⚠️ |
|-----|---------|------|-------------|
| ✅ 1 | `products` | 商品表 | 所有用户可读，仅创建者可写 |
| 2 | `banners` | 轮播图表 | 所有用户可读，仅创建者可写 |
| 3 | `notices` | 公告表 | 所有用户可读，仅创建者可写 |
| 4 | `categories` | 分类表 | 所有用户可读，仅创建者可写 |
| 5 | `service_qrcodes` | 客服二维码 | 所有用户可读，仅创建者可写 |
| 6 | `users` | 用户表 | 仅创建者可读写（云函数控制）|
| 7 | `orders` | 订单表 | 仅创建者可读写（云函数控制）|
| 8 | `buyer_shows` | 买家秀 | 仅创建者可读写（云函数控制）|
| 9 | `artist_applications` | 画师申请表 | 仅创建者可读写（云函数控制）|
| 10 | `income_ledger` | 收入账本 | 仅创建者可读写（云函数控制）|
| 11 | `withdraw_records` | 提现记录 | 仅创建者可读写（云函数控制）|
| 12 | `reward_records` | 打赏记录 | 仅创建者可读写（云函数控制）|
| 13 | `system_admin` | 管理员表 | 仅创建者可读写 |

**操作提示：**
- 每创建一个集合后，在下方打✅
- 创建完成后，左侧应该显示**13个集合**
- ⚠️ **权限设置非常重要**：
  - **前5个集合**（products、banners、notices、categories、service_qrcodes）→ **"所有用户可读，仅创建者可写"**
  - **后8个集合**（users、orders、buyer_shows、artist_applications、income_ledger、withdraw_records、reward_records、system_admin）→ **"仅创建者可读写"**
- 如果创建错误，可以右键点击集合名 → 删除

**💡 权限说明**：
- 前5个集合是公开展示数据，所有用户需要直接读取
- 后8个集合涉及复杂的多角色权限，通过**云函数API**控制访问
- `system_admin` 是管理员表，存储管理员openid用于权限判断

---

## 🔍 第三部分：创建数据库索引

### 什么是索引？
索引就像书的目录，可以让数据库快速找到数据。
- 没有索引：需要翻遍整本书（慢）
- 有索引：直接跳到目标页（快）

### 为什么需要索引？
- **提升查询速度**：订单列表、商品搜索会快很多
- **保证唯一性**：防止用户ID重复、订单号重复

---

### 步骤1：进入索引管理

1. 在左侧集合列表中，点击 **`users`** 集合
2. 在右侧页面，找到并点击 **"索引管理"** 标签
3. 进入索引管理界面

### 步骤2：创建第一个索引（users.userId）

#### 2.1 点击添加索引
1. 在索引管理页面
2. 点击 **"添加索引"** 按钮
3. 弹出添加索引对话框

#### 2.2 填写索引配置

**方式一（推荐）：使用JSON模式**

1. 在对话框中，找到 **"JSON"** 或 **"高级模式"** 选项卡
2. 在文本框中粘贴以下内容：

```json
{
  "keys": {
    "userId": 1
  },
  "unique": true
}
```

3. 点击 **"确定"** 按钮

**方式二：使用可视化模式**

1. 在对话框中，选择 **"可视化"** 或 **"基础模式"** 选项卡
2. 找到 **"索引字段"** 区域
3. 点击 **"添加字段"** 按钮
4. 字段名输入：`userId`
5. 排序选择：`升序 (1)`
6. 勾选 **"唯一索引"** 复选框
7. 点击 **"确定"** 按钮

#### 2.3 确认创建成功

✅ **成功标志**：索引列表中出现：
- 索引名：可能是 `userId_1` 或系统生成的名称
- 索引键：`userId: 1`
- 是否唯一：`是`

---

### 步骤3：创建第二个索引（users.openid）

重复步骤2，使用以下JSON：

```json
{
  "keys": {
    "openid": 1
  },
  "unique": true
}
```

✅ **完成后，users集合应该有2个索引**

---

## 📋 完整索引创建清单

### 1. users 集合（2个索引）

切换到 `users` 集合 → 索引管理 → 添加索引

**索引1：**
```json
{
  "keys": {
    "userId": 1
  },
  "unique": true
}
```

**索引2：**
```json
{
  "keys": {
    "openid": 1
  },
  "unique": true
}
```

---

### 2. orders 集合（10个索引）⚠️ 最重要

切换到 `orders` 集合 → 索引管理 → 依次添加以下10个索引

**索引1：orderId（唯一）**
```json
{
  "keys": {
    "orderId": 1
  },
  "unique": true
}
```

**索引2：buyerId**
```json
{
  "keys": {
    "buyerId": 1
  }
}
```

**索引3：artistId**
```json
{
  "keys": {
    "artistId": 1
  }
}
```

**索引4：serviceId**
```json
{
  "keys": {
    "serviceId": 1
  }
}
```

**索引5：status**
```json
{
  "keys": {
    "status": 1
  }
}
```

**索引6：createTime（倒序）**
```json
{
  "keys": {
    "createTime": -1
  }
}
```

**索引7：deadline**
```json
{
  "keys": {
    "deadline": 1
  }
}
```

**索引8：status + createTime（复合索引）**
```json
{
  "keys": {
    "status": 1,
    "createTime": -1
  }
}
```

**索引9：buyerId + status（复合索引）**
```json
{
  "keys": {
    "buyerId": 1,
    "status": 1
  }
}
```

**索引10：artistId + status（复合索引）**
```json
{
  "keys": {
    "artistId": 1,
    "status": 1
  }
}
```

✅ **完成后，orders集合应该有10个索引**

---

### 3. products 集合（4个索引）

切换到 `products` 集合 → 索引管理

**索引1：productId（唯一）**
```json
{
  "keys": {
    "productId": 1
  },
  "unique": true
}
```

**索引2：artistId**
```json
{
  "keys": {
    "artistId": 1
  }
}
```

**索引3：categoryId**
```json
{
  "keys": {
    "categoryId": 1
  }
}
```

**索引4：status**
```json
{
  "keys": {
    "status": 1
  }
}
```

✅ **完成后，products集合应该有4个索引**

---

### 4. artist_applications 集合（3个索引）

切换到 `artist_applications` 集合 → 索引管理

**索引1：userId（唯一）**
```json
{
  "keys": {
    "userId": 1
  },
  "unique": true
}
```

**索引2：artistNumber（唯一）**
```json
{
  "keys": {
    "artistNumber": 1
  },
  "unique": true
}
```

**索引3：status**
```json
{
  "keys": {
    "status": 1
  }
}
```

✅ **完成后，artist_applications集合应该有3个索引**

---

### 5. income_ledger 集合（4个索引）

切换到 `income_ledger` 集合 → 索引管理

**索引1：userId**
```json
{
  "keys": {
    "userId": 1
  }
}
```

**索引2：orderId**
```json
{
  "keys": {
    "orderId": 1
  }
}
```

**索引3：incomeType**
```json
{
  "keys": {
    "incomeType": 1
  }
}
```

**索引4：createTime（倒序）**
```json
{
  "keys": {
    "createTime": -1
  }
}
```

✅ **完成后，income_ledger集合应该有4个索引**

---

### 6. withdraw_records 集合（3个索引）

切换到 `withdraw_records` 集合 → 索引管理

**索引1：userId**
```json
{
  "keys": {
    "userId": 1
  }
}
```

**索引2：status**
```json
{
  "keys": {
    "status": 1
  }
}
```

**索引3：time（倒序）**
```json
{
  "keys": {
    "time": -1
  }
}
```

✅ **完成后，withdraw_records集合应该有3个索引**

---

### 7. 其他集合（暂不需要索引）

以下集合暂时不需要创建索引（数据量小，可后续添加）：
- `categories` - 分类表
- `notices` - 公告表
- `banners` - 轮播图表
- `reward_records` - 打赏记录
- `service_qrcodes` - 客服二维码
- `buyer_shows` - 买家秀

---

## ✅ 完成检查清单

### 集合创建检查（12个）

在云开发控制台 → 数据库 → 左侧集合列表，应该看到：

- [ ] users
- [ ] orders
- [ ] products
- [ ] artist_applications
- [ ] categories
- [ ] notices
- [ ] banners
- [ ] income_ledger
- [ ] withdraw_records
- [ ] reward_records
- [ ] service_qrcodes
- [ ] buyer_shows

**总计：12个集合**

---

### 索引创建检查（26个）

| 集合名 | 应有索引数 | 实际索引数 | 状态 |
|--------|-----------|-----------|------|
| users | 2 | ___ | ⬜ |
| orders | 10 | ___ | ⬜ |
| products | 4 | ___ | ⬜ |
| artist_applications | 3 | ___ | ⬜ |
| income_ledger | 4 | ___ | ⬜ |
| withdraw_records | 3 | ___ | ⬜ |
| **总计** | **26** | ___ | ⬜ |

**检查方法：**
1. 点击集合名
2. 点击"索引管理"标签
3. 统计索引数量（不包括系统默认的 `_id` 索引）

---

## 🎯 快速复制粘贴版

### 方式一：逐个复制粘贴（推荐新手）

按照上面的清单，每次复制一个JSON，粘贴到"添加索引"对话框

### 方式二：批量创建脚本（高级）

如果你觉得一个个创建太慢，可以使用脚本批量创建。

**步骤：**
1. 在云开发控制台 → 数据库 → 右上角找到"数据库指引"或"帮助"
2. 查看是否支持批量导入索引
3. 或联系我，我提供批量创建脚本

---

## ❓ 常见问题

### Q1：创建索引时提示"字段不存在"
**A**：这是正常的！索引可以提前创建，等数据插入时会自动使用。

### Q2：创建索引时提示"索引已存在"
**A**：说明该索引已经创建过了，跳过即可。

### Q3：索引名称显示为 `userId_1` 而不是 `userId`
**A**：这是正常的！微信云数据库会自动给索引命名，不影响使用。

### Q4：`unique: true` 是什么意思？
**A**：表示该字段的值必须唯一，不能重复。例如：
- `userId` 唯一：每个用户只有一个ID
- `orderId` 唯一：每个订单只有一个订单号

### Q5：`-1` 和 `1` 有什么区别？
**A**：
- `1` 表示升序（从小到大）
- `-1` 表示倒序（从大到小）
- 例如：`createTime: -1` 表示按创建时间倒序，最新的订单排在前面

### Q6：复合索引是什么？
**A**：包含多个字段的索引，例如：
```json
{
  "keys": {
    "status": 1,
    "createTime": -1
  }
}
```
这个索引同时按 `status` 和 `createTime` 排序，可以加速"查询某状态的订单并按时间排序"的操作。

### Q7：创建索引需要多久？
**A**：
- 集合为空时：1-2秒
- 集合有数据时：可能需要几分钟（数据量越大越慢）

### Q8：索引可以删除吗？
**A**：可以。在索引管理页面，右键点击索引 → 删除。但不建议删除，除非确定不需要。

---

## 📸 操作截图说明

**由于无法提供实际截图，这里用文字描述关键位置：**

### 云开发控制台界面
```
┌─────────────────────────────────────┐
│ 云开发 - cloud1-2gca1h9d11f4d9d2   │
├──────────┬──────────────────────────┤
│ 概览     │                          │
│ 数据库 ◄─┤  集合列表                │
│ 存储     │  ┌───────────────────┐   │
│ 云函数   │  │ + 创建集合         │   │
│ 统计     │  ├───────────────────┤   │
│          │  │ users             │   │
│          │  │ orders            │   │
│          │  │ products          │   │
│          │  │ ...               │   │
│          │  └───────────────────┘   │
└──────────┴──────────────────────────┘
```

### 创建集合对话框
```
┌──────────────────────┐
│ 创建集合              │
├──────────────────────┤
│ 集合名称:             │
│ [users        ]       │
│                       │
│ 权限设置:             │
│ [仅创建者可读写 ▼]    │
│                       │
│  [取消]  [确定]       │
└──────────────────────┘
```

### 添加索引对话框
```
┌──────────────────────┐
│ 添加索引              │
├──────────────────────┤
│ [可视化] [JSON]       │
├──────────────────────┤
│ {                     │
│   "keys": {          │
│     "userId": 1      │
│   },                 │
│   "unique": true     │
│ }                    │
│                       │
│  [取消]  [确定]       │
└──────────────────────┘
```

---

## 🎉 完成后的下一步

完成所有集合和索引创建后：

1. **截图留存**：拍一张集合列表的截图，方便以后查看
2. **告诉我**：在聊天中回复"集合和索引创建完成"
3. **下一步**：我们开始数据迁移和测试

---

## 📞 需要帮助？

如果在操作过程中遇到任何问题：
1. 截图发给我（包含错误提示）
2. 告诉我在哪一步卡住了
3. 我会立即帮你解决

**不要担心操作错误，数据库可以随时删除重建！**

---

**祝操作顺利！完成后告诉我 🎉**

