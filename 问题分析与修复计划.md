# 问题分析与修复计划

> 依据客服反馈的 25 项问题，对现有小程序与后台的代码逻辑进行了快速溯源，以下为每一项问题的可能成因与对应的修复计划。计划按优先级分类，优先处理影响下单、支付、售后流程的问题，其次是展示类与管理报表类问题。

## 高优先级（直接影响交易流程）

1. **商品图片适配变形**  
   *可能原因*：部分页面的图片容器仍然使用固定宽高比或 `mode="widthFix"`，在接口返回的原始尺寸比例与容器不一致时会被压缩。  
   *修复计划*：统一封装 `square-image` 与 `banner-image` 样式，页面内统一使用 `mode="aspectFill"` 并搭配 `padding-top` 维持比例，替换仍旧使用 `widthFix` 的位置。

2. **画师改名后橱窗显示旧昵称**  
   *可能原因*：橱窗页的数据源来自缓存的 `mock_products`，其中 `artistName` 字段在改名时未同步更新。  
   *修复计划*：在画师昵称更新逻辑中，同时更新商品、橱窗、订单缓存内的 `artistName` 字段，并在页面加载时优先读取最新的用户表昵称。

3. **首页价格区间不可点击**  
   *可能原因*：筛选面板使用 `cover-view` 叠加，未开启 `pointer-events` 或按钮被隐藏层覆盖。  
   *修复计划*：梳理筛选层的层级关系，在面板容器上加 `pointer-events: auto` 与 `z-index`，并补充单测脚本验证四个区间的点击事件。

4. **画师点击完成后顾客无法确认**  
   *可能原因*：画师端将订单状态直接写为 `completed`，顾客端重新加载时被判定已完成。  
   *修复计划*：画师端仅设置 `workCompleted=true` 并把 `status` 置为 `waitingConfirm`，顾客端保留“确认完成”按钮，同时记录拖稿天数以便客服查看。

5. **橱窗跳转画师提示不存在**  
   *可能原因*：跳转参数仍旧传入旧的 `artistId` 或者传入 `undefined`，而画师详情页只接受 `id`。  
   *修复计划*：检查橱窗、商品详情的 `navigateTo` 参数，统一传 `artistId`，并在详情页增加对 `userId`、`_id` 的兼容。

6. **用户昵称头像无法保存并被登出**  
   *可能原因*：更新接口需要校验 `token`，请求 401 后触发登录流程；保存逻辑先清空本地缓存导致页面回到登录。  
   *修复计划*：在更新前验证会话有效性，失败时提示重新登录而不是直接清空；成功保存后再刷新用户信息。

7. **订单详情客服二维码不显示**  
   *可能原因*：`serviceQRCode` 字段命名不一致（`serviceQrCode`、`serviceQrcode` 等），兜底读取 `system_settings` 时没有包含图片链接。  
   *修复计划*：扩展二维码字段的兼容读取；`contactService` 时优先使用订单内二维码，兜底读默认二维码。

8. **后台仪表盘待处理订单数量与列表不符**  
   *可能原因*：统计接口使用 `status==='pending'` 但列表过滤使用 `inProgress/processing`，导致点击后查不到数据。  
   *修复计划*：统一仪表盘统计与列表过滤的状态集合，并在前端增加空列表日志输出辅助排查。

9. **后台商品浏览量始终为 0、销量后库存不减**  
   *可能原因*：销量统计写在顾客确认完成时执行，但库存扣减逻辑缺失；浏览量统计未在商品详情埋点调用。  
   *修复计划*：在商品详情 `onShow` 时上报浏览量；在订单确认完成时扣减对应商品库存并更新 `mock_products`。

10. **后台订单初次进入显示空列表**  
    *可能原因*：页面 `onLoad` 默认筛选 `pending`，而模拟数据全部是 `inProgress`，需要再次点击“全部”才加载。  
    *修复计划*：进入页面时自动触发“全部”筛选，或默认加载全部列表。

11. **客服处理退款无状态变化**  
    *可能原因*：客服后台更新退款状态后未写回 `orders/pending_orders` 缓存；画师端仍可操作。  
    *修复计划*：在客服点击“处理退款”时统一调用 `order-helper.updateOrder`，并广播事件让画师端刷新；状态切换到 `refunding/refunded` 后禁用画师的“确认完成”。

12. **客服后台退款后管理后台仍显示制作中**  
    *可能原因*：管理后台读取的缓存没有监听退款状态变化。  
    *修复计划*：管理后台在刷新时同步读取退款状态字段，并在 UI 上优先展示退款状态。

13. **投诉专员二维码不显示**  
    *可能原因*：订单详情只读取 `complaint_qrcode` 键，后台配置使用了 `complaintQRCode`。  
    *修复计划*：扩展二维码读取键名并添加默认图。

14. **顾客缺少申请退款按钮**  
    *可能原因*：顾客端在重构时移除了退款入口。  
    *修复计划*：在订单状态为制作中/待确认时重新显示“申请退款”按钮，并复用 `requestRefund` 流程。

15. **买家秀不显示图片**  
    *可能原因*：部分旧数据的图片是 `http://tmp/` 临时路径，被 `ensureRenderableImage` 过滤成占位图。  
    *修复计划*：在发布买家秀时将临时文件上传到云存储；同时在展示页对临时路径做一次复制缓存逻辑。

16. **画师/客服提现记录加载失败**  
    *可能原因*：记录存储在 `withdraw_records`，页面读取了 `withdraw_history`。  
    *修复计划*：统一存储键名，并在请求失败时提示“暂无记录”而非报错。

17. **仪表盘画师排行榜不显示**  
    *可能原因*：排行榜依赖的统计脚本只在每日任务执行，手动刷新不会更新。  
    *修复计划*：在仪表盘加载时动态计算最近 30 天的完成订单和收入，生成排行榜。

18. **画师列表统计为 0、名片跳转不存在**  
    *可能原因*：列表数据只读取 `artist_applications`，未合并订单统计；跳转仍使用废弃的 `artistProfile` 页面。  
    *修复计划*：重构画师列表使用统一 `artist-service`；名片跳转到 `/pages/artist-detail` 并传入 `artistId`。

19. **画师业绩排行数据缺失**  
    *可能原因*：排行读取的字段 `totalRevenue` 未写入。  
    *修复计划*：复用第 17 项的动态统计结果。

20. **角色收入统计不准确**  
    *可能原因*：客服与画师共用同一用户 ID 时被算了两次或覆盖。  
    *修复计划*：统计逻辑区分角色维度，按 `roleId+userId` 聚合，同时补齐客服人工录入的订单。

21. **轮播图图片适配问题**  
    *可能原因*：轮播图仍使用固定高度+`aspectFit` 导致留白。  
    *修复计划*：统一轮播容器使用比例盒子，并设置图片 `mode="aspectFill"`。

22. **公告保存图标位置异常**  
    *可能原因*：图标按钮使用了绝对定位但父容器高度自适应导致偏移。  
    *修复计划*：改为 Flex 布局，或在按钮上重设 `line-height` 与 `align-items`。

23. **买家秀空态“去查看订单”无反应**  
    *可能原因*：`wx.switchTab` 目标页面不是 Tab 页。  
    *修复计划*：改为 `wx.navigateTo`，或将“订单列表”加入 tabBar。

24. **客服复制群名时间乱码**  
    *可能原因*：部分订单的 `deadline` 是 `Invalid Date` 或未标准化导致格式化出“NaN”。  
    *修复计划*：在 `copyGroupName` 前增加日期有效性校验，不合法时提示手动填写。

25. **客服后台缺少主动添加客户入口**  
    *需求建议*：在订单详情增加“复制客户微信号”或弹窗显示联系方式。  
    *实施计划*：在客服工作台订单详情中加入“客户联系方式”模块，并在数据模型中补充字段。

---

## 已启动修复

- 优先处理第 7、13、14、24 项，涉及客服沟通、售后流程与用户退款体验，预计可在本次改动中完成。
- 其余问题将在后续迭代中按优先级排期。

