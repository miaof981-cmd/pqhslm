# å›¾ç‰‡ä¸Šä¼ æ¥å£è¯´æ˜æ–‡æ¡£

## ğŸ“¸ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºæ‰€æœ‰éœ€è¦å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½çš„æ¨¡å—ï¼Œä»¥åŠåç«¯éœ€è¦å®ç°çš„å›¾ç‰‡å­˜å‚¨è·¯å¾„å’Œæ¥å£è§„èŒƒã€‚

---

## ğŸ—‚ï¸ å›¾ç‰‡åˆ†ç±»åŠå­˜å‚¨è·¯å¾„

### 1. å•†å“ä¸»å›¾
**ç”¨é€”**ï¼šå•†å“å±•ç¤ºçš„ä¸»è¦å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/products/{productId}/main/{timestamp}-{random}.jpg
```

**å­—æ®µå**ï¼š`images` (æ•°ç»„)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/product-edit/index.js` - `chooseImages()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šæœ€å¤š9å¼ 
- å°ºå¯¸å»ºè®®ï¼š800Ã—800px
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡2MB

---

### 2. å•†å“ç®€ä»‹å›¾
**ç”¨é€”**ï¼šå•†å“è¯¦æƒ…é¡µçš„ç®€ä»‹é…å›¾ï¼ˆæœ€å¤š3å¼ ï¼‰

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/products/{productId}/summary/{timestamp}-{random}.jpg
```

**å­—æ®µå**ï¼š`summaryImages` (æ•°ç»„)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/product-edit/index.js` - `chooseSummaryImages()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šæœ€å¤š3å¼ 
- å°ºå¯¸å»ºè®®ï¼š750Ã—500px
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡1MB

---

### 3. è§„æ ¼å›¾ç‰‡ï¼ˆä¸€çº§è§„æ ¼ï¼‰
**ç”¨é€”**ï¼šå•†å“è§„æ ¼é€‰é¡¹çš„å±•ç¤ºå›¾ç‰‡ï¼ˆå¦‚ï¼šé¢œè‰²ã€æ„å›¾ç¤ºæ„å›¾ï¼‰

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/products/{productId}/specs/level1/{timestamp}-{random}.jpg
```

**å­—æ®µå**ï¼š`specs[i].values[j].image` (å­—ç¬¦ä¸²)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/product-edit/index.js` - `chooseSpec1Image()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šæ¯ä¸ªè§„æ ¼å€¼1å¼ 
- å°ºå¯¸å»ºè®®ï¼š200Ã—200pxï¼ˆæ­£æ–¹å½¢ï¼‰
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡500KB

**æ•°æ®ç»“æ„ç¤ºä¾‹**ï¼š
```javascript
{
  specs: [
    {
      name: 'æ„å›¾ç±»å‹',
      values: [
        { 
          name: 'å¤§å¤´', 
          addPrice: '0', 
          image: '/products/123/specs/level1/1698765432-abc123.jpg'
        },
        { 
          name: 'åŠèº«', 
          addPrice: '30', 
          image: '/products/123/specs/level1/1698765433-def456.jpg'
        }
      ]
    }
  ]
}
```

---

### 4. è§„æ ¼å›¾ç‰‡ï¼ˆäºŒçº§è§„æ ¼ï¼‰
**ç”¨é€”**ï¼šäºŒçº§è§„æ ¼é€‰é¡¹çš„å±•ç¤ºå›¾ç‰‡ï¼ˆå¦‚ï¼šè¾“å‡ºæ¯”ä¾‹ç¤ºæ„å›¾ï¼‰

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/products/{productId}/specs/level2/{timestamp}-{random}.jpg
```

**å­—æ®µå**ï¼š`specs[i].values[j].image` (å­—ç¬¦ä¸²)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/product-edit/index.js` - `chooseSpec2Image()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šæ¯ä¸ªè§„æ ¼å€¼1å¼ 
- å°ºå¯¸å»ºè®®ï¼š200Ã—200pxï¼ˆæ­£æ–¹å½¢ï¼‰
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡500KB

---

### 5. ç”»å¸ˆä½œå“é›†å›¾ç‰‡
**ç”¨é€”**ï¼šç”»å¸ˆç”³è¯·æ—¶ä¸Šä¼ çš„ä½œå“å±•ç¤º

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/artists/{artistId}/portfolio/{timestamp}-{random}.jpg
```

**å­—æ®µå**ï¼š`portfolio` (æ•°ç»„)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/apply/index.js` - `choosePortfolioImages()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šæœ€å¤š6å¼ 
- å°ºå¯¸å»ºè®®ï¼š1000Ã—1000px
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡3MB

---

### 6. ç”¨æˆ·å¤´åƒ
**ç”¨é€”**ï¼šç”¨æˆ·ä¸ªäººä¸­å¿ƒçš„å¤´åƒ

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/users/{userId}/avatar/{timestamp}.jpg
```

**å­—æ®µå**ï¼š`avatar` (å­—ç¬¦ä¸²)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/user-center/index.js` - `changeAvatar()` æ–¹æ³•ï¼ˆå¾…å®ç°ï¼‰

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼š1å¼ 
- å°ºå¯¸å»ºè®®ï¼š400Ã—400pxï¼ˆæ­£æ–¹å½¢ï¼‰
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šä¸è¶…è¿‡500KB

---

### 7. è½®æ’­å›¾
**ç”¨é€”**ï¼šé¦–é¡µè½®æ’­å±•ç¤ºå›¾

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/banners/{bannerId}/{timestamp}.jpg
```

**å­—æ®µå**ï¼š`image_url` (å­—ç¬¦ä¸²)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/banner-manage/index.js` - `uploadBanner()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šä¸é™
- å°ºå¯¸å»ºè®®ï¼š750Ã—400pxï¼ˆå®½é«˜æ¯”çº¦2:1ï¼‰
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡1MB

---

### 8. å®¢æœäºŒç»´ç 
**ç”¨é€”**ï¼šå®¢æœè”ç³»äºŒç»´ç 

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/service-qr/{qrId}/{timestamp}.jpg
```

**å­—æ®µå**ï¼š`image_url` (å­—ç¬¦ä¸²)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/service-qr-manage/index.js` - `uploadQRCode()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šä¸é™
- å°ºå¯¸å»ºè®®ï¼š400Ã—400pxï¼ˆæ­£æ–¹å½¢ï¼‰
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡300KB

---

### 9. åˆ†ç±»å°é¢å›¾
**ç”¨é€”**ï¼šå•†å“åˆ†ç±»çš„å°é¢å±•ç¤º

**å­˜å‚¨è·¯å¾„å»ºè®®**ï¼š
```
/categories/{categoryId}/cover/{timestamp}.jpg
```

**å­—æ®µå**ï¼š`cover_image` (å­—ç¬¦ä¸²)

**å‰ç«¯è°ƒç”¨ä½ç½®**ï¼š
- `miniprogram/pages/category-manage/index.js` - `uploadCategoryCover()` æ–¹æ³•

**ä¸Šä¼ é™åˆ¶**ï¼š
- æ•°é‡ï¼šæ¯ä¸ªåˆ†ç±»1å¼ 
- å°ºå¯¸å»ºè®®ï¼š300Ã—300pxï¼ˆæ­£æ–¹å½¢ï¼‰
- æ ¼å¼ï¼šjpg/png/webp
- å¤§å°ï¼šæ¯å¼ ä¸è¶…è¿‡500KB

---

## ğŸ”Œ ç»Ÿä¸€å›¾ç‰‡ä¸Šä¼ æ¥å£

### æ¥å£è§„èŒƒ

**è¯·æ±‚æ–¹å¼**ï¼š`POST`

**æ¥å£åœ°å€**ï¼š
```
/api/upload/image
```

**è¯·æ±‚å‚æ•°**ï¼š
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| file | File | æ˜¯ | å›¾ç‰‡æ–‡ä»¶ |
| type | String | æ˜¯ | ä¸Šä¼ ç±»å‹ï¼ˆproduct_main/product_summary/spec_imageç­‰ï¼‰ |
| id | String | å¦ | å…³è”IDï¼ˆproductId/artistIdç­‰ï¼‰ |

**ä¸Šä¼ ç±»å‹æšä¸¾**ï¼š
```javascript
const UPLOAD_TYPES = {
  PRODUCT_MAIN: 'product_main',        // å•†å“ä¸»å›¾
  PRODUCT_SUMMARY: 'product_summary',  // å•†å“ç®€ä»‹å›¾
  SPEC_IMAGE_L1: 'spec_image_l1',      // ä¸€çº§è§„æ ¼å›¾
  SPEC_IMAGE_L2: 'spec_image_l2',      // äºŒçº§è§„æ ¼å›¾
  ARTIST_PORTFOLIO: 'artist_portfolio', // ç”»å¸ˆä½œå“é›†
  USER_AVATAR: 'user_avatar',          // ç”¨æˆ·å¤´åƒ
  BANNER: 'banner',                    // è½®æ’­å›¾
  SERVICE_QR: 'service_qr',            // å®¢æœäºŒç»´ç 
  CATEGORY_COVER: 'category_cover'     // åˆ†ç±»å°é¢
}
```

**å“åº”æ ¼å¼**ï¼š
```json
{
  "code": 0,
  "message": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "url": "https://cdn.example.com/products/123/main/1698765432-abc123.jpg",
    "path": "/products/123/main/1698765432-abc123.jpg",
    "size": 256789,
    "width": 800,
    "height": 800
  }
}
```

**é”™è¯¯å“åº”**ï¼š
```json
{
  "code": 1001,
  "message": "å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ",
  "data": null
}
```

---

## ğŸ› ï¸ å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### ä½¿ç”¨å¾®ä¿¡äº‘å¼€å‘ä¸Šä¼ 

```javascript
// å•†å“ä¸»å›¾ä¸Šä¼ 
async chooseImages() {
  try {
    const res = await wx.chooseImage({
      count: 9 - this.data.formData.images.length,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
    
    // ä¸Šä¼ åˆ°äº‘å­˜å‚¨
    const uploadPromises = res.tempFilePaths.map(filePath => {
      const cloudPath = `products/${this.data.productId}/main/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`
      return wx.cloud.uploadFile({
        cloudPath,
        filePath
      })
    })
    
    const uploadResults = await Promise.all(uploadPromises)
    const imageUrls = uploadResults.map(r => r.fileID)
    
    this.setData({
      'formData.images': [...this.data.formData.images, ...imageUrls]
    })

    wx.hideLoading()
    wx.showToast({ title: 'ä¸Šä¼ æˆåŠŸ', icon: 'success' })

  } catch (error) {
    wx.hideLoading()
    console.error('ä¸Šä¼ å¤±è´¥', error)
    wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
  }
}
```

### ä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨ä¸Šä¼ 

```javascript
// è§„æ ¼å›¾ç‰‡ä¸Šä¼ 
async chooseSpec1Image(e) {
  const index = e.currentTarget.dataset.index
  try {
    const res = await wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
    
    // ä¸Šä¼ åˆ°æœåŠ¡å™¨
    const uploadRes = await wx.uploadFile({
      url: 'https://api.example.com/api/upload/image',
      filePath: res.tempFilePaths[0],
      name: 'file',
      formData: {
        type: 'spec_image_l1',
        id: this.data.productId
      }
    })
    
    const result = JSON.parse(uploadRes.data)
    if (result.code === 0) {
      const spec1Values = [...this.data.spec1Values]
      spec1Values[index].image = result.data.url
      this.setData({ spec1Values })
      
      wx.hideLoading()
      wx.showToast({ title: 'ä¸Šä¼ æˆåŠŸ', icon: 'success' })
    } else {
      throw new Error(result.message)
    }

  } catch (error) {
    wx.hideLoading()
    console.error('ä¸Šä¼ å¤±è´¥', error)
    wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
  }
}
```

---

## ğŸ—ƒï¸ æ•°æ®åº“å­—æ®µè®¾è®¡

### å•†å“è¡¨ï¼ˆproductsï¼‰

```sql
CREATE TABLE products (
  id VARCHAR(32) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  category VARCHAR(32),
  base_price DECIMAL(10,2),
  stock INT DEFAULT 0,
  
  -- å›¾ç‰‡å­—æ®µï¼ˆJSONæ•°ç»„ï¼‰
  images JSON COMMENT 'å•†å“ä¸»å›¾æ•°ç»„',
  summary_images JSON COMMENT 'ç®€ä»‹å›¾ç‰‡æ•°ç»„',
  
  -- è§„æ ¼å­—æ®µï¼ˆJSONå¯¹è±¡ï¼‰
  specs JSON COMMENT 'è§„æ ¼é…ç½®ï¼ˆåŒ…å«è§„æ ¼å›¾ç‰‡ï¼‰',
  
  -- å…¶ä»–å­—æ®µ...
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### specså­—æ®µJSONç»“æ„ç¤ºä¾‹

```json
{
  "specs": [
    {
      "name": "æ„å›¾ç±»å‹",
      "values": [
        {
          "name": "å¤§å¤´",
          "addPrice": "0",
          "image": "https://cdn.example.com/products/123/specs/level1/1698765432-abc.jpg"
        },
        {
          "name": "åŠèº«",
          "addPrice": "30",
          "image": "https://cdn.example.com/products/123/specs/level1/1698765433-def.jpg"
        }
      ]
    },
    {
      "name": "è¾“å‡ºæ¯”ä¾‹",
      "values": [
        {
          "name": "æ‰‹æœºå£çº¸",
          "addPrice": "0",
          "image": "https://cdn.example.com/products/123/specs/level2/1698765434-ghi.jpg"
        }
      ]
    }
  ]
}
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. å›¾ç‰‡éªŒè¯
- éªŒè¯æ–‡ä»¶ç±»å‹ï¼ˆMIME typeï¼‰
- é™åˆ¶æ–‡ä»¶å¤§å°
- æ£€æŸ¥å›¾ç‰‡å°ºå¯¸
- é˜²æ­¢æ¶æ„æ–‡ä»¶ä¸Šä¼ 

### 2. å­˜å‚¨ä¼˜åŒ–
- è‡ªåŠ¨å‹ç¼©å›¾ç‰‡
- ç”Ÿæˆå¤šç§å°ºå¯¸ï¼ˆç¼©ç•¥å›¾/ä¸­å›¾/åŸå›¾ï¼‰
- ä½¿ç”¨CDNåŠ é€Ÿè®¿é—®
- å®šæœŸæ¸…ç†æ— ç”¨å›¾ç‰‡

### 3. æƒé™æ§åˆ¶
- éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
- æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆç”»å¸ˆ/ç®¡ç†å‘˜ï¼‰
- é™åˆ¶ä¸Šä¼ é¢‘ç‡ï¼ˆé˜²åˆ·ï¼‰
- è®°å½•ä¸Šä¼ æ—¥å¿—

### 4. æ–‡ä»¶å‘½å
- ä½¿ç”¨æ—¶é—´æˆ³ + éšæœºå­—ç¬¦
- é¿å…æ–‡ä»¶åå†²çª
- ä¸æš´éœ²ç”¨æˆ·ä¿¡æ¯
- ä¾¿äºç®¡ç†å’Œæ¸…ç†

---

## ğŸ“Š å›¾ç‰‡ä¸Šä¼ ç»Ÿè®¡

| æ¨¡å— | å›¾ç‰‡ç±»å‹ | æœ€å¤§æ•°é‡ | æ€»ç©ºé—´ä¼°ç®—ï¼ˆå•ä¸ªå•†å“ï¼‰ |
|------|----------|----------|----------------------|
| å•†å“ä¸»å›¾ | product_main | 9 | 9 Ã— 2MB = 18MB |
| å•†å“ç®€ä»‹ | product_summary | 3 | 3 Ã— 1MB = 3MB |
| ä¸€çº§è§„æ ¼ | spec_image_l1 | ~6 | 6 Ã— 500KB = 3MB |
| äºŒçº§è§„æ ¼ | spec_image_l2 | ~6 | 6 Ã— 500KB = 3MB |
| **å•å•†å“æ€»è®¡** | - | **~24å¼ ** | **~27MB** |

**å»ºè®®**ï¼š
- å­˜å‚¨ï¼šæ¯100ä¸ªå•†å“çº¦ 2.7GB
- CDNï¼šä½¿ç”¨ä¸ƒç‰›äº‘/é˜¿é‡Œäº‘OSS
- æ¸…ç†ï¼šå®šæœŸåˆ é™¤æœªå‘å¸ƒå•†å“çš„å›¾ç‰‡

---

## âœ… åç«¯TODOæ¸…å•

- [ ] å®ç°ç»Ÿä¸€å›¾ç‰‡ä¸Šä¼ æ¥å£ `/api/upload/image`
- [ ] é…ç½®äº‘å­˜å‚¨/OSSæœåŠ¡
- [ ] å®ç°å›¾ç‰‡å‹ç¼©å’Œå°ºå¯¸è½¬æ¢
- [ ] é…ç½®CDNåŠ é€Ÿ
- [ ] å®ç°å›¾ç‰‡åˆ é™¤æ¥å£ï¼ˆæ¸…ç†æ— ç”¨å›¾ç‰‡ï¼‰
- [ ] æ·»åŠ ä¸Šä¼ æ—¥å¿—è®°å½•
- [ ] å®ç°å›¾ç‰‡é˜²ç›—é“¾
- [ ] è®¾ç½®å›¾ç‰‡è®¿é—®æƒé™
- [ ] å®ç°æ‰¹é‡ä¸Šä¼ æ¥å£
- [ ] æ·»åŠ å›¾ç‰‡å®¡æ ¸æœºåˆ¶ï¼ˆå¯é€‰ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´10æœˆ24æ—¥  
**ç»´æŠ¤äººå‘˜**ï¼šå¼€å‘å›¢é˜Ÿ

