# 图片上传接口说明文档

## 📸 概述

本文档详细列出所有需要图片上传功能的模块，以及后端需要实现的图片存储路径和接口规范。

---

## 🗂️ 图片分类及存储路径

### 1. 商品主图
**用途**：商品展示的主要图片（最多9张）

**存储路径建议**：
```
/products/{productId}/main/{timestamp}-{random}.jpg
```

**字段名**：`images` (数组)

**前端调用位置**：
- `miniprogram/pages/product-edit/index.js` - `chooseImages()` 方法

**上传限制**：
- 数量：最多9张
- 尺寸建议：800×800px
- 格式：jpg/png/webp
- 大小：每张不超过2MB

---

### 2. 商品简介图
**用途**：商品详情页的简介配图（最多3张）

**存储路径建议**：
```
/products/{productId}/summary/{timestamp}-{random}.jpg
```

**字段名**：`summaryImages` (数组)

**前端调用位置**：
- `miniprogram/pages/product-edit/index.js` - `chooseSummaryImages()` 方法

**上传限制**：
- 数量：最多3张
- 尺寸建议：750×500px
- 格式：jpg/png/webp
- 大小：每张不超过1MB

---

### 3. 规格图片（一级规格）
**用途**：商品规格选项的展示图片（如：颜色、构图示意图）

**存储路径建议**：
```
/products/{productId}/specs/level1/{timestamp}-{random}.jpg
```

**字段名**：`specs[i].values[j].image` (字符串)

**前端调用位置**：
- `miniprogram/pages/product-edit/index.js` - `chooseSpec1Image()` 方法

**上传限制**：
- 数量：每个规格值1张
- 尺寸建议：200×200px（正方形）
- 格式：jpg/png/webp
- 大小：每张不超过500KB

**数据结构示例**：
```javascript
{
  specs: [
    {
      name: '构图类型',
      values: [
        { 
          name: '大头', 
          addPrice: '0', 
          image: '/products/123/specs/level1/1698765432-abc123.jpg'
        },
        { 
          name: '半身', 
          addPrice: '30', 
          image: '/products/123/specs/level1/1698765433-def456.jpg'
        }
      ]
    }
  ]
}
```

---

### 4. 规格图片（二级规格）
**用途**：二级规格选项的展示图片（如：输出比例示意图）

**存储路径建议**：
```
/products/{productId}/specs/level2/{timestamp}-{random}.jpg
```

**字段名**：`specs[i].values[j].image` (字符串)

**前端调用位置**：
- `miniprogram/pages/product-edit/index.js` - `chooseSpec2Image()` 方法

**上传限制**：
- 数量：每个规格值1张
- 尺寸建议：200×200px（正方形）
- 格式：jpg/png/webp
- 大小：每张不超过500KB

---

### 5. 画师作品集图片
**用途**：画师申请时上传的作品展示

**存储路径建议**：
```
/artists/{artistId}/portfolio/{timestamp}-{random}.jpg
```

**字段名**：`portfolio` (数组)

**前端调用位置**：
- `miniprogram/pages/apply/index.js` - `choosePortfolioImages()` 方法

**上传限制**：
- 数量：最多6张
- 尺寸建议：1000×1000px
- 格式：jpg/png/webp
- 大小：每张不超过3MB

---

### 6. 用户头像
**用途**：用户个人中心的头像

**存储路径建议**：
```
/users/{userId}/avatar/{timestamp}.jpg
```

**字段名**：`avatar` (字符串)

**前端调用位置**：
- `miniprogram/pages/user-center/index.js` - `changeAvatar()` 方法（待实现）

**上传限制**：
- 数量：1张
- 尺寸建议：400×400px（正方形）
- 格式：jpg/png/webp
- 大小：不超过500KB

---

### 7. 轮播图
**用途**：首页轮播展示图

**存储路径建议**：
```
/banners/{bannerId}/{timestamp}.jpg
```

**字段名**：`image_url` (字符串)

**前端调用位置**：
- `miniprogram/pages/banner-manage/index.js` - `uploadBanner()` 方法

**上传限制**：
- 数量：不限
- 尺寸建议：750×400px（宽高比约2:1）
- 格式：jpg/png/webp
- 大小：每张不超过1MB

---

### 8. 客服二维码
**用途**：客服联系二维码

**存储路径建议**：
```
/service-qr/{qrId}/{timestamp}.jpg
```

**字段名**：`image_url` (字符串)

**前端调用位置**：
- `miniprogram/pages/service-qr-manage/index.js` - `uploadQRCode()` 方法

**上传限制**：
- 数量：不限
- 尺寸建议：400×400px（正方形）
- 格式：jpg/png/webp
- 大小：每张不超过300KB

---

### 9. 分类封面图
**用途**：商品分类的封面展示

**存储路径建议**：
```
/categories/{categoryId}/cover/{timestamp}.jpg
```

**字段名**：`cover_image` (字符串)

**前端调用位置**：
- `miniprogram/pages/category-manage/index.js` - `uploadCategoryCover()` 方法

**上传限制**：
- 数量：每个分类1张
- 尺寸建议：300×300px（正方形）
- 格式：jpg/png/webp
- 大小：每张不超过500KB

---

## 🔌 统一图片上传接口

### 接口规范

**请求方式**：`POST`

**接口地址**：
```
/api/upload/image
```

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | 图片文件 |
| type | String | 是 | 上传类型（product_main/product_summary/spec_image等） |
| id | String | 否 | 关联ID（productId/artistId等） |

**上传类型枚举**：
```javascript
const UPLOAD_TYPES = {
  PRODUCT_MAIN: 'product_main',        // 商品主图
  PRODUCT_SUMMARY: 'product_summary',  // 商品简介图
  SPEC_IMAGE_L1: 'spec_image_l1',      // 一级规格图
  SPEC_IMAGE_L2: 'spec_image_l2',      // 二级规格图
  ARTIST_PORTFOLIO: 'artist_portfolio', // 画师作品集
  USER_AVATAR: 'user_avatar',          // 用户头像
  BANNER: 'banner',                    // 轮播图
  SERVICE_QR: 'service_qr',            // 客服二维码
  CATEGORY_COVER: 'category_cover'     // 分类封面
}
```

**响应格式**：
```json
{
  "code": 0,
  "message": "上传成功",
  "data": {
    "url": "https://cdn.example.com/products/123/main/1698765432-abc123.jpg",
    "path": "/products/123/main/1698765432-abc123.jpg",
    "size": 256789,
    "width": 800,
    "height": 800
  }
}
```

**错误响应**：
```json
{
  "code": 1001,
  "message": "图片格式不支持",
  "data": null
}
```

---

## 🛠️ 前端调用示例

### 使用微信云开发上传

```javascript
// 商品主图上传
async chooseImages() {
  try {
    const res = await wx.chooseImage({
      count: 9 - this.data.formData.images.length,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: '上传中...' })
    
    // 上传到云存储
    const uploadPromises = res.tempFilePaths.map(filePath => {
      const cloudPath = `products/${this.data.productId}/main/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`
      return wx.cloud.uploadFile({
        cloudPath,
        filePath
      })
    })
    
    const uploadResults = await Promise.all(uploadPromises)
    const imageUrls = uploadResults.map(r => r.fileID)
    
    this.setData({
      'formData.images': [...this.data.formData.images, ...imageUrls]
    })

    wx.hideLoading()
    wx.showToast({ title: '上传成功', icon: 'success' })

  } catch (error) {
    wx.hideLoading()
    console.error('上传失败', error)
    wx.showToast({ title: '上传失败', icon: 'none' })
  }
}
```

### 使用自建服务器上传

```javascript
// 规格图片上传
async chooseSpec1Image(e) {
  const index = e.currentTarget.dataset.index
  try {
    const res = await wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: '上传中...' })
    
    // 上传到服务器
    const uploadRes = await wx.uploadFile({
      url: 'https://api.example.com/api/upload/image',
      filePath: res.tempFilePaths[0],
      name: 'file',
      formData: {
        type: 'spec_image_l1',
        id: this.data.productId
      }
    })
    
    const result = JSON.parse(uploadRes.data)
    if (result.code === 0) {
      const spec1Values = [...this.data.spec1Values]
      spec1Values[index].image = result.data.url
      this.setData({ spec1Values })
      
      wx.hideLoading()
      wx.showToast({ title: '上传成功', icon: 'success' })
    } else {
      throw new Error(result.message)
    }

  } catch (error) {
    wx.hideLoading()
    console.error('上传失败', error)
    wx.showToast({ title: '上传失败', icon: 'none' })
  }
}
```

---

## 🗃️ 数据库字段设计

### 商品表（products）

```sql
CREATE TABLE products (
  id VARCHAR(32) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  category VARCHAR(32),
  base_price DECIMAL(10,2),
  stock INT DEFAULT 0,
  
  -- 图片字段（JSON数组）
  images JSON COMMENT '商品主图数组',
  summary_images JSON COMMENT '简介图片数组',
  
  -- 规格字段（JSON对象）
  specs JSON COMMENT '规格配置（包含规格图片）',
  
  -- 其他字段...
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### specs字段JSON结构示例

```json
{
  "specs": [
    {
      "name": "构图类型",
      "values": [
        {
          "name": "大头",
          "addPrice": "0",
          "image": "https://cdn.example.com/products/123/specs/level1/1698765432-abc.jpg"
        },
        {
          "name": "半身",
          "addPrice": "30",
          "image": "https://cdn.example.com/products/123/specs/level1/1698765433-def.jpg"
        }
      ]
    },
    {
      "name": "输出比例",
      "values": [
        {
          "name": "手机壁纸",
          "addPrice": "0",
          "image": "https://cdn.example.com/products/123/specs/level2/1698765434-ghi.jpg"
        }
      ]
    }
  ]
}
```

---

## 🔐 安全建议

### 1. 图片验证
- 验证文件类型（MIME type）
- 限制文件大小
- 检查图片尺寸
- 防止恶意文件上传

### 2. 存储优化
- 自动压缩图片
- 生成多种尺寸（缩略图/中图/原图）
- 使用CDN加速访问
- 定期清理无用图片

### 3. 权限控制
- 验证用户登录状态
- 检查用户权限（画师/管理员）
- 限制上传频率（防刷）
- 记录上传日志

### 4. 文件命名
- 使用时间戳 + 随机字符
- 避免文件名冲突
- 不暴露用户信息
- 便于管理和清理

---

## 📊 图片上传统计

| 模块 | 图片类型 | 最大数量 | 总空间估算（单个商品） |
|------|----------|----------|----------------------|
| 商品主图 | product_main | 9 | 9 × 2MB = 18MB |
| 商品简介 | product_summary | 3 | 3 × 1MB = 3MB |
| 一级规格 | spec_image_l1 | ~6 | 6 × 500KB = 3MB |
| 二级规格 | spec_image_l2 | ~6 | 6 × 500KB = 3MB |
| **单商品总计** | - | **~24张** | **~27MB** |

**建议**：
- 存储：每100个商品约 2.7GB
- CDN：使用七牛云/阿里云OSS
- 清理：定期删除未发布商品的图片

---

## ✅ 后端TODO清单

- [ ] 实现统一图片上传接口 `/api/upload/image`
- [ ] 配置云存储/OSS服务
- [ ] 实现图片压缩和尺寸转换
- [ ] 配置CDN加速
- [ ] 实现图片删除接口（清理无用图片）
- [ ] 添加上传日志记录
- [ ] 实现图片防盗链
- [ ] 设置图片访问权限
- [ ] 实现批量上传接口
- [ ] 添加图片审核机制（可选）

---

**文档版本**：v1.0  
**更新日期**：2025年10月24日  
**维护人员**：开发团队

