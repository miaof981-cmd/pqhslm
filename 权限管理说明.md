# 权限管理说明

## ⚠️ 重要安全提示

**当前权限管理仅用于开发测试，不适合生产环境！**

### 当前问题

1. **权限存储在本地** - 用户可以通过修改本地存储来获取任何权限
2. **没有服务端验证** - 所有权限检查都在前端进行
3. **容易被绕过** - 任何懂技术的用户都可以修改权限

### 生产环境必须做的改进

#### 1. 使用云开发数据库存储权限

```javascript
// 正确的做法：权限存储在云数据库
// users 集合结构
{
  _id: "xxx",
  openid: "用户的openid",
  userId: 10001,
  roles: ["customer", "artist"],  // 角色数组
  name: "用户名",
  phone: "手机号",
  createTime: "2024-01-01",
  updateTime: "2024-01-01"
}
```

#### 2. 服务端权限验证

```javascript
// 云函数：checkPermission
exports.main = async (event, context) => {
  const { OPENID } = cloud.getWXContext()
  const { requiredRole } = event
  
  // 从数据库查询用户角色
  const user = await db.collection('users').where({
    openid: OPENID
  }).get()
  
  if (user.data.length === 0) {
    return { hasPermission: false }
  }
  
  const userRoles = user.data[0].roles || ['customer']
  return { 
    hasPermission: userRoles.includes(requiredRole)
  }
}
```

#### 3. 所有敏感操作都要调用云函数验证

```javascript
// 错误做法（当前）：前端检查权限
if (app.checkPermission('admin')) {
  // 执行管理员操作
}

// 正确做法：调用云函数验证
wx.cloud.callFunction({
  name: 'checkPermission',
  data: { requiredRole: 'admin' }
}).then(res => {
  if (res.result.hasPermission) {
    // 执行管理员操作
  } else {
    wx.showToast({ title: '权限不足', icon: 'none' })
  }
})
```

## 当前权限系统

### 角色定义

```javascript
const roles = {
  customer: '普通用户',   // 默认角色，所有用户都有
  artist: '画师',         // 可以上传商品、管理订单
  admin: '管理员'         // 可以管理所有内容
}
```

### 权限存储位置

```javascript
// 本地存储
wx.setStorageSync('userRoles', ['customer', 'artist'])
wx.setStorageSync('userId', 10001)

// 全局数据
app.globalData.roles = ['customer', 'artist']
app.globalData.role = 'customer'  // 主要角色（第一个）
```

### 权限检查方法

#### 1. app.checkPermission(role)
检查用户是否拥有指定角色

```javascript
// 检查是否是管理员
if (app.checkPermission('admin')) {
  // 有管理员权限
}

// 检查是否是画师
if (app.checkPermission('artist')) {
  // 有画师权限
}
```

#### 2. app.hasAnyRole(roles)
检查用户是否拥有任一角色

```javascript
// 检查是否是画师或管理员
if (app.hasAnyRole(['artist', 'admin'])) {
  // 有画师或管理员权限
}
```

#### 3. app.getUserRoles()
获取用户的所有角色

```javascript
const roles = app.getUserRoles()
// 返回: ['customer', 'artist']
```

## 测试权限管理

### 方法1：使用权限管理页面

1. 进入"我的"页面
2. 点击"权限管理"按钮
3. 开启/关闭不同的角色权限

### 方法2：使用控制台

```javascript
// 在开发者工具控制台执行

// 添加画师权限
wx.setStorageSync('userRoles', ['customer', 'artist'])

// 添加管理员权限
wx.setStorageSync('userRoles', ['customer', 'admin'])

// 添加所有权限
wx.setStorageSync('userRoles', ['customer', 'artist', 'admin'])

// 只保留普通用户权限
wx.setStorageSync('userRoles', ['customer'])

// 刷新页面生效
```

## 页面权限要求

| 页面 | 需要权限 | 检查位置 |
|------|---------|---------|
| 首页 | 无 | - |
| 商品详情 | 无 | - |
| 购物车 | 无 | - |
| 我的 | 无 | - |
| 画师申请 | 无 | - |
| 画师工作台 | artist 或 admin | artist-dashboard/index.js:19 |
| 管理后台 | admin | user-center/index.js:192 |
| 商品编辑 | artist 或 admin | （应添加检查）|
| 订单管理 | admin | （应添加检查）|

## 安全建议

### 开发阶段（当前）
✅ 使用本地存储，方便测试
✅ 前端权限检查，快速开发
✅ 权限管理页面，方便切换角色

### 生产阶段（必须改进）
❌ 不能使用本地存储
❌ 不能只在前端检查
✅ 必须使用云数据库
✅ 必须在云函数中验证
✅ 敏感操作必须二次验证

## 迁移到生产环境的步骤

### 1. 开通云开发

```javascript
// app.js
wx.cloud.init({
  env: 'your-env-id',
  traceUser: true
})
```

### 2. 创建users集合

在云开发控制台创建`users`集合，设置权限为：
- 所有用户可读
- 仅创建者可写

### 3. 创建云函数

创建以下云函数：
- `checkPermission` - 检查权限
- `getUserRoles` - 获取用户角色
- `updateUserRoles` - 更新用户角色（仅管理员）

### 4. 修改前端代码

将所有`app.checkPermission()`替换为云函数调用：

```javascript
// 修改前
if (app.checkPermission('admin')) {
  // 执行操作
}

// 修改后
wx.cloud.callFunction({
  name: 'checkPermission',
  data: { requiredRole: 'admin' }
}).then(res => {
  if (res.result.hasPermission) {
    // 执行操作
  }
})
```

### 5. 添加管理员初始化

在云函数中添加初始管理员：

```javascript
// 云函数：initAdmin
exports.main = async (event, context) => {
  const db = cloud.database()
  
  // 检查是否已有管理员
  const admins = await db.collection('users').where({
    roles: db.command.in(['admin'])
  }).count()
  
  if (admins.total === 0) {
    // 创建初始管理员
    await db.collection('users').add({
      data: {
        openid: 'your-openid',
        userId: 10001,
        roles: ['customer', 'admin'],
        name: '初始管理员',
        createTime: new Date()
      }
    })
  }
}
```

## 常见问题

### Q: 为什么我有管理员权限但显示"普通用户"？

A: 这是因为角色标签显示的是所有角色，而用户信息中的role字段显示的是主要角色（第一个角色）。如果你的roles数组是`['customer', 'admin']`，那么主要角色就是`customer`。

**解决方法**：
1. 去权限管理页面，先关闭所有权限
2. 只开启你想要的主要权限（如admin）
3. 这样roles数组就会变成`['admin']`

### Q: 如何给其他用户添加权限？

A: 当前版本只能通过权限管理页面给自己添加权限。生产环境应该：
1. 创建管理员后台页面
2. 管理员可以搜索用户
3. 管理员可以修改其他用户的权限
4. 所有操作都要调用云函数验证

### Q: 权限会丢失吗？

A: 当前版本权限存储在本地，会在以下情况丢失：
- 清除小程序缓存
- 卸载小程序
- 切换设备

生产环境使用云数据库后，权限会永久保存。

### Q: 如何防止普通用户获取管理员权限？

A: 当前版本无法防止（这是开发测试版本的限制）。生产环境必须：
1. 权限存储在云数据库
2. 所有权限检查都在云函数中进行
3. 前端只负责显示，不负责权限判断
4. 敏感操作（如删除用户、修改权限）需要二次验证

## 总结

⚠️ **再次强调**：当前权限系统仅用于开发测试！

✅ 开发阶段优势：
- 快速测试不同角色
- 不需要配置云开发
- 方便调试

❌ 生产环境风险：
- 任何用户都可以修改权限
- 没有审计日志
- 无法追踪权限变更

📝 上线前必须：
1. 迁移到云开发
2. 实现服务端权限验证
3. 添加审计日志
4. 实现管理员审批流程

