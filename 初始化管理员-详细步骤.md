# 初始化管理员账户 - 详细步骤

> **目标**：在 system_admin 集合中添加第一个管理员  
> **预计时间**：10分钟  
> **重要性**：⭐⭐⭐⭐⭐ 必须完成，否则云函数权限控制无法使用

---

## 步骤1：获取您的 openid（5分钟）

### 1.1 打开微信开发者工具

1. 打开您的小程序项目
2. 确保小程序已经编译运行
3. 确保您已经登录（如果还没登录，先进入登录页面）

### 1.2 打开控制台

在微信开发者工具中：
- **方式一**：点击顶部菜单 → 调试 → 调试器
- **方式二**：使用快捷键 `Ctrl + Shift + I`（Windows）或 `Cmd + Option + I`（Mac）
- 控制台应该在底部或右侧打开

### 1.3 执行脚本

在控制台的"Console"标签中，复制粘贴以下代码并按回车：

```javascript
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('='.repeat(50))
    console.log('✅ 您的openid:', res.result.openid)
    console.log('='.repeat(50))
    wx.setClipboardData({
      data: res.result.openid,
      success: () => console.log('✅ openid已复制到剪贴板')
    })
  },
  fail: err => {
    console.log('❌ 调用失败，使用方式二:')
    const openid = wx.getStorageSync('openid')
    console.log('您的openid:', openid)
  }
})
```

### 1.4 复制 openid

执行成功后，控制台会显示：

```
==================================================
✅ 您的openid: oXXXX-xxxxxxxxxxxxxxxxxxxxxxxx
==================================================
✅ openid已复制到剪贴板
```

**重要**：
- 复制这个openid（如果已自动复制，可直接使用）
- openid格式类似：`oXXXX-xxxxxxxxxxxxxxxxxxxxxxxx`
- 妥善保存，待会要用

---

## 步骤2：添加管理员记录（5分钟）

### 2.1 打开云开发控制台

1. 在微信开发者工具顶部菜单
2. 点击"云开发"按钮
3. 进入云开发控制台

### 2.2 进入 system_admin 集合

1. 点击左侧"数据库"图标
2. 在左侧集合列表中，找到并点击 `system_admin`
3. 应该看到一个空的集合（没有任何记录）

### 2.3 添加记录

#### 方式一：使用"添加记录"按钮（推荐）

1. 点击右上角的"添加记录"按钮
2. 在弹出的编辑器中，粘贴以下JSON：

```json
{
  "_openid": "您的openid粘贴在这里",
  "isAdmin": true,
  "adminLevel": "super",
  "nickName": "超级管理员",
  "createdAt": "2025-11-12 10:00:00"
}
```

3. **重要**：将第2行的 `"您的openid粘贴在这里"` 替换为步骤1中获取的真实openid
4. 示例：

```json
{
  "_openid": "oXXXX-xxxxxxxxxxxxxxxxxxxxxxxx",
  "isAdmin": true,
  "adminLevel": "super",
  "nickName": "超级管理员",
  "createdAt": "2025-11-12 10:00:00"
}
```

5. 点击"确定"按钮

#### 方式二：使用"导入"功能

1. 点击"导入"按钮
2. 选择"JSON"格式
3. 粘贴上面的JSON内容（替换openid）
4. 点击"导入"

### 2.4 验证添加成功

添加完成后，在 `system_admin` 集合中应该看到：

| 字段 | 值 | 说明 |
|------|----|----|
| _id | auto_generated | 系统自动生成 |
| _openid | oXXXX-xxx... | 您的openid |
| isAdmin | true | 管理员标识 |
| adminLevel | super | 超级管理员 |
| nickName | 超级管理员 | 昵称 |
| createdAt | 2025-11-12 10:00:00 | 创建时间 |

**如果看到这条记录，说明管理员添加成功！** ✅

---

## 步骤3：测试管理员权限（可选）

### 3.1 创建测试云函数

在 `cloudfunctions` 目录下创建 `testAdmin` 文件夹：

```
cloudfunctions/
  └── testAdmin/
      ├── index.js
      └── package.json
```

**index.js**：
```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  
  // 检查是否为管理员
  const res = await db.collection('system_admin')
    .where({
      _openid: openid,
      isAdmin: true
    })
    .get()
  
  return {
    isAdmin: res.data.length > 0,
    openid: openid,
    message: res.data.length > 0 ? '您是管理员' : '您不是管理员'
  }
}
```

**package.json**：
```json
{
  "name": "testAdmin",
  "version": "1.0.0",
  "description": "测试管理员权限",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "^2.6.3"
  }
}
```

### 3.2 部署并测试

1. 右键点击 `testAdmin` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

4. 在控制台执行测试：

```javascript
wx.cloud.callFunction({
  name: 'testAdmin',
  success: res => {
    console.log('测试结果:', res.result)
    if (res.result.isAdmin) {
      console.log('✅ 管理员权限验证成功！')
    } else {
      console.log('❌ 管理员权限验证失败，请检查system_admin集合')
    }
  }
})
```

如果看到"✅ 管理员权限验证成功！"，说明一切正常！

---

## ❓ 常见问题

### Q1：找不到 system_admin 集合？

**A**：请检查：
1. 是否已创建 system_admin 集合？
2. 集合名称是否正确（全小写，下划线连接）
3. 如果没有，在云开发控制台 → 数据库 → 创建集合 → 输入 `system_admin`

### Q2：获取不到 openid？

**A**：请检查：
1. 小程序是否已运行？
2. 是否已登录？（进入登录页面）
3. 云开发环境是否已初始化？（app.js 中的 `wx.cloud.init()`）

**备用方案**：
```javascript
// 在 app.js 的 onLaunch 中添加
console.log('当前 openid:', this.globalData.openid)
```

### Q3：添加记录时提示权限不足？

**A**：这是因为集合权限设置的问题。
- 方式一：在云开发控制台手动添加（推荐）
- 方式二：临时修改 system_admin 集合权限为"所有人可读写"，添加完成后改回"仅创建者可读写"

### Q4：openid 格式不对？

**A**：正确的openid格式：
- 以 `o` 开头
- 后面跟随28个字符（数字+字母+特殊字符）
- 示例：`oXXXX-xxxxxxxxxxxxxxxxxxxxxxxx`

如果格式不对，请检查是否完整复制。

---

## ✅ 完成检查清单

完成后，请确认以下内容：

- [ ] 已获取到 openid
- [ ] openid 格式正确（`oXXXX-xxx...`）
- [ ] 已在 system_admin 集合中添加管理员记录
- [ ] 记录中的 _openid 字段正确
- [ ] isAdmin 字段为 true
- [ ] 可以在云开发控制台看到这条记录

---

## 🎯 下一步

完成后，回复："管理员初始化完成"

我会进入下一步：决定是否迁移数据。

