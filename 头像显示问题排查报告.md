# 头像显示问题排查报告

## 问题描述

**现象**：管理后台的画师列表中，用户"11"（ID: 1001）的头像显示为默认SVG头像（绿色背景+"画"字），而不是用户上传的微信头像。

**用户信息**：
- 用户ID: 1001
- 昵称: 妙妙
- 角色: `["customer", "admin", "artist"]`
- 申请状态: approved（已通过）

---

## 问题定位

### 1. 头像读取逻辑

#### 管理后台画师列表 (`miniprogram/pages/admin/index.js`)

**代码位置**: 第 333-357 行

```javascript
// 获取用户头像和昵称
const currentUserId = wx.getStorageSync('userId')
let avatar = ''
let nickname = app.name

// 如果是当前用户，优先使用微信头像
if (String(app.userId) === String(currentUserId)) {
  const wxUserInfo = wx.getStorageSync('wxUserInfo') || {}
  if (wxUserInfo.avatarUrl) {
    avatar = wxUserInfo.avatarUrl
    nickname = wxUserInfo.nickName || app.name
  }
} else {
  // 其他画师，尝试从申请记录读取头像
  if (app.avatar) {
    avatar = app.avatar
  }
  nickname = app.name
}

// 如果还是没有头像，使用默认SVG头像
if (!avatar) {
  avatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI0E4RTZDRiIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSI0MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7nlLs8L3RleHQ+PC9zdmc+'
}
```

**逻辑分析**：
1. 读取当前用户ID (`userId`)
2. 如果画师是当前用户，从 `wxUserInfo` 读取头像
3. 如果不是当前用户，从申请记录 (`app.avatar`) 读取头像
4. 如果都没有，使用默认SVG头像

---

### 2. 可能的原因

#### 原因A: `wxUserInfo` 未保存或为空

**检查方法**：
```javascript
// 在控制台执行
wx.getStorageSync('wxUserInfo')
```

**预期结果**：
```javascript
{
  avatarUrl: "https://thirdwx.qlogo.cn/...",
  nickName: "妙妙"
}
```

**如果返回 `null` 或 `{}`**：
- 说明登录时没有保存微信用户信息
- 需要检查登录页面的逻辑

---

#### 原因B: `avatarUrl` 字段不存在

**检查方法**：
```javascript
// 在控制台执行
const wxUserInfo = wx.getStorageSync('wxUserInfo')
console.log('wxUserInfo:', wxUserInfo)
console.log('avatarUrl:', wxUserInfo?.avatarUrl)
```

**如果 `avatarUrl` 为 `undefined`**：
- 说明保存的数据结构不对
- 可能保存的是 `avatar` 而不是 `avatarUrl`

---

#### 原因C: 申请记录中没有保存头像

**检查方法**：
```javascript
// 在控制台执行
const allApplications = wx.getStorageSync('artist_applications') || []
const myApp = allApplications.find(app => app.userId == 1001)
console.log('我的申请记录:', myApp)
console.log('申请记录中的头像:', myApp?.avatar)
```

**如果 `myApp.avatar` 为 `undefined`**：
- 说明申请时没有保存头像
- 需要检查申请页面的逻辑

---

### 3. 登录页面检查

#### 登录页面路径
`miniprogram/pages/login/index.js`

#### 需要检查的关键代码

**保存用户信息的逻辑**：
```javascript
// 应该有类似这样的代码
wx.setStorageSync('wxUserInfo', {
  avatarUrl: avatarUrl,  // ⚠️ 检查字段名是否正确
  nickName: nickName
})
```

**可能的问题**：
1. 字段名错误（`avatar` vs `avatarUrl`）
2. 没有保存头像
3. 头像路径无效

---

### 4. 申请页面检查

#### 申请页面路径
`miniprogram/pages/apply/index.js`

#### 需要检查的关键代码

**保存申请记录的逻辑**：
```javascript
// 应该有类似这样的代码
const application = {
  userId: userId,
  name: name,
  avatar: avatarUrl,  // ⚠️ 检查是否保存了头像
  // ... 其他字段
}

allApplications.push(application)
wx.setStorageSync('artist_applications', allApplications)
```

---

## 调试步骤

### 步骤1: 检查本地存储

在控制台依次执行以下命令：

```javascript
// 1. 检查当前用户ID
console.log('当前用户ID:', wx.getStorageSync('userId'))

// 2. 检查微信用户信息
const wxUserInfo = wx.getStorageSync('wxUserInfo')
console.log('微信用户信息:', wxUserInfo)
console.log('头像URL:', wxUserInfo?.avatarUrl)
console.log('昵称:', wxUserInfo?.nickName)

// 3. 检查画师申请记录
const allApplications = wx.getStorageSync('artist_applications') || []
const myApp = allApplications.find(app => app.userId == 1001)
console.log('我的申请记录:', myApp)
console.log('申请记录中的头像:', myApp?.avatar)

// 4. 检查所有存储的key
console.log('所有存储的key:', wx.getStorageInfoSync())
```

---

### 步骤2: 查看完整的调试日志

点击管理后台的"管理"按钮 → "查看该画师的所有商品"，查看控制台输出：

```
=== 画师商品管理页 - 加载画师信息 ===
artistId: 1001 string
currentUserId: 1001 number
所有画师申请: [...]
检查 userId=1001, status=approved, 匹配=true
找到画师申请: {...}
是否为当前用户: true
微信用户信息: {...}  ⬅️ 重点看这里
使用微信头像: ...     ⬅️ 重点看这里
最终设置的头像: ...   ⬅️ 重点看这里
```

---

### 步骤3: 检查登录流程

1. 退出登录（如果有退出功能）
2. 重新登录
3. 观察登录时是否正确保存了头像
4. 检查控制台是否有错误信息

---

## 可能的解决方案

### 方案A: 字段名不匹配

**问题**: 保存的是 `avatar`，读取的是 `avatarUrl`

**解决**: 统一字段名

```javascript
// 登录页面保存时
wx.setStorageSync('wxUserInfo', {
  avatarUrl: avatarUrl,  // 使用 avatarUrl
  nickName: nickName
})

// 或者修改读取逻辑
const avatar = wxUserInfo.avatarUrl || wxUserInfo.avatar  // 兼容两种字段名
```

---

### 方案B: 登录时未保存头像

**问题**: `wxUserInfo` 为空或没有 `avatarUrl`

**解决**: 修改登录页面，确保保存头像

```javascript
// 在登录成功后
const avatarUrl = e.detail.avatarUrl  // 从选择头像组件获取
const nickName = this.data.nickname

wx.setStorageSync('wxUserInfo', {
  avatarUrl: avatarUrl,
  nickName: nickName
})
```

---

### 方案C: 申请时未保存头像

**问题**: 申请记录中没有 `avatar` 字段

**解决**: 修改申请页面，保存头像到申请记录

```javascript
// 提交申请时
const wxUserInfo = wx.getStorageSync('wxUserInfo')
const application = {
  userId: userId,
  name: name,
  avatar: wxUserInfo?.avatarUrl || '',  // 从 wxUserInfo 读取头像
  // ... 其他字段
}
```

---

### 方案D: 强制刷新头像

**临时解决**: 手动设置头像

```javascript
// 在控制台执行（仅用于测试）
wx.setStorageSync('wxUserInfo', {
  avatarUrl: 'https://你的头像URL',
  nickName: '妙妙'
})

// 然后刷新页面
```

---

## 需要检查的文件

### 1. 登录页面
- **路径**: `miniprogram/pages/login/index.js`
- **检查**: `wx.setStorageSync('wxUserInfo', ...)` 的逻辑
- **字段**: 确保保存了 `avatarUrl` 和 `nickName`

### 2. 申请页面
- **路径**: `miniprogram/pages/apply/index.js`
- **检查**: 提交申请时是否保存了 `avatar` 字段
- **来源**: 应该从 `wxUserInfo.avatarUrl` 读取

### 3. 管理后台
- **路径**: `miniprogram/pages/admin/index.js`
- **检查**: 第 333-357 行的头像读取逻辑
- **问题**: 可能需要兼容不同的字段名

### 4. 画师商品管理页
- **路径**: `miniprogram/pages/artist-products-manage/index.js`
- **检查**: 第 28-101 行的头像读取逻辑
- **调试**: 已添加详细日志，查看控制台输出

---

## 快速诊断命令

复制以下代码到控制台执行，一次性检查所有可能的问题：

```javascript
console.log('========== 头像问题诊断 ==========')

// 1. 用户ID
const userId = wx.getStorageSync('userId')
console.log('✓ 当前用户ID:', userId)

// 2. 微信用户信息
const wxUserInfo = wx.getStorageSync('wxUserInfo')
console.log('✓ 微信用户信息:', wxUserInfo)
if (!wxUserInfo) {
  console.error('❌ wxUserInfo 为空！')
} else if (!wxUserInfo.avatarUrl && !wxUserInfo.avatar) {
  console.error('❌ wxUserInfo 中没有头像字段！')
  console.log('   可用字段:', Object.keys(wxUserInfo))
} else {
  console.log('✓ 头像URL:', wxUserInfo.avatarUrl || wxUserInfo.avatar)
}

// 3. 画师申请记录
const allApplications = wx.getStorageSync('artist_applications') || []
const myApp = allApplications.find(app => app.userId == userId)
console.log('✓ 我的申请记录:', myApp)
if (!myApp) {
  console.error('❌ 未找到申请记录！')
} else if (!myApp.avatar) {
  console.warn('⚠️ 申请记录中没有头像')
} else {
  console.log('✓ 申请记录中的头像:', myApp.avatar)
}

// 4. 所有存储信息
const storageInfo = wx.getStorageInfoSync()
console.log('✓ 本地存储概况:', storageInfo)

console.log('========== 诊断完成 ==========')
```

---

## 预期输出示例

### 正常情况
```
========== 头像问题诊断 ==========
✓ 当前用户ID: 1001
✓ 微信用户信息: {avatarUrl: "https://...", nickName: "妙妙"}
✓ 头像URL: https://...
✓ 我的申请记录: {userId: 1001, name: "11", avatar: "https://...", ...}
✓ 申请记录中的头像: https://...
✓ 本地存储概况: {keys: [...], currentSize: ..., limitSize: ...}
========== 诊断完成 ==========
```

### 异常情况1: wxUserInfo为空
```
========== 头像问题诊断 ==========
✓ 当前用户ID: 1001
✓ 微信用户信息: null
❌ wxUserInfo 为空！
✓ 我的申请记录: {userId: 1001, name: "11", ...}
⚠️ 申请记录中没有头像
========== 诊断完成 ==========
```
**解决**: 需要修复登录页面，确保保存 `wxUserInfo`

### 异常情况2: 字段名错误
```
========== 头像问题诊断 ==========
✓ 当前用户ID: 1001
✓ 微信用户信息: {avatar: "https://...", nickname: "妙妙"}
❌ wxUserInfo 中没有头像字段！
   可用字段: ["avatar", "nickname"]
✓ 我的申请记录: {userId: 1001, name: "11", ...}
========== 诊断完成 ==========
```
**解决**: 字段名不匹配，需要统一为 `avatarUrl` 和 `nickName`

---

## 总结

### 问题根源（最可能）

1. **登录时未保存头像** (80%可能性)
   - `wxUserInfo` 为空或缺少 `avatarUrl` 字段
   
2. **字段名不匹配** (15%可能性)
   - 保存的是 `avatar`，读取的是 `avatarUrl`
   
3. **申请时未保存头像** (5%可能性)
   - 申请记录中缺少 `avatar` 字段

### 下一步行动

1. **立即执行快速诊断命令**，确定具体问题
2. **根据诊断结果**，修改对应的页面代码
3. **重新登录**，测试头像是否正常显示

---

## 附录：相关代码文件

### 需要检查的文件清单
```
miniprogram/
├── pages/
│   ├── login/
│   │   └── index.js          ⬅️ 检查 wxUserInfo 保存逻辑
│   ├── apply/
│   │   └── index.js          ⬅️ 检查申请时是否保存头像
│   ├── admin/
│   │   └── index.js          ⬅️ 第333-357行，头像读取逻辑
│   └── artist-products-manage/
│       └── index.js          ⬅️ 第28-101行，头像读取逻辑（已添加日志）
```

---

**报告生成时间**: 2025-10-26
**问题状态**: 待诊断
**下一步**: 执行快速诊断命令，确定具体原因

