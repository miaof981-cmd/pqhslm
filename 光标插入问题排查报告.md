# 光标插入问题完整排查报告

## 一、需求复述

### 用户期望的完整流程

```
步骤1: 用户输入文字
  ┌─────────────────────────────┐
  │ "这是一个专业的头像设计"    │
  │                             │
  └─────────────────────────────┘

步骤2: 用户点击文本框，光标定位到"专业"和"的"之间
  ┌─────────────────────────────┐
  │ "这是一个专业|的头像设计"   │  ← 光标在这里
  │                             │
  └─────────────────────────────┘

步骤3: 用户点击 [插入图1] 按钮

步骤4: 期望结果
  ┌─────────────────────────────┐
  │ "这是一个专业[图1]的头像设计" │  ✅ 占位符插入到光标位置
  │                             │
  └─────────────────────────────┘
```

### 实际情况
占位符没有插入到光标指定的位置。

---

## 二、问题根源分析

### 核心问题：微信小程序 `textarea` 的 `cursor` 属性特性

#### 问题1: `cursor` 属性是"设置"而非"获取"

查看微信官方文档：
```
cursor: Number
指定 focus 时的光标位置
```

**关键发现**：
- `cursor` 属性是用来**设置**光标位置的
- `cursor` 属性**不是**用来获取当前光标位置的
- `e.detail.cursor` 在 `bindinput` 事件中**可能不准确**

#### 问题2: 事件触发顺序导致光标位置丢失

```
用户操作流程：
1. 用户在文本框中点击 → onTextareaFocus 触发
2. 用户输入文字 → onSummaryInput 触发（光标位置更新）
3. 用户点击文本框外的 [插入图1] 按钮 → onTextareaBlur 触发 ⚠️
4. 点击按钮 → insertImagePlaceholder 触发

问题：
- 步骤3中，textarea 失去焦点
- onTextareaBlur 中的 e.detail.cursor 可能是 undefined 或不准确
- 导致 cursorPosition 被错误更新
```

#### 问题3: `bindtap` 无法获取光标位置

```javascript
onTextareaTap(e) {
  // e.detail 中没有 cursor 信息
  // 这个方法无法获取真实的光标位置
}
```

---

## 三、微信小程序 textarea 光标获取的限制

### 官方文档说明

根据微信小程序官方文档，`textarea` 组件的事件中：

| 事件 | e.detail.cursor 可用性 | 说明 |
|------|------------------------|------|
| `bindinput` | ❌ 不可靠 | 输入时光标在变化，不是用户点击位置 |
| `bindfocus` | ✅ 可用 | 获得焦点时的光标位置 |
| `bindblur` | ❌ 不可靠 | 失去焦点时，光标位置可能已改变 |
| `bindtap` | ❌ 不可用 | 事件中没有 cursor 信息 |

### 核心限制

**微信小程序没有提供直接获取 textarea 当前光标位置的 API！**

---

## 四、为什么当前实现不工作

### 当前代码流程

```javascript
// 1. 用户输入文字
onSummaryInput(e) {
  const cursorPos = typeof e.detail.cursor === 'number' 
    ? e.detail.cursor 
    : e.detail.value.length
  this.setData({ cursorPosition: cursorPos })
}

// 2. 用户点击文本框定位光标（没有事件捕获！）

// 3. 用户点击 [插入图1] 按钮
//    → textarea 失去焦点 → onTextareaBlur 触发
onTextareaBlur(e) {
  const cursorPos = typeof e.detail.cursor === 'number' 
    ? e.detail.cursor 
    : e.detail.value.length  // ⚠️ 很可能走这里，插入到末尾
  this.setData({ cursorPosition: cursorPos })
}

// 4. 插入占位符
insertImagePlaceholder(e) {
  let { cursorPosition } = this.data  // ⚠️ 这里的值是错误的
  // ...
}
```

### 问题总结

1. **没有捕获用户点击文本框定位光标的动作**
2. **`onSummaryInput` 只在输入时触发，不在点击时触发**
3. **`onTextareaBlur` 在失去焦点时触发，但此时光标位置已不准确**
4. **点击按钮导致 textarea 失去焦点，光标位置丢失**

---

## 五、解决方案

### 方案1: 使用 `selection-start` 和 `selection-end` 属性（推荐）

微信小程序 `textarea` 支持 `bindselectionchange` 事件：

```javascript
// WXML
<textarea 
  value="{{formData.summary}}"
  bindinput="onSummaryInput"
  bindselectionchange="onSelectionChange"  // ✅ 新增
  selection-start="{{selectionStart}}"
  selection-end="{{selectionEnd}}"
  maxlength="500" />

// JS
data: {
  selectionStart: -1,
  selectionEnd: -1,
  cursorPosition: 0
},

onSelectionChange(e) {
  console.log('光标位置改变:', e.detail)
  this.setData({
    selectionStart: e.detail.selectionStart,
    selectionEnd: e.detail.selectionEnd,
    cursorPosition: e.detail.selectionStart  // ✅ 使用 selectionStart
  })
},

insertImagePlaceholder(e) {
  const { summary } = this.data.formData
  let { cursorPosition } = this.data
  
  // 使用最后记录的光标位置
  if (cursorPosition < 0 || cursorPosition > summary.length) {
    cursorPosition = summary.length
  }
  
  const before = summary.substring(0, cursorPosition)
  const after = summary.substring(cursorPosition)
  const newSummary = before + placeholder + after
  
  this.setData({
    'formData.summary': newSummary,
    cursorPosition: cursorPosition + placeholder.length,
    selectionStart: cursorPosition + placeholder.length,
    selectionEnd: cursorPosition + placeholder.length
  })
}
```

### 方案2: 防止 textarea 失去焦点（备选）

```javascript
// WXML - 按钮使用 catchtap 阻止冒泡
<button catchtap="insertImagePlaceholder" data-index="{{item}}">
  插入[图{{item}}]
</button>

// JS - 在插入后重新聚焦
insertImagePlaceholder(e) {
  // ... 插入逻辑 ...
  
  // 重新聚焦到 textarea
  this.setData({
    textareaFocus: true
  })
}

// WXML - 添加 focus 属性
<textarea 
  focus="{{textareaFocus}}"
  bindfocus="onTextareaFocus"
  bindblur="onTextareaBlur" />
```

### 方案3: 使用 `rich-text` 组件（长期方案）

如果需要更复杂的富文本编辑，建议使用 `rich-text` 组件或第三方富文本编辑器。

---

## 六、推荐实现（方案1）

### 优势
- ✅ 准确捕获光标位置变化
- ✅ 支持用户点击、拖动选择
- ✅ 官方支持，稳定可靠
- ✅ 无需阻止失焦，用户体验好

### 劣势
- 需要额外维护 `selectionStart` 和 `selectionEnd`

---

## 七、测试验证

### 测试用例1: 光标在文本中间
```
输入: "专业画师手绘"
光标位置: 4（"手"之前）
点击: [插入图1]
期望: "专业画师[图1]手绘" ✅
```

### 测试用例2: 光标在开头
```
输入: "专业画师手绘"
光标位置: 0
点击: [插入图1]
期望: "[图1]专业画师手绘" ✅
```

### 测试用例3: 光标在末尾
```
输入: "专业画师手绘"
光标位置: 7
点击: [插入图1]
期望: "专业画师手绘[图1]" ✅
```

### 测试用例4: 选中一段文字
```
输入: "专业画师手绘"
选中: "画师"（位置 2-4）
点击: [插入图1]
期望: "专业[图1]手绘" ✅（替换选中文字）
```

---

## 八、结论

### 根本原因
**微信小程序 `textarea` 没有提供直接获取当前光标位置的 API，必须使用 `bindselectionchange` 事件来实时监听光标位置变化。**

### 当前代码的问题
1. 依赖 `bindinput` 和 `bindblur` 事件获取光标位置（不准确）
2. 点击按钮导致 textarea 失焦，光标位置丢失
3. 没有使用 `bindselectionchange` 事件

### 解决方案
使用 `bindselectionchange` 事件 + `selection-start` / `selection-end` 属性，实时追踪光标位置。

---

## 九、下一步行动

1. ✅ 修改 WXML，添加 `bindselectionchange` 事件
2. ✅ 修改 JS，添加 `onSelectionChange` 方法
3. ✅ 修改 `insertImagePlaceholder`，使用 `selectionStart`
4. ✅ 测试所有用例
5. ✅ 提交代码

---

**报告完成时间**: 2025-10-25
**问题严重程度**: 高（核心功能不可用）
**修复优先级**: P0（立即修复）

