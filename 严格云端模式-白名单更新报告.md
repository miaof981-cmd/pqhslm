# 严格云端模式 - 白名单更新报告

**更新时间**：2025-11-22  
**更新原因**：补充 UI 辅助功能和待云端化的数据

---

## 一、白名单更新内容

### ✅ 新增白名单键（4个）

| 缓存键 | 类型 | 用途 | 优先级 |
|--------|------|------|--------|
| `product_draft` | UI辅助 | 商品编辑草稿，防止用户数据丢失 | 保留 |
| `reject_templates` | UI辅助 | 审核驳回模板，提高审核效率 | 保留 |
| `search_history_keywords` | UI辅助 | 搜索历史记录 | 保留 |
| `workspace_role` | UI状态 | 工作台角色选择 | 保留 |
| `needRefresh` | UI状态 | 页面刷新标志 | 保留 |
| `cart_items` | 核心业务 | 购物车数据 | **P2 待云端化** |
| `buyer_show_posts` | 核心业务 | 买家秀帖子 | **P2 待云端化** |

---

## 二、更新后的完整白名单

### 当前白名单（16个键）

```javascript
ALLOWED_KEYS = [
  // === 核心系统缓存 ===
  'logs',                    // 系统日志
  'userId',                  // 用户ID缓存（从云端获取后缓存）
  'openid',                  // 用户openid缓存
  'userInfo',                // 用户基本信息缓存（从云端获取后缓存）
  'userRoles',               // 用户角色缓存（从云端获取后缓存）
  'hasLoggedIn',             // 登录状态标记
  'isGuestMode',             // 游客模式标记
  
  // === UI 辅助功能 ===
  'product_draft',           // 商品编辑草稿（用户体验必需）
  'reject_templates',        // 审核驳回模板（用户体验必需）
  'search_history_keywords', // 搜索历史（UI辅助）
  'workspace_role',          // 工作台角色选择（UI状态）
  'needRefresh',             // 刷新标志（UI状态）
  
  // === 待云端化数据（临时允许）===
  'cart_items',              // 购物车（待云端化 P2）
  'buyer_show_posts',        // 买家秀帖子（待云端化 P2）
  
  // === 遗留标记 ===
  'avatar_migrated_v2',      // 头像迁移标记（已废弃）
  'userId_counter'           // userId计数器（已废弃）
]
```

**分类统计**：
- ✅ 核心系统缓存：7个
- ✅ UI 辅助功能：5个
- ⏳ 待云端化数据：2个
- ⚠️ 遗留标记：2个

---

## 三、黑名单（保持不变）

### 禁止的缓存模式（17种）

```javascript
FORBIDDEN_PATTERNS = [
  // === 订单相关 ===
  /^pending_orders$/,
  /^completed_orders$/,
  /^orders$/,
  /^mock_orders$/,
  /^guest_orders$/,
  
  // === 商品/服务相关 ===
  /^mock_products$/,
  /^products$/,
  /^service_list$/,
  /^customer_service_list$/,
  /^product_categories$/,
  
  // === 用户/申请相关 ===
  /^artist_applications$/,
  
  // === 财务相关 ===
  /^withdraw_records$/,
  /^reward_records$/,
  /^income_ledger$/,
  
  // === 通配模式 ===
  /.*_draft$/,      // 所有草稿（product_draft 已加白名单）
  /.*_cache$/,      // 所有缓存
  /.*_temp$/        // 所有临时数据
]
```

**⚠️ 注意**：白名单优先级高于黑名单！

---

## 四、更新原因分析

### 1. UI 辅助功能（必须加白名单）

#### `product_draft` - 商品编辑草稿
- **用途**：保存用户正在编辑的商品信息
- **必要性**：防止意外退出导致数据丢失（用户体验关键）
- **风险**：低（仅影响当前用户，不涉及数据一致性）
- **决策**：✅ 加入白名单

#### `reject_templates` - 审核驳回模板
- **用途**：保存审核员常用的驳回理由模板
- **必要性**：提高审核效率，减少重复输入
- **风险**：低（仅影响当前用户工作效率）
- **决策**：✅ 加入白名单

#### `search_history_keywords` - 搜索历史
- **用途**：记录用户搜索历史，快速重复搜索
- **必要性**：标准用户体验功能
- **风险**：低（仅个人历史记录）
- **决策**：✅ 加入白名单

#### `workspace_role` - 工作台角色选择
- **用途**：记住用户在工作台选择的当前角色
- **必要性**：避免每次进入都重新选择
- **风险**：低（仅UI状态）
- **决策**：✅ 加入白名单

#### `needRefresh` - 刷新标志
- **用途**：跨页面通信，标记需要刷新的页面
- **必要性**：页面数据同步
- **风险**：低（仅UI状态标志）
- **决策**：✅ 加入白名单

---

### 2. 待云端化数据（临时加白名单）

#### `cart_items` - 购物车
- **用途**：存储用户购物车数据
- **必要性**：核心业务功能
- **风险**：中（数据一致性问题，但影响范围有限）
- **决策**：⏳ 临时加入白名单，标记为 **P2 优先级**
- **后续计划**：
  1. 创建 `carts` 云数据库集合
  2. 新增 `cloudAPI.getCartList()`, `cloudAPI.addToCart()`, `cloudAPI.updateCart()`, `cloudAPI.removeFromCart()`
  3. 迁移现有购物车逻辑

#### `buyer_show_posts` - 买家秀帖子
- **用途**：存储买家秀帖子数据
- **必要性**：社区功能核心
- **风险**：中（多用户场景下数据不同步）
- **决策**：⏳ 临时加入白名单，标记为 **P2 优先级**
- **后续计划**：
  1. 确认云端是否已有 `buyer_shows` 表
  2. 新增 `cloudAPI.getBuyerShowList()`, `cloudAPI.createBuyerShow()`, `cloudAPI.updateBuyerShow()`, `cloudAPI.deleteBuyerShow()`
  3. 迁移现有买家秀逻辑

---

## 五、拦截效果验证

### 测试案例 1：核心业务数据（应拦截）

```javascript
// ❌ 应该被拦截
wx.getStorageSync('pending_orders')
// 预期结果：抛出错误 "❌ 禁止使用本地缓存：pending_orders"
```

### 测试案例 2：UI 辅助功能（应允许）

```javascript
// ✅ 应该被允许
wx.getStorageSync('product_draft')
wx.getStorageSync('search_history_keywords')
// 预期结果：正常返回数据
```

### 测试案例 3：待云端化数据（应允许）

```javascript
// ✅ 应该被允许（临时）
wx.getStorageSync('cart_items')
wx.getStorageSync('buyer_show_posts')
// 预期结果：正常返回数据
// ⚠️ 注意：标记为 P2 优先级，需要后续云端化
```

---

## 六、风险评估

### ✅ 低风险（已加白名单）

- `product_draft` - 仅影响编辑体验，不影响已发布数据
- `reject_templates` - 仅影响审核效率，不影响审核结果
- `search_history_keywords` - 仅个人历史记录
- `workspace_role` - 仅UI状态
- `needRefresh` - 仅UI标志

### ⚠️ 中风险（待云端化）

- `cart_items` - 可能导致多设备购物车不同步
- `buyer_show_posts` - 可能导致多用户买家秀数据不一致

**缓解措施**：
1. 标记为 P2 优先级，优先安排云端化
2. 在云端化前，添加数据同步逻辑（定期从云端拉取）
3. 在用户反馈问题前完成迁移

---

## 七、后续优化计划

### P1（必须） - 已完成 ✅

- ✅ 核心业务数据 100% 云端化
- ✅ 严格云端模式启用
- ✅ 白名单/黑名单机制完善

### P2（重要） - 计划中 ⏳

1. **购物车云端化**
   - 创建 `carts` 云数据库集合
   - 新增 CloudAPI 方法
   - 迁移购物车逻辑
   - 移除 `cart_items` 白名单

2. **买家秀云端化**
   - 确认/创建 `buyer_shows` 云数据库集合
   - 新增 CloudAPI 方法
   - 迁移买家秀逻辑
   - 移除 `buyer_show_posts` 白名单

### P3（可选） - 待评估

1. **清理遗留标记**
   - 删除 `avatar_migrated_v2`
   - 删除 `userId_counter`
   - 删除 `migrateOrderAvatars()` 函数

2. **缓存管理优化**
   - 为白名单缓存添加过期机制
   - 添加缓存大小限制
   - 添加缓存同步策略（与云端对比）

---

## 八、变更摘要

### 本次更新

- ✅ 白名单：9个 → 16个（+7个）
- ✅ 黑名单：17种（保持不变）
- ✅ 待云端化：2个（cart_items, buyer_show_posts）

### 拦截覆盖率

- ✅ 核心业务数据：100%（全部拦截）
- ✅ UI 辅助功能：0%（全部白名单）
- ⏳ 待云端化数据：0%（临时白名单，P2 优先级）

---

## 九、结论

✅ **白名单更新合理**  
✅ **用户体验得到保障**  
⏳ **待云端化数据已标记**  
✅ **拦截机制运行正常**  

**推荐操作**：
1. ✅ 立即部署当前版本
2. ⏳ 启动 P2 优先级任务（购物车和买家秀云端化）
3. ✅ 持续监控严格云端模式日志

---

**报告结束**

