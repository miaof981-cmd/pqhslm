# 问题排查报告：画师商品管理页数量显示错误

**生成时间**: 2025-10-27  
**问题页面**: `pages/artist-products-manage/index`  
**报告版本**: v2.0 详细版

---

## 📋 问题描述

### 现象
- **控制台显示**: `该画师商品数量: 1`, `筛选后商品数量: 1`
- **用户反馈**: 实际有 2 个商品
- **页面统计**: 全部1, 已上架1, 已下架0
- **列表显示**: 只显示 1 个商品卡片

### 预期
- 控制台显示: 2 个商品
- 页面显示: 2 个商品卡片
- 统计数据: 全部2, 已上架2, 已下架0

---

## 🔍 数据流分析

### 完整数据链路

```
本地存储 (mock_products)
    ↓
loadProducts() 读取
    ↓
筛选 artistId
    ↓
转换格式（价格处理）
    ↓
setData({ products })
    ↓
filterProducts() 二次筛选
    ↓
setData({ filteredProducts })
    ↓
WXML 渲染
```

---

## 💻 关键代码位置

### 1. 页面加载 (第17-26行)
```javascript
onLoad(options) {
  console.log('=== onLoad 触发 ===')
  console.log('接收到的 options:', options)
  
  if (options.artistId) {
    this.setData({ artistId: options.artistId })
    this.loadArtistInfo()
    this.loadProducts()
  }
}
```

**检查点**:
- `options.artistId` 是否正确传入？
- 类型是 string 还是 number？

### 2. 加载商品数据 (第110-158行)
```javascript
loadProducts() {
  const artistId = this.data.artistId
  console.log('当前画师ID:', artistId)
  
  // 从本地存储读取所有商品
  const allProducts = wx.getStorageSync('mock_products') || []
  console.log('所有商品数量:', allProducts.length)
  
  // 筛选该画师的商品
  const artistProducts = allProducts.filter(product => {
    const match = product.artistId == artistId  // ⚠️ 关键点
    if (match) {
      console.log('找到商品:', product.name, 'isOnSale:', product.isOnSale)
    }
    return match
  })
  
  console.log('该画师商品数量:', artistProducts.length)
}
```

**关键筛选逻辑**:
```javascript
product.artistId == artistId
```

**可能的问题**:
- ❌ 类型不匹配：`"1001" === 1001` → `false`
- ❌ 数据丢失：某个商品的 `artistId` 为 `undefined`
- ❌ 数据错误：某个商品的 `artistId` 指向其他用户

### 3. 价格处理 (第127-141行)
```javascript
.map(product => {
  let displayPrice = parseFloat(product.price) || parseFloat(product.basePrice) || 0
  
  return {
    ...product,
    price: displayPrice
  }
})
```

**检查点**:
- 是否所有商品都能正确计算价格？
- 价格为 0 的商品是否被过滤掉？

### 4. 二次筛选 (第168-187行)
```javascript
filterProducts() {
  const { products, currentTab } = this.data
  let filtered = products
  
  if (currentTab === 'online') {
    filtered = products.filter(p => p.isOnSale !== false)
  } else if (currentTab === 'offline') {
    filtered = products.filter(p => p.isOnSale === false)
  }
  
  this.setData({ filteredProducts: filtered })
}
```

**检查点**:
- 默认 `currentTab` 是 'all'，应该显示全部商品
- `isOnSale` 字段是否正确？

---

## 🧪 排查步骤（详细版）

### 步骤1: 检查本地存储完整数据

**在控制台运行**:
```javascript
const allProducts = wx.getStorageSync('mock_products') || []
console.log('=== 本地存储完整数据检查 ===')
console.log('总商品数:', allProducts.length)

allProducts.forEach((p, i) => {
  console.log(`\n商品 ${i + 1}:`)
  console.log('  ID:', p.id)
  console.log('  名称:', p.name)
  console.log('  画师ID:', p.artistId, '(类型:', typeof p.artistId, ')')
  console.log('  上架状态:', p.isOnSale)
  console.log('  价格:', p.price)
  console.log('  基础价格:', p.basePrice)
  console.log('  是否有规格:', !!(p.specs && p.specs.length > 0))
})
```

**期望输出**:
```
=== 本地存储完整数据检查 ===
总商品数: 2

商品 1:
  ID: product_xxx
  名称: 美丽妙妙
  画师ID: 1001 (类型: string)
  上架状态: undefined
  价格: 10
  基础价格: 98
  是否有规格: true

商品 2:
  ID: product_yyy
  名称: 222
  画师ID: 1001 (类型: string)
  上架状态: undefined
  价格: 10
  基础价格: 10
  是否有规格: false
```

### 步骤2: 检查当前用户ID

```javascript
const currentUserId = wx.getStorageSync('userId')
console.log('\n=== 当前用户信息 ===')
console.log('用户ID:', currentUserId)
console.log('类型:', typeof currentUserId)
```

**期望输出**:
```
=== 当前用户信息 ===
用户ID: 1001
类型: string (或 number)
```

### 步骤3: 测试不同筛选方式

```javascript
const userId = wx.getStorageSync('userId')
const allProducts = wx.getStorageSync('mock_products') || []

console.log('\n=== 筛选方式测试 ===')
console.log('userId:', userId, '(', typeof userId, ')')

// 方式1: 使用 == (宽松相等)
const match1 = allProducts.filter(p => p.artistId == userId)
console.log('使用 == 筛选:', match1.length, '个')
console.log('  商品:', match1.map(p => p.name))

// 方式2: 使用 === (严格相等)
const match2 = allProducts.filter(p => p.artistId === userId)
console.log('使用 === 筛选:', match2.length, '个')
console.log('  商品:', match2.map(p => p.name))

// 方式3: 强制转换为字符串
const match3 = allProducts.filter(p => String(p.artistId) === String(userId))
console.log('使用 String() 筛选:', match3.length, '个')
console.log('  商品:', match3.map(p => p.name))

// 方式4: 强制转换为数字
const match4 = allProducts.filter(p => Number(p.artistId) === Number(userId))
console.log('使用 Number() 筛选:', match4.length, '个')
console.log('  商品:', match4.map(p => p.name))
```

**分析输出**:
- 如果 `==` 筛选到 2 个，`===` 只筛选到 1 个 → **类型不匹配问题**
- 如果所有方式都只筛选到 1 个 → **数据本身的问题**

### 步骤4: 检查页面当前状态

```javascript
const pages = getCurrentPages()
const currentPage = pages[pages.length - 1]

console.log('\n=== 页面状态检查 ===')
console.log('当前路由:', currentPage.route)
console.log('应该是: pages/artist-products-manage/index')

console.log('\n页面 data:')
console.log('  artistId:', currentPage.data.artistId, typeof currentPage.data.artistId)
console.log('  products.length:', currentPage.data.products.length)
console.log('  filteredProducts.length:', currentPage.data.filteredProducts.length)
console.log('  currentTab:', currentPage.data.currentTab)

console.log('\nproducts 详情:')
currentPage.data.products.forEach((p, i) => {
  console.log(`  ${i + 1}. ${p.name} (ID: ${p.id})`)
})

console.log('\nfilteredProducts 详情:')
currentPage.data.filteredProducts.forEach((p, i) => {
  console.log(`  ${i + 1}. ${p.name} (ID: ${p.id})`)
})
```

### 步骤5: 检查商品创建时的 artistId 保存

**检查 product-edit/index.js**:
```javascript
// 搜索关键词: artistId
// 确认商品保存时是否正确设置 artistId
```

---

## 🐛 可能的问题原因

### 原因1: artistId 类型不匹配 ⚠️ (最可能)

**场景**:
```javascript
// 商品1
{ id: 'xxx', artistId: "1001" }  // 字符串

// 商品2
{ id: 'yyy', artistId: 1001 }    // 数字

// 当前用户
userId: "1001"  // 字符串

// 筛选结果
product.artistId == "1001"
  "1001" == "1001"  → true  ✅ (商品1 匹配)
  1001 == "1001"    → true  ✅ (商品2 匹配)

// 但如果某个环节使用了 ===
product.artistId === "1001"
  "1001" === "1001"  → true  ✅ (商品1 匹配)
  1001 === "1001"    → false ❌ (商品2 不匹配)
```

### 原因2: 某个商品的 artistId 丢失

**场景**:
```javascript
// 商品1
{ id: 'xxx', artistId: "1001" }  ✅

// 商品2
{ id: 'yyy', artistId: undefined }  ❌ 丢失

// 筛选结果: 只有 1 个商品
```

**如何验证**:
```javascript
allProducts.forEach(p => {
  if (!p.artistId) {
    console.error(`❌ 商品 ${p.name} 缺少 artistId!`)
  }
})
```

### 原因3: 价格处理导致商品被过滤

**场景**:
```javascript
// 如果某个商品的 price 和 basePrice 都是 0 或空
{
  name: '商品2',
  price: '',
  basePrice: '',
  artistId: '1001'
}

// 价格处理后
displayPrice = parseFloat('') || parseFloat('') || 0  // = 0

// 可能在某个地方被过滤掉
```

### 原因4: currentTab 状态异常

**场景**:
```javascript
// 如果 currentTab 不是 'all'
currentTab: 'online'

// 会进行二次筛选
filtered = products.filter(p => p.isOnSale !== false)

// 如果某个商品的 isOnSale 是 false，就会被过滤掉
```

---

## 🔧 修复方案

### 方案1: 统一类型转换（推荐）

**修改位置**: `artist-products-manage/index.js` 第121行

```javascript
// 修改前
const artistProducts = allProducts.filter(product => {
  const match = product.artistId == artistId
  return match
})

// 修改后
const artistProducts = allProducts.filter(product => {
  // 强制转换为字符串比较，避免类型问题
  const match = String(product.artistId || '') === String(artistId || '')
  if (match) {
    console.log('✅ 匹配商品:', product.name, 'artistId:', product.artistId)
  } else if (product.artistId) {
    console.log('❌ 不匹配:', product.name, 'artistId:', product.artistId, '期望:', artistId)
  }
  return match
})
```

### 方案2: 数据修复脚本

**在控制台运行**:
```javascript
// 检查并修复所有商品的 artistId
const allProducts = wx.getStorageSync('mock_products') || []
const currentUserId = String(wx.getStorageSync('userId'))

console.log('=== 数据修复 ===')
let fixed = 0

const fixedProducts = allProducts.map(p => {
  if (!p.artistId) {
    console.warn(`修复商品 ${p.name}: 缺少 artistId`)
    fixed++
    return { ...p, artistId: currentUserId }
  }
  
  // 统一转换为字符串
  if (typeof p.artistId !== 'string') {
    console.log(`统一商品 ${p.name}: artistId 从 ${typeof p.artistId} 转为 string`)
    fixed++
    return { ...p, artistId: String(p.artistId) }
  }
  
  return p
})

if (fixed > 0) {
  wx.setStorageSync('mock_products', fixedProducts)
  console.log(`✅ 修复完成! 共修复 ${fixed} 个商品`)
  console.log('请刷新页面查看效果')
} else {
  console.log('✅ 数据正常，无需修复')
}
```

### 方案3: 增强日志输出

**已实现**，但可以进一步增强:

```javascript
loadProducts() {
  const artistId = this.data.artistId
  console.log('=== 加载商品列表 ===')
  console.log('当前画师ID:', artistId, typeof artistId)
  
  const allProducts = wx.getStorageSync('mock_products') || []
  console.log('所有商品数量:', allProducts.length)
  
  // 显示所有商品的 artistId
  console.log('所有商品的画师ID:')
  allProducts.forEach((p, i) => {
    console.log(`  ${i + 1}. ${p.name}: artistId=${p.artistId} (${typeof p.artistId})`)
  })
  
  // 筛选
  const artistProducts = allProducts.filter(product => {
    const match = product.artistId == artistId
    const matchStrict = product.artistId === artistId
    
    if (match !== matchStrict) {
      console.warn(`⚠️  商品 ${product.name}: == 匹配=${match}, === 匹配=${matchStrict}`)
      console.warn(`   product.artistId: ${product.artistId} (${typeof product.artistId})`)
      console.warn(`   期望 artistId: ${artistId} (${typeof artistId})`)
    }
    
    return match
  })
  
  console.log('筛选后商品数量:', artistProducts.length)
  artistProducts.forEach((p, i) => {
    console.log(`  ${i + 1}. ${p.name}`)
  })
}
```

---

## 📊 检查清单

使用此清单逐项排查:

- [ ] **步骤1**: 运行本地存储检查脚本
  - [ ] 确认总商品数是 2
  - [ ] 确认两个商品的 artistId 都存在
  - [ ] 确认两个商品的 artistId 都是 1001
  - [ ] 记录 artistId 的类型

- [ ] **步骤2**: 运行用户ID检查脚本
  - [ ] 确认当前用户ID是 1001
  - [ ] 记录用户ID的类型

- [ ] **步骤3**: 运行筛选方式测试脚本
  - [ ] 对比 `==` 和 `===` 的结果
  - [ ] 如果结果不同 → 类型问题
  - [ ] 如果结果相同且都是1 → 数据问题

- [ ] **步骤4**: 运行页面状态检查脚本
  - [ ] 确认当前路由正确
  - [ ] 确认 `products.length`
  - [ ] 确认 `filteredProducts.length`
  - [ ] 确认 `currentTab` 是 'all'

- [ ] **步骤5**: 根据结果选择修复方案
  - [ ] 类型问题 → 使用方案1
  - [ ] 数据丢失 → 使用方案2
  - [ ] 其他问题 → 使用方案3增强日志

---

## 🎯 最终验证

修复后，应该看到:

```
=== 加载商品列表 ===
当前画师ID: 1001 string
所有商品数量: 2
筛选后该画师的商品数量: 2
商品: 美丽妙妙, artistId: 1001, isOnSale: undefined
商品: 222, artistId: 1001, isOnSale: undefined
转换后的商品数据: 2 个
  - 美丽妙妙: status=online, isOnSale=true
  - 222: status=online, isOnSale=true
统计数据: {all: 2, online: 2, offline: 0}

=== 筛选商品 ===
当前标签: all
全部商品数量 (products): 2
筛选后商品数量 (filtered): 2
```

**页面显示**:
- 商品总数: 2
- 已上架: 2
- 已下架: 0
- 列表显示: 2 个商品卡片

---

## 📝 相关文件

| 文件路径 | 行号 | 说明 |
|---------|------|------|
| `pages/artist-products-manage/index.js` | 17-26 | onLoad 接收参数 |
| `pages/artist-products-manage/index.js` | 31-38 | onShow 刷新数据 |
| `pages/artist-products-manage/index.js` | 110-158 | loadProducts 主逻辑 |
| `pages/artist-products-manage/index.js` | 121-127 | **关键筛选代码** |
| `pages/artist-products-manage/index.js` | 168-187 | filterProducts 二次筛选 |
| `pages/artist-products-manage/index.wxml` | 39-72 | 列表渲染 |

---

**报告生成时间**: 2025-10-27 20:59  
**当前状态**: 待用户运行排查脚本反馈结果  
**建议优先级**: 🔴 高（影响核心功能）

