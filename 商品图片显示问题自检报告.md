# 商品图片频繁不显示问题 - 深度自检报告

## 🎯 问题现象
订单列表中商品图片不显示（已出现多次）

---

## 📊 数据流全链路分析

### 1️⃣ 商品创建时
**文件**: `pages/product-edit/index.js`

**图片上传**:
```javascript
wx.chooseImage() 
  ↓
tempFilePaths: ["http://tmp/wxfile_xxxxx.jpg"]  // ✅ 临时路径
  ↓
formData.images: [...tempFilePaths]  // ✅ 保存临时路径
```

**问题**:
- ❌ 临时文件路径在小程序重启后会失效
- ❌ 没有上传到云存储，只是本地临时路径

### 2️⃣ 加入购物车时
**文件**: `pages/product-detail/index.js`

```javascript
productImage: (product.images && product.images[0]) || 'placeholder'
```

**问题**:
- ✅ 读取逻辑正确
- ❌ 但如果 product.images[0] 是过期的临时路径，就会失效

### 3️⃣ 订单创建时
**文件**: `pages/cart/index.js` → `pages/order-success/index.js`

```javascript
productImage: item.productImage  // 传递的是临时路径
  ↓
encodeURIComponent(item.productImage)  // URL编码
  ↓
order.productImage = decodeURIComponent(...)  // 解码后仍是临时路径
```

**问题**:
- ❌ 整个链路都在传递临时路径
- ❌ 临时路径有效期很短（几分钟到几小时）

### 4️⃣ 订单列表显示
**文件**: `pages/order-list/index.wxml`

```xml
<image src="{{item.productImage}}" />
```

**问题**:
- ❌ 显示过期的临时路径 → 图片加载失败

---

## 🎯 根本原因

### 核心问题: 使用临时文件路径而不是永久路径

**临时路径特点**:
```
http://tmp/wxfile_abc123.jpg
```
- ✅ 立即可用
- ❌ 小程序重启后失效
- ❌ 几小时后自动清理
- ❌ 无法长期存储

**为什么频繁出现**:
1. 每次小程序重启/更新代码 → 临时路径失效
2. 用户切换小程序后台 → 临时文件可能被清理
3. 超过时效期 → 路径自动失效

---

## 💡 解决方案

### 方案A: 使用微信云存储（推荐）✅

**优势**:
- ✅ 永久存储
- ✅ CDN加速
- ✅ 自动管理

**实现步骤**:
1. 上传到云存储获取 fileID
2. 保存 fileID 到商品数据
3. 显示时使用 fileID

### 方案B: 转换为 base64（不推荐）❌

**缺点**:
- ❌ 数据量大
- ❌ 性能差
- ❌ 存储浪费

### 方案C: 临时方案 - 使用默认图片

**优势**:
- ✅ 快速实现
- ✅ 不影响功能

**缺点**:
- ❌ 无法显示真实商品图

---

## 🔧 立即修复方案（临时）

### 修复1: 添加默认图片兜底

```javascript
// 订单列表显示
productImage: order.productImage || '/assets/default-product.png'
```

### 修复2: 检测图片加载失败

```xml
<image 
  src="{{item.productImage}}" 
  binderror="onImageError"
  data-index="{{index}}"
/>
```

```javascript
onImageError(e) {
  const index = e.currentTarget.dataset.index
  const orders = this.data.orders
  orders[index].productImage = '/assets/default-product.png'
  this.setData({ orders })
}
```

---

## 📊 数据检查

### 当前订单数据结构
```javascript
{
  productImage: "http://tmp/wxfile_xxxxx.jpg",  // ❌ 临时路径
  // 应该是:
  // productImage: "cloud://xxx.png"  // ✅ 云存储路径
  // 或:
  // productImage: "https://cdn.xxx.com/xxx.png"  // ✅ CDN路径
}
```

---

## 🎯 终极解决方案路线图

### 短期（立即）
1. ✅ 添加默认图片兜底
2. ✅ 添加图片加载失败处理
3. ✅ 在控制台输出图片路径用于调试

### 中期（1-2天）
1. 集成微信云存储
2. 商品创建时上传到云存储
3. 保存云存储 fileID

### 长期（未来）
1. 图片自动压缩
2. CDN加速
3. 图片预加载

---

## 🧪 调试方法

### 检查图片路径
```javascript
// 在控制台执行
const orders = wx.getStorageSync('pending_orders') || []
orders.forEach(o => {
  console.log('订单:', o.id)
  console.log('图片路径:', o.productImage)
  console.log('是否临时路径:', o.productImage.includes('tmp'))
})
```

### 检查图片是否存在
```javascript
wx.getFileInfo({
  filePath: '图片路径',
  success: () => console.log('✅ 文件存在'),
  fail: () => console.log('❌ 文件不存在或已过期')
})
```

---

## 📈 优先级

1. **紧急**: 添加默认图片兜底（立即）
2. **重要**: 集成云存储（下一步）
3. **优化**: 图片处理和CDN（未来）

