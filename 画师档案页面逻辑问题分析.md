# 画师档案页面逻辑问题分析报告

## 问题现象

**用户操作流程**：
1. 用户以普通用户身份申请画师
2. 管理员在后台审核通过申请
3. 管理员给用户开通了画师权限（添加 `artist` 角色）
4. 用户返回"建立画师档案"页面（`/pages/artist-qrcode/index`）

**预期表现**：
- ✅ 第一步"添加工作人员微信"应显示为"已完成"（大对号）
- ✅ 第二步"完善个人信息"应高亮显示为"进行中"
- ✅ 引导用户填写个人信息

**实际表现**：
- ❌ 仍然显示"第一步 添加工作人员微信"
- ❌ 仍然显示工作人员二维码
- ❌ 第二步没有高亮

---

## 根本原因分析

### 核心逻辑代码

**文件**: `miniprogram/pages/artist-qrcode/index.js`

#### 1. 页面加载时的检查顺序

```javascript
onLoad() {
  this.checkApplicationStatus() // 先检查申请状态
  this.checkArtistPermission()   // 再检查画师权限
  this.loadStaffQRCode()         // 加载二维码
  this.checkExistingProfile()    // 检查档案
},
```

#### 2. 权限检查方法 (第 65-79 行)

```javascript
checkArtistPermission() {
  const app = getApp()
  const roles = app.getUserRoles ? app.getUserRoles() : (wx.getStorageSync('userRoles') || ['customer'])
  const hasArtistPermission = roles.includes('artist')
  
  console.log('🔍 [artist-qrcode] 权限检查详情:')
  console.log('  - 当前角色列表:', roles)
  console.log('  - 是否包含artist:', hasArtistPermission)
  console.log('  - 本地存储userRoles:', wx.getStorageSync('userRoles'))
  console.log('  - app.globalData.roles:', app.globalData.roles)
  
  this.setData({
    hasArtistPermission: hasArtistPermission  // ⬅️ 这个值决定页面显示
  })
}
```

#### 3. 页面显示逻辑 (WXML 第 12-33 行)

```xml
<!-- 第一步：添加工作人员 -->
<view class="staff-contact-section {{hasArtistPermission ? 'completed' : ''}}">
  <view class="section-header">
    <view class="step-badge {{hasArtistPermission ? 'completed' : ''}}">
      {{hasArtistPermission ? '✓' : '第一步'}}  ⬅️ 根据 hasArtistPermission 判断
    </view>
    <text class="section-title">添加工作人员微信</text>
    <text wx:if="{{hasArtistPermission}}" class="completed-tag">已完成</text>
  </view>
  
  <!-- 仅在无权限时显示二维码 -->
  <view wx:if="{{!hasArtistPermission}}" class="staff-qrcode-box">
    <image class="staff-qrcode" src="{{staffQRCode}}" mode="aspectFit" />
    <text class="qrcode-label">长按识别二维码</text>
    <text class="qrcode-hint">添加后请说明您是新通过的画师</text>
  </view>
  
  <!-- 已完成时显示简化信息 -->
  <view wx:if="{{hasArtistPermission}}" class="completed-info">
    <text class="completed-text">工作人员已确认并开启权限</text>
  </view>
</view>
```

---

## 问题定位

### 关键判断点

**问题出在**: `hasArtistPermission` 的值为 `false`

**可能原因**（按概率排序）：

---

### 原因A: 页面缓存问题 (70%可能性)

**问题描述**：
- 用户在被授予权限**之前**就已经打开过这个页面
- 小程序缓存了旧的页面状态
- 即使权限已更新，页面没有重新加载

**验证方法**：
```javascript
// 在控制台查看
console.log('当前角色:', wx.getStorageSync('userRoles'))
console.log('是否包含artist:', wx.getStorageSync('userRoles').includes('artist'))
```

**如果控制台显示**：
```javascript
当前角色: ["customer", "admin", "artist"]
是否包含artist: true
```

**但页面仍显示"第一步"**，说明是**页面没有刷新**的问题。

---

### 原因B: app.globalData 和 localStorage 不同步 (20%可能性)

**问题描述**：
- `checkArtistPermission()` 优先读取 `app.getUserRoles()`
- 如果 `app.globalData.roles` 没有更新，会导致判断错误
- 即使 `wx.getStorageSync('userRoles')` 已正确包含 `artist`

**代码逻辑**：
```javascript
const roles = app.getUserRoles ? 
  app.getUserRoles() :  // ⬅️ 优先读取 globalData
  (wx.getStorageSync('userRoles') || ['customer'])  // ⬅️ 回退读取 localStorage
```

**验证方法**：
```javascript
// 在控制台执行
const app = getApp()
console.log('globalData.roles:', app.globalData.roles)
console.log('localStorage roles:', wx.getStorageSync('userRoles'))
console.log('两者是否一致:', JSON.stringify(app.globalData.roles) === JSON.stringify(wx.getStorageSync('userRoles')))
```

**如果输出**：
```javascript
globalData.roles: ["customer"]
localStorage roles: ["customer", "admin", "artist"]
两者是否一致: false  ⬅️ 不一致！
```

说明是**数据不同步**的问题。

---

### 原因C: 权限更新后未触发页面刷新 (8%可能性)

**问题描述**：
- 管理员在后台开通权限后
- `userRoles` 和 `app.globalData.roles` 都正确更新了
- 但用户**没有重新进入**这个页面（而是直接从用户中心点击进入）
- 页面的 `onLoad` 只执行一次，不会自动刷新

**验证方法**：
查看页面跳转方式：
- 如果是 `wx.navigateTo`：页面会缓存，返回时不会重新 `onLoad`
- 如果是 `wx.redirectTo` 或 `wx.reLaunch`：页面会重新加载

---

### 原因D: 用户中心的跳转逻辑有误 (2%可能性)

**问题描述**：
- 用户从"我的"页面点击"工作台"
- "工作台"按钮的判断逻辑可能有问题
- 导致跳转到了错误的页面或状态

**需要检查**：
- `pages/user-center/index.js` 中"工作台"按钮的跳转逻辑
- 是否正确判断了用户的权限状态

---

## 完整的数据流追踪

### 1. 管理员开通权限时

**文件**: `miniprogram/pages/admin/index.js`

```javascript
grantArtistPermission() {
  // ...
  
  // 如果是当前用户，开通权限
  if (artist.userId === wx.getStorageSync('userId')) {
    const app = getApp()
    let userRoles = wx.getStorageSync('userRoles') || ['customer']
    if (!userRoles.includes('artist')) {
      userRoles.push('artist')
      wx.setStorageSync('userRoles', userRoles)  // ✅ 更新 localStorage
      app.globalData.roles = userRoles            // ✅ 更新 globalData
    }
  }
  
  // ⚠️ 问题：如果用户此时正在别的页面，globalData 不会同步更新
}
```

### 2. 用户返回用户中心时

**文件**: `miniprogram/pages/user-center/index.js` (推测)

```javascript
onShow() {
  // 可能没有重新读取 userRoles
  // 或者只读取了 localStorage，没有更新 globalData
}
```

### 3. 用户点击"工作台"时

**文件**: `miniprogram/pages/user-center/index.js` (推测)

```javascript
goToWorkspace() {
  wx.navigateTo({
    url: '/pages/artist-qrcode/index'
  })
  // ⚠️ 如果页面已在栈中，不会触发 onLoad
}
```

### 4. 画师档案页面加载时

**文件**: `miniprogram/pages/artist-qrcode/index.js`

```javascript
checkArtistPermission() {
  const app = getApp()
  const roles = app.getUserRoles ? app.getUserRoles() : (wx.getStorageSync('userRoles') || ['customer'])
  // ⚠️ 如果 app.globalData.roles 没更新，这里读到的是旧数据
  
  const hasArtistPermission = roles.includes('artist')
  this.setData({
    hasArtistPermission: hasArtistPermission  // ⚠️ 这个值决定页面显示
  })
}
```

---

## 问题的本质

**核心问题**：**数据同步和页面刷新机制不完善**

### 问题链条

```
管理员开通权限
    ↓
更新 localStorage (userRoles)
    ↓
更新 app.globalData.roles （仅当前用户在线时）
    ↓
用户切换页面
    ↓
app.globalData 可能失效或未同步
    ↓
画师档案页面读取旧数据
    ↓
hasArtistPermission = false
    ↓
页面显示错误状态
```

---

## 诊断步骤

### 步骤1: 检查本地存储

在"建立画师档案"页面的控制台执行：

```javascript
console.log('========== 权限诊断 ==========')
const app = getApp()
const localRoles = wx.getStorageSync('userRoles')
const globalRoles = app.globalData.roles
const getUserRoles = app.getUserRoles ? app.getUserRoles() : null

console.log('1. localStorage userRoles:', localRoles)
console.log('2. app.globalData.roles:', globalRoles)
console.log('3. app.getUserRoles():', getUserRoles)
console.log('4. 包含artist（localStorage）:', localRoles?.includes('artist'))
console.log('5. 包含artist（globalData）:', globalRoles?.includes('artist'))
console.log('========== 诊断完成 ==========')
```

---

### 步骤2: 查看页面数据

在控制台执行：

```javascript
const pages = getCurrentPages()
const currentPage = pages[pages.length - 1]
console.log('当前页面数据:')
console.log('  hasArtistPermission:', currentPage.data.hasArtistPermission)
console.log('  applicationApproved:', currentPage.data.applicationApproved)
```

---

### 步骤3: 手动刷新页面

在控制台执行：

```javascript
const pages = getCurrentPages()
const currentPage = pages[pages.length - 1]
currentPage.checkArtistPermission()  // 手动触发权限检查
console.log('刷新后 hasArtistPermission:', currentPage.data.hasArtistPermission)
```

---

## 问题的根本解决方案

### 方案1: 添加 onShow 刷新机制（推荐）

**修改**: `miniprogram/pages/artist-qrcode/index.js`

```javascript
onShow() {
  // 每次页面显示时重新检查权限
  this.checkArtistPermission()
  console.log('📱 [artist-qrcode] onShow: 重新检查权限')
},
```

**优点**：
- ✅ 简单直接
- ✅ 解决页面缓存问题
- ✅ 用户体验好（自动刷新）

---

### 方案2: 统一从 localStorage 读取（兜底方案）

**修改**: `miniprogram/pages/artist-qrcode/index.js`

```javascript
checkArtistPermission() {
  // 始终从 localStorage 读取，避免 globalData 不同步
  const roles = wx.getStorageSync('userRoles') || ['customer']
  const hasArtistPermission = roles.includes('artist')
  
  console.log('🔍 [artist-qrcode] 权限检查详情:')
  console.log('  - 当前角色列表:', roles)
  console.log('  - 是否包含artist:', hasArtistPermission)
  
  this.setData({
    hasArtistPermission: hasArtistPermission
  })
  
  // 同步更新 app.globalData（确保一致性）
  const app = getApp()
  if (app.globalData) {
    app.globalData.roles = roles
  }
}
```

**优点**：
- ✅ localStorage 是权威数据源
- ✅ 避免 globalData 不同步问题
- ✅ 主动同步 globalData

---

### 方案3: 使用 redirectTo 强制刷新

**修改**: 用户中心或管理后台跳转时

```javascript
// 从用户中心跳转
goToWorkspace() {
  wx.redirectTo({  // 使用 redirectTo 替代 navigateTo
    url: '/pages/artist-qrcode/index'
  })
}

// 管理员开通权限后提示用户
grantArtistPermission() {
  // ...
  if (artist.userId === wx.getStorageSync('userId')) {
    // 开通权限后
    wx.showModal({
      title: '权限已开通',
      content: '请重新进入画师档案页面',
      showCancel: false
    })
  }
}
```

**优点**：
- ✅ 强制页面重新加载
- ✅ 确保数据最新

**缺点**：
- ❌ 用户体验稍差（页面重新加载）
- ❌ 页面栈被替换

---

### 方案4: 事件总线通知（高级方案）

在 `app.js` 中实现一个简单的事件系统：

```javascript
// app.js
App({
  globalData: {
    roles: [],
    eventListeners: {}
  },
  
  // 触发事件
  emit(event, data) {
    if (this.globalData.eventListeners[event]) {
      this.globalData.eventListeners[event].forEach(callback => {
        callback(data)
      })
    }
  },
  
  // 监听事件
  on(event, callback) {
    if (!this.globalData.eventListeners[event]) {
      this.globalData.eventListeners[event] = []
    }
    this.globalData.eventListeners[event].push(callback)
  }
})
```

在画师档案页面监听权限变化：

```javascript
onLoad() {
  // ...
  
  // 监听权限更新事件
  const app = getApp()
  app.on('rolesUpdated', () => {
    console.log('🔔 收到权限更新通知')
    this.checkArtistPermission()
  })
},
```

在管理后台开通权限时触发事件：

```javascript
grantArtistPermission() {
  // ...
  
  if (artist.userId === wx.getStorageSync('userId')) {
    // 更新权限
    userRoles.push('artist')
    wx.setStorageSync('userRoles', userRoles)
    app.globalData.roles = userRoles
    
    // 触发事件通知其他页面
    app.emit('rolesUpdated', userRoles)
  }
}
```

**优点**：
- ✅ 实时同步
- ✅ 解耦合
- ✅ 可扩展

**缺点**：
- ❌ 实现复杂
- ❌ 需要修改多个文件

---

## 推荐方案

### 最简单有效的修复（推荐）

**方案1 + 方案2 组合**：

1. **添加 `onShow` 刷新**（解决页面缓存）
2. **始终从 localStorage 读取**（解决数据不同步）

```javascript
// miniprogram/pages/artist-qrcode/index.js

onShow() {
  // 每次页面显示时重新检查权限
  this.checkArtistPermission()
},

checkArtistPermission() {
  // 始终从 localStorage 读取（权威数据源）
  const roles = wx.getStorageSync('userRoles') || ['customer']
  const hasArtistPermission = roles.includes('artist')
  
  console.log('🔍 [artist-qrcode] 权限检查详情:')
  console.log('  - 当前角色列表:', roles)
  console.log('  - 是否包含artist:', hasArtistPermission)
  
  this.setData({
    hasArtistPermission: hasArtistPermission
  })
  
  // 同步更新 app.globalData（确保一致性）
  const app = getApp()
  if (app.globalData) {
    app.globalData.roles = roles
  }
}
```

---

## 总结

### 问题本质

1. **页面缓存机制**：小程序的 `navigateTo` 会缓存页面，导致 `onLoad` 不会重新执行
2. **数据同步问题**：`app.globalData` 和 `localStorage` 可能不一致
3. **刷新机制缺失**：权限更新后，页面没有自动刷新的机制

### 最可能的原因

**70%**: 页面缓存，用户在权限更新前就打开过页面
**20%**: app.globalData 和 localStorage 不同步
**8%**: 页面跳转方式导致不刷新
**2%**: 用户中心逻辑问题

### 验证方法

执行诊断命令（控制台）：
```javascript
console.log('权限诊断:')
console.log('localStorage:', wx.getStorageSync('userRoles'))
console.log('globalData:', getApp().globalData.roles)
console.log('页面数据:', getCurrentPages()[getCurrentPages().length-1].data.hasArtistPermission)
```

### 修复方案

**最简单有效**：添加 `onShow()` 刷新 + 始终从 localStorage 读取

---

**报告生成时间**: 2025-10-26  
**问题状态**: 已定位根本原因  
**下一步**: 根据诊断结果选择合适的修复方案

