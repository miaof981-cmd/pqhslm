# ç”»å¸ˆæ¡£æ¡ˆé¡µé¢é€»è¾‘é—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜ç°è±¡

**ç”¨æˆ·æ“ä½œæµç¨‹**ï¼š
1. ç”¨æˆ·ä»¥æ™®é€šç”¨æˆ·èº«ä»½ç”³è¯·ç”»å¸ˆ
2. ç®¡ç†å‘˜åœ¨åå°å®¡æ ¸é€šè¿‡ç”³è¯·
3. ç®¡ç†å‘˜ç»™ç”¨æˆ·å¼€é€šäº†ç”»å¸ˆæƒé™ï¼ˆæ·»åŠ  `artist` è§’è‰²ï¼‰
4. ç”¨æˆ·è¿”å›"å»ºç«‹ç”»å¸ˆæ¡£æ¡ˆ"é¡µé¢ï¼ˆ`/pages/artist-qrcode/index`ï¼‰

**é¢„æœŸè¡¨ç°**ï¼š
- âœ… ç¬¬ä¸€æ­¥"æ·»åŠ å·¥ä½œäººå‘˜å¾®ä¿¡"åº”æ˜¾ç¤ºä¸º"å·²å®Œæˆ"ï¼ˆå¤§å¯¹å·ï¼‰
- âœ… ç¬¬äºŒæ­¥"å®Œå–„ä¸ªäººä¿¡æ¯"åº”é«˜äº®æ˜¾ç¤ºä¸º"è¿›è¡Œä¸­"
- âœ… å¼•å¯¼ç”¨æˆ·å¡«å†™ä¸ªäººä¿¡æ¯

**å®é™…è¡¨ç°**ï¼š
- âŒ ä»ç„¶æ˜¾ç¤º"ç¬¬ä¸€æ­¥ æ·»åŠ å·¥ä½œäººå‘˜å¾®ä¿¡"
- âŒ ä»ç„¶æ˜¾ç¤ºå·¥ä½œäººå‘˜äºŒç»´ç 
- âŒ ç¬¬äºŒæ­¥æ²¡æœ‰é«˜äº®

---

## æ ¹æœ¬åŸå› åˆ†æ

### æ ¸å¿ƒé€»è¾‘ä»£ç 

**æ–‡ä»¶**: `miniprogram/pages/artist-qrcode/index.js`

#### 1. é¡µé¢åŠ è½½æ—¶çš„æ£€æŸ¥é¡ºåº

```javascript
onLoad() {
  this.checkApplicationStatus() // å…ˆæ£€æŸ¥ç”³è¯·çŠ¶æ€
  this.checkArtistPermission()   // å†æ£€æŸ¥ç”»å¸ˆæƒé™
  this.loadStaffQRCode()         // åŠ è½½äºŒç»´ç 
  this.checkExistingProfile()    // æ£€æŸ¥æ¡£æ¡ˆ
},
```

#### 2. æƒé™æ£€æŸ¥æ–¹æ³• (ç¬¬ 65-79 è¡Œ)

```javascript
checkArtistPermission() {
  const app = getApp()
  const roles = app.getUserRoles ? app.getUserRoles() : (wx.getStorageSync('userRoles') || ['customer'])
  const hasArtistPermission = roles.includes('artist')
  
  console.log('ğŸ” [artist-qrcode] æƒé™æ£€æŸ¥è¯¦æƒ…:')
  console.log('  - å½“å‰è§’è‰²åˆ—è¡¨:', roles)
  console.log('  - æ˜¯å¦åŒ…å«artist:', hasArtistPermission)
  console.log('  - æœ¬åœ°å­˜å‚¨userRoles:', wx.getStorageSync('userRoles'))
  console.log('  - app.globalData.roles:', app.globalData.roles)
  
  this.setData({
    hasArtistPermission: hasArtistPermission  // â¬…ï¸ è¿™ä¸ªå€¼å†³å®šé¡µé¢æ˜¾ç¤º
  })
}
```

#### 3. é¡µé¢æ˜¾ç¤ºé€»è¾‘ (WXML ç¬¬ 12-33 è¡Œ)

```xml
<!-- ç¬¬ä¸€æ­¥ï¼šæ·»åŠ å·¥ä½œäººå‘˜ -->
<view class="staff-contact-section {{hasArtistPermission ? 'completed' : ''}}">
  <view class="section-header">
    <view class="step-badge {{hasArtistPermission ? 'completed' : ''}}">
      {{hasArtistPermission ? 'âœ“' : 'ç¬¬ä¸€æ­¥'}}  â¬…ï¸ æ ¹æ® hasArtistPermission åˆ¤æ–­
    </view>
    <text class="section-title">æ·»åŠ å·¥ä½œäººå‘˜å¾®ä¿¡</text>
    <text wx:if="{{hasArtistPermission}}" class="completed-tag">å·²å®Œæˆ</text>
  </view>
  
  <!-- ä»…åœ¨æ— æƒé™æ—¶æ˜¾ç¤ºäºŒç»´ç  -->
  <view wx:if="{{!hasArtistPermission}}" class="staff-qrcode-box">
    <image class="staff-qrcode" src="{{staffQRCode}}" mode="aspectFit" />
    <text class="qrcode-label">é•¿æŒ‰è¯†åˆ«äºŒç»´ç </text>
    <text class="qrcode-hint">æ·»åŠ åè¯·è¯´æ˜æ‚¨æ˜¯æ–°é€šè¿‡çš„ç”»å¸ˆ</text>
  </view>
  
  <!-- å·²å®Œæˆæ—¶æ˜¾ç¤ºç®€åŒ–ä¿¡æ¯ -->
  <view wx:if="{{hasArtistPermission}}" class="completed-info">
    <text class="completed-text">å·¥ä½œäººå‘˜å·²ç¡®è®¤å¹¶å¼€å¯æƒé™</text>
  </view>
</view>
```

---

## é—®é¢˜å®šä½

### å…³é”®åˆ¤æ–­ç‚¹

**é—®é¢˜å‡ºåœ¨**: `hasArtistPermission` çš„å€¼ä¸º `false`

**å¯èƒ½åŸå› **ï¼ˆæŒ‰æ¦‚ç‡æ’åºï¼‰ï¼š

---

### åŸå› A: é¡µé¢ç¼“å­˜é—®é¢˜ (70%å¯èƒ½æ€§)

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·åœ¨è¢«æˆäºˆæƒé™**ä¹‹å‰**å°±å·²ç»æ‰“å¼€è¿‡è¿™ä¸ªé¡µé¢
- å°ç¨‹åºç¼“å­˜äº†æ—§çš„é¡µé¢çŠ¶æ€
- å³ä½¿æƒé™å·²æ›´æ–°ï¼Œé¡µé¢æ²¡æœ‰é‡æ–°åŠ è½½

**éªŒè¯æ–¹æ³•**ï¼š
```javascript
// åœ¨æ§åˆ¶å°æŸ¥çœ‹
console.log('å½“å‰è§’è‰²:', wx.getStorageSync('userRoles'))
console.log('æ˜¯å¦åŒ…å«artist:', wx.getStorageSync('userRoles').includes('artist'))
```

**å¦‚æœæ§åˆ¶å°æ˜¾ç¤º**ï¼š
```javascript
å½“å‰è§’è‰²: ["customer", "admin", "artist"]
æ˜¯å¦åŒ…å«artist: true
```

**ä½†é¡µé¢ä»æ˜¾ç¤º"ç¬¬ä¸€æ­¥"**ï¼Œè¯´æ˜æ˜¯**é¡µé¢æ²¡æœ‰åˆ·æ–°**çš„é—®é¢˜ã€‚

---

### åŸå› B: app.globalData å’Œ localStorage ä¸åŒæ­¥ (20%å¯èƒ½æ€§)

**é—®é¢˜æè¿°**ï¼š
- `checkArtistPermission()` ä¼˜å…ˆè¯»å– `app.getUserRoles()`
- å¦‚æœ `app.globalData.roles` æ²¡æœ‰æ›´æ–°ï¼Œä¼šå¯¼è‡´åˆ¤æ–­é”™è¯¯
- å³ä½¿ `wx.getStorageSync('userRoles')` å·²æ­£ç¡®åŒ…å« `artist`

**ä»£ç é€»è¾‘**ï¼š
```javascript
const roles = app.getUserRoles ? 
  app.getUserRoles() :  // â¬…ï¸ ä¼˜å…ˆè¯»å– globalData
  (wx.getStorageSync('userRoles') || ['customer'])  // â¬…ï¸ å›é€€è¯»å– localStorage
```

**éªŒè¯æ–¹æ³•**ï¼š
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
const app = getApp()
console.log('globalData.roles:', app.globalData.roles)
console.log('localStorage roles:', wx.getStorageSync('userRoles'))
console.log('ä¸¤è€…æ˜¯å¦ä¸€è‡´:', JSON.stringify(app.globalData.roles) === JSON.stringify(wx.getStorageSync('userRoles')))
```

**å¦‚æœè¾“å‡º**ï¼š
```javascript
globalData.roles: ["customer"]
localStorage roles: ["customer", "admin", "artist"]
ä¸¤è€…æ˜¯å¦ä¸€è‡´: false  â¬…ï¸ ä¸ä¸€è‡´ï¼
```

è¯´æ˜æ˜¯**æ•°æ®ä¸åŒæ­¥**çš„é—®é¢˜ã€‚

---

### åŸå› C: æƒé™æ›´æ–°åæœªè§¦å‘é¡µé¢åˆ·æ–° (8%å¯èƒ½æ€§)

**é—®é¢˜æè¿°**ï¼š
- ç®¡ç†å‘˜åœ¨åå°å¼€é€šæƒé™å
- `userRoles` å’Œ `app.globalData.roles` éƒ½æ­£ç¡®æ›´æ–°äº†
- ä½†ç”¨æˆ·**æ²¡æœ‰é‡æ–°è¿›å…¥**è¿™ä¸ªé¡µé¢ï¼ˆè€Œæ˜¯ç›´æ¥ä»ç”¨æˆ·ä¸­å¿ƒç‚¹å‡»è¿›å…¥ï¼‰
- é¡µé¢çš„ `onLoad` åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸ä¼šè‡ªåŠ¨åˆ·æ–°

**éªŒè¯æ–¹æ³•**ï¼š
æŸ¥çœ‹é¡µé¢è·³è½¬æ–¹å¼ï¼š
- å¦‚æœæ˜¯ `wx.navigateTo`ï¼šé¡µé¢ä¼šç¼“å­˜ï¼Œè¿”å›æ—¶ä¸ä¼šé‡æ–° `onLoad`
- å¦‚æœæ˜¯ `wx.redirectTo` æˆ– `wx.reLaunch`ï¼šé¡µé¢ä¼šé‡æ–°åŠ è½½

---

### åŸå› D: ç”¨æˆ·ä¸­å¿ƒçš„è·³è½¬é€»è¾‘æœ‰è¯¯ (2%å¯èƒ½æ€§)

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·ä»"æˆ‘çš„"é¡µé¢ç‚¹å‡»"å·¥ä½œå°"
- "å·¥ä½œå°"æŒ‰é’®çš„åˆ¤æ–­é€»è¾‘å¯èƒ½æœ‰é—®é¢˜
- å¯¼è‡´è·³è½¬åˆ°äº†é”™è¯¯çš„é¡µé¢æˆ–çŠ¶æ€

**éœ€è¦æ£€æŸ¥**ï¼š
- `pages/user-center/index.js` ä¸­"å·¥ä½œå°"æŒ‰é’®çš„è·³è½¬é€»è¾‘
- æ˜¯å¦æ­£ç¡®åˆ¤æ–­äº†ç”¨æˆ·çš„æƒé™çŠ¶æ€

---

## å®Œæ•´çš„æ•°æ®æµè¿½è¸ª

### 1. ç®¡ç†å‘˜å¼€é€šæƒé™æ—¶

**æ–‡ä»¶**: `miniprogram/pages/admin/index.js`

```javascript
grantArtistPermission() {
  // ...
  
  // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œå¼€é€šæƒé™
  if (artist.userId === wx.getStorageSync('userId')) {
    const app = getApp()
    let userRoles = wx.getStorageSync('userRoles') || ['customer']
    if (!userRoles.includes('artist')) {
      userRoles.push('artist')
      wx.setStorageSync('userRoles', userRoles)  // âœ… æ›´æ–° localStorage
      app.globalData.roles = userRoles            // âœ… æ›´æ–° globalData
    }
  }
  
  // âš ï¸ é—®é¢˜ï¼šå¦‚æœç”¨æˆ·æ­¤æ—¶æ­£åœ¨åˆ«çš„é¡µé¢ï¼ŒglobalData ä¸ä¼šåŒæ­¥æ›´æ–°
}
```

### 2. ç”¨æˆ·è¿”å›ç”¨æˆ·ä¸­å¿ƒæ—¶

**æ–‡ä»¶**: `miniprogram/pages/user-center/index.js` (æ¨æµ‹)

```javascript
onShow() {
  // å¯èƒ½æ²¡æœ‰é‡æ–°è¯»å– userRoles
  // æˆ–è€…åªè¯»å–äº† localStorageï¼Œæ²¡æœ‰æ›´æ–° globalData
}
```

### 3. ç”¨æˆ·ç‚¹å‡»"å·¥ä½œå°"æ—¶

**æ–‡ä»¶**: `miniprogram/pages/user-center/index.js` (æ¨æµ‹)

```javascript
goToWorkspace() {
  wx.navigateTo({
    url: '/pages/artist-qrcode/index'
  })
  // âš ï¸ å¦‚æœé¡µé¢å·²åœ¨æ ˆä¸­ï¼Œä¸ä¼šè§¦å‘ onLoad
}
```

### 4. ç”»å¸ˆæ¡£æ¡ˆé¡µé¢åŠ è½½æ—¶

**æ–‡ä»¶**: `miniprogram/pages/artist-qrcode/index.js`

```javascript
checkArtistPermission() {
  const app = getApp()
  const roles = app.getUserRoles ? app.getUserRoles() : (wx.getStorageSync('userRoles') || ['customer'])
  // âš ï¸ å¦‚æœ app.globalData.roles æ²¡æ›´æ–°ï¼Œè¿™é‡Œè¯»åˆ°çš„æ˜¯æ—§æ•°æ®
  
  const hasArtistPermission = roles.includes('artist')
  this.setData({
    hasArtistPermission: hasArtistPermission  // âš ï¸ è¿™ä¸ªå€¼å†³å®šé¡µé¢æ˜¾ç¤º
  })
}
```

---

## é—®é¢˜çš„æœ¬è´¨

**æ ¸å¿ƒé—®é¢˜**ï¼š**æ•°æ®åŒæ­¥å’Œé¡µé¢åˆ·æ–°æœºåˆ¶ä¸å®Œå–„**

### é—®é¢˜é“¾æ¡

```
ç®¡ç†å‘˜å¼€é€šæƒé™
    â†“
æ›´æ–° localStorage (userRoles)
    â†“
æ›´æ–° app.globalData.roles ï¼ˆä»…å½“å‰ç”¨æˆ·åœ¨çº¿æ—¶ï¼‰
    â†“
ç”¨æˆ·åˆ‡æ¢é¡µé¢
    â†“
app.globalData å¯èƒ½å¤±æ•ˆæˆ–æœªåŒæ­¥
    â†“
ç”»å¸ˆæ¡£æ¡ˆé¡µé¢è¯»å–æ—§æ•°æ®
    â†“
hasArtistPermission = false
    â†“
é¡µé¢æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
```

---

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æœ¬åœ°å­˜å‚¨

åœ¨"å»ºç«‹ç”»å¸ˆæ¡£æ¡ˆ"é¡µé¢çš„æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
console.log('========== æƒé™è¯Šæ–­ ==========')
const app = getApp()
const localRoles = wx.getStorageSync('userRoles')
const globalRoles = app.globalData.roles
const getUserRoles = app.getUserRoles ? app.getUserRoles() : null

console.log('1. localStorage userRoles:', localRoles)
console.log('2. app.globalData.roles:', globalRoles)
console.log('3. app.getUserRoles():', getUserRoles)
console.log('4. åŒ…å«artistï¼ˆlocalStorageï¼‰:', localRoles?.includes('artist'))
console.log('5. åŒ…å«artistï¼ˆglobalDataï¼‰:', globalRoles?.includes('artist'))
console.log('========== è¯Šæ–­å®Œæˆ ==========')
```

---

### æ­¥éª¤2: æŸ¥çœ‹é¡µé¢æ•°æ®

åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
const pages = getCurrentPages()
const currentPage = pages[pages.length - 1]
console.log('å½“å‰é¡µé¢æ•°æ®:')
console.log('  hasArtistPermission:', currentPage.data.hasArtistPermission)
console.log('  applicationApproved:', currentPage.data.applicationApproved)
```

---

### æ­¥éª¤3: æ‰‹åŠ¨åˆ·æ–°é¡µé¢

åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
const pages = getCurrentPages()
const currentPage = pages[pages.length - 1]
currentPage.checkArtistPermission()  // æ‰‹åŠ¨è§¦å‘æƒé™æ£€æŸ¥
console.log('åˆ·æ–°å hasArtistPermission:', currentPage.data.hasArtistPermission)
```

---

## é—®é¢˜çš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ·»åŠ  onShow åˆ·æ–°æœºåˆ¶ï¼ˆæ¨èï¼‰

**ä¿®æ”¹**: `miniprogram/pages/artist-qrcode/index.js`

```javascript
onShow() {
  // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°æ£€æŸ¥æƒé™
  this.checkArtistPermission()
  console.log('ğŸ“± [artist-qrcode] onShow: é‡æ–°æ£€æŸ¥æƒé™')
},
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥
- âœ… è§£å†³é¡µé¢ç¼“å­˜é—®é¢˜
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰

---

### æ–¹æ¡ˆ2: ç»Ÿä¸€ä» localStorage è¯»å–ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰

**ä¿®æ”¹**: `miniprogram/pages/artist-qrcode/index.js`

```javascript
checkArtistPermission() {
  // å§‹ç»ˆä» localStorage è¯»å–ï¼Œé¿å… globalData ä¸åŒæ­¥
  const roles = wx.getStorageSync('userRoles') || ['customer']
  const hasArtistPermission = roles.includes('artist')
  
  console.log('ğŸ” [artist-qrcode] æƒé™æ£€æŸ¥è¯¦æƒ…:')
  console.log('  - å½“å‰è§’è‰²åˆ—è¡¨:', roles)
  console.log('  - æ˜¯å¦åŒ…å«artist:', hasArtistPermission)
  
  this.setData({
    hasArtistPermission: hasArtistPermission
  })
  
  // åŒæ­¥æ›´æ–° app.globalDataï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼‰
  const app = getApp()
  if (app.globalData) {
    app.globalData.roles = roles
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… localStorage æ˜¯æƒå¨æ•°æ®æº
- âœ… é¿å… globalData ä¸åŒæ­¥é—®é¢˜
- âœ… ä¸»åŠ¨åŒæ­¥ globalData

---

### æ–¹æ¡ˆ3: ä½¿ç”¨ redirectTo å¼ºåˆ¶åˆ·æ–°

**ä¿®æ”¹**: ç”¨æˆ·ä¸­å¿ƒæˆ–ç®¡ç†åå°è·³è½¬æ—¶

```javascript
// ä»ç”¨æˆ·ä¸­å¿ƒè·³è½¬
goToWorkspace() {
  wx.redirectTo({  // ä½¿ç”¨ redirectTo æ›¿ä»£ navigateTo
    url: '/pages/artist-qrcode/index'
  })
}

// ç®¡ç†å‘˜å¼€é€šæƒé™åæç¤ºç”¨æˆ·
grantArtistPermission() {
  // ...
  if (artist.userId === wx.getStorageSync('userId')) {
    // å¼€é€šæƒé™å
    wx.showModal({
      title: 'æƒé™å·²å¼€é€š',
      content: 'è¯·é‡æ–°è¿›å…¥ç”»å¸ˆæ¡£æ¡ˆé¡µé¢',
      showCancel: false
    })
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¼ºåˆ¶é¡µé¢é‡æ–°åŠ è½½
- âœ… ç¡®ä¿æ•°æ®æœ€æ–°

**ç¼ºç‚¹**ï¼š
- âŒ ç”¨æˆ·ä½“éªŒç¨å·®ï¼ˆé¡µé¢é‡æ–°åŠ è½½ï¼‰
- âŒ é¡µé¢æ ˆè¢«æ›¿æ¢

---

### æ–¹æ¡ˆ4: äº‹ä»¶æ€»çº¿é€šçŸ¥ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

åœ¨ `app.js` ä¸­å®ç°ä¸€ä¸ªç®€å•çš„äº‹ä»¶ç³»ç»Ÿï¼š

```javascript
// app.js
App({
  globalData: {
    roles: [],
    eventListeners: {}
  },
  
  // è§¦å‘äº‹ä»¶
  emit(event, data) {
    if (this.globalData.eventListeners[event]) {
      this.globalData.eventListeners[event].forEach(callback => {
        callback(data)
      })
    }
  },
  
  // ç›‘å¬äº‹ä»¶
  on(event, callback) {
    if (!this.globalData.eventListeners[event]) {
      this.globalData.eventListeners[event] = []
    }
    this.globalData.eventListeners[event].push(callback)
  }
})
```

åœ¨ç”»å¸ˆæ¡£æ¡ˆé¡µé¢ç›‘å¬æƒé™å˜åŒ–ï¼š

```javascript
onLoad() {
  // ...
  
  // ç›‘å¬æƒé™æ›´æ–°äº‹ä»¶
  const app = getApp()
  app.on('rolesUpdated', () => {
    console.log('ğŸ”” æ”¶åˆ°æƒé™æ›´æ–°é€šçŸ¥')
    this.checkArtistPermission()
  })
},
```

åœ¨ç®¡ç†åå°å¼€é€šæƒé™æ—¶è§¦å‘äº‹ä»¶ï¼š

```javascript
grantArtistPermission() {
  // ...
  
  if (artist.userId === wx.getStorageSync('userId')) {
    // æ›´æ–°æƒé™
    userRoles.push('artist')
    wx.setStorageSync('userRoles', userRoles)
    app.globalData.roles = userRoles
    
    // è§¦å‘äº‹ä»¶é€šçŸ¥å…¶ä»–é¡µé¢
    app.emit('rolesUpdated', userRoles)
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶åŒæ­¥
- âœ… è§£è€¦åˆ
- âœ… å¯æ‰©å±•

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°å¤æ‚
- âŒ éœ€è¦ä¿®æ”¹å¤šä¸ªæ–‡ä»¶

---

## æ¨èæ–¹æ¡ˆ

### æœ€ç®€å•æœ‰æ•ˆçš„ä¿®å¤ï¼ˆæ¨èï¼‰

**æ–¹æ¡ˆ1 + æ–¹æ¡ˆ2 ç»„åˆ**ï¼š

1. **æ·»åŠ  `onShow` åˆ·æ–°**ï¼ˆè§£å†³é¡µé¢ç¼“å­˜ï¼‰
2. **å§‹ç»ˆä» localStorage è¯»å–**ï¼ˆè§£å†³æ•°æ®ä¸åŒæ­¥ï¼‰

```javascript
// miniprogram/pages/artist-qrcode/index.js

onShow() {
  // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°æ£€æŸ¥æƒé™
  this.checkArtistPermission()
},

checkArtistPermission() {
  // å§‹ç»ˆä» localStorage è¯»å–ï¼ˆæƒå¨æ•°æ®æºï¼‰
  const roles = wx.getStorageSync('userRoles') || ['customer']
  const hasArtistPermission = roles.includes('artist')
  
  console.log('ğŸ” [artist-qrcode] æƒé™æ£€æŸ¥è¯¦æƒ…:')
  console.log('  - å½“å‰è§’è‰²åˆ—è¡¨:', roles)
  console.log('  - æ˜¯å¦åŒ…å«artist:', hasArtistPermission)
  
  this.setData({
    hasArtistPermission: hasArtistPermission
  })
  
  // åŒæ­¥æ›´æ–° app.globalDataï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼‰
  const app = getApp()
  if (app.globalData) {
    app.globalData.roles = roles
  }
}
```

---

## æ€»ç»“

### é—®é¢˜æœ¬è´¨

1. **é¡µé¢ç¼“å­˜æœºåˆ¶**ï¼šå°ç¨‹åºçš„ `navigateTo` ä¼šç¼“å­˜é¡µé¢ï¼Œå¯¼è‡´ `onLoad` ä¸ä¼šé‡æ–°æ‰§è¡Œ
2. **æ•°æ®åŒæ­¥é—®é¢˜**ï¼š`app.globalData` å’Œ `localStorage` å¯èƒ½ä¸ä¸€è‡´
3. **åˆ·æ–°æœºåˆ¶ç¼ºå¤±**ï¼šæƒé™æ›´æ–°åï¼Œé¡µé¢æ²¡æœ‰è‡ªåŠ¨åˆ·æ–°çš„æœºåˆ¶

### æœ€å¯èƒ½çš„åŸå› 

**70%**: é¡µé¢ç¼“å­˜ï¼Œç”¨æˆ·åœ¨æƒé™æ›´æ–°å‰å°±æ‰“å¼€è¿‡é¡µé¢
**20%**: app.globalData å’Œ localStorage ä¸åŒæ­¥
**8%**: é¡µé¢è·³è½¬æ–¹å¼å¯¼è‡´ä¸åˆ·æ–°
**2%**: ç”¨æˆ·ä¸­å¿ƒé€»è¾‘é—®é¢˜

### éªŒè¯æ–¹æ³•

æ‰§è¡Œè¯Šæ–­å‘½ä»¤ï¼ˆæ§åˆ¶å°ï¼‰ï¼š
```javascript
console.log('æƒé™è¯Šæ–­:')
console.log('localStorage:', wx.getStorageSync('userRoles'))
console.log('globalData:', getApp().globalData.roles)
console.log('é¡µé¢æ•°æ®:', getCurrentPages()[getCurrentPages().length-1].data.hasArtistPermission)
```

### ä¿®å¤æ–¹æ¡ˆ

**æœ€ç®€å•æœ‰æ•ˆ**ï¼šæ·»åŠ  `onShow()` åˆ·æ–° + å§‹ç»ˆä» localStorage è¯»å–

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-26  
**é—®é¢˜çŠ¶æ€**: å·²å®šä½æ ¹æœ¬åŸå›   
**ä¸‹ä¸€æ­¥**: æ ¹æ®è¯Šæ–­ç»“æœé€‰æ‹©åˆé€‚çš„ä¿®å¤æ–¹æ¡ˆ

