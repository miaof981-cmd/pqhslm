# å››ç«¯ç»Ÿä¸€å·¥å…·åº”ç”¨æŒ‡å—

## ğŸ“Œ ç›®æ ‡

è®©ç”¨æˆ·ç«¯ã€ç”»å¸ˆç«¯ã€å®¢æœç«¯ã€ç®¡ç†ç«¯éƒ½ä½¿ç”¨ç›¸åŒçš„æ•°æ®å¤„ç†é€»è¾‘ï¼Œç¡®ä¿ï¼š
1. âœ… å®¢æœå¤´åƒæ˜¾ç¤ºä¸€è‡´
2. âœ… çŠ¶æ€æ–‡å­—æ˜¾ç¤ºä¸€è‡´ï¼ˆä¸å†å‡ºç°"åˆ¶ä½œä¸­"vs"è¿›è¡Œä¸­"çš„æ··ç”¨ï¼‰
3. âœ… æ ·å¼ç±»åç»Ÿä¸€
4. âœ… å…œåº•é€»è¾‘ç»Ÿä¸€ï¼ˆæ•°æ®ç¼ºå¤±æ—¶æœ‰é»˜è®¤å€¼ï¼‰

---

## ğŸ”§ å·¥å…·å‡½æ•°è¯´æ˜

### å·²åˆ›å»ºçš„å·¥å…·æ–‡ä»¶

1. **`utils/order-status.js`** - çŠ¶æ€è®¡ç®—å’Œæ˜ å°„
   - `textOf(status)` - è·å–çŠ¶æ€ä¸­æ–‡æ–‡æœ¬
   - `classOf(status)` - è·å–CSSç±»å
   - `withServiceFallback(order)` - å®¢æœä¿¡æ¯å…œåº•
   - `DEFAULT_AVATAR` - é»˜è®¤å¤´åƒå¸¸é‡

2. **`utils/order-helper.js`** - è®¢å•æ•°æ®å¤„ç†
   - `normalizeOrders(orders)` - æ ‡å‡†åŒ–è®¢å•æ•°ç»„
   - `getAllOrders()` - è·å–æ‰€æœ‰è®¢å•
   - `prepareOrdersForPage(filter)` - ä¸ºé¡µé¢å‡†å¤‡è®¢å•

---

## ğŸ“ å››ç«¯è¿ç§»æ­¥éª¤

### 1ï¸âƒ£ ç”¨æˆ·ç«¯ (pages/order-list/index.js)

#### ä¿®æ”¹å‰ï¼š
```javascript
// åˆ†æ•£çš„å¤„ç†é€»è¾‘
let statusText = 'åˆ¶ä½œä¸­'  // âŒ ç¡¬ç¼–ç 
if (order.status === 'completed') {
  statusText = 'å·²å®Œæˆ'
}

// å¤æ‚çš„å®¢æœä¿¡æ¯å¤„ç†
if (order.serviceName && order.serviceName !== 'å¾…åˆ†é…') {
  serviceName = order.serviceName
  serviceAvatar = order.serviceAvatar || '/assets/default-avatar.png'
} else if (order.serviceId) {
  const service = serviceList.find(...)
  // ...
}
```

#### ä¿®æ”¹åï¼š
```javascript
const orderHelper = require('../../utils/order-helper.js')

loadOrders() {
  const userId = wx.getStorageSync('userId')
  
  // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å·¥å…·å‡½æ•°
  const orders = orderHelper.prepareOrdersForPage({
    role: 'customer',
    userId: userId,
    status: this.data.currentTab  // å½“å‰ç­›é€‰çŠ¶æ€
  })
  
  this.setData({ orders })
}
```

---

### 2ï¸âƒ£ ç”»å¸ˆç«¯ (pages/workspace/index.js)

#### ä¿®æ”¹æ­¥éª¤ï¼š

1. **å¼•å…¥å·¥å…·**
```javascript
const orderHelper = require('../../utils/order-helper.js')
```

2. **æ›¿æ¢ loadOrders**
```javascript
loadOrders() {
  const userId = wx.getStorageSync('userId')
  
  // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å·¥å…·å‡½æ•°
  const orders = orderHelper.prepareOrdersForPage({
    role: 'artist',
    userId: userId
  })
  
  // è®¡ç®—ç»Ÿè®¡
  const stats = {
    all: orders.length,
    inProgress: orders.filter(o => o.status === 'inProgress').length,
    nearDeadline: orders.filter(o => o.status === 'nearDeadline').length,
    overdue: orders.filter(o => o.status === 'overdue').length,
    waitingConfirm: orders.filter(o => o.status === 'waitingConfirm').length
  }
  
  this.setData({
    allOrders: orders,
    pendingStats: stats
  })
  
  this.applyFilter()
}
```

---

### 3ï¸âƒ£ å®¢æœç«¯ (pages/service-workspace/index.js)

#### ä¿®æ”¹æ­¥éª¤ï¼š

```javascript
const orderHelper = require('../../utils/order-helper.js')

loadOrders() {
  const userId = wx.getStorageSync('userId')
  
  // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å·¥å…·å‡½æ•°
  const orders = orderHelper.prepareOrdersForPage({
    role: 'service',
    userId: userId
  })
  
  // è®¡ç®—ç»Ÿè®¡
  const stats = {
    pending: orders.filter(o => o.status === 'inProgress').length,
    nearDeadline: orders.filter(o => o.status === 'nearDeadline').length,
    overdue: orders.filter(o => o.status === 'overdue').length
  }
  
  this.setData({
    allOrders: orders,
    pendingStats: stats
  })
  
  this.applyFilter()
}
```

---

### 4ï¸âƒ£ ç®¡ç†ç«¯ (pages/admin/index.js)

#### ä¿®æ”¹æ­¥éª¤ï¼š

```javascript
const orderHelper = require('../../utils/order-helper.js')

loadOrders() {
  // ğŸ¯ ä½¿ç”¨ç»Ÿä¸€å·¥å…·å‡½æ•°ï¼ˆç®¡ç†å‘˜çœ‹æ‰€æœ‰è®¢å•ï¼‰
  const orders = orderHelper.prepareOrdersForPage({
    role: 'admin'
  })
  
  this.setData({ orders })
}
```

---

## âš ï¸ é‡è¦æé†’

### åˆ é™¤è¿™äº›ä»£ç ï¼ˆå››ç«¯éƒ½è¦åˆ ï¼‰

1. âŒ åˆ é™¤æœ¬åœ°çš„çŠ¶æ€æ˜ å°„å®šä¹‰
```javascript
// âŒ åˆ é™¤è¿™äº›
const statusMap = {
  'inProgress': 'åˆ¶ä½œä¸­',
  'completed': 'å·²å®Œæˆ'
}
```

2. âŒ åˆ é™¤æœ¬åœ°çš„å®¢æœä¿¡æ¯å¤„ç†
```javascript
// âŒ åˆ é™¤è¿™äº›
if (order.serviceId) {
  const serviceList = wx.getStorageSync('customer_service_list') || []
  const service = serviceList.find(...)
  // ...
}
```

3. âŒ åˆ é™¤ç¡¬ç¼–ç çš„çŠ¶æ€æ–‡å­—
```javascript
// âŒ åˆ é™¤è¿™äº›
let statusText = 'åˆ¶ä½œä¸­'
if (order.status === 'completed') {
  statusText = 'å·²å®Œæˆ'
}
```

### ä¿ç•™è¿™äº›ä»£ç 

âœ… ä¿ç•™ç­›é€‰é€»è¾‘ï¼ˆapplyFilterï¼‰
âœ… ä¿ç•™UIäº¤äº’é€»è¾‘ï¼ˆviewOrder, contactServiceç­‰ï¼‰
âœ… ä¿ç•™æ ·å¼ç±»åç»‘å®šï¼ˆ`class="status-{{item.status}}"`ï¼‰

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### ä¿®æ”¹å®Œæˆåï¼Œåœ¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
// éªŒè¯å·¥å…·å‡½æ•°æ˜¯å¦æ­£å¸¸
const orderHelper = require('utils/order-helper.js')
const orderStatus = require('utils/order-status.js')

console.log('=== å·¥å…·å‡½æ•°æµ‹è¯• ===')
console.log('çŠ¶æ€æ˜ å°„:', orderStatus.textOf('inProgress'))  // åº”è¯¥è¾“å‡º"è¿›è¡Œä¸­"
console.log('é»˜è®¤å¤´åƒ:', orderStatus.DEFAULT_AVATAR.substring(0, 50))  // åº”è¯¥æ˜¯ base64
console.log('è®¢å•æ€»æ•°:', orderHelper.getAllOrders().length)

// æµ‹è¯•æ ‡å‡†åŒ–
const orders = orderHelper.prepareOrdersForPage({
  role: 'customer',
  userId: wx.getStorageSync('userId')
})
console.log('æ ‡å‡†åŒ–è®¢å•:', orders[0])
// åº”è¯¥åŒ…å«: serviceName, serviceAvatar, statusText, statusClass
```

---

## ğŸ“‹ è¿ç§»æ£€æŸ¥æ¸…å•

### ç”¨æˆ·ç«¯ (order-list)
- [ ] å¼•å…¥ `order-helper.js`
- [ ] æ›¿æ¢ `loadOrders` ä½¿ç”¨ `prepareOrdersForPage`
- [ ] åˆ é™¤æœ¬åœ°çŠ¶æ€æ˜ å°„
- [ ] åˆ é™¤æœ¬åœ°å®¢æœä¿¡æ¯å¤„ç†
- [ ] æµ‹è¯•ï¼šå®¢æœå¤´åƒæ­£å¸¸æ˜¾ç¤º
- [ ] æµ‹è¯•ï¼šçŠ¶æ€æ–‡å­—æ˜¾ç¤º"è¿›è¡Œä¸­"è€Œä¸æ˜¯"åˆ¶ä½œä¸­"

### ç”»å¸ˆç«¯ (workspace)
- [ ] å¼•å…¥ `order-helper.js`
- [ ] æ›¿æ¢ `loadOrders` ä½¿ç”¨ `prepareOrdersForPage`
- [ ] æµ‹è¯•ï¼šå®¢æœå¤´åƒæ­£å¸¸æ˜¾ç¤º

### å®¢æœç«¯ (service-workspace)
- [ ] å¼•å…¥ `order-helper.js`
- [ ] æ›¿æ¢ `loadOrders` ä½¿ç”¨ `prepareOrdersForPage`
- [ ] åˆ é™¤ `getStatusText` å‡½æ•°
- [ ] æµ‹è¯•ï¼šä¹°å®¶å’Œç”»å¸ˆå¤´åƒæ­£å¸¸æ˜¾ç¤º

### ç®¡ç†ç«¯ (admin)
- [ ] å¼•å…¥ `order-helper.js`
- [ ] æ›¿æ¢ `loadOrders` ä½¿ç”¨ `prepareOrdersForPage`
- [ ] åˆ é™¤æœ¬åœ° `statusTextMap`
- [ ] æµ‹è¯•ï¼šçŠ¶æ€æ–‡å­—ç»Ÿä¸€

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä¿®æ”¹å®Œæˆåï¼š

1. **å››ç«¯çŠ¶æ€æ–‡å­—ç»Ÿä¸€**
   - ç”¨æˆ·ç«¯ï¼š`inProgress` â†’ "è¿›è¡Œä¸­" âœ…
   - ç”»å¸ˆç«¯ï¼š`inProgress` â†’ "è¿›è¡Œä¸­" âœ…
   - å®¢æœç«¯ï¼š`inProgress` â†’ "è¿›è¡Œä¸­" âœ…
   - ç®¡ç†ç«¯ï¼š`inProgress` â†’ "è¿›è¡Œä¸­" âœ…

2. **å®¢æœå¤´åƒç¨³å®šæ˜¾ç¤º**
   - å³ä½¿ `customer_service_list` ä¸ºç©º
   - ä¹Ÿä¼šæ˜¾ç¤ºé»˜è®¤å¤´åƒï¼ˆbase64 SVGï¼‰
   - ä¸ä¼šå‡ºç° 500 é”™è¯¯

3. **ä»£ç é‡å‡å°‘**
   - æ¯ä¸ªé¡µé¢å‡å°‘ 50-100 è¡Œé‡å¤ä»£ç 
   - ç»Ÿä¸€åœ¨å·¥å…·å‡½æ•°ä¸­ç»´æŠ¤

4. **æ˜“äºç»´æŠ¤**
   - çŠ¶æ€æ–‡å­—ä¿®æ”¹ï¼šåªæ”¹ `utils/order-status.js`
   - å…œåº•é€»è¾‘ä¿®æ”¹ï¼šåªæ”¹ `utils/order-status.js`
   - å››ç«¯è‡ªåŠ¨åŒæ­¥

---

## ğŸ’¡ åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### å¦‚æœæ—¶é—´å……è£•ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

1. **WXML ä¼˜åŒ–**
```xml
<!-- ä¿®æ”¹å‰ -->
<text>{{item.statusText}}</text>

<!-- ä¿®æ”¹åï¼ˆæ›´ç®€æ´ï¼‰ -->
<text>{{item.statusText}}</text>
<!-- çŠ¶æ€æ–‡å­—å·²åœ¨ JS ä¸­ç»Ÿä¸€å¤„ç†ï¼ŒWXML æ— éœ€ä¿®æ”¹ -->
```

2. **åˆ›å»ºè®¢å•å¡ç‰‡ç»„ä»¶**
```
components/order-card/
â”œâ”€â”€ index.wxml
â”œâ”€â”€ index.wxss
â”œâ”€â”€ index.js
â””â”€â”€ index.json
```

æŠŠè®¢å•å¡ç‰‡æŠ½å–æˆç»„ä»¶ï¼Œå››ç«¯å…±ç”¨ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦åŒæ—¶ä¿®æ”¹å››ä¸ªé¡µé¢**
   - å…ˆä¿®æ”¹ä¸€ä¸ªï¼ˆå»ºè®®ä»ç”¨æˆ·ç«¯å¼€å§‹ï¼‰
   - æµ‹è¯•é€šè¿‡åå†ä¿®æ”¹ä¸‹ä¸€ä¸ª

2. **ä¿ç•™åŸæœ‰å‡½æ•°ä½œä¸ºå¤‡ä»½**
   - åœ¨ä¿®æ”¹å‰æ³¨é‡Šæ‰æ—§ä»£ç ï¼Œä¸è¦ç›´æ¥åˆ é™¤
   - æµ‹è¯•é€šè¿‡åå†åˆ é™¤

3. **è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—**
   - å·¥å…·å‡½æ•°ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—
   - æ–¹ä¾¿æ’æŸ¥é—®é¢˜

4. **æ¸è¿›å¼è¿ç§»**
   - å¯ä»¥å…ˆåªè¿ç§»å®¢æœä¿¡æ¯å¤„ç†
   - å†è¿ç§»çŠ¶æ€æ˜ å°„
   - æœ€ååˆ é™¤å†—ä½™ä»£ç 

---

**å®Œæˆåæäº¤ä»£ç æ—¶çš„ commit ä¿¡æ¯å»ºè®®ï¼š**

```
refactor: ç»Ÿä¸€å››ç«¯è®¢å•æ•°æ®å¤„ç†é€»è¾‘

- åˆ›å»º utils/order-helper.js ç»Ÿä¸€è®¢å•æ•°æ®å¤„ç†
- åˆ›å»ºç»Ÿä¸€çŠ¶æ€æ˜ å°„å’Œå¤´åƒå…œåº•é€»è¾‘
- å››ç«¯éƒ½ä½¿ç”¨ç›¸åŒçš„å·¥å…·å‡½æ•°
- è§£å†³å®¢æœå¤´åƒä¸æ˜¾ç¤ºé—®é¢˜
- è§£å†³çŠ¶æ€æ–‡å­—ä¸ä¸€è‡´é—®é¢˜ï¼ˆ"åˆ¶ä½œä¸­" vs "è¿›è¡Œä¸­"ï¼‰

å½±å“é¡µé¢:
- pages/order-list/index (ç”¨æˆ·ç«¯)
- pages/workspace/index (ç”»å¸ˆç«¯)
- pages/service-workspace/index (å®¢æœç«¯)
- pages/admin/index (ç®¡ç†ç«¯)
```

