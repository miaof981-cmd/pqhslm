# 四端统一工具应用指南

## 📌 目标

让用户端、画师端、客服端、管理端都使用相同的数据处理逻辑，确保：
1. ✅ 客服头像显示一致
2. ✅ 状态文字显示一致（不再出现"制作中"vs"进行中"的混用）
3. ✅ 样式类名统一
4. ✅ 兜底逻辑统一（数据缺失时有默认值）

---

## 🔧 工具函数说明

### 已创建的工具文件

1. **`utils/order-status.js`** - 状态计算和映射
   - `textOf(status)` - 获取状态中文文本
   - `classOf(status)` - 获取CSS类名
   - `withServiceFallback(order)` - 客服信息兜底
   - `DEFAULT_AVATAR` - 默认头像常量

2. **`utils/order-helper.js`** - 订单数据处理
   - `normalizeOrders(orders)` - 标准化订单数组
   - `getAllOrders()` - 获取所有订单
   - `prepareOrdersForPage(filter)` - 为页面准备订单

---

## 📝 四端迁移步骤

### 1️⃣ 用户端 (pages/order-list/index.js)

#### 修改前：
```javascript
// 分散的处理逻辑
let statusText = '制作中'  // ❌ 硬编码
if (order.status === 'completed') {
  statusText = '已完成'
}

// 复杂的客服信息处理
if (order.serviceName && order.serviceName !== '待分配') {
  serviceName = order.serviceName
  serviceAvatar = order.serviceAvatar || '/assets/default-avatar.png'
} else if (order.serviceId) {
  const service = serviceList.find(...)
  // ...
}
```

#### 修改后：
```javascript
const orderHelper = require('../../utils/order-helper.js')

loadOrders() {
  const userId = wx.getStorageSync('userId')
  
  // 🎯 使用统一工具函数
  const orders = orderHelper.prepareOrdersForPage({
    role: 'customer',
    userId: userId,
    status: this.data.currentTab  // 当前筛选状态
  })
  
  this.setData({ orders })
}
```

---

### 2️⃣ 画师端 (pages/workspace/index.js)

#### 修改步骤：

1. **引入工具**
```javascript
const orderHelper = require('../../utils/order-helper.js')
```

2. **替换 loadOrders**
```javascript
loadOrders() {
  const userId = wx.getStorageSync('userId')
  
  // 🎯 使用统一工具函数
  const orders = orderHelper.prepareOrdersForPage({
    role: 'artist',
    userId: userId
  })
  
  // 计算统计
  const stats = {
    all: orders.length,
    inProgress: orders.filter(o => o.status === 'inProgress').length,
    nearDeadline: orders.filter(o => o.status === 'nearDeadline').length,
    overdue: orders.filter(o => o.status === 'overdue').length,
    waitingConfirm: orders.filter(o => o.status === 'waitingConfirm').length
  }
  
  this.setData({
    allOrders: orders,
    pendingStats: stats
  })
  
  this.applyFilter()
}
```

---

### 3️⃣ 客服端 (pages/service-workspace/index.js)

#### 修改步骤：

```javascript
const orderHelper = require('../../utils/order-helper.js')

loadOrders() {
  const userId = wx.getStorageSync('userId')
  
  // 🎯 使用统一工具函数
  const orders = orderHelper.prepareOrdersForPage({
    role: 'service',
    userId: userId
  })
  
  // 计算统计
  const stats = {
    pending: orders.filter(o => o.status === 'inProgress').length,
    nearDeadline: orders.filter(o => o.status === 'nearDeadline').length,
    overdue: orders.filter(o => o.status === 'overdue').length
  }
  
  this.setData({
    allOrders: orders,
    pendingStats: stats
  })
  
  this.applyFilter()
}
```

---

### 4️⃣ 管理端 (pages/admin/index.js)

#### 修改步骤：

```javascript
const orderHelper = require('../../utils/order-helper.js')

loadOrders() {
  // 🎯 使用统一工具函数（管理员看所有订单）
  const orders = orderHelper.prepareOrdersForPage({
    role: 'admin'
  })
  
  this.setData({ orders })
}
```

---

## ⚠️ 重要提醒

### 删除这些代码（四端都要删）

1. ❌ 删除本地的状态映射定义
```javascript
// ❌ 删除这些
const statusMap = {
  'inProgress': '制作中',
  'completed': '已完成'
}
```

2. ❌ 删除本地的客服信息处理
```javascript
// ❌ 删除这些
if (order.serviceId) {
  const serviceList = wx.getStorageSync('customer_service_list') || []
  const service = serviceList.find(...)
  // ...
}
```

3. ❌ 删除硬编码的状态文字
```javascript
// ❌ 删除这些
let statusText = '制作中'
if (order.status === 'completed') {
  statusText = '已完成'
}
```

### 保留这些代码

✅ 保留筛选逻辑（applyFilter）
✅ 保留UI交互逻辑（viewOrder, contactService等）
✅ 保留样式类名绑定（`class="status-{{item.status}}"`）

---

## 🧪 验证步骤

### 修改完成后，在控制台运行：

```javascript
// 验证工具函数是否正常
const orderHelper = require('utils/order-helper.js')
const orderStatus = require('utils/order-status.js')

console.log('=== 工具函数测试 ===')
console.log('状态映射:', orderStatus.textOf('inProgress'))  // 应该输出"进行中"
console.log('默认头像:', orderStatus.DEFAULT_AVATAR.substring(0, 50))  // 应该是 base64
console.log('订单总数:', orderHelper.getAllOrders().length)

// 测试标准化
const orders = orderHelper.prepareOrdersForPage({
  role: 'customer',
  userId: wx.getStorageSync('userId')
})
console.log('标准化订单:', orders[0])
// 应该包含: serviceName, serviceAvatar, statusText, statusClass
```

---

## 📋 迁移检查清单

### 用户端 (order-list)
- [ ] 引入 `order-helper.js`
- [ ] 替换 `loadOrders` 使用 `prepareOrdersForPage`
- [ ] 删除本地状态映射
- [ ] 删除本地客服信息处理
- [ ] 测试：客服头像正常显示
- [ ] 测试：状态文字显示"进行中"而不是"制作中"

### 画师端 (workspace)
- [ ] 引入 `order-helper.js`
- [ ] 替换 `loadOrders` 使用 `prepareOrdersForPage`
- [ ] 测试：客服头像正常显示

### 客服端 (service-workspace)
- [ ] 引入 `order-helper.js`
- [ ] 替换 `loadOrders` 使用 `prepareOrdersForPage`
- [ ] 删除 `getStatusText` 函数
- [ ] 测试：买家和画师头像正常显示

### 管理端 (admin)
- [ ] 引入 `order-helper.js`
- [ ] 替换 `loadOrders` 使用 `prepareOrdersForPage`
- [ ] 删除本地 `statusTextMap`
- [ ] 测试：状态文字统一

---

## 🎯 预期效果

### 修改完成后：

1. **四端状态文字统一**
   - 用户端：`inProgress` → "进行中" ✅
   - 画师端：`inProgress` → "进行中" ✅
   - 客服端：`inProgress` → "进行中" ✅
   - 管理端：`inProgress` → "进行中" ✅

2. **客服头像稳定显示**
   - 即使 `customer_service_list` 为空
   - 也会显示默认头像（base64 SVG）
   - 不会出现 500 错误

3. **代码量减少**
   - 每个页面减少 50-100 行重复代码
   - 统一在工具函数中维护

4. **易于维护**
   - 状态文字修改：只改 `utils/order-status.js`
   - 兜底逻辑修改：只改 `utils/order-status.js`
   - 四端自动同步

---

## 💡 后续优化（可选）

### 如果时间充裕，可以进一步优化：

1. **WXML 优化**
```xml
<!-- 修改前 -->
<text>{{item.statusText}}</text>

<!-- 修改后（更简洁） -->
<text>{{item.statusText}}</text>
<!-- 状态文字已在 JS 中统一处理，WXML 无需修改 -->
```

2. **创建订单卡片组件**
```
components/order-card/
├── index.wxml
├── index.wxss
├── index.js
└── index.json
```

把订单卡片抽取成组件，四端共用。

---

## ⚠️ 注意事项

1. **不要同时修改四个页面**
   - 先修改一个（建议从用户端开始）
   - 测试通过后再修改下一个

2. **保留原有函数作为备份**
   - 在修改前注释掉旧代码，不要直接删除
   - 测试通过后再删除

3. **观察控制台日志**
   - 工具函数会输出详细日志
   - 方便排查问题

4. **渐进式迁移**
   - 可以先只迁移客服信息处理
   - 再迁移状态映射
   - 最后删除冗余代码

---

**完成后提交代码时的 commit 信息建议：**

```
refactor: 统一四端订单数据处理逻辑

- 创建 utils/order-helper.js 统一订单数据处理
- 创建统一状态映射和头像兜底逻辑
- 四端都使用相同的工具函数
- 解决客服头像不显示问题
- 解决状态文字不一致问题（"制作中" vs "进行中"）

影响页面:
- pages/order-list/index (用户端)
- pages/workspace/index (画师端)
- pages/service-workspace/index (客服端)
- pages/admin/index (管理端)
```

