# 登录问题后端排查-执行清单

## 🎯 问题定位

**核心问题**：点击登录出现报错

**必须回答的5个问题**：

### 1. 调用的云函数名
- **云函数名**：`userManager`
- **action**：`login`
- **请求参数**：`{ nickName, avatarUrl }`

### 2. 对应数据库集合
- **集合名**：`users`
- **操作类型**：查询 + 插入/更新
- **查询字段**：`_openid`（云端自动生成）
- **写入字段**：userId, nickName, avatarUrl, role, 等

### 3. 实际请求路径
```javascript
// 前端调用
cloudAPI.login(nickName, avatarUrl)
  ↓
// utils/cloud-api.js
wx.cloud.callFunction({
  name: 'userManager',
  data: { action: 'login', nickName, avatarUrl }
})
  ↓
// 云函数 userManager/index.js
exports.main = async (event, context) => {
  const openid = wxContext.OPENID  // 自动获取
  await login(openid, event)
}
```

### 4. 服务器返回的真实错误日志

**⚠️ 关键：需要在云开发控制台查看云函数日志**

**查看步骤**：
1. 登录微信开发者工具
2. 点击"云开发"
3. 进入"云函数"
4. 选择 `userManager`
5. 查看"日志"

**可能的错误类型**：
- ❌ 云函数未部署：`cloud function not found`
- ❌ 集合权限错误：`permission denied`
- ❌ 集合不存在：`collection not found`
- ❌ 字段类型错误：`validation error`
- ❌ 索引冲突：`duplicate key error`

### 5. 云函数部署状态

**检查项**：
- [ ] 云函数代码是否存在于本地 `/cloudfunctions/userManager/`
- [ ] 云函数是否已上传到云端
- [ ] 云函数版本是否为最新
- [ ] 云函数环境变量是否正确

## 🔧 立即执行的检查步骤

### 步骤1：检查云函数是否已部署

**方法**：在开发者工具中右键点击 `cloudfunctions/userManager`，选择"查看云端记录"

**预期结果**：
- ✅ 能看到云端版本号
- ✅ 上传时间为最近
- ❌ 提示"未部署" → **这就是问题所在**

### 步骤2：检查云数据库 users 集合

**方法**：
1. 云开发控制台 → 数据库
2. 查看是否存在 `users` 集合
3. 检查集合权限设置

**预期权限**：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

### 步骤3：测试云函数调用

**方法**：在开发者工具控制台执行：
```javascript
wx.cloud.callFunction({
  name: 'userManager',
  data: {
    action: 'login',
    nickName: '测试用户',
    avatarUrl: 'https://example.com/avatar.jpg'
  }
}).then(res => {
  console.log('✅ 云函数调用成功:', res)
}).catch(err => {
  console.error('❌ 云函数调用失败:', err)
})
```

### 步骤4：检查环境ID是否正确

**位置**：`miniprogram/app.js` 第14行  
**当前值**：`cloud1-2gca1h9d11f4d9d2`

**验证方法**：
1. 微信开发者工具 → 云开发 → 设置
2. 查看"环境ID"
3. 确认是否与代码中的一致

## 🚨 最可能的问题

### 问题1：云函数未上传（概率：80%）

**现象**：
- 本地有云函数代码
- 云端没有部署记录

**解决方案**：
1. 右键点击 `cloudfunctions/userManager` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成（显示"上传成功"）
4. 重新测试登录

### 问题2：云数据库未初始化（概率：15%）

**现象**：
- 云函数已部署
- users 集合不存在

**解决方案**：
1. 云开发控制台 → 数据库
2. 点击"添加集合"
3. 集合名称：`users`
4. 权限设置：
   ```json
   {
     "read": true,
     "write": "doc._openid == auth.openid"
   }
   ```

### 问题3：环境ID错误（概率：5%）

**现象**：
- 云函数已部署到环境A
- 代码中初始化环境B

**解决方案**：
修改 `miniprogram/app.js` 第14行，使用正确的环境ID

## ✅ 验证修复成功的标准

### 前端验证：
```javascript
// 控制台应该看到
☁️ 云开发已初始化
📱 准备登录，昵称: 测试用户
✅ 云函数登录成功: { userId: '1001', openid: 'o...', ... }
✅ 登录信息已保存
```

### 云端验证：
1. 云开发控制台 → 数据库 → users
2. 能看到新增的用户记录
3. 记录包含 `_openid`, `userId`, `nickName`, `avatarUrl` 等字段

### 云函数日志验证：
1. 云开发控制台 → 云函数 → userManager → 日志
2. 能看到最新的调用记录
3. 返回结果：`{ success: true, data: { ... } }`

## 📝 修复记录模板

```markdown
### 修复日期：____年__月__日
### 执行人：________

#### 问题确认：
- [ ] 云函数已部署到云端
- [ ] users 集合已创建
- [ ] 集合权限已正确设置
- [ ] 环境ID已确认正确

#### 测试结果：
- [ ] 云函数调用成功
- [ ] 用户记录已写入数据库
- [ ] 前端收到正确的返回值
- [ ] 登录流程完整走通

#### 遇到的真实错误：
```
（粘贴云函数日志中的真实错误信息）
```

#### 最终解决方案：
（描述实际采取的修复措施）
```

---

**重要提示**：
- ❌ 不要使用本地存储兜底
- ❌ 不要使用 mock 数据
- ❌ 不要跳过云函数调用
- ✅ 必须确保云端真实写入成功
- ✅ 所有数据必须走云数据库

**生成时间**：2025-11-22  
**报告类型**：后端真实问题排查执行清单

