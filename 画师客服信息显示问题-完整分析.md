# 画师和客服信息显示问题 - 完整分析报告

## 📋 问题现象

### 新订单 (202511051624265956) - 2025-11-05 16:24
- ✅ 画师：妙妙（有头像）
- ❌ 客服：待分配（灰色头像）

### 旧订单 (202511051609149233) - 2025-11-05 16:09  
- ❌ 画师：未知画师（灰色头像）← 之前显示"妙妙"
- ✅ 客服：妙妙（有头像）← 之前显示"待分配"

---

## 🔍 根本原因分析

### 原因1：客服显示"待分配"的BUG

**代码位置：** `miniprogram/pages/order-success/index.js` 第32-35行

```javascript
// --- 分配客服 ---
const service = this.assignService()  // ✅ 返回 { serviceId, serviceName, serviceAvatar }
const serviceId = service?.serviceId || service?.id || ''
const serviceName = service?.serviceName || service?.name || '客服未分配'  // ⚠️ BUG在这里
const serviceAvatar = service?.serviceAvatar || service?.avatar || DEFAULT_AVATAR_DATA
```

**问题：**
1. `assignService()` 返回的对象结构是：
   ```javascript
   {
     serviceId: 'xxx',
     serviceName: '妙妙',  // ⚠️ 注意字段名是 serviceName
     serviceAvatar: 'https://...'
   }
   ```

2. 但第34行的兜底逻辑是：
   ```javascript
   service?.serviceName || service?.name || '客服未分配'
   ```
   这里尝试读取 `service.name`，但 `assignService()` 返回的对象中**没有 `name` 字段**！

3. 如果 `service.serviceName` 因为某种原因为空（例如客服表中 `name` 和 `nickName` 都为空），就会使用兜底值 `'客服未分配'`

**实际发生的情况：**
- `assignService()` 正确执行，返回了客服信息
- 但 `service.serviceName` 的值可能是 `undefined` 或空字符串
- 导致兜底逻辑生效，`serviceName = '客服未分配'`
- 订单保存时就固化了这个错误值

---

### 原因2：旧订单画师变成"未知画师"

**代码位置：** `miniprogram/utils/order-helper.js` 第21-90行

```javascript
function normalizeOrders(orders, options = {}) {
  return orders.map(order => {
    // 1️⃣ 备份原始字段
    const rawArtistName = order.artistName  // 备份"妙妙"
    
    // 2️⃣ 计算状态（可能清空字段）
    let processed = orderStatusUtil.calculateOrderStatus(order)
    
    // 3️⃣ 恢复原始非空字段
    if (rawArtistName && !processed.artistName) {
      processed.artistName = rawArtistName  // ⚠️ 只有当 processed.artistName 为空时才恢复
    }
    
    // 4️⃣ 从商品表补充
    let product = products.find(p => String(p.id) === String(processed.productId))
    if (product) {
      if (!processed.artistName && product.artistName) {
        processed.artistName = product.artistName
      }
    }
    
    // 6️⃣ 强制恢复原值
    if (rawArtistName) {
      processed.artistName = rawArtistName  // ⚠️ 这里应该恢复"妙妙"
    }
    
    return processed
  })
}
```

**问题：**
1. 如果 `calculateOrderStatus()` 将 `artistName` 设置为某个非空值（例如空字符串 `""`），第3步的条件 `!processed.artistName` 就不成立
2. 第6步的强制恢复应该生效，但如果 `rawArtistName` 本身就是空的（例如旧订单保存时就没有画师信息），就无法恢复
3. 最终显示为空值或默认值"未知画师"

**可能的触发条件：**
- 旧订单在保存时，`artistName` 字段为空或未设置
- 或者 `calculateOrderStatus()` 错误地覆盖了 `artistName`

---

### 原因3：`order-helper.js` 的"强制恢复"逻辑导致"待分配"无法被修复

**代码位置：** `miniprogram/utils/order-helper.js` 第76-80行

```javascript
// 6️⃣ 最后再次确保不覆盖原值
if (rawServiceName) {
  processed.serviceName = rawServiceName  // ⚠️ 强制恢复"待分配"
}
```

**问题：**
1. 订单保存时 `serviceName = "待分配"`
2. 归一化时第5步尝试从客服表补充：
   ```javascript
   if (processed.serviceName === '待分配' && processed.serviceId && services.length > 0) {
     // 尝试匹配客服
   }
   ```
   但如果 `serviceId` 为空字符串，条件不成立，无法补充

3. 第6步强制恢复原值 `"待分配"`
4. 结果：**永远无法修复"待分配"状态**

---

## 🔧 修复方案

### 修复1：确保 `assignService()` 永远返回有效客服

**修改文件：** `miniprogram/pages/order-success/index.js`

**修改位置：** 第32-35行

```javascript
// 当前代码：
const service = this.assignService()
const serviceId = service?.serviceId || service?.id || ''
const serviceName = service?.serviceName || service?.name || '客服未分配'  // ❌
const serviceAvatar = service?.serviceAvatar || service?.avatar || DEFAULT_AVATAR_DATA

// 修改为：
const service = this.assignService()

// ⚠️ 如果客服分配失败，阻止下单
if (!service || !service.serviceId || !service.serviceName) {
  wx.showModal({
    title: '系统错误',
    content: '客服分配失败，请稍后再试',
    showCancel: false,
    complete: () => {
      wx.navigateBack()
    }
  })
  return
}

const serviceId = service.serviceId
const serviceName = service.serviceName
const serviceAvatar = service.serviceAvatar || DEFAULT_AVATAR_DATA
```

---

### 修复2：`order-helper.js` 不要强制恢复"待分配"

**修改文件：** `miniprogram/utils/order-helper.js`

**修改位置：** 第76-80行

```javascript
// 当前代码：
if (rawServiceName) {
  processed.serviceName = rawServiceName  // ❌ 恢复"待分配"
}
if (rawServiceAvatar) {
  processed.serviceAvatar = rawServiceAvatar
}

// 修改为：
if (rawServiceName && rawServiceName !== '待分配' && rawServiceName !== '客服未分配') {
  processed.serviceName = rawServiceName  // ✅ 不恢复错误值
}
if (rawServiceAvatar) {
  processed.serviceAvatar = rawServiceAvatar
}
```

---

### 修复3：增强客服补充逻辑

**修改文件：** `miniprogram/utils/order-helper.js`

**修改位置：** 第60-70行

```javascript
// 当前代码：
if ((!processed.serviceName || processed.serviceName === '待分配') && processed.serviceId && services.length > 0) {
  // 只有当 serviceId 存在时才尝试匹配
}

// 修改为：
if ((!processed.serviceName || processed.serviceName === '待分配' || processed.serviceName === '客服未分配') && services.length > 0) {
  // 优先通过 serviceId 匹配
  let matched = null
  if (processed.serviceId) {
    matched = services.find(s => 
      String(s.userId) === String(processed.serviceId) || 
      String(s.id) === String(processed.serviceId)
    )
  }
  
  // 如果没有 serviceId 或匹配失败，使用第一个在线客服
  if (!matched) {
    matched = services.find(s => s.isActive) || services[0]
  }
  
  if (matched) {
    processed.serviceId = matched.userId || matched.id
    processed.serviceName = matched.name || matched.nickName || '在线客服'
    if (!processed.serviceAvatar && (matched.avatar || matched.avatarUrl)) {
      processed.serviceAvatar = matched.avatar || matched.avatarUrl
    }
  }
}
```

---

### 修复4：修复旧订单数据（一次性脚本）

```javascript
// 在控制台运行
console.log('=== 修复旧订单数据 ===\n')

const orders = wx.getStorageSync('pending_orders') || []
const products = wx.getStorageSync('mock_products') || []
const services = wx.getStorageSync('customer_service_list') || []

let fixedCount = 0

orders.forEach(order => {
  let needUpdate = false
  
  // 修复客服信息
  if (!order.serviceName || order.serviceName === '待分配' || order.serviceName === '客服未分配') {
    if (services.length > 0) {
      const firstService = services.find(s => s.isActive) || services[0]
      order.serviceId = firstService.userId || firstService.id
      order.serviceName = firstService.name || firstService.nickName || '在线客服'
      order.serviceAvatar = firstService.avatar || firstService.avatarUrl || ''
      needUpdate = true
      console.log(`✅ 修复订单 ${order.id} 的客服: ${order.serviceName}`)
    }
  }
  
  // 修复画师信息
  if (!order.artistName || order.artistName === '画师' || order.artistName === '未知画师') {
    if (order.productId) {
      const product = products.find(p => p.id === order.productId)
      if (product && product.artistName) {
        order.artistId = product.artistId || ''
        order.artistName = product.artistName
        order.artistAvatar = product.artistAvatar || ''
        needUpdate = true
        console.log(`✅ 修复订单 ${order.id} 的画师: ${order.artistName}`)
      }
    }
  }
  
  if (needUpdate) fixedCount++
})

wx.setStorageSync('pending_orders', orders)
console.log(`\n✅ 修复完成！共修复 ${fixedCount} 个订单`)
console.log('🔄 请刷新订单列表页面')
```

---

## 📊 完整数据流向

```
下单阶段（order-success/index.js）
  ↓
1. 读取商品表 → artistName: "妙妙" ✅
2. 调用 assignService() → 返回客服信息
3. ⚠️ BUG：兜底逻辑错误 → serviceName: "待分配" ❌
  ↓
订单保存到 pending_orders
  {
    artistName: "妙妙",
    serviceName: "待分配",
    serviceId: ""  // ⚠️ 空字符串
  }
  ↓
订单列表加载（order-list/index.js）
  ↓
调用 orderHelper.prepareOrdersForPage()
  ↓
调用 normalizeOrders()
  ↓
1. 备份原始值
   rawArtistName = "妙妙"
   rawServiceName = "待分配"
  ↓
2. calculateOrderStatus() 可能修改字段
  ↓
3. 尝试恢复原始值（条件判断）
  ↓
4. 从商品表补充画师信息（如果为空）
  ↓
5. 从客服表补充客服信息
   ⚠️ 条件：serviceName === '待分配' && serviceId && services.length > 0
   ⚠️ 但 serviceId 是空字符串 ''，条件不成立 ❌
  ↓
6. ⚠️ 强制恢复原始值
   serviceName = "待分配"  // ❌ 永远无法修复
  ↓
显示结果：
  画师：妙妙 ✅
  客服：待分配 ❌
```

---

## ✅ 修复优先级

1. **高优先级**：修复 `order-success/index.js` 第32-35行，阻止保存"待分配"
2. **高优先级**：修复 `order-helper.js` 第76-80行，不恢复错误值
3. **中优先级**：增强 `order-helper.js` 客服补充逻辑
4. **低优先级**：运行一次性脚本修复旧订单

---

## 🎯 验证方法

修复后，执行以下测试：

1. **测试新订单**：
   - 下一个新订单
   - 检查订单列表，确保画师和客服都正确显示

2. **测试旧订单修复**：
   - 运行修复脚本
   - 刷新订单列表
   - 确认"待分配"和"未知画师"都已修复

3. **测试归一化逻辑**：
   - 在控制台运行调试脚本
   - 检查 `normalizeOrders()` 的输出
   - 确认不再强制恢复错误值

