<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>
  
  <view wx:else>
    <!-- 页面头部 -->
    <view class="page-header">
      <view class="header-left">
        <view class="back-btn" bindtap="goBack">
          <view class="back-icon"></view>
        </view>
        <text class="page-title">用户管理</text>
      </view>
      <view class="header-stats">
        <text class="stats-text">总用户：{{totalUsers}}</text>
      </view>
    </view>

    <!-- 搜索和筛选 -->
    <view class="search-section">
      <view class="search-bar">
        <view class="search-icon"></view>
        <input class="search-input" placeholder="搜索用户昵称/手机号/ID" bindinput="onSearch" value="{{searchKeyword}}" />
        <view wx:if="{{searchKeyword}}" class="clear-icon" bindtap="clearSearch">×</view>
      </view>
      
      <view class="filter-bar">
        <view class="filter-item {{statusFilter === 'all' ? 'active' : ''}}" data-filter="all" bindtap="filterByStatus">
          全部({{userStats.all}})
        </view>
        <view class="filter-item {{statusFilter === 'normal' ? 'active' : ''}}" data-filter="normal" bindtap="filterByStatus">
          正常({{userStats.normal}})
        </view>
        <view class="filter-item {{statusFilter === 'blocked' ? 'active' : ''}}" data-filter="blocked" bindtap="filterByStatus">
          已拉黑({{userStats.blocked}})
        </view>
      </view>
    </view>

    <!-- 用户列表 -->
    <view class="user-list">
      <view wx:for="{{users}}" wx:key="_id" class="user-item" bindtap="viewUserDetail" data-id="{{item._id}}">
        <image class="user-avatar" src="{{item.avatar}}" mode="aspectFill" />
        
        <view class="user-info">
          <view class="user-header">
            <text class="user-name">{{item.nickname}}</text>
            <view class="user-status status-{{item.status}}">
              {{item.status === 'normal' ? '正常' : item.status === 'blocked' ? '已拉黑' : '禁言'}}
            </view>
          </view>
          
          <view class="user-meta">
            <text class="meta-item">ID: {{item.userId}}</text>
            <text class="meta-item">手机: {{item.phone || '未绑定'}}</text>
          </view>
          
          <view class="user-stats">
            <view class="stat-item">
              <text class="stat-value">{{item.orderCount}}</text>
              <text class="stat-label">订单数</text>
            </view>
            <view class="stat-item">
              <text class="stat-value">¥{{item.totalAmount}}</text>
              <text class="stat-label">消费金额</text>
            </view>
            <view class="stat-item">
              <text class="stat-value">{{item.lastLoginTime}}</text>
              <text class="stat-label">最近登录</text>
            </view>
          </view>
          
          <view class="user-time">
            注册时间：{{item.registerTime}}
          </view>
        </view>
        
        <view class="user-actions" catchtap="stopPropagation">
          <button wx:if="{{item.status === 'normal'}}" class="action-btn danger" data-id="{{item._id}}" catchtap="blockUser">
            拉黑
          </button>
          <button wx:else class="action-btn success" data-id="{{item._id}}" catchtap="unblockUser">
            解封
          </button>
          <button class="action-btn" data-id="{{item._id}}" catchtap="editPhone">
            修改手机
          </button>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{users.length === 0}}" class="empty-state">
      <view class="empty-icon"></view>
      <text class="empty-text">{{searchKeyword ? '未找到相关用户' : '暂无用户'}}</text>
    </view>

    <!-- 加载更多 -->
    <view wx:if="{{hasMore && users.length > 0}}" class="load-more" bindtap="loadMore">
      <text>{{loadingMore ? '加载中...' : '加载更多'}}</text>
    </view>
  </view>

  <!-- 修改手机号弹窗 -->
  <view wx:if="{{showPhoneModal}}" class="modal-overlay" bindtap="closePhoneModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">修改手机号</text>
        <view class="modal-close" bindtap="closePhoneModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">当前手机号</text>
          <text class="form-value">{{currentUser.phone || '未绑定'}}</text>
        </view>
        
        <view class="form-item">
          <text class="form-label">新手机号 *</text>
          <input class="form-input" type="number" placeholder="请输入新手机号" value="{{newPhone}}" bindinput="onPhoneInput" maxlength="11" />
        </view>
        
        <view class="form-tip">
          <text class="tip-icon">!</text>
          <text class="tip-text">修改手机号需谨慎，请确认用户身份后再操作</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closePhoneModal">取消</button>
        <button class="modal-btn confirm" bindtap="savePhone">保存</button>
      </view>
    </view>
  </view>

  <!-- 用户详情弹窗 -->
  <view wx:if="{{showDetailModal}}" class="modal-overlay" bindtap="closeDetailModal">
    <view class="modal-content large" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">用户详情</text>
        <view class="modal-close" bindtap="closeDetailModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="detail-section">
          <view class="detail-header">
            <image class="detail-avatar" src="{{currentUser.avatar}}" mode="aspectFill" />
            <view class="detail-basic">
              <text class="detail-name">{{currentUser.nickname}}</text>
              <text class="detail-id">ID: {{currentUser.userId}}</text>
            </view>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">手机号</text>
            <text class="detail-value">{{currentUser.phone || '未绑定'}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">微信OpenID</text>
            <text class="detail-value">{{currentUser.openid}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">注册时间</text>
            <text class="detail-value">{{currentUser.registerTime}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">最近登录</text>
            <text class="detail-value">{{currentUser.lastLoginTime}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">订单数</text>
            <text class="detail-value">{{currentUser.orderCount}}单</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">累计消费</text>
            <text class="detail-value">¥{{currentUser.totalAmount}}</text>
          </view>
          
          <view class="detail-item">
            <text class="detail-label">账户状态</text>
            <view class="detail-status status-{{currentUser.status}}">
              {{currentUser.status === 'normal' ? '正常' : currentUser.status === 'blocked' ? '已拉黑' : '禁言'}}
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn" bindtap="viewUserOrders">查看订单</button>
        <button class="modal-btn confirm" bindtap="closeDetailModal">关闭</button>
      </view>
    </view>
  </view>
</view>

