<view class="order-detail-container">
  <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
  
  <view wx:else class="detail-content">
    <!-- è®¢å•æ ‡é¢˜å¡ç‰‡ -->
    <view class="order-header-card">
      <view class="order-title-row">
        <text class="order-title">è®¢å•è¯¦æƒ…</text>
        <view class="status-badge status-{{order.statusClass || order.status}}">
          {{order.statusText}}
        </view>
      </view>
      <view class="order-id-row">
        <text class="order-id-label">è®¢å•å·ï¼š{{order.id}}</text>
        <view class="copy-actions">
          <view class="copy-btn" bindtap="copyOrderNo" catchtap="copyOrderNo">
            <view class="copy-icon"></view>
          </view>
          <view class="copy-btn copy-group" bindtap="copyGroupName" catchtap="copyGroupName">
            <view class="group-icon"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- å¾…ç¡®è®¤æç¤ºå¡ç‰‡ -->
    <view wx:if="{{order.status === 'waitingConfirm'}}" class="waiting-confirm-hint">
      <view class="hint-icon">âœ“</view>
      <view class="hint-content">
        <view class="hint-title">ç”»å¸ˆå·²å®Œæˆåˆ¶ä½œ</view>
        <view class="hint-desc">è¯·å‰å¾€ç¾¤èŠæŸ¥çœ‹ä½œå“ï¼Œæ»¡æ„åç‚¹å‡»ä¸‹æ–¹"ç¡®è®¤å®Œæˆ"</view>
      </view>
    </view>
    
    <!-- è®¢å•è¿›åº¦æ¡ï¼ˆå¤ç”¨é€šç”¨ç»„ä»¶ï¼‰ -->
    <!-- ğŸ¯ ä¿®æ”¹ï¼šå·²å®Œæˆçš„è®¢å•ä¹Ÿæ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆå¦‚æœæœ‰è„±ç¨¿è®°å½•ï¼‰ -->
    <view wx:if="{{order.status !== 'completed' || order.wasOverdue}}" class="order-progress-section {{order.isOverdue ? 'overdue' : (order.isNearDeadline ? 'near-deadline' : '')}}">
      <view class="progress-header">
        <view class="progress-label">
          <text class="time-title">ä¸‹å•æ—¶é—´</text>
          <text class="time-value">{{order.createTime}}</text>
        </view>
        <view class="progress-label deadline-label {{order.isOverdue ? 'overdue' : ''}}">
          <text class="time-title">æˆªç¨¿æ—¶é—´</text>
          <text class="time-value">{{order.deadline}}</text>
        </view>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar-bg">
          <view class="progress-bar-fill" 
                style="width: {{order.progressPercent || 50}}%; background: {{order.statusColor || '#4CAF50'}};"></view>
        </view>
      </view>
      <!-- è„±ç¨¿å¤©æ•°æç¤º -->
      <view wx:if="{{order.isOverdue && order.overdueDays > 0}}" class="overdue-days-tip">
        å·²è„±ç¨¿ {{order.overdueDays}} å¤©
      </view>
    </view>

    <!-- å•†å“ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">å•†å“ä¿¡æ¯</view>
      
      <!-- ğŸ¯ å¤šå•†å“è®¢å•æ˜¾ç¤º -->
      <block wx:if="{{order.items && order.items.length > 0}}">
        <view wx:for="{{order.items}}" wx:key="index" class="product-detail {{index > 0 ? 'product-detail-border' : ''}}">
          <image class="product-image" src="{{item.productImage}}" mode="aspectFill"/>
          <view class="product-info">
            <text class="product-name">{{item.productName}}</text>
            <text wx:if="{{item.specText}}" class="product-spec">{{item.specText}}</text>
            <view class="product-price-row">
              <text class="price-label">æ•°é‡ï¼š</text>
              <text class="price-value-small">Ã—{{item.quantity}}</text>
              <text class="price-label" style="margin-left: 20rpx;">é‡‘é¢ï¼š</text>
              <text class="price-symbol">Â¥</text>
              <text class="price-value">{{item.totalPrice || item.price}}</text>
            </view>
          </view>
        </view>
        <!-- æ€»è®¡ -->
        <view class="order-total-row">
          <text class="total-label">è®¢å•æ€»è®¡</text>
          <view class="total-price">
            <text class="price-symbol">Â¥</text>
            <text class="price-value">{{order.totalAmount || order.price}}</text>
          </view>
        </view>
      </block>
      
      <!-- å•å•†å“è®¢å•æ˜¾ç¤ºï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰ -->
      <view wx:else class="product-detail">
        <image class="product-image" src="{{order.productImage}}" mode="aspectFill"/>
        <view class="product-info">
          <text class="product-name">{{order.productName}}</text>
          <text class="product-spec">è§„æ ¼ï¼š{{order.spec}}</text>
          <view class="product-price-row">
            <text class="price-label">é‡‘é¢ï¼š</text>
            <text class="price-symbol">Â¥</text>
            <text class="price-value">{{order.price}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-title">æ—¶é—´ä¿¡æ¯</view>
      <view class="info-row">
        <text class="info-label">ä¸‹å•æ—¶é—´</text>
        <text class="info-value">{{order.createTime}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">æˆªç¨¿æ—¶é—´</text>
        <text class="info-value {{order.urgent ? 'urgent' : ''}}">{{order.deadline}}</text>
      </view>
      <view wx:if="{{order.completedTime}}" class="info-row">
        <text class="info-label">å®Œæˆæ—¶é—´</text>
        <text class="info-value">{{order.completedTime}}</text>
      </view>
    </view>

    <!-- å®¢æˆ·ä¿¡æ¯ï¼ˆç”»å¸ˆè§†è§’ï¼‰ -->
    <view wx:if="{{userRole === 'artist'}}" class="section-card people-card">
      <view class="section-title">å®¢æˆ·ä¿¡æ¯</view>
      <view class="people-info">
        <image class="people-avatar" src="{{order.buyerAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
        <view class="people-detail">
          <text class="people-name">{{order.buyerName || 'åŒ¿åç”¨æˆ·'}}</text>
          <text class="people-label">å®¢æˆ·</text>
        </view>
      </view>
    </view>

    <!-- å®¢æœä¿¡æ¯ï¼ˆç”»å¸ˆè§†è§’ï¼‰ -->
    <view wx:if="{{userRole === 'artist'}}" class="section-card people-card">
      <view class="section-title">å¯¹æ¥å®¢æœ</view>
      <view class="people-info">
        <image class="people-avatar" src="{{order.serviceAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
        <view class="people-detail">
          <text class="people-name">{{order.serviceName || 'å¾…åˆ†é…'}}</text>
          <text class="people-label">å®¢æœ</text>
        </view>
      </view>
    </view>

    <!-- ç”»å¸ˆä¿¡æ¯ï¼ˆä¹°å®¶å¯è§ï¼‰ -->
    <view wx:if="{{userRole === 'customer'}}" class="section-card people-card">
      <view class="section-title">ç”»å¸ˆä¿¡æ¯</view>
      <view class="people-info">
        <image class="people-avatar" src="{{order.artistAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
        <view class="people-detail">
          <text class="people-name">{{order.artistName}}</text>
          <text class="people-label">ç”»å¸ˆ</text>
        </view>
      </view>
    </view>

    <!-- å®¢æœäºŒç»´ç ï¼ˆä¹°å®¶å¯è§ï¼‰ -->
    <view wx:if="{{userRole === 'customer'}}" class="section-card qr-section">
      <view class="section-title">è”ç³»å®¢æœ{{order.serviceName ? ' - ' + order.serviceName : ''}}</view>
      <view class="qr-container">
        <image 
          wx:if="{{order.serviceQRCode}}"
          class="qr-image" 
          src="{{order.serviceQRCode}}" 
          mode="aspectFit"
        />
        <view wx:else class="qr-placeholder">
          <text class="placeholder-text">å®¢æœäºŒç»´ç åŠ è½½ä¸­...</text>
          <text class="placeholder-hint">è¯·ç¨ååˆ·æ–°é¡µé¢</text>
        </view>
        <text class="qr-hint">é•¿æŒ‰è¯†åˆ«äºŒç»´ç æ·»åŠ å®¢æœå¾®ä¿¡</text>
        <text class="qr-desc">å®¢æœä¼šä¸æ‚¨è¿›ä¸€æ­¥æ²Ÿé€šç»˜ç”»è¦æ±‚</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’®åŒº -->
    <view class="action-buttons">
      <!-- ç”»å¸ˆæ“ä½œ -->
      <view wx:if="{{userRole === 'artist'}}" class="button-group">
        <button wx:if="{{order.status !== 'completed' && order.status !== 'waitingConfirm'}}" class="btn-primary btn-full" bindtap="markComplete">
          æ ‡è®°å·²å®Œæˆ
        </button>
        <view wx:elif="{{order.status === 'waitingConfirm'}}" class="completion-tip">
          <text class="tip-icon">âœ“</text>
          <text class="tip-text">å·²æ ‡è®°å®Œæˆï¼Œç­‰å¾…å®¢æˆ·ç¡®è®¤</text>
        </view>
      </view>
      
      <!-- ä¹°å®¶æ“ä½œ -->
      <view wx:if="{{userRole === 'customer'}}" class="button-group">
        <!-- ğŸ¯ é€€æ¬¾ç”³è¯·ä¸­çŠ¶æ€ -->
        <block wx:if="{{order.refundStatus === 'requesting'}}">
          <view class="refund-requesting-tip">
            <text class="refund-icon">â³</text>
            <text class="refund-text">é€€æ¬¾ç”³è¯·å·²æäº¤ï¼Œå®¢æœæ­£åœ¨å¤„ç†ä¸­...</text>
          </view>
        </block>
        <!-- ğŸ¯ ä¿®å¤ï¼šç§»é™¤ç”¨æˆ·ç«¯"ç”³è¯·é€€æ¬¾"æŒ‰é’®ï¼Œåªä¿ç•™è”ç³»å®¢æœå’Œç¡®è®¤å®Œæˆ -->
        <!-- è¿›è¡Œä¸­/å¾…ç¡®è®¤çŠ¶æ€ -->
        <block wx:elif="{{order.status === 'inProgress' || order.status === 'processing' || order.status === 'overdue' || order.status === 'nearDeadline' || order.status === 'waitingConfirm'}}">
          <button class="action-btn default" bindtap="contactService">è”ç³»å®¢æœ</button>
          <button wx:if="{{order.refundStatus !== 'requesting' && order.refundStatus !== 'refunding' && order.refundStatus !== 'refunded'}}" class="action-btn danger" bindtap="requestRefund">ç”³è¯·é€€æ¬¾</button>
          <button class="action-btn primary" bindtap="confirmComplete">ç¡®è®¤å®Œæˆ</button>
        </block>
        <!-- å·²å®ŒæˆçŠ¶æ€ -->
        <block wx:elif="{{order.status === 'completed'}}">
          <view class="completed-actions">
            <button wx:if="{{order.hasBuyerShow}}" class="action-btn default" bindtap="viewBuyerShow">æŸ¥çœ‹æ™’ç¨¿</button>
            <button wx:elif="{{canPublishBuyerShow}}" class="action-btn primary" bindtap="openBuyerShowPublish">æ™’ç¨¿</button>
            <text class="completed-text">è®¢å•å·²å®Œæˆ</text>
          </view>
        </block>
      </view>
    </view>
  </view>
</view>

<!-- å®¢æœäºŒç»´ç å¼¹çª— -->
<view wx:if="{{showServiceQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">è”ç³»å®¢æœ</text>
      <view class="qr-modal-close" catchtap="hideQRModal">âœ•</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{serviceQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">é•¿æŒ‰è¯†åˆ«äºŒç»´ç æ·»åŠ å®¢æœå¾®ä¿¡</text>
    </view>
  </view>
</view>

<!-- æŠ•è¯‰äºŒç»´ç å¼¹çª— -->
<view wx:if="{{showComplaintQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">æŠ•è¯‰é€šé“</text>
      <view class="qr-modal-close" catchtap="hideQRModal">âœ•</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{complaintQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">é•¿æŒ‰è¯†åˆ«äºŒç»´ç è”ç³»æŠ•è¯‰ä¸“å‘˜</text>
      <text class="qr-modal-desc">æˆ‘ä»¬ä¼šè®¤çœŸå¤„ç†æ¯ä¸€æ¡æŠ•è¯‰</text>
    </view>
  </view>
</view>
