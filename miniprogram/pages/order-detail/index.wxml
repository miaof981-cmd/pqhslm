<view class="order-detail-container">
  <view wx:if="{{loading}}" class="loading">加载中...</view>
  
  <view wx:else class="detail-content">
    <!-- 订单标题卡片 -->
    <view class="order-header-card">
      <view class="order-title-row">
        <text class="order-title">订单详情</text>
        <view class="status-badge status-{{order.statusClass || order.status}}">
          {{order.statusText}}
        </view>
      </view>
      <view class="order-id-row">
        <text class="order-id-label">订单号：{{order.id}}</text>
        <view class="copy-actions">
          <view class="copy-btn" bindtap="copyOrderNo" catchtap="copyOrderNo">
            <view class="copy-icon"></view>
          </view>
          <view class="copy-btn copy-group" bindtap="copyGroupName" catchtap="copyGroupName">
            <view class="group-icon"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- 待确认提示卡片 -->
    <view wx:if="{{order.status === 'waitingConfirm'}}" class="waiting-confirm-hint">
      <view class="hint-icon">✓</view>
      <view class="hint-content">
        <view class="hint-title">画师已完成制作</view>
        <view class="hint-desc">请前往群聊查看作品，满意后点击下方"确认完成"</view>
      </view>
    </view>
    
    <!-- 订单进度条（复用通用组件） -->
    <!-- 🎯 修改：已完成的订单也显示进度条（如果有脱稿记录） -->
    <view wx:if="{{order.status !== 'completed' || order.wasOverdue}}" class="order-progress-section {{order.isOverdue ? 'overdue' : (order.isNearDeadline ? 'near-deadline' : '')}}">
      <view class="progress-header">
        <view class="progress-label">
          <text class="time-title">下单时间</text>
          <text class="time-value">{{order.createTime}}</text>
        </view>
        <view class="progress-label deadline-label {{order.isOverdue ? 'overdue' : ''}}">
          <text class="time-title">截稿时间</text>
          <text class="time-value">{{order.deadline}}</text>
        </view>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar-bg">
          <view class="progress-bar-fill" 
                style="width: {{order.progressPercent || 50}}%; background: {{order.statusColor || '#4CAF50'}};"></view>
        </view>
      </view>
      <!-- 脱稿天数提示 -->
      <view wx:if="{{order.isOverdue && order.overdueDays > 0}}" class="overdue-days-tip">
        已脱稿 {{order.overdueDays}} 天
      </view>
    </view>

    <!-- 商品信息 -->
    <view class="section-card">
      <view class="section-title">商品信息</view>
      <view class="product-detail">
        <image class="product-image" src="{{order.productImage}}" mode="aspectFill"/>
        <view class="product-info">
          <text class="product-name">{{order.productName}}</text>
          <text class="product-spec">规格：{{order.spec}}</text>
          <view class="product-price-row">
            <text class="price-label">金额：</text>
            <text class="price-symbol">¥</text>
            <text class="price-value">{{order.price}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 时间信息 -->
    <view class="section-card">
      <view class="section-title">时间信息</view>
      <view class="info-row">
        <text class="info-label">下单时间</text>
        <text class="info-value">{{order.createTime}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">截稿时间</text>
        <text class="info-value {{order.urgent ? 'urgent' : ''}}">{{order.deadline}}</text>
      </view>
      <view wx:if="{{order.completedTime}}" class="info-row">
        <text class="info-label">完成时间</text>
        <text class="info-value">{{order.completedTime}}</text>
      </view>
    </view>

    <!-- 客户信息（画师视角） -->
    <view wx:if="{{userRole === 'artist'}}" class="section-card people-card">
      <view class="section-title">客户信息</view>
      <view class="people-info">
        <image class="people-avatar" src="{{order.buyerAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
        <view class="people-detail">
          <text class="people-name">{{order.buyerName || '匿名用户'}}</text>
          <text class="people-label">客户</text>
        </view>
      </view>
    </view>

    <!-- 客服信息（画师视角） -->
    <view wx:if="{{userRole === 'artist'}}" class="section-card people-card">
      <view class="section-title">对接客服</view>
      <view class="people-info">
        <image class="people-avatar" src="{{order.serviceAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
        <view class="people-detail">
          <text class="people-name">{{order.serviceName || '待分配'}}</text>
          <text class="people-label">客服</text>
        </view>
      </view>
    </view>

    <!-- 画师信息（买家可见） -->
    <view wx:if="{{userRole === 'customer'}}" class="section-card people-card">
      <view class="section-title">画师信息</view>
      <view class="people-info">
        <image class="people-avatar" src="{{order.artistAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
        <view class="people-detail">
          <text class="people-name">{{order.artistName}}</text>
          <text class="people-label">画师</text>
        </view>
      </view>
    </view>

    <!-- 客服二维码（买家可见） -->
    <view wx:if="{{userRole === 'customer'}}" class="section-card qr-section">
      <view class="section-title">联系客服{{order.serviceName ? ' - ' + order.serviceName : ''}}</view>
      <view class="qr-container">
        <image 
          wx:if="{{order.serviceQRCode}}"
          class="qr-image" 
          src="{{order.serviceQRCode}}" 
          mode="aspectFit"
        />
        <view wx:else class="qr-placeholder">
          <text class="placeholder-text">客服二维码加载中...</text>
          <text class="placeholder-hint">请稍后刷新页面</text>
        </view>
        <text class="qr-hint">长按识别二维码添加客服微信</text>
        <text class="qr-desc">客服会与您进一步沟通绘画要求</text>
      </view>
    </view>

    <!-- 打赏区域 -->
    <view wx:if="{{userRole === 'customer' && order.status === 'completed'}}" class="reward-card">
      <view class="reward-header">
        <view class="reward-icon"></view>
        <text class="reward-title">对作品满意？给画师打赏吧~</text>
      </view>
      <view class="reward-amounts">
        <view wx:for="{{rewardOptions}}" wx:key="*this" 
              class="reward-option {{selectedReward === item ? 'selected' : ''}}"
              bindtap="selectReward"
              data-amount="{{item}}">
          ¥{{item}}
        </view>
        <view class="reward-option custom" bindtap="showCustomReward">
          自定义
        </view>
      </view>
      <button class="reward-btn" bindtap="confirmReward" disabled="{{!selectedReward}}">
        确认打赏
      </button>
    </view>

    <!-- 操作按钮区 -->
    <view class="action-buttons">
      <!-- 画师操作 -->
      <view wx:if="{{userRole === 'artist'}}" class="button-group">
        <button wx:if="{{order.status !== 'completed' && order.status !== 'waitingConfirm'}}" class="btn-primary btn-full" bindtap="markComplete">
          标记已完成
        </button>
        <view wx:elif="{{order.status === 'waitingConfirm'}}" class="completion-tip">
          <text class="tip-icon">✓</text>
          <text class="tip-text">已标记完成，等待客户确认</text>
        </view>
      </view>
      
      <!-- 买家操作 -->
      <view wx:if="{{userRole === 'customer'}}" class="button-group">
        <!-- 进行中/待确认状态 -->
        <block wx:if="{{order.status === 'inProgress' || order.status === 'processing' || order.status === 'overdue' || order.status === 'nearDeadline' || order.status === 'waitingConfirm'}}">
          <button class="action-btn default" bindtap="contactService">联系客服</button>
          <button class="action-btn default" bindtap="showComplaint">投诉</button>
          <button class="action-btn primary" bindtap="confirmComplete">确认完成</button>
        </block>
        <!-- 已完成状态 -->
        <block wx:elif="{{order.status === 'completed'}}">
          <view class="completed-actions">
            <button wx:if="{{order.hasBuyerShow}}" class="action-btn default" bindtap="viewBuyerShow">查看晒稿</button>
            <button wx:elif="{{canPublishBuyerShow}}" class="action-btn primary" bindtap="openBuyerShowPublish">晒稿</button>
            <text class="completed-text">订单已完成</text>
          </view>
        </block>
      </view>
    </view>
  </view>
</view>

<!-- 客服二维码弹窗 -->
<view wx:if="{{showServiceQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">联系客服</text>
      <view class="qr-modal-close" catchtap="hideQRModal">✕</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{serviceQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">长按识别二维码添加客服微信</text>
    </view>
  </view>
</view>

<!-- 投诉二维码弹窗 -->
<view wx:if="{{showComplaintQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">投诉通道</text>
      <view class="qr-modal-close" catchtap="hideQRModal">✕</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{complaintQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">长按识别二维码联系投诉专员</text>
      <text class="qr-modal-desc">我们会认真处理每一条投诉</text>
    </view>
  </view>
</view>
