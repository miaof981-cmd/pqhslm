<view class="container">
  <!-- 顶部Tab栏 -->
  <view class="tab-bar">
    <view wx:for="{{tabs}}" wx:key="value"
          class="tab-item {{currentTab === item.value ? 'active' : ''}}"
          data-tab="{{item.value}}"
          bindtap="switchTab">
      <text class="tab-text">{{item.label}}</text>
      <text wx:if="{{item.count > 0}}" class="tab-badge">{{item.count}}</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <!-- 订单列表 -->
  <view wx:elif="{{orders.length > 0}}" class="order-list">
    <view wx:for="{{orders}}" wx:key="_id" class="order-item">
      <!-- 订单头部 -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-no">订单号：{{item.orderNo}}</text>
          <text class="order-time">{{item.createTime}}</text>
        </view>
        <view class="order-status status-{{item.status}}">
          {{item.statusText}}
        </view>
      </view>

      <!-- 商品信息 -->
      <view class="order-content" bindtap="viewOrder" data-id="{{item._id}}">
        <view class="product-image-wrapper">
          <image 
            wx:if="{{item.productImage}}"
            class="product-image" 
            src="{{item.productImage}}" 
            mode="aspectFill"
            binderror="onImageError"
            data-id="{{item._id}}"
          />
          <view wx:else class="product-image-placeholder">
            <text class="placeholder-text">暂无图片</text>
          </view>
        </view>
        <view class="product-info">
          <text class="product-name">{{item.productName}}</text>
          <view class="product-meta">
            <text class="product-delivery">{{item.deliveryDays}}天出稿</text>
            <text class="product-price">¥{{item.amount}}</text>
          </view>
        </view>
      </view>

      <!-- 订单进度条 -->
      <view wx:if="{{item.status === 'processing' || item.status === 'inProgress' || item.status === 'overdue' || item.status === 'nearDeadline'}}" class="order-progress-section {{item.isOverdue ? 'overdue' : (item.isNearDeadline ? 'near-deadline' : '')}}">
        <view class="progress-header">
          <view class="progress-label">
            <text class="time-title">下单时间</text>
            <text class="time-value">{{item.createTime}}</text>
          </view>
          <view class="progress-label deadline-label {{item.isOverdue ? 'overdue' : ''}}">
            <text class="time-title">截稿时间</text>
            <text class="time-value">{{item.deadline}}</text>
          </view>
        </view>
        <view class="progress-bar-container">
          <view class="progress-bar-bg {{item.isOverdue ? 'overdue' : (item.isNearDeadline ? 'near-deadline' : '')}}">
            <view class="progress-bar-fill {{item.isOverdue ? 'overdue' : (item.isNearDeadline ? 'near-deadline' : '')}}" 
                  style="width: {{item.progressPercent || 50}}%;"></view>
          </view>
        </view>
      </view>

      <!-- 人员信息区（画师、客服） -->
      <view class="order-people-row">
        <view class="people-item">
          <text class="people-label">画师</text>
          <image class="people-avatar-small" src="{{item.artistAvatar}}" mode="aspectFill"/>
          <text class="people-name-compact">{{item.artistName}}</text>
        </view>
        <view class="people-divider-compact"></view>
        <view class="people-item">
          <text class="people-label">客服</text>
          <image class="people-avatar-small" src="{{item.serviceAvatar}}" mode="aspectFill"/>
          <text class="people-name-compact">{{item.serviceName}}</text>
        </view>
      </view>

      <!-- 订单操作 -->
      <view class="order-actions">
        <!-- 未支付 -->
        <block wx:if="{{item.status === 'unpaid'}}">
          <button class="action-btn default" bindtap="cancelOrder" data-id="{{item._id}}">取消订单</button>
          <button class="action-btn primary" bindtap="payOrder" data-id="{{item._id}}">立即支付</button>
        </block>

        <!-- 已支付/制作中（包括所有进行中的状态） -->
        <!-- 🎯 逻辑调整：单主任何时候都可以确认完成，不需要等待画师标记 -->
        <block wx:elif="{{item.status === 'paid' || item.status === 'processing' || item.status === 'inProgress' || item.status === 'overdue' || item.status === 'nearDeadline'}}">
          <button class="action-btn default" bindtap="contactService" data-id="{{item._id}}">联系客服</button>
          <button class="action-btn default" bindtap="showComplaint" data-id="{{item._id}}">投诉</button>
          <button class="action-btn primary" bindtap="confirmComplete" data-id="{{item._id}}">确认完成</button>
        </block>

        <!-- 待确认（画师已完成，等待买家确认） -->
        <!-- 🌟 鎏金高亮效果：画师标记完成后，引导单主确认 -->
        <block wx:elif="{{item.status === 'waitingConfirm'}}">
          <button class="action-btn default" bindtap="contactService" data-id="{{item._id}}">联系客服</button>
          <button class="action-btn primary btn-confirm-glow" bindtap="confirmComplete" data-id="{{item._id}}">确认完成</button>
        </block>

        <!-- 已完成 -->
        <block wx:elif="{{item.status === 'completed'}}">
          <button class="action-btn default" bindtap="deleteOrder" data-id="{{item._id}}">删除订单</button>
          <button wx:if="{{!item.reviewed}}" class="action-btn primary" bindtap="reviewOrder" data-id="{{item._id}}">评价</button>
          <button wx:else class="action-btn default" bindtap="viewReview" data-id="{{item._id}}">查看评价</button>
        </block>

        <!-- 已取消/已退款 -->
        <block wx:elif="{{item.status === 'cancelled' || item.status === 'refunded'}}">
          <button class="action-btn default" bindtap="deleteOrder" data-id="{{item._id}}">删除订单</button>
          <button wx:if="{{item.status === 'cancelled'}}" class="action-btn primary" bindtap="buyAgain" data-id="{{item.productId}}">再次购买</button>
        </block>

        <!-- 退款中 -->
        <block wx:elif="{{item.status === 'refunding'}}">
          <button class="action-btn default" bindtap="viewRefund" data-id="{{item._id}}">查看退款进度</button>
        </block>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:else class="empty-state">
    <view class="empty-icon"></view>
    <text class="empty-text">{{emptyText}}</text>
    <button wx:if="{{currentTab === 'all'}}" class="go-shopping-btn" bindtap="goShopping">去逛逛</button>
  </view>
</view>

<!-- 客服二维码弹窗 -->
<view wx:if="{{showServiceQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">联系客服</text>
      <view class="qr-modal-close" catchtap="hideQRModal">✕</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{serviceQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">长按识别二维码添加客服微信</text>
    </view>
  </view>
</view>

<!-- 投诉二维码弹窗 -->
<view wx:if="{{showComplaintQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">投诉通道</text>
      <view class="qr-modal-close" catchtap="hideQRModal">✕</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{complaintQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">长按识别二维码联系投诉专员</text>
      <text class="qr-modal-desc">我们会认真处理每一条投诉</text>
    </view>
  </view>
</view>
