<view class="container">
  <!-- é¡¶éƒ¨Tabæ  -->
  <view class="tab-bar">
    <view wx:for="{{tabs}}" wx:key="value"
          class="tab-item {{currentTab === item.value ? 'active' : ''}}"
          data-tab="{{item.value}}"
          bindtap="switchTab">
      <text class="tab-text">{{item.label}}</text>
      <text wx:if="{{item.count > 0}}" class="tab-badge">{{item.count}}</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view wx:elif="{{orders.length > 0}}" class="order-list">
    <view wx:for="{{orders}}" wx:key="_id" class="order-item">
      <!-- è®¢å•å¤´éƒ¨ -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-no">è®¢å•å·ï¼š{{item.orderNo}}</text>
          <text class="order-time">{{item.createTime}}</text>
        </view>
        <view class="order-status status-{{item.status}}">
          {{item.statusText}}
        </view>
      </view>

      <!-- å•†å“ä¿¡æ¯ -->
      <view class="order-content" bindtap="viewOrder" data-id="{{item._id}}">
        <view class="product-image-wrapper">
          <image 
            wx:if="{{item.productImage}}"
            class="product-image" 
            src="{{item.productImage}}" 
            mode="aspectFill"
            binderror="onImageError"
            data-id="{{item._id}}"
          />
          <view wx:else class="product-image-placeholder">
            <text class="placeholder-text">æš‚æ— å›¾ç‰‡</text>
          </view>
        </view>
        <view class="product-info">
          <text class="product-name">{{item.productName}}</text>
          <view class="product-meta">
            <text class="product-delivery">{{item.deliveryDays}}å¤©å‡ºç¨¿</text>
            <text class="product-price">Â¥{{item.amount}}</text>
          </view>
        </view>
      </view>

      <!-- è®¢å•è¿›åº¦æ¡ -->
      <view wx:if="{{item.status === 'processing' || item.status === 'inProgress' || item.status === 'overdue' || item.status === 'nearDeadline'}}" class="order-progress-section {{item.isOverdue ? 'overdue' : (item.isNearDeadline ? 'near-deadline' : '')}}">
        <view class="progress-header">
          <view class="progress-label">
            <text class="time-title">ä¸‹å•æ—¶é—´</text>
            <text class="time-value">{{item.createTime}}</text>
          </view>
          <view class="progress-label deadline-label {{item.isOverdue ? 'overdue' : ''}}">
            <text class="time-title">æˆªç¨¿æ—¶é—´</text>
            <text class="time-value">{{item.deadline}}</text>
          </view>
        </view>
        <view class="progress-bar-container">
          <view class="progress-bar-bg">
            <view class="progress-bar-fill" 
                  style="width: {{item.progressPercent || 50}}%; background: {{item.statusColor || '#4CAF50'}};"></view>
          </view>
        </view>
      </view>

      <!-- å¾…ç¡®è®¤æç¤ºå¡ç‰‡ï¼ˆä»£æ›¿è¿›åº¦æ¡åŒºåŸŸï¼‰ -->
      <view wx:if="{{item.status === 'waitingConfirm'}}" class="order-waiting-hint">
        <view class="waiting-hint-icon">âœ“</view>
        <view class="waiting-hint-content">
          <view class="waiting-hint-title">ç”»å¸ˆå·²å®Œæˆåˆ¶ä½œ</view>
          <view class="waiting-hint-desc">è¯·å‰å¾€ç¾¤èŠæŸ¥çœ‹ä½œå“ï¼Œæ»¡æ„åç‚¹å‡»ä¸‹æ–¹"ç¡®è®¤å®Œæˆ"</view>
        </view>
      </view>

      <!-- äººå‘˜ä¿¡æ¯åŒºï¼ˆç”»å¸ˆã€å®¢æœï¼‰ -->
      <view class="order-people-row">
        <view class="people-item">
          <text class="people-label">ç”»å¸ˆ</text>
          <image class="people-avatar-small" src="{{item.artistAvatar || DEFAULT_AVATAR_DATA}}" mode="aspectFill" binderror="onArtistImgErr" data-index="{{index}}"/>
          <text class="people-name-compact">{{item.artistName}}</text>
        </view>
        <view class="people-divider-compact"></view>
        <view class="people-item">
          <text class="people-label">å®¢æœ</text>
          <image class="people-avatar-small" src="{{item.serviceAvatar || DEFAULT_AVATAR_DATA}}" mode="aspectFill" binderror="onServiceImgErr" data-index="{{index}}"/>
          <text class="people-name-compact">{{item.serviceName}}</text>
        </view>
      </view>

      <!-- è®¢å•æ“ä½œ -->
      <view class="order-actions">
        <!-- æœªæ”¯ä»˜ -->
        <block wx:if="{{item.status === 'unpaid'}}">
          <button class="action-btn default" bindtap="cancelOrder" data-id="{{item._id}}">å–æ¶ˆè®¢å•</button>
          <button class="action-btn primary" bindtap="payOrder" data-id="{{item._id}}">ç«‹å³æ”¯ä»˜</button>
        </block>

        <!-- å·²æ”¯ä»˜/åˆ¶ä½œä¸­ï¼ˆåŒ…æ‹¬æ‰€æœ‰è¿›è¡Œä¸­çš„çŠ¶æ€ï¼‰ -->
        <!-- ğŸ¯ é€»è¾‘è°ƒæ•´ï¼šå•ä¸»ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ç¡®è®¤å®Œæˆï¼Œä¸éœ€è¦ç­‰å¾…ç”»å¸ˆæ ‡è®° -->
        <block wx:elif="{{item.status === 'paid' || item.status === 'processing' || item.status === 'inProgress' || item.status === 'overdue' || item.status === 'nearDeadline'}}">
          <button class="action-btn default" bindtap="contactService" data-id="{{item._id}}">è”ç³»å®¢æœ</button>
          <button class="action-btn default" bindtap="showComplaint" data-id="{{item._id}}">æŠ•è¯‰</button>
          <button class="action-btn primary" bindtap="confirmComplete" data-id="{{item._id}}">ç¡®è®¤å®Œæˆ</button>
        </block>

        <!-- å¾…ç¡®è®¤ï¼ˆç”»å¸ˆå·²å®Œæˆï¼Œç­‰å¾…ä¹°å®¶ç¡®è®¤ï¼‰ -->
        <!-- ğŸŒŸ æµå…‰ç‰¹æ•ˆï¼šç”»å¸ˆæ ‡è®°å®Œæˆåï¼Œå¼•å¯¼å•ä¸»ç¡®è®¤ -->
        <!-- âš ï¸ é‡è¦ï¼šæŠ•è¯‰æŒ‰é’®å§‹ç»ˆä¿ç•™ï¼Œæ­¤æ—¶æœ€å®¹æ˜“äº§ç”Ÿçº çº· -->
        <block wx:elif="{{item.status === 'waitingConfirm'}}">
          <button class="action-btn default" bindtap="contactService" data-id="{{item._id}}">è”ç³»å®¢æœ</button>
          <button class="action-btn default" bindtap="showComplaint" data-id="{{item._id}}">æŠ•è¯‰</button>
          <button class="action-btn primary btn-with-glow" bindtap="confirmComplete" data-id="{{item._id}}">ç¡®è®¤å®Œæˆ</button>
        </block>

        <!-- å·²å®Œæˆ -->
        <block wx:elif="{{item.status === 'completed'}}">
          <button class="action-btn default" bindtap="deleteOrder" data-id="{{item._id}}">åˆ é™¤è®¢å•</button>
          <button wx:if="{{!item.reviewed}}" class="action-btn primary" bindtap="reviewOrder" data-id="{{item._id}}">è¯„ä»·</button>
          <button wx:else class="action-btn default" bindtap="viewReview" data-id="{{item._id}}">æŸ¥çœ‹è¯„ä»·</button>
        </block>

        <!-- å·²å–æ¶ˆ/å·²é€€æ¬¾ -->
        <block wx:elif="{{item.status === 'cancelled' || item.status === 'refunded'}}">
          <button class="action-btn default" bindtap="deleteOrder" data-id="{{item._id}}">åˆ é™¤è®¢å•</button>
          <button wx:if="{{item.status === 'cancelled'}}" class="action-btn primary" bindtap="buyAgain" data-id="{{item.productId}}">å†æ¬¡è´­ä¹°</button>
        </block>

        <!-- é€€æ¬¾ä¸­ -->
        <block wx:elif="{{item.status === 'refunding'}}">
          <button class="action-btn default" bindtap="viewRefund" data-id="{{item._id}}">æŸ¥çœ‹é€€æ¬¾è¿›åº¦</button>
        </block>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else class="empty-state">
    <view class="empty-icon"></view>
    <text class="empty-text">{{emptyText}}</text>
    <button wx:if="{{currentTab === 'all'}}" class="go-shopping-btn" bindtap="goShopping">å»é€›é€›</button>
  </view>
</view>

<!-- å®¢æœäºŒç»´ç å¼¹çª— -->
<view wx:if="{{showServiceQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">è”ç³»å®¢æœ</text>
      <view class="qr-modal-close" catchtap="hideQRModal">âœ•</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{serviceQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">é•¿æŒ‰è¯†åˆ«äºŒç»´ç æ·»åŠ å®¢æœå¾®ä¿¡</text>
    </view>
  </view>
</view>

<!-- æŠ•è¯‰äºŒç»´ç å¼¹çª— -->
<view wx:if="{{showComplaintQR}}" class="qr-modal" bindtap="hideQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">æŠ•è¯‰é€šé“</text>
      <view class="qr-modal-close" catchtap="hideQRModal">âœ•</view>
    </view>
    <view class="qr-modal-body">
      <image class="qr-modal-image" src="{{complaintQRCode}}" mode="aspectFit"/>
      <text class="qr-modal-hint">é•¿æŒ‰è¯†åˆ«äºŒç»´ç è”ç³»æŠ•è¯‰ä¸“å‘˜</text>
      <text class="qr-modal-desc">æˆ‘ä»¬ä¼šè®¤çœŸå¤„ç†æ¯ä¸€æ¡æŠ•è¯‰</text>
    </view>
  </view>
</view>
