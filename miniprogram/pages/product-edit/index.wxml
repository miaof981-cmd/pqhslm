<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <view wx:else class="wizard-container">
    <!-- 步骤导航栏 -->
    <view class="step-nav">
      <view class="step-item {{currentStep >= 1 ? 'active' : ''}}" bindtap="goToStep" data-step="1">
        <view class="step-number">1</view>
        <text class="step-label">基础信息</text>
      </view>
      <view class="step-line {{currentStep >= 2 ? 'active' : ''}}"></view>
      <view class="step-item {{currentStep >= 2 ? 'active' : ''}}" bindtap="goToStep" data-step="2">
        <view class="step-number">2</view>
        <text class="step-label">规格定价</text>
      </view>
      <view class="step-line {{currentStep >= 3 ? 'active' : ''}}"></view>
      <view class="step-item {{currentStep >= 3 ? 'active' : ''}}" bindtap="goToStep" data-step="3">
        <view class="step-number">3</view>
        <text class="step-label">详情发布</text>
      </view>
    </view>

    <!-- 进度条 -->
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}%"></view>
    </view>

    <!-- 第一步：基础信息 -->
    <view wx:if="{{currentStep === 1}}" class="step-content">
      <view class="step-title">
        <text class="title-text">基础信息</text>
        <text class="title-desc">上传作品图片，填写基本信息</text>
      </view>

      <!-- 商品主图 -->
      <view class="form-group">
        <view class="group-label">商品主图 <text class="required">*</text></view>
        <view class="group-hint">上传作品示意图，第一张为封面</view>
        <view class="image-grid">
          <view wx:for="{{formData.images}}" wx:key="*this" class="image-item">
            <image src="{{item}}" mode="aspectFill" class="preview-image" />
            <view wx:if="{{index === 0}}" class="cover-badge">封面</view>
            <view class="delete-btn" data-index="{{index}}" bindtap="deleteImage">×</view>
          </view>
          <view wx:if="{{formData.images.length < 9}}" class="upload-btn" bindtap="chooseImages">
            <view class="upload-icon">+</view>
            <text class="upload-text">添加图片</text>
          </view>
        </view>
      </view>

      <!-- 商品名称 -->
      <view class="form-group">
        <view class="group-label">商品名称 <text class="required">*</text></view>
        <input class="form-input" 
               placeholder="请输入商品名称（2-50字）" 
               value="{{formData.name}}"
               bindinput="onNameInput" 
               maxlength="50" />
        <view class="char-count">{{formData.name.length}}/50</view>
      </view>

      <!-- 商品分类 -->
      <view class="form-group">
        <view class="group-label">商品分类 <text class="required">*</text></view>
        <picker mode="selector" 
                range="{{categories}}" 
                range-key="name"
                value="{{categoryIndex}}"
                bindchange="onCategoryChange">
          <view class="picker-display">
            <text class="{{categoryName === '请选择分类' ? 'placeholder' : ''}}">{{categoryName}}</text>
            <view class="arrow-icon"></view>
          </view>
        </picker>
      </view>

      <!-- 出稿天数 -->
      <view class="form-group">
        <view class="group-label">出稿天数 <text class="required">*</text></view>
        <picker mode="selector" 
                range="{{deliveryOptions}}" 
                value="{{deliveryIndex}}"
                bindchange="onDeliveryOptionChange">
          <view class="picker-display">
            <text>{{deliveryOptions[deliveryIndex]}}天</text>
            <view class="arrow-icon"></view>
          </view>
        </picker>
      </view>

      <!-- 商品标签 -->
      <view class="form-group">
        <view class="group-label">商品标签 <text class="label-hint">（最多3个）</text></view>
        <view class="tag-grid">
          <view wx:for="{{tagOptions}}" wx:key="*this"
                class="tag-item {{formData.tags.includes(item) ? 'active' : ''}}"
                data-tag="{{item}}"
                bindtap="toggleTag">
            {{item}}
          </view>
        </view>
      </view>

      <!-- 自动保存提示 -->
      <view wx:if="{{draftSaved}}" class="draft-tip">
        <text class="tip-icon">✓</text>
        <text class="tip-text">草稿已自动保存</text>
      </view>
    </view>

    <!-- 第二步：规格与定价 -->
    <view wx:if="{{currentStep === 2}}" class="step-content">
      <view class="step-title">
        <text class="title-text">规格与定价</text>
        <text class="title-desc">设置商品规格和价格体系</text>
      </view>

      <!-- 基础价格 -->
      <view class="form-group">
        <view class="group-label">基础价格 <text class="required">*</text></view>
        <view class="group-hint">不选规格时的默认价格</view>
        <view class="price-input-wrapper">
          <text class="price-symbol">¥</text>
          <input class="form-input price-input" 
                 type="digit"
                 placeholder="0.00" 
                 value="{{formData.basePrice}}"
                 bindinput="onBasePriceInput" />
        </view>
      </view>

      <!-- 库存设置 -->
      <view class="form-group">
        <view class="group-label">库存管理</view>
        <view class="stock-mode-selector">
          <view class="stock-mode-item {{!enableStockLimit ? 'active' : ''}}" 
                bindtap="toggleStockMode" 
                data-mode="auto">
            <view class="mode-icon">♾️</view>
            <view class="mode-info">
              <text class="mode-title">自动补货</text>
              <text class="mode-desc">无限库存，不限制购买</text>
            </view>
          </view>
          <view class="stock-mode-item {{enableStockLimit ? 'active' : ''}}" 
                bindtap="toggleStockMode" 
                data-mode="limit">
            <view class="mode-icon">📦</view>
            <view class="mode-info">
              <text class="mode-title">限量库存</text>
              <text class="mode-desc">设置具体库存数量</text>
            </view>
          </view>
        </view>
        
        <!-- 库存数量设置（仅在限量模式下显示） -->
        <view wx:if="{{enableStockLimit}}" class="stock-setting">
          <view class="stock-control">
            <button class="stock-btn minus" bindtap="decreaseStock">-</button>
            <input class="stock-input" 
                   type="number"
                   value="{{formData.stock}}"
                   bindinput="onStockInput" 
                   placeholder="请输入库存" />
            <button class="stock-btn plus" bindtap="increaseStock">+</button>
          </view>
          <view class="group-hint">当前库存：{{formData.stock || 0}} 件</view>
        </view>
      </view>

      <!-- 规格设置 -->
      <view class="spec-guide">
        <view class="guide-header">
          <text class="guide-title">💡 规格设置（选填）</text>
          <text class="guide-desc">为商品添加不同规格和价格组合</text>
        </view>

        <!-- 一级规格 -->
        <view wx:if="{{!spec1Selected}}" class="add-spec-tip">
          <button class="add-first-spec-btn" bindtap="addFirstSpec">+ 添加规格</button>
        </view>

        <!-- 规格配置 -->
        <view wx:if="{{spec1Selected}}" class="spec-config">
          <view class="spec-card">
            <view class="spec-card-header">
              <view class="spec-header-left">
                <text class="spec-level">一级规格</text>
                <input class="spec-name-input" 
                       placeholder="如：构图类型" 
                       value="{{spec1Name}}"
                       bindinput="onSpec1NameInput" />
              </view>
              <button class="reset-spec-btn" bindtap="resetSpec1">重置</button>
            </view>

            <view class="spec-values-section">
              <text class="section-label">规格选项：</text>
              <view class="spec-value-list">
                <view wx:for="{{spec1Values}}" wx:key="index" class="spec-value-item">
                  <!-- 规格图片 -->
                  <view class="spec-image-upload" bindtap="chooseSpec1Image" data-index="{{index}}">
                    <image wx:if="{{item.image}}" src="{{item.image}}" mode="aspectFill" class="spec-image" />
                    <view wx:else class="spec-image-placeholder">
                      <text class="placeholder-icon">📷</text>
                      <text class="placeholder-text">上传图片</text>
                    </view>
                  </view>
                  
                  <!-- 规格信息 -->
                  <view class="spec-value-info">
                    <input class="spec-value-name" 
                           placeholder="选项名称（如：蓝色）" 
                           value="{{item.name}}"
                           data-index="{{index}}"
                           bindinput="onSpec1ValueNameInput" />
                    <view class="spec-price-row">
                      <input class="spec-value-price" 
                             type="digit"
                             placeholder="0" 
                             value="{{item.addPrice}}"
                             data-index="{{index}}"
                             bindinput="onSpec1ValuePriceInput" />
                      <text class="price-unit">元</text>
                    </view>
                  </view>
                  
                  <!-- 删除按钮 -->
                  <view class="delete-value-btn" 
                        data-index="{{index}}" 
                        catchtap="deleteSpec1Value">×</view>
                </view>
              </view>
              <button class="add-value-btn" bindtap="addSpec1Value">+ 添加选项</button>
            </view>
          </view>

          <!-- 二级规格（可选） -->
          <view wx:if="{{!spec2Selected}}" class="add-spec2-tip">
            <button class="add-spec2-btn" bindtap="showSpec2Selector">+ 添加二级规格</button>
            <text class="tip-text">二级规格可细分一级规格的选项</text>
          </view>

          <view wx:if="{{spec2Selected}}" class="spec-card">
            <view class="spec-card-header">
              <view class="spec-header-left">
                <text class="spec-level">二级规格</text>
                <input class="spec-name-input" 
                       placeholder="如：输出比例" 
                       value="{{spec2Name}}"
                       bindinput="onSpec2NameInput" />
              </view>
              <button class="reset-spec-btn" bindtap="resetSpec2">移除</button>
            </view>

            <view class="spec-values-section">
              <text class="section-label">规格选项：</text>
              <view class="spec-value-list">
                <view wx:for="{{spec2Values}}" wx:key="index" class="spec-value-item">
                  <!-- 规格图片 -->
                  <view class="spec-image-upload" bindtap="chooseSpec2Image" data-index="{{index}}">
                    <image wx:if="{{item.image}}" src="{{item.image}}" mode="aspectFill" class="spec-image" />
                    <view wx:else class="spec-image-placeholder">
                      <text class="placeholder-icon">📷</text>
                      <text class="placeholder-text">上传图片</text>
                    </view>
                  </view>
                  
                  <!-- 规格信息 -->
                  <view class="spec-value-info">
                    <input class="spec-value-name" 
                           placeholder="选项名称（如：手机壁纸）" 
                           value="{{item.name}}"
                           data-index="{{index}}"
                           bindinput="onSpec2ValueNameInput" />
                    <view class="spec-price-row">
                      <text class="plus-symbol">+</text>
                      <input class="spec-value-price" 
                             type="digit"
                             placeholder="0" 
                             value="{{item.addPrice}}"
                             data-index="{{index}}"
                             bindinput="onSpec2ValuePriceInput" />
                      <text class="price-unit">元</text>
                    </view>
                  </view>
                  
                  <!-- 删除按钮 -->
                  <view class="delete-value-btn" 
                        data-index="{{index}}" 
                        catchtap="deleteSpec2Value">×</view>
                </view>
              </view>
              <button class="add-value-btn" bindtap="addSpec2Value">+ 添加选项</button>
            </view>
          </view>

          <!-- 价格预览表 -->
          <view wx:if="{{pricePreviewTable.length > 0}}" class="price-preview">
            <text class="preview-title">价格组合预览</text>
            <view class="preview-table">
              <view wx:for="{{pricePreviewTable}}" wx:key="index" class="preview-row">
                <text class="preview-spec">{{item.spec}}</text>
                <text class="preview-price">¥{{item.price}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 自动保存提示 -->
      <view wx:if="{{draftSaved}}" class="draft-tip">
        <text class="tip-icon">✓</text>
        <text class="tip-text">草稿已自动保存</text>
      </view>
    </view>

    <!-- 第三步：详情与发布 -->
    <view wx:if="{{currentStep === 3}}" class="step-content">
      <view class="step-title">
        <text class="title-text">详情与发布</text>
        <text class="title-desc">完善商品描述，准备发布</text>
      </view>

      <!-- 商品简介（富文本） -->
      <view class="form-group">
        <view class="group-label">商品简介</view>
        <view class="group-hint">输入文字说明，点击图片按钮可在光标位置插入占位符 [图1] [图2] [图3]</view>
        
        <!-- 使用说明卡片 -->
        <view class="usage-card">
          <view class="usage-title">使用说明</view>
          <view class="usage-steps">
            <view class="usage-step">
              <text class="step-num">1</text>
              <text class="step-text">先上传图片（最多3张）</text>
            </view>
            <view class="usage-step">
              <text class="step-num">2</text>
              <text class="step-text">在下方文本框中输入文字</text>
            </view>
            <view class="usage-step">
              <text class="step-num">3</text>
              <text class="step-text">点击文本框确定光标位置</text>
            </view>
            <view class="usage-step">
              <text class="step-num">4</text>
              <text class="step-text">点击顶部[插入图1]按钮，在光标位置插入占位符</text>
            </view>
          </view>
        </view>
        
        <!-- 富文本编辑区域 -->
        <view class="rich-text-editor">
          <!-- 文字输入 + 插入按钮 -->
          <view class="editor-header">
            <text class="editor-label">商品描述</text>
            <view class="editor-actions">
              <button wx:for="{{[1,2,3]}}" 
                      wx:key="*this"
                      wx:if="{{item <= formData.summaryImages.length}}"
                      class="insert-placeholder-btn"
                      data-index="{{item}}"
                      catchtap="insertImagePlaceholder"
                      hover-stop-propagation="{{true}}">
                插入[图{{item}}]
              </button>
            </view>
          </view>
          
          <textarea class="form-textarea rich-textarea" 
                    placeholder="专业画师手绘，风格多样，满意为止...&#10;&#10;示例：&#10;作品介绍文字...&#10;[图1]&#10;更多说明文字...&#10;[图2]" 
                    value="{{formData.summary}}"
                    bindinput="onSummaryInput"
                    bindselectionchange="onSelectionChange"
                    selection-start="{{selectionStart}}"
                    selection-end="{{selectionEnd}}"
                    maxlength="500"
                    auto-height />
          <view class="char-count">{{formData.summary.length}}/500</view>
          
          <!-- 图片上传区域 -->
          <view class="images-upload-section">
            <text class="section-title">上传图片（最多3张）</text>
            <view class="upload-hint">上传后可点击上方按钮将图片插入到文本中的任意位置</view>
            
            <view class="image-upload-list">
              <!-- 已上传的图片 -->
              <view wx:for="{{formData.summaryImages}}" 
                    wx:key="index" 
                    class="upload-image-item">
                <image src="{{item}}" mode="aspectFill" class="upload-image" />
                <view class="image-label">[图{{index + 1}}]</view>
                <view class="delete-image-btn" data-index="{{index}}" catchtap="deleteSummaryImage">×</view>
              </view>
              
              <!-- 上传按钮 -->
              <view wx:if="{{formData.summaryImages.length < 3}}" 
                    class="upload-image-btn" 
                    bindtap="chooseSummaryImages">
                <text class="upload-icon">+</text>
                <text class="upload-text">上传图片</text>
              </view>
            </view>
          </view>
          
          <!-- 预览说明 -->
          <view wx:if="{{formData.summaryImages.length > 0 && formData.summary.indexOf('[图') > -1}}" class="preview-hint">
            <text class="hint-icon">i</text>
            <text class="hint-text">商品详情中，文本里的 [图1] [图2] [图3] 会替换为对应的图片</text>
          </view>
        </view>
      </view>

      <!-- 发布设置 -->
      <view class="publish-settings">
        <view class="setting-row">
          <text class="setting-label">是否立即上架</text>
          <switch class="setting-switch" 
                  checked="{{formData.isOnSale}}" 
                  color="#A8E6CF"
                  bindchange="onSaleChange" />
        </view>
      </view>

      <!-- 信息确认 -->
      <view class="confirm-info">
        <text class="confirm-title">信息确认</text>
        <view class="confirm-item">
          <text class="confirm-label">商品名称：</text>
          <text class="confirm-value">{{formData.name || '未填写'}}</text>
        </view>
        <view class="confirm-item">
          <text class="confirm-label">商品分类：</text>
          <text class="confirm-value">{{categoryName}}</text>
        </view>
        
        <!-- 动态显示价格 -->
        <view wx:if="{{pricePreviewTable.length === 0}}" class="confirm-item">
          <text class="confirm-label">商品价格：</text>
          <text class="confirm-value price-highlight">¥{{formData.basePrice || '0'}}</text>
        </view>
        <view wx:else class="confirm-item">
          <text class="confirm-label">价格区间：</text>
          <text class="confirm-value price-highlight">¥{{finalPrice}} 起</text>
        </view>
        
        <view class="confirm-item">
          <text class="confirm-label">出稿天数：</text>
          <text class="confirm-value">{{deliveryOptions[deliveryIndex]}}天</text>
        </view>
        
        <!-- 规格信息 -->
        <view wx:if="{{spec1Selected}}" class="confirm-item">
          <text class="confirm-label">规格设置：</text>
          <text class="confirm-value">
            {{spec1Name}}({{spec1Values.length}}个)
            <text wx:if="{{spec2Selected}}"> + {{spec2Name}}({{spec2Values.length}}个)</text>
          </text>
        </view>
        <view wx:if="{{pricePreviewTable.length > 0}}" class="confirm-item">
          <text class="confirm-label">价格组合：</text>
          <text class="confirm-value">共{{pricePreviewTable.length}}种</text>
        </view>
      </view>
    </view>

    <!-- 底部操作按钮 -->
    <view class="action-bar">
      <button wx:if="{{currentStep > 1}}" class="prev-btn" bindtap="prevStep">上一步</button>
      <button wx:if="{{currentStep < 3}}" class="next-btn" bindtap="nextStep">下一步</button>
      <button wx:if="{{currentStep === 3}}" class="submit-btn" bindtap="submitForm">发布商品</button>
    </view>
  </view>
</view>
