<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>
  
  <view wx:else class="detail-page">
    <!-- 商品图片轮播 -->
    <swiper class="image-swiper" 
            indicator-dots="{{true}}" 
            indicator-color="rgba(255,255,255,0.5)"
            indicator-active-color="#A8E6CF"
            circular="{{true}}"
            autoplay="{{true}}"
            interval="{{3000}}">
      <swiper-item wx:for="{{product.images}}" wx:key="*this">
        <image class="swiper-image" src="{{item}}" mode="aspectFill" />
      </swiper-item>
    </swiper>

    <!-- 价格区域 -->
    <view class="price-section">
      <view class="price-row">
        <text class="price-symbol">¥</text>
        <text class="price-value">{{product.price}}</text>
        <text wx:if="{{product.specs && product.specs.length > 0}}" class="price-suffix">起</text>
      </view>
      <view class="sales-info">
        <text class="sales-count">已售 {{product.sales || 0}}</text>
      </view>
    </view>

    <!-- 商品标题 -->
    <view class="title-section">
      <view class="product-name">{{product.name}}</view>
      <view wx:if="{{product.tags && product.tags.length > 0}}" class="tags">
        <view wx:for="{{product.tags}}" wx:key="*this" class="tag">{{item}}</view>
      </view>
    </view>

    <!-- 基础信息 -->
    <view class="info-section">
      <view wx:if="{{product.categoryName}}" class="info-row">
        <text class="info-label">分类</text>
        <text class="info-value">{{product.categoryName}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">出稿时间</text>
        <text class="info-value">{{product.deliveryDays}}天</text>
      </view>
      <view wx:if="{{artist && artist.name}}" class="info-row" bindtap="viewArtist">
        <text class="info-label">画师</text>
        <text class="info-value">{{artist.name}}</text>
        <text wx:if="{{artist.id}}" class="arrow">›</text>
      </view>
    </view>

    <!-- 商品详情 -->
    <view class="detail-section">
      <view class="section-title">商品详情</view>
      <view class="detail-content">
        <!-- 解析后的内容：文本和图片混排 -->
        <block wx:if="{{summaryContent && summaryContent.length > 0}}">
          <block wx:for="{{summaryContent}}" wx:key="index">
            <!-- 文本块 -->
            <text wx:if="{{item.type === 'text'}}" class="detail-text">{{item.content}}</text>
            <!-- 图片块 -->
            <image wx:if="{{item.type === 'image'}}" 
                   class="detail-image" 
                   src="{{item.content}}" 
                   mode="widthFix" 
                   lazy-load />
          </block>
        </block>
        
        <!-- 如果没有内容，显示默认文本 -->
        <text wx:if="{{!summaryContent || summaryContent.length === 0}}" class="detail-text">暂无详情</text>
      </view>
    </view>

    <!-- 底部占位 -->
    <view class="bottom-placeholder"></view>
  </view>

  <!-- 底部操作栏 -->
  <view wx:if="{{!loading}}" class="bottom-bar">
    <view class="service-btn" bindtap="toggleServiceQR">
      <view class="service-icon-wrapper">
        <view class="chat-bubble">
          <view class="bubble-dot"></view>
          <view class="bubble-dot"></view>
          <view class="bubble-dot"></view>
        </view>
      </view>
      <text class="service-text">{{serviceInfo && serviceInfo.serviceName ? serviceInfo.serviceName : '客服'}}</text>
    </view>
    <button class="buy-btn" bindtap="buyProduct">立即购买</button>
  </view>

  <!-- 侧边悬浮购物车按钮 -->
  <view class="floating-cart-btn" bindtap="addToCart">
    <!-- 购物车图标 -->
    <view class="cart-icon">
      <!-- 车身 -->
      <view class="cart-body"></view>
      <!-- 车把手 -->
      <view class="cart-handle"></view>
      <!-- 左轮子 -->
      <view class="cart-wheel cart-wheel-left"></view>
      <!-- 右轮子 -->
      <view class="cart-wheel cart-wheel-right"></view>
    </view>
    
    <!-- 商品数量角标 -->
    <view wx:if="{{cartCount > 0}}" class="cart-badge">{{cartCount}}</view>
    
    <!-- 加入动画的商品图标 -->
    <image wx:if="{{showCartAnimation}}" 
           class="cart-fly-item" 
           src="{{animationImage}}" 
           mode="aspectFill" />
  </view>

  <!-- 客服二维码弹窗 -->
  <view class="modal-overlay" wx:if="{{showServiceQR}}" catchtap="toggleServiceQR">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-title">{{serviceInfo && serviceInfo.serviceName ? serviceInfo.serviceName : '扫码添加客服'}}</view>
      <block wx:if="{{hasOrder && orderQR}}">
        <image class="qr-image" src="{{orderQR}}" mode="aspectFit" />
        <text class="qr-hint">专属客服二维码</text>
      </block>
      <block wx:elif="{{serviceQR && serviceQR.imageUrl}}">
        <image class="qr-image" src="{{serviceQR.imageUrl}}" mode="aspectFit" />
        <text class="qr-hint">长按识别添加客服微信</text>
      </block>
      <block wx:else>
        <view class="qr-placeholder">
          <text class="qr-placeholder-text">客服二维码未配置</text>
          <text class="qr-placeholder-hint">请稍后再试，或联系管理员</text>
        </view>
      </block>
      <button class="modal-close" catchtap="toggleServiceQR">关闭</button>
    </view>
  </view>

  <!-- 购买弹窗 -->
  <view class="buy-modal-overlay" wx:if="{{showBuyModal}}" catchtap="closeBuyModal">
    <view class="buy-modal-content" catchtap="stopPropagation">
      <!-- 商品信息 -->
      <view class="buy-modal-header">
        <image class="buy-modal-image" src="{{product.images[0]}}" mode="aspectFill" />
        <view class="buy-modal-info">
          <view class="buy-modal-price">¥{{currentPrice}}</view>
          <view class="buy-modal-stock">库存：{{product.stock === 0 ? '♾️' : product.stock}}</view>
          <!-- 已选规格显示 -->
          <view class="selected-specs" wx:if="{{selectedSpecText}}">
            <text class="specs-label">已选：</text>
            <text class="specs-text">{{selectedSpecText}}</text>
          </view>
        </view>
        <view class="buy-modal-close" catchtap="closeBuyModal">×</view>
      </view>

      <!-- 规格选择 -->
      <view class="buy-modal-body">
        <!-- 一级规格 -->
        <view wx:if="{{product.specs && product.specs.length > 0}}" class="spec-section">
          <view class="spec-title">{{product.specs[0].name}}</view>
          <view class="spec-options">
            <view wx:for="{{product.specs[0].values}}" 
                  wx:key="index"
                  class="spec-option {{selectedSpec1 === index ? 'selected' : ''}}"
                  data-index="{{index}}"
                  catchtap="selectSpec1">
              <image wx:if="{{item.image}}" class="spec-image" src="{{item.image}}" mode="aspectFill" />
              <text class="spec-name">{{item.name}}</text>
              <text class="spec-price">¥{{item.addPrice}}</text>
            </view>
          </view>
        </view>

        <!-- 二级规格 -->
        <view wx:if="{{product.specs && product.specs.length > 1}}" class="spec-section">
          <view class="spec-title">{{product.specs[1].name}}</view>
          <view class="spec-options">
            <view wx:for="{{product.specs[1].values}}" 
                  wx:key="index"
                  class="spec-option {{selectedSpec2 === index ? 'selected' : ''}}"
                  data-index="{{index}}"
                  catchtap="selectSpec2">
              <image wx:if="{{item.image}}" class="spec-image" src="{{item.image}}" mode="aspectFill" />
              <text class="spec-name">{{item.name}}</text>
              <text class="spec-price">+¥{{item.addPrice}}</text>
            </view>
          </view>
        </view>

        <!-- 数量选择 -->
        <view class="quantity-section">
          <view class="quantity-title">购买数量</view>
          <view class="quantity-controls">
            <view class="quantity-btn {{quantity <= 1 ? 'disabled' : ''}}" catchtap="decreaseQuantity">-</view>
            <input class="quantity-input" type="number" value="{{quantity}}" disabled />
            <view class="quantity-btn" catchtap="increaseQuantity">+</view>
          </view>
        </view>
      </view>

      <!-- 底部按钮 -->
      <view class="buy-modal-footer">
        <view class="total-price">
          <text class="total-label">合计：</text>
          <text class="total-value">¥{{currentPrice * quantity}}</text>
        </view>
        <button class="confirm-buy-btn {{canSubmit ? '' : 'disabled'}}" catchtap="confirmOrder">
          <view wx:if="{{!canSubmit}}" class="btn-text">请选择规格</view>
          <view wx:else class="btn-text">
            <text>确认</text>
            <text wx:if="{{selectedSpecText}}" class="btn-spec">{{selectedSpecText}}</text>
            <text> × {{quantity}}</text>
          </view>
        </button>
      </view>
    </view>
  </view>
</view>
