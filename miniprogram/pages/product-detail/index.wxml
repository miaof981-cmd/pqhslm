<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <view wx:else class="detail-page">
    <!-- å•†å“å›¾ç‰‡è½®æ’­ -->
    <swiper class="image-swiper" 
            indicator-dots="{{true}}" 
            indicator-color="rgba(255,255,255,0.5)"
            indicator-active-color="#A8E6CF"
            circular="{{true}}"
            autoplay="{{true}}"
            interval="{{3000}}">
      <swiper-item wx:for="{{product.images}}" wx:key="*this">
        <image class="swiper-image" 
               src="{{item}}" 
               mode="aspectFill" 
               data-current="{{item}}"
               bindtap="previewImages" />
      </swiper-item>
    </swiper>

    <!-- ä»·æ ¼åŒºåŸŸ -->
    <view class="price-section">
      <view class="price-row">
        <text class="price-symbol">Â¥</text>
        <text class="price-value">{{product.price}}</text>
        <text wx:if="{{product.specs && product.specs.length > 0}}" class="price-suffix">èµ·</text>
      </view>
      <view class="sales-info">
        <text class="sales-count">å·²å”® {{product.sales || 0}}</text>
      </view>
    </view>

    <!-- å•†å“æ ‡é¢˜ -->
    <view class="title-section">
      <view class="product-name">{{product.name}}</view>
      <view wx:if="{{product.tags && product.tags.length > 0}}" class="tags">
        <view wx:for="{{product.tags}}" wx:key="*this" class="tag">{{item}}</view>
      </view>
    </view>

    <!-- åŸºç¡€ä¿¡æ¯ -->
    <view class="info-section">
      <!-- ğŸ¯ ä¿®å¤ï¼šå§‹ç»ˆæ˜¾ç¤ºåˆ†ç±»ï¼Œæœªè®¾ç½®æ—¶æ˜¾ç¤º"æœªåˆ†ç±»" -->
      <view class="info-row">
        <text class="info-label">åˆ†ç±»</text>
        <text class="info-value">{{product.categoryName || 'æœªåˆ†ç±»'}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">å‡ºç¨¿æ—¶é—´</text>
        <text class="info-value">{{product.deliveryDays}}å¤©</text>
      </view>
      <view wx:if="{{artist && artist.name}}" class="info-row" bindtap="viewArtist">
        <text class="info-label">ç”»å¸ˆ</text>
        <text class="info-value">{{artist.name}}</text>
        <text wx:if="{{artist.id}}" class="arrow">â€º</text>
      </view>
    </view>

    <!-- å•†å“è¯¦æƒ… -->
    <view class="detail-section">
      <view class="section-title">å•†å“è¯¦æƒ…</view>
      <view class="detail-content">
        <!-- è§£æåçš„å†…å®¹ï¼šæ–‡æœ¬å’Œå›¾ç‰‡æ··æ’ -->
        <block wx:if="{{summaryContent && summaryContent.length > 0}}">
          <block wx:for="{{summaryContent}}" wx:key="index">
            <!-- æ–‡æœ¬å— -->
            <text wx:if="{{item.type === 'text'}}" class="detail-text">{{item.content}}</text>
            <!-- å›¾ç‰‡å— -->
            <image wx:if="{{item.type === 'image'}}" 
                   class="detail-image" 
                   src="{{item.content}}" 
                   mode="widthFix" 
                   lazy-load />
          </block>
        </block>
        
        <!-- å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬ -->
        <text wx:if="{{!summaryContent || summaryContent.length === 0}}" class="detail-text">æš‚æ— è¯¦æƒ…</text>
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view wx:if="{{!loading}}" class="bottom-bar">
    <view class="service-btn" bindtap="toggleServiceQR">
      <view class="service-icon-wrapper">
        <view class="chat-bubble">
          <view class="bubble-dot"></view>
          <view class="bubble-dot"></view>
          <view class="bubble-dot"></view>
        </view>
      </view>
      <!-- ğŸ¯ ä¿®å¤ï¼šå›ºå®šæ˜¾ç¤º"å®¢æœ"ï¼Œé¿å…æ˜¾ç¤ºä¸ªäººåç§°è¯¯å¯¼ç”¨æˆ· -->
      <text class="service-text">å®¢æœ</text>
    </view>
    <button class="buy-btn" bindtap="buyProduct">ç«‹å³è´­ä¹°</button>
  </view>

  <!-- ä¾§è¾¹æ‚¬æµ®è´­ç‰©è½¦æŒ‰é’® -->
  <view class="floating-cart-btn" bindtap="addToCart">
    <!-- è´­ç‰©è½¦å›¾æ ‡ -->
    <view class="cart-icon">
      <!-- è½¦èº« -->
      <view class="cart-body"></view>
      <!-- è½¦æŠŠæ‰‹ -->
      <view class="cart-handle"></view>
      <!-- å·¦è½®å­ -->
      <view class="cart-wheel cart-wheel-left"></view>
      <!-- å³è½®å­ -->
      <view class="cart-wheel cart-wheel-right"></view>
    </view>
    
    <!-- å•†å“æ•°é‡è§’æ ‡ -->
    <view wx:if="{{cartCount > 0}}" class="cart-badge">{{cartCount}}</view>
    
    <!-- åŠ å…¥åŠ¨ç”»çš„å•†å“å›¾æ ‡ -->
    <image wx:if="{{showCartAnimation}}" 
           class="cart-fly-item" 
           src="{{animationImage}}" 
           mode="aspectFill" />
  </view>

  <!-- ğŸ¯ ä¿®å¤ï¼šå®¢æœäºŒç»´ç å¼¹çª—æ ‡é¢˜æ˜ç¡®è¯´æ˜ -->
  <view class="modal-overlay" wx:if="{{showServiceQR}}" catchtap="toggleServiceQR">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-title">å¹³å°å®¢æœå¾®ä¿¡</view>
      <block wx:if="{{hasOrder && orderQR}}">
        <image class="qr-image" src="{{orderQR}}" mode="aspectFit" />
        <text class="qr-hint">æ‚¨çš„ä¸“å±å®¢æœå¾®ä¿¡äºŒç»´ç </text>
      </block>
      <block wx:elif="{{serviceQR && serviceQR.imageUrl}}">
        <image class="qr-image" src="{{serviceQR.imageUrl}}" mode="aspectFit" />
        <text class="qr-hint">é•¿æŒ‰è¯†åˆ«æ·»åŠ å¹³å°å®¢æœå¾®ä¿¡</text>
      </block>
      <block wx:else>
        <view class="qr-placeholder">
          <text class="qr-placeholder-text">å®¢æœäºŒç»´ç æœªé…ç½®</text>
          <text class="qr-placeholder-hint">è¯·ç¨åå†è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜</text>
        </view>
      </block>
      <button class="modal-close" catchtap="toggleServiceQR">å…³é—­</button>
    </view>
  </view>

  <!-- è´­ä¹°å¼¹çª— -->
  <view class="buy-modal-overlay" wx:if="{{showBuyModal}}" catchtap="closeBuyModal">
    <view class="buy-modal-content" catchtap="stopPropagation">
      <!-- å•†å“ä¿¡æ¯ -->
      <view class="buy-modal-header">
        <image class="buy-modal-image" src="{{product.images[0]}}" mode="aspectFill" />
        <view class="buy-modal-info">
          <view class="buy-modal-price">Â¥{{currentPrice}}</view>
          <view class="buy-modal-stock">åº“å­˜ï¼š{{product.stock === 0 ? 'â™¾ï¸' : product.stock}}</view>
          <!-- å·²é€‰è§„æ ¼æ˜¾ç¤º -->
          <view class="selected-specs" wx:if="{{selectedSpecText}}">
            <text class="specs-label">å·²é€‰ï¼š</text>
            <text class="specs-text">{{selectedSpecText}}</text>
          </view>
        </view>
        <view class="buy-modal-close" catchtap="closeBuyModal">Ã—</view>
      </view>

      <!-- è§„æ ¼é€‰æ‹© -->
      <view class="buy-modal-body">
        <!-- ä¸€çº§è§„æ ¼ -->
        <view wx:if="{{product.specs && product.specs.length > 0}}" class="spec-section">
          <view class="spec-title">{{product.specs[0].name}}</view>
          <view class="spec-options">
            <view wx:for="{{product.specs[0].values}}" 
                  wx:key="index"
                  class="spec-option {{selectedSpec1 === index ? 'selected' : ''}}"
                  data-index="{{index}}"
                  catchtap="selectSpec1">
              <image wx:if="{{item.image}}" class="spec-image" src="{{item.image}}" mode="aspectFill" />
              <text class="spec-name">{{item.name}}</text>
              <text class="spec-price">Â¥{{item.addPrice}}</text>
            </view>
          </view>
        </view>

        <!-- äºŒçº§è§„æ ¼ -->
        <view wx:if="{{product.specs && product.specs.length > 1}}" class="spec-section">
          <view class="spec-title">{{product.specs[1].name}}</view>
          <view class="spec-options">
            <view wx:for="{{product.specs[1].values}}" 
                  wx:key="index"
                  class="spec-option {{selectedSpec2 === index ? 'selected' : ''}}"
                  data-index="{{index}}"
                  catchtap="selectSpec2">
              <image wx:if="{{item.image}}" class="spec-image" src="{{item.image}}" mode="aspectFill" />
              <text class="spec-name">{{item.name}}</text>
              <text class="spec-price">+Â¥{{item.addPrice}}</text>
            </view>
          </view>
        </view>

        <!-- æ•°é‡é€‰æ‹© -->
        <view class="quantity-section">
          <view class="quantity-title">è´­ä¹°æ•°é‡</view>
          <view class="quantity-controls">
            <view class="quantity-btn {{quantity <= 1 ? 'disabled' : ''}}" catchtap="decreaseQuantity">-</view>
            <input class="quantity-input" type="number" value="{{quantity}}" disabled />
            <view class="quantity-btn" catchtap="increaseQuantity">+</view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="buy-modal-footer">
        <view class="total-price">
          <text class="total-label">åˆè®¡ï¼š</text>
          <text class="total-value">Â¥{{currentPrice * quantity}}</text>
        </view>
        <button class="confirm-buy-btn {{canSubmit ? '' : 'disabled'}}" catchtap="confirmOrder">
          <view wx:if="{{!canSubmit}}" class="btn-text">è¯·é€‰æ‹©è§„æ ¼</view>
          <view wx:else class="btn-text">
            <text>ç¡®è®¤</text>
            <text wx:if="{{selectedSpecText}}" class="btn-spec">{{selectedSpecText}}</text>
            <text> Ã— {{quantity}}</text>
          </view>
        </button>
      </view>
    </view>
  </view>
</view>
