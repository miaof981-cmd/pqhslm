<view class="workspace-container">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- æ— æƒé™æç¤º -->
  <view wx:elif="{{!hasPermission}}" class="no-permission">
    <view class="no-permission-icon">ğŸ”’</view>
    <view class="no-permission-title">æš‚æ— è®¿é—®æƒé™</view>
    <view class="no-permission-text">æ‚¨è¿˜ä¸æ˜¯ç”»å¸ˆæˆ–å®¢æœ</view>
  </view>

  <view wx:else class="workspace-content">
    <!-- é¡¶éƒ¨åŠŸèƒ½åŒºï¼ˆç´§å‡‘ï¼‰ -->
    <view class="top-section">
      <view class="header-row">
        <text class="page-title">å·¥ä½œå°</text>
        <view class="stats-mini">
          <view class="stat-mini-item" bindtap="filterOrders" data-filter="inProgress">
            å¾…å¤„ç† <text class="stat-mini-num">{{pendingStats.inProgress || 0}}</text>
          </view>
          <view class="stat-mini-item urgent" bindtap="filterOrders" data-filter="urgent">
            ç´§æ€¥ <text class="stat-mini-num">{{(pendingStats.overdue || 0) + (pendingStats.nearDeadline || 0)}}</text>
          </view>
        </view>
      </view>

      <!-- å¿«æ·åŠŸèƒ½ï¼ˆç´§å‡‘ï¼‰ -->
      <!-- ç”»å¸ˆåŠŸèƒ½ -->
      <view wx:if="{{userRole === 'artist'}}" class="quick-functions">
        <view class="func-btn" bindtap="handleFunction" data-func="productManage">
          <view class="func-icon product-icon"></view>
          <text class="func-name">å•†å“</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="dataStats">
          <view class="func-icon stats-icon"></view>
          <text class="func-name">ç»Ÿè®¡</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="withdraw">
          <view class="func-icon money-icon"></view>
          <text class="func-name">æç°</text>
        </view>
        <view class="func-btn" bindtap="toggleNotices">
          <view class="func-icon notice-icon"></view>
          <text class="func-name">é¡»çŸ¥</text>
        </view>
      </view>

      <!-- å®¢æœåŠŸèƒ½ -->
      <view wx:elif="{{userRole === 'service'}}" class="quick-functions">
        <view class="func-btn" bindtap="handleFunction" data-func="dataStats">
          <view class="func-icon stats-icon"></view>
          <text class="func-name">ç»Ÿè®¡</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="withdraw">
          <view class="func-icon money-icon"></view>
          <text class="func-name">æç°</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="qrcodeManage">
          <view class="func-icon qrcode-icon"></view>
          <text class="func-name">äºŒç»´ç </text>
        </view>
        <view class="func-btn" bindtap="toggleNotices">
          <view class="func-icon notice-icon"></view>
          <text class="func-name">é¡»çŸ¥</text>
        </view>
      </view>

      <!-- å¹³å°é¡»çŸ¥ï¼ˆå¯å±•å¼€ï¼‰ -->
      <view wx:if="{{showNotices}}" class="notices-compact">
        <view wx:for="{{notices}}" wx:key="id" class="notice-line">
          <text>â€¢ {{item.content}}</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•åˆ—è¡¨åŒºï¼ˆå å¤§åŠå±å¹•ï¼‰ -->
    <view class="orders-section">
      <view class="section-header">
        <text class="section-title">å¾…å¤„ç†è®¢å•</text>
        <text class="order-count">å…± {{filteredOrders.length}} å•</text>
      </view>

      <!-- æœç´¢å’Œç­›é€‰ -->
      <view class="filter-bar">
        <view class="search-box">
          <view class="search-icon"></view>
          <input class="search-input" 
                 placeholder="æœç´¢è®¢å•å·/å•†å“å" 
                 value="{{searchKeyword}}"
                 bindinput="onSearchInput"/>
          <view wx:if="{{searchKeyword}}" class="clear-icon" bindtap="clearSearch"></view>
        </view>
        
        <view class="filter-tabs">
          <view class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="all">
            å…¨éƒ¨
          </view>
          <view class="filter-tab {{currentFilter === 'urgent' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="urgent">
            ç´§æ€¥
          </view>
          <view class="filter-tab {{currentFilter === 'inProgress' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="inProgress">
            è¿›è¡Œä¸­
          </view>
          <view class="filter-tab {{currentFilter === 'waitingConfirm' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="waitingConfirm">
            å¾…ç¡®è®¤
          </view>
          <view class="filter-tab {{currentFilter === 'completed' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="completed">
            å·²å®Œæˆ
          </view>
        </view>
      </view>

      <scroll-view class="orders-scroll" scroll-y>
        <view wx:if="{{filteredOrders.length === 0}}" class="empty-orders">
          <view class="empty-icon-wrapper">
            <view class="empty-icon"></view>
          </view>
          <text class="empty-text">{{searchKeyword ? 'æœªæ‰¾åˆ°ç›¸å…³è®¢å•' : 'æš‚æ— å¾…å¤„ç†è®¢å•'}}</text>
        </view>

        <view wx:else class="orders-list">
          <view wx:for="{{filteredOrders}}" wx:key="id" class="order-card {{item.status === 'waitingConfirm' ? 'order-card-waiting' : ''}}">
            <!-- è®¢å•å¤´éƒ¨ï¼šè®¢å•å· + çŠ¶æ€ -->
            <view class="order-header" bindtap="viewOrderDetail" data-id="{{item.id}}">
              <view class="order-id">è®¢å• {{item.id}}</view>
              <view class="order-status status-{{item.status}}">{{item.statusText}}</view>
            </view>

            <!-- å•†å“ä¿¡æ¯åŒº -->
            <view class="order-product" bindtap="viewOrderDetail" data-id="{{item.id}}">
              <image class="product-thumb" src="{{item.productImage}}" mode="aspectFill"/>
              <view class="product-info">
                <text class="product-name">{{item.productName}}</text>
                <text class="product-spec">{{item.spec}}</text>
              </view>
              <view class="product-price">
                <text class="price-symbol">Â¥</text>
                <text class="price-value">{{item.price}}</text>
              </view>
            </view>

            <!-- æ—¶é—´è¿›åº¦æ¡ -->
            <view class="order-progress-section {{item.status === 'overdue' ? 'overdue' : (item.status === 'nearDeadline' ? 'near-deadline' : '')}}">
              <view class="progress-header">
                <view class="progress-label">
                  <text class="time-title">ä¸‹å•æ—¶é—´</text>
                  <text class="time-value">{{item.createTime}}</text>
                </view>
                <view class="progress-label deadline-label {{item.status === 'overdue' ? 'overdue' : ''}}">
                  <text class="time-title">æˆªç¨¿æ—¶é—´</text>
                  <text class="time-value">{{item.deadline}}</text>
                </view>
              </view>
              <view class="progress-bar-container">
                <view class="progress-bar-bg {{item.status === 'overdue' ? 'overdue' : (item.status === 'nearDeadline' ? 'near-deadline' : '')}}">
                  <view class="progress-bar-fill {{item.status === 'overdue' ? 'overdue' : (item.status === 'nearDeadline' ? 'near-deadline' : '')}}" 
                        style="width: {{item.progressPercent || 50}}%;"></view>
                </view>
              </view>
            </view>

            <!-- äººå‘˜ä¿¡æ¯åŒºï¼ˆå•è¡Œï¼‰ -->
            <view class="order-people-compact">
              <view class="people-item-compact">
                <text class="people-label-small">å®¢æˆ·</text>
                <image class="people-avatar-small" src="{{item.buyerAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
                <text class="people-name-compact">{{item.buyerName || 'å®¢æˆ·'}}</text>
              </view>
              <view class="people-divider-compact"></view>
              <view class="people-item-compact">
                <text class="people-label-small">å®¢æœ</text>
                <image class="people-avatar-small" src="{{item.serviceAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
                <text class="people-name-compact">{{item.serviceName || 'å¾…åˆ†é…'}}</text>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’®ï¼ˆåªåœ¨æœªå®Œæˆä¸”æœªæ ‡è®°å®Œæˆæ—¶æ˜¾ç¤ºï¼‰ -->
            <view wx:if="{{item.status !== 'completed' && item.status !== 'waitingConfirm'}}" class="order-actions">
              <button class="btn-mark-complete" 
                      catchtap="quickMarkComplete" 
                      data-id="{{item.id}}">
                æ ‡è®°å®Œæˆ
              </button>
            </view>
            
            <!-- å·²æ ‡è®°å®Œæˆæç¤º -->
            <view wx:elif="{{item.status === 'waitingConfirm'}}" class="order-waiting-tip">
              <text class="waiting-text">âœ“ å·²å®Œæˆï¼Œç­‰å¾…å®¢æˆ·ç¡®è®¤</text>
            </view>
          </view>
          
          <!-- åº•éƒ¨æç¤º -->
          <view class="list-footer">
            <text class="footer-text">æ²¡æœ‰æ›´å¤šäº†</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
