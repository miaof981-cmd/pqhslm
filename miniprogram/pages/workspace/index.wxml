<view class="workspace-container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <!-- 无权限提示 -->
  <view wx:elif="{{!hasPermission}}" class="no-permission">
    <view class="no-permission-icon">🔒</view>
    <view class="no-permission-title">暂无访问权限</view>
    <view class="no-permission-text">您还不是画师或客服</view>
  </view>

  <view wx:else class="workspace-content">
    <!-- 顶部功能区（紧凑） -->
    <view class="top-section">
      <view class="header-row">
        <text class="page-title">工作台</text>
        <view class="stats-mini">
          <view class="stat-mini-item" bindtap="filterOrders" data-filter="inProgress">
            待处理 <text class="stat-mini-num">{{pendingStats.inProgress || 0}}</text>
          </view>
          <view class="stat-mini-item urgent" bindtap="filterOrders" data-filter="urgent">
            紧急 <text class="stat-mini-num">{{(pendingStats.overdue || 0) + (pendingStats.nearDeadline || 0)}}</text>
          </view>
        </view>
      </view>

      <!-- 快捷功能（紧凑） -->
      <!-- 画师功能 -->
      <view wx:if="{{userRole === 'artist'}}" class="quick-functions">
        <view class="func-btn" bindtap="handleFunction" data-func="productManage">
          <view class="func-icon product-icon"></view>
          <text class="func-name">商品</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="dataStats">
          <view class="func-icon stats-icon"></view>
          <text class="func-name">统计</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="withdraw">
          <view class="func-icon money-icon"></view>
          <text class="func-name">提现</text>
        </view>
        <view class="func-btn" bindtap="toggleNotices">
          <view class="func-icon notice-icon"></view>
          <text class="func-name">须知</text>
        </view>
      </view>

      <!-- 客服功能 -->
      <view wx:elif="{{userRole === 'service'}}" class="quick-functions">
        <view class="func-btn" bindtap="handleFunction" data-func="dataStats">
          <view class="func-icon stats-icon"></view>
          <text class="func-name">统计</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="withdraw">
          <view class="func-icon money-icon"></view>
          <text class="func-name">提现</text>
        </view>
        <view class="func-btn" bindtap="handleFunction" data-func="qrcodeManage">
          <view class="func-icon qrcode-icon"></view>
          <text class="func-name">二维码</text>
        </view>
        <view class="func-btn" bindtap="toggleNotices">
          <view class="func-icon notice-icon"></view>
          <text class="func-name">须知</text>
        </view>
      </view>

      <!-- 平台须知（可展开） -->
      <view wx:if="{{showNotices}}" class="notices-compact">
        <view wx:for="{{notices}}" wx:key="id" class="notice-line">
          <text>• {{item.content}}</text>
        </view>
      </view>
    </view>

    <!-- 订单列表区（占大半屏幕） -->
    <view class="orders-section">
      <view class="section-header">
        <text class="section-title">待处理订单</text>
        <text class="order-count">共 {{filteredOrders.length}} 单</text>
      </view>

      <!-- 搜索和筛选 -->
      <view class="filter-bar">
        <view class="search-box">
          <view class="search-icon"></view>
          <input class="search-input" 
                 placeholder="搜索订单号/商品名" 
                 value="{{searchKeyword}}"
                 bindinput="onSearchInput"/>
          <view wx:if="{{searchKeyword}}" class="clear-icon" bindtap="clearSearch"></view>
        </view>
        
        <view class="filter-tabs">
          <view class="filter-tab {{currentFilter === 'all' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="all">
            全部
          </view>
          <view class="filter-tab {{currentFilter === 'urgent' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="urgent">
            紧急
          </view>
          <view class="filter-tab {{currentFilter === 'inProgress' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="inProgress">
            进行中
          </view>
          <view class="filter-tab {{currentFilter === 'waitingConfirm' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="waitingConfirm">
            待确认
          </view>
          <view class="filter-tab {{currentFilter === 'completed' ? 'active' : ''}}" 
                bindtap="filterOrders" 
                data-filter="completed">
            已完成
          </view>
        </view>
      </view>

      <scroll-view class="orders-scroll" scroll-y>
        <view wx:if="{{filteredOrders.length === 0}}" class="empty-orders">
          <view class="empty-icon-wrapper">
            <view class="empty-icon"></view>
          </view>
          <text class="empty-text">{{searchKeyword ? '未找到相关订单' : '暂无待处理订单'}}</text>
        </view>

        <view wx:else class="orders-list">
          <view wx:for="{{filteredOrders}}" wx:key="id" class="order-card {{item.status === 'waitingConfirm' ? 'order-card-waiting' : ''}}">
            <!-- 订单头部：订单号 + 状态 -->
            <view class="order-header" bindtap="viewOrderDetail" data-id="{{item.id}}">
              <view class="order-id">订单 {{item.id}}</view>
              <view class="order-status status-{{item.status}}">{{item.statusText}}</view>
            </view>

            <!-- 商品信息区 -->
            <view class="order-product" bindtap="viewOrderDetail" data-id="{{item.id}}">
              <image class="product-thumb" src="{{item.productImage}}" mode="aspectFill"/>
              <view class="product-info">
                <text class="product-name">{{item.productName}}</text>
                <text class="product-spec">{{item.spec}}</text>
              </view>
              <view class="product-price">
                <text class="price-symbol">¥</text>
                <text class="price-value">{{item.price}}</text>
              </view>
            </view>

            <!-- 时间进度条 -->
            <view class="order-progress-section {{item.status === 'overdue' ? 'overdue' : (item.status === 'nearDeadline' ? 'near-deadline' : '')}}">
              <view class="progress-header">
                <view class="progress-label">
                  <text class="time-title">下单时间</text>
                  <text class="time-value">{{item.createTime}}</text>
                </view>
                <view class="progress-label deadline-label {{item.status === 'overdue' ? 'overdue' : ''}}">
                  <text class="time-title">截稿时间</text>
                  <text class="time-value">{{item.deadline}}</text>
                </view>
              </view>
              <view class="progress-bar-container">
                <view class="progress-bar-bg {{item.status === 'overdue' ? 'overdue' : (item.status === 'nearDeadline' ? 'near-deadline' : '')}}">
                  <view class="progress-bar-fill {{item.status === 'overdue' ? 'overdue' : (item.status === 'nearDeadline' ? 'near-deadline' : '')}}" 
                        style="width: {{item.progressPercent || 50}}%;"></view>
                </view>
              </view>
            </view>

            <!-- 人员信息区（单行） -->
            <view class="order-people-compact">
              <view class="people-item-compact">
                <text class="people-label-small">客户</text>
                <image class="people-avatar-small" src="{{item.buyerAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
                <text class="people-name-compact">{{item.buyerName || '客户'}}</text>
              </view>
              <view class="people-divider-compact"></view>
              <view class="people-item-compact">
                <text class="people-label-small">客服</text>
                <image class="people-avatar-small" src="{{item.serviceAvatar || '/assets/default-avatar.png'}}" mode="aspectFill"/>
                <text class="people-name-compact">{{item.serviceName || '待分配'}}</text>
              </view>
            </view>

            <!-- 操作按钮（只在未完成且未标记完成时显示） -->
            <view wx:if="{{item.status !== 'completed' && item.status !== 'waitingConfirm'}}" class="order-actions">
              <button class="btn-mark-complete" 
                      catchtap="quickMarkComplete" 
                      data-id="{{item.id}}">
                标记完成
              </button>
            </view>
            
            <!-- 已标记完成提示 -->
            <view wx:elif="{{item.status === 'waitingConfirm'}}" class="order-waiting-tip">
              <text class="waiting-text">✓ 已完成，等待客户确认</text>
            </view>
          </view>
          
          <!-- 底部提示 -->
          <view class="list-footer">
            <text class="footer-text">没有更多了</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
