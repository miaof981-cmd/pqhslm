<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>
  
  <view wx:else>
    <!-- 主标签栏 -->
    <view class="main-tabs">
      <view class="main-tab {{currentTab === 'dashboard' ? 'active' : ''}}" data-tab="dashboard" bindtap="switchMainTab">
        <view class="tab-icon icon-dashboard"></view>
        <text>仪表盘</text>
      </view>
      <view class="main-tab {{currentTab === 'product' ? 'active' : ''}}" data-tab="product" bindtap="switchMainTab">
        <view class="tab-icon icon-product"></view>
        <text>商品</text>
      </view>
      <view class="main-tab {{currentTab === 'order' ? 'active' : ''}}" data-tab="order" bindtap="switchMainTab">
        <view class="tab-icon icon-order"></view>
        <text>订单</text>
        <view wx:if="{{pendingOrders > 0}}" class="tab-badge">{{pendingOrders}}</view>
      </view>
      <view class="main-tab {{currentTab === 'artist' ? 'active' : ''}}" data-tab="artist" bindtap="switchMainTab">
        <view class="tab-icon icon-artist"></view>
        <text>画师</text>
      </view>
      <view class="main-tab {{currentTab === 'more' ? 'active' : ''}}" data-tab="more" bindtap="switchMainTab">
        <view class="tab-icon icon-more"></view>
        <text>更多</text>
      </view>
    </view>

    <!-- 1. 仪表盘 -->
    <view wx:if="{{currentTab === 'dashboard'}}" class="tab-content">
      <!-- 时间筛选（仅在仪表盘显示） -->
      <view class="time-filter">
        <view class="filter-item {{timeFilter === 'today' ? 'active' : ''}}" data-filter="today" bindtap="switchTimeFilter">今日</view>
        <view class="filter-item {{timeFilter === 'yesterday' ? 'active' : ''}}" data-filter="yesterday" bindtap="switchTimeFilter">昨日</view>
        <view class="filter-item {{timeFilter === 'week' ? 'active' : ''}}" data-filter="week" bindtap="switchTimeFilter">本周</view>
        <view class="filter-item {{timeFilter === 'month' ? 'active' : ''}}" data-filter="month" bindtap="switchTimeFilter">本月</view>
      </view>

      <!-- 核心数据卡片 -->
      <view class="stats-grid">
        <view class="stat-card" bindtap="goToOrders">
          <view class="stat-label">订单数</view>
          <view class="stat-value">{{dashboard.orderCount}}<text class="stat-unit">笔</text></view>
          <view class="stat-trend">较昨日 {{dashboard.orderTrend}}</view>
        </view>

        <view class="stat-card" bindtap="goToUsers">
          <view class="stat-label">下单人数</view>
          <view class="stat-value">{{dashboard.buyerCount}}<text class="stat-unit">人</text></view>
          <view class="stat-trend">较昨日 {{dashboard.buyerTrend}}</view>
        </view>

        <view class="stat-card" bindtap="goToOrders">
          <view class="stat-label">成交金额</view>
          <view class="stat-value">{{dashboard.revenue}}<text class="stat-unit">元</text></view>
          <view class="stat-trend">较昨日 {{dashboard.revenueTrend}}</view>
        </view>

        <view class="stat-card" bindtap="goToRefunds">
          <view class="stat-label">退款金额</view>
          <view class="stat-value">{{dashboard.refundAmount}}<text class="stat-unit">元</text></view>
          <view class="stat-trend">{{dashboard.refundCount}}笔退款</view>
        </view>

        <view class="stat-card" bindtap="goToArtists">
          <view class="stat-label">画师数</view>
          <view class="stat-value">{{dashboard.artistCount}}<text class="stat-unit">人</text></view>
          <view class="stat-trend">活跃 {{dashboard.activeArtists}}人</view>
        </view>

        <view class="stat-card" bindtap="goToUsers">
          <view class="stat-label">用户数</view>
          <view class="stat-value">{{dashboard.userCount}}<text class="stat-unit">人</text></view>
          <view class="stat-trend">新增 {{dashboard.newUsers}}人</view>
        </view>
      </view>

      <!-- 待处理事项 -->
      <view class="pending-section">
        <view class="section-title">待处理事项</view>
        <view class="pending-list">
          <view class="pending-item" bindtap="goToPendingOrders">
            <view class="pending-info">
              <text class="pending-title">待处理订单</text>
              <text class="pending-desc">需要确认的订单</text>
            </view>
            <view class="pending-count">{{pendingOrders}}</view>
          </view>
          <view class="pending-item" bindtap="goToOverdueOrders">
            <view class="pending-info">
              <text class="pending-title">拖稿订单</text>
              <text class="pending-desc">超时未交付</text>
            </view>
            <view class="pending-count warning">{{overdueOrders}}</view>
          </view>
          <view class="pending-item" bindtap="goToReviewManage">
            <view class="pending-info">
              <text class="pending-title">画师审核</text>
              <text class="pending-desc">待审核</text>
            </view>
            <view class="pending-count">{{pendingApplications}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 2. 商品管理 -->
    <view wx:if="{{currentTab === 'product'}}" class="tab-content">
      <view class="section-header">
        <text class="section-title">商品管理</text>
        <button class="add-btn" bindtap="addProduct">+ 添加商品</button>
      </view>

      <!-- 商品筛选 -->
      <view class="filter-bar">
        <view class="filter-item {{productFilter === 'all' ? 'active' : ''}}" data-filter="all" bindtap="filterProducts">全部</view>
        <view class="filter-item {{productFilter === 'online' ? 'active' : ''}}" data-filter="online" bindtap="filterProducts">已上架</view>
        <view class="filter-item {{productFilter === 'offline' ? 'active' : ''}}" data-filter="offline" bindtap="filterProducts">已下架</view>
        <view class="filter-item {{productFilter === 'hot' ? 'active' : ''}}" data-filter="hot" bindtap="filterProducts">热销</view>
      </view>

      <!-- 搜索栏 -->
      <view class="search-bar">
        <input class="search-input" placeholder="搜索商品名称" bindinput="searchProducts" />
      </view>

      <!-- 商品列表 -->
      <view class="product-list">
        <view wx:for="{{products}}" wx:key="_id" class="product-item">
          <image class="product-image" src="{{item.image}}" mode="aspectFill" />
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <view class="product-meta">
              <text class="product-category">{{item.category}}</text>
              <text class="product-price">¥{{item.price}}</text>
            </view>
            <view class="product-tags">
              <text wx:if="{{item.isHot}}" class="tag hot">热销</text>
              <text wx:if="{{item.isRecommend}}" class="tag recommend">推荐</text>
              <text wx:if="{{item.isSpecial}}" class="tag special">特价</text>
            </view>
          </view>
          <view class="product-actions">
            <view class="product-status status-{{item.status}}">{{item.status === 'online' ? '已上架' : '已下架'}}</view>
            <button class="action-btn" data-id="{{item._id}}" bindtap="editProduct">编辑</button>
            <button class="action-btn" data-id="{{item._id}}" data-status="{{item.status}}" bindtap="toggleProductStatus">
              {{item.status === 'online' ? '下架' : '上架'}}
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- 3. 订单管理 -->
    <view wx:if="{{currentTab === 'order'}}" class="tab-content">
      <!-- 顶部操作栏 -->
      <view class="order-header-bar">
        <text class="section-title">订单管理</text>
        <view class="header-actions">
          <input class="search-input-inline" placeholder="搜索订单" bindinput="searchOrders" />
          <button class="export-btn-small" bindtap="exportOrders">导出</button>
        </view>
      </view>

      <!-- 订单筛选 -->
      <scroll-view class="filter-scroll" scroll-x>
        <view class="filter-bar-compact">
          <view class="filter-item {{orderFilter === 'all' ? 'active' : ''}}" data-filter="all" bindtap="filterOrders">
            全部<text class="filter-count">{{orderStats.all}}</text>
          </view>
          <view class="filter-item {{orderFilter === 'unpaid' ? 'active' : ''}}" data-filter="unpaid" bindtap="filterOrders">
            待支付<text class="filter-count">{{orderStats.unpaid}}</text>
          </view>
          <view class="filter-item {{orderFilter === 'processing' ? 'active' : ''}}" data-filter="processing" bindtap="filterOrders">
            制作中<text class="filter-count">{{orderStats.processing}}</text>
          </view>
          <view class="filter-item {{orderFilter === 'completed' ? 'active' : ''}}" data-filter="completed" bindtap="filterOrders">
            已完成<text class="filter-count">{{orderStats.completed}}</text>
          </view>
          <view class="filter-item {{orderFilter === 'refunding' ? 'active' : ''}}" data-filter="refunding" bindtap="filterOrders">
            退款中<text class="filter-count">{{orderStats.refunding}}</text>
          </view>
        </view>
      </scroll-view>

      <!-- 订单列表 -->
      <view class="order-list">
        <view wx:for="{{orders}}" wx:key="_id" class="order-item" bindtap="viewOrderDetail" data-id="{{item._id}}">
          <view class="order-header">
            <text class="order-no">{{item.orderNo}}</text>
            <view class="order-status status-{{item.status}}">{{item.statusText}}</view>
          </view>
          <view class="order-content">
            <image class="order-image" src="{{item.productImage}}" mode="aspectFill" />
            <view class="order-info">
              <text class="order-product">{{item.productName}}</text>
              <text class="order-user">买家：{{item.userName}}</text>
              <text class="order-artist">画师：{{item.artistName}}</text>
              <text class="order-time">下单：{{item.createTime}}</text>
              <text wx:if="{{item.deadline}}" class="order-deadline {{item.isOverdue ? 'overdue' : ''}}">
                截稿：{{item.deadline}} {{item.isOverdue ? '(已超时)' : ''}}
              </text>
            </view>
          </view>
          <view class="order-footer">
            <text class="order-amount">¥{{item.amount}}</text>
            <view class="order-actions">
              <button wx:if="{{item.status === 'refunding'}}" class="action-btn warning" data-id="{{item._id}}" catchtap="processRefund">处理退款</button>
              <button class="action-btn default" data-id="{{item._id}}" catchtap="viewOrderDetail">详情</button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 4. 画师管理 -->
    <view wx:if="{{currentTab === 'artist'}}" class="tab-content">
      <view class="sub-tabs">
        <view class="sub-tab {{artistTab === 'list' ? 'active' : ''}}" data-tab="list" bindtap="switchArtistTab">画师列表</view>
        <view class="sub-tab {{artistTab === 'performance' ? 'active' : ''}}" data-tab="performance" bindtap="switchArtistTab">业绩排行</view>
      </view>

      <!-- 画师列表 -->
      <view wx:if="{{artistTab === 'list'}}">
        <view class="artist-list">
          <view wx:for="{{artists}}" wx:key="_id" class="artist-item" bindtap="viewArtistDetail" data-id="{{item._id}}">
            <image class="artist-avatar" src="{{item.avatar}}" mode="aspectFill" />
            <view class="artist-info">
              <view class="artist-name-row">
                <text class="artist-name">{{item.name}}</text>
              </view>
              <text class="artist-meta">入驻：{{item.joinTime}}</text>
              <text class="artist-meta">作品：{{item.productCount}}个 | 订单：{{item.orderCount}}单</text>
              <text class="artist-meta">收入：¥{{item.totalRevenue}}</text>
            </view>
            <view class="artist-actions">
              <view class="artist-status status-{{item.status}}">{{item.statusText}}</view>
              <button class="action-btn" data-id="{{item._id}}" catchtap="editArtist">管理</button>
            </view>
          </view>
        </view>
      </view>

      <!-- 业绩排行 -->
      <view wx:if="{{artistTab === 'performance'}}">
        <view class="performance-list">
          <view wx:for="{{artistPerformance}}" wx:key="_id" class="performance-item">
            <view class="rank-badge rank-{{index + 1}}">{{index + 1}}</view>
            <image class="artist-avatar-small" src="{{item.avatar}}" mode="aspectFill" />
            <view class="performance-info">
              <text class="artist-name">{{item.name}}</text>
              <text class="performance-data">订单：{{item.orderCount}}单 | 收入：¥{{item.revenue}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 5. 更多功能 -->
    <view wx:if="{{currentTab === 'more'}}" class="tab-content">
      <view class="more-grid">
        <view class="more-item" bindtap="goToCategories">
          <view class="more-icon icon-category"></view>
          <text class="more-label">分类管理</text>
        </view>
        <view class="more-item" bindtap="goToUsers">
          <view class="more-icon icon-users"></view>
          <text class="more-label">用户管理</text>
        </view>
        <view class="more-item" bindtap="goToCustomerService">
          <view class="more-icon icon-service"></view>
          <text class="more-label">客服管理</text>
        </view>
        <view class="more-item" bindtap="goToStaffQRCode">
          <view class="more-icon icon-qrcode"></view>
          <text class="more-label">工作人员二维码</text>
        </view>
        <view class="more-item" bindtap="goToStaff">
          <view class="more-icon icon-staff"></view>
          <text class="more-label">人员管理</text>
        </view>
        <view class="more-item" bindtap="goToReports">
          <view class="more-icon icon-report"></view>
          <text class="more-label">业绩统计</text>
        </view>
        <view class="more-item" bindtap="goToMedia">
          <view class="more-icon icon-media"></view>
          <text class="more-label">资源管理</text>
        </view>
        <view class="more-item" bindtap="goToBanners">
          <view class="more-icon icon-banner"></view>
          <text class="more-label">轮播图</text>
        </view>
        <view class="more-item" bindtap="goToNotices">
          <view class="more-icon icon-notice"></view>
          <text class="more-label">公告管理</text>
        </view>
        <view class="more-item" bindtap="goToSettings">
          <view class="more-icon icon-settings"></view>
          <text class="more-label">系统设置</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 编辑画师弹窗 -->
  <view wx:if="{{showEditArtistModal}}" class="modal-overlay" bindtap="closeEditArtistModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">画师信息</text>
        <view class="modal-close" bindtap="closeEditArtistModal">×</view>
      </view>
      
      <view class="modal-body">
        <!-- 权限开通（置顶） -->
        <view wx:if="{{!editingArtist.hasPermission}}" class="permission-section">
          <view class="section-title">开通工作台权限</view>
          <view class="permission-hint">开通后将自动分配画师编号</view>
          <button class="btn-grant-permission" bindtap="grantArtistPermission">开通权限</button>
        </view>
        
        <!-- 权限管理（已开通） -->
        <view wx:else class="permission-granted-section">
          <view class="section-title">权限状态</view>
          
          <!-- 权限状态卡片 -->
          <view class="permission-status-card">
            <view class="status-icon-large">✓</view>
            <view class="status-info">
              <text class="status-title">工作台权限已开通</text>
              <text class="status-subtitle">画师编号：{{editingArtist.artistNumber || '未分配'}}</text>
            </view>
          </view>
          
          <!-- 企业微信ID -->
          <view class="wechat-id-section">
            <view class="id-label">企业昵称：</view>
            <view class="id-display">
              <text class="id-value">联盟id{{editingArtist.artistNumber}}{{editingArtist.realName || editingArtist.name}}</text>
              <button class="btn-copy-id" bindtap="copyWechatId" data-id="联盟id{{editingArtist.artistNumber}}{{editingArtist.realName || editingArtist.name}}">复制</button>
            </view>
            <view class="id-hint">用于企业微信昵称设置，方便订单分配</view>
          </view>
          
        </view>
        
        <!-- 基础信息 -->
        <view class="info-section">
          <view class="section-title">基础信息</view>
          
          <view class="info-row">
            <text class="info-label">用户ID</text>
            <text class="info-value">{{editingArtist.userId}}</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">画师编号</text>
            <text class="info-value">{{editingArtist.artistNumber || '未分配'}}</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">画师昵称</text>
            <text class="info-value">{{editingArtist.name}}</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">入驻时间</text>
            <text class="info-value">{{editingArtist.joinTime}}</text>
          </view>
        </view>
        
        <!-- 联系方式 -->
        <view class="info-section">
          <view class="section-title">联系方式</view>
          
          <view class="info-row">
            <text class="info-label">联系电话</text>
            <text class="info-value">{{editingArtist.contactPhone || '未填写'}}</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">联系微信</text>
            <text class="info-value">{{editingArtist.wechat || '未填写'}}</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">紧急联系人</text>
            <text class="info-value">{{editingArtist.emergencyName || '未填写'}} ({{editingArtist.emergencyRelation || '-'}})</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">紧急联系电话</text>
            <text class="info-value">{{editingArtist.emergencyPhone || '未填写'}}</text>
          </view>
        </view>
        
        <!-- 商品管理 -->
        <view class="info-section">
          <view class="section-title">商品管理</view>
          
          <!-- 查看商品 -->
          <button class="action-btn-view-products" bindtap="manageArtistProducts">
            <text class="btn-icon">📦</text>
            <text class="btn-text">查看该画师的所有商品</text>
            <text class="btn-arrow">›</text>
          </button>
          
          <!-- 商品状态开关 -->
          <view class="info-row" style="align-items: center; margin-top: 24rpx;">
            <text class="info-label">商品销售状态</text>
            <view class="status-switch-group">
              <switch checked="{{!editingArtist.allProductsOffline}}" bindchange="toggleProductsStatus" color="#66BB6A"/>
              <text class="status-text {{editingArtist.allProductsOffline ? 'status-offline' : 'status-online'}}">
                {{editingArtist.allProductsOffline ? '全部已下架' : '正常销售中'}}
              </text>
            </view>
          </view>
          
          <view class="offline-hint">
            <text class="hint-icon">⚠️</text>
            <text class="hint-text">关闭后，商品将不显示在商城，已加入购物车的也无法购买，但画师仍可处理现有订单</text>
          </view>
        </view>
        
        <!-- 业绩数据 -->
        <view class="info-section">
          <view class="section-title">业绩数据</view>
          
          <view class="info-row">
            <text class="info-label">作品数量</text>
            <text class="info-value">{{editingArtist.productCount}}个</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">订单数量</text>
            <text class="info-value">{{editingArtist.orderCount}}单</text>
          </view>
          
          <view class="info-row">
            <text class="info-label">总收入</text>
            <text class="info-value">¥{{editingArtist.totalRevenue}}</text>
          </view>
        </view>
        
        <!-- 危险操作区 -->
        <view class="danger-section">
          <view class="section-title" style="color: #FF6B6B;">危险操作</view>
          <button class="btn-revoke-permission" bindtap="revokeArtistPermission">撤销工作台权限</button>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeEditArtistModal">取消</button>
        <button class="modal-btn confirm-btn" bindtap="saveArtistEdit">保存</button>
      </view>
    </view>
  </view>
</view>
