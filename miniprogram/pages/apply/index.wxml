<view class="container">
  <view class="header-section">
    <view class="header-title">画师认证申请</view>
    <view class="header-subtitle">加入联盟，开启您的创作之旅</view>
    
    <!-- ✅ 申请记录按钮（如果有申请记录） -->
    <view wx:if="{{hasApplicationHistory}}" class="history-btn" bindtap="showApplicationHistory">
      <text class="history-btn-text">查看申请记录</text>
      <text wx:if="{{applicationStatus === 'pending'}}" class="history-badge pending">审核中</text>
      <text wx:elif="{{applicationStatus === 'rejected'}}" class="history-badge rejected">未通过</text>
    </view>
  </view>

  <!-- ✅ 申请记录弹窗 -->
  <view wx:if="{{showHistoryModal}}" class="modal-overlay" bindtap="hideApplicationHistory">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">申请记录</text>
        <view class="modal-close" bindtap="hideApplicationHistory">✕</view>
      </view>
      
      <scroll-view class="modal-body" scroll-y>
        <view wx:for="{{applicationHistory}}" wx:key="id" class="history-item status-{{item.status}}">
          <view class="history-item-header">
            <view class="history-status">
              <text wx:if="{{item.status === 'pending'}}" class="status-badge pending">⏳ 审核中</text>
              <text wx:elif="{{item.status === 'approved'}}" class="status-badge approved">✓ 已通过</text>
              <text wx:elif="{{item.status === 'rejected'}}" class="status-badge rejected">✕ 未通过</text>
            </view>
            <text class="history-time">{{item.submitTime}}</text>
          </view>
          
          <!-- 驳回原因 -->
          <view wx:if="{{item.status === 'rejected'}}" class="history-reject-reason">
            <text class="reason-label">驳回原因：</text>
            <text class="reason-text">{{item.rejectReason}}</text>
            <text class="reason-time">驳回时间：{{item.rejectTime}}</text>
          </view>
          
          <!-- 通过信息 -->
          <view wx:if="{{item.status === 'approved'}}" class="history-approve-info">
            <text class="approve-text">通过时间：{{item.approveTime}}</text>
          </view>
        </view>
        
        <view wx:if="{{applicationHistory.length === 0}}" class="empty-history">
          <text>暂无申请记录</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="form-section">
    <!-- 基本信息 -->
    <view class="section-card">
      <view class="section-title">
        <view class="title-icon"></view>
        <text class="title-text">基本信息</text>
      </view>
      
      <view class="input-group">
        <view class="input-label">
          <text class="label-text">真实姓名</text>
          <text class="required">*</text>
        </view>
        <input class="input-field" 
               placeholder="请输入您的真实姓名" 
               value="{{formData.name}}"
               bindinput="onNameInput" />
      </view>

      <view class="input-group">
        <view class="input-label">
          <text class="label-text">真实年龄</text>
          <text class="required">*</text>
        </view>
        <input class="input-field" 
               type="number"
               placeholder="请输入您的年龄" 
               value="{{formData.age}}"
               bindinput="onAgeInput" />
      </view>

      <view class="input-group">
        <view class="input-label">
          <text class="label-text">联系微信</text>
          <text class="required">*</text>
        </view>
        <input class="input-field" 
               placeholder="请输入您的微信号" 
               value="{{formData.wechat}}"
               bindinput="onWechatInput" />
        <view class="input-hint">用于接收订单通知和沟通</view>
      </view>
    </view>

    <!-- 价格信息 -->
    <view class="section-card">
      <view class="section-title">
        <view class="title-icon"></view>
        <text class="title-text">价格信息</text>
      </view>
      
      <view class="input-group">
        <view class="input-label">
          <text class="label-text">理想稿酬（元）</text>
          <text class="required">*</text>
        </view>
        <input class="input-field" 
               type="digit"
               placeholder="如：200" 
               value="{{formData.idealPrice}}"
               bindinput="onIdealPriceInput" />
        <view class="input-hint">您期望的单件作品价格</view>
      </view>

      <view class="input-group">
        <view class="input-label">
          <text class="label-text">最低可接受价格（元）</text>
          <text class="required">*</text>
        </view>
        <input class="input-field" 
               type="digit"
               placeholder="如：100" 
               value="{{formData.minPrice}}"
               bindinput="onMinPriceInput" />
        <view class="input-hint">低于此价格的订单您可以选择拒绝</view>
      </view>
    </view>

    <!-- 作品展示 -->
    <view class="section-card">
      <view class="section-title">
        <view class="title-icon"></view>
        <text class="title-text">作品展示</text>
      </view>
      
      <view class="upload-group">
        <view class="upload-label">
          <text class="label-text">满意的作品</text>
          <text class="required">*</text>
        </view>
        <view class="upload-hint-top">请上传您最满意的作品，展示您的绘画风格和水平（至少4张，最多9张）</view>
        <view class="image-grid">
          <view wx:for="{{formData.finishedWorks}}" wx:key="*this" class="image-item">
            <image src="{{item}}" mode="aspectFill" />
            <view class="delete-btn" data-type="finishedWorks" data-index="{{index}}" bindtap="deleteImage">
              <view class="delete-icon"></view>
            </view>
          </view>
          <view wx:if="{{formData.finishedWorks.length < 9}}" 
                class="upload-btn" 
                data-type="finishedWorks"
                bindtap="chooseImages">
            <view class="upload-icon"></view>
            <text class="upload-text">添加作品</text>
            <text class="upload-count">{{formData.finishedWorks.length}}/9</text>
          </view>
        </view>
      </view>

      <view class="upload-group">
        <view class="upload-label">
          <text class="label-text">绘画过程（图层截图）</text>
          <text class="required">*</text>
        </view>
        <view class="upload-hint-top">请直接截图画面图层，证明作品原创性（至少1张，最多9张）</view>
        <view class="image-grid">
          <view wx:for="{{formData.processImages}}" wx:key="*this" class="image-item">
            <image src="{{item}}" mode="aspectFill" />
            <view class="delete-btn" data-type="processImages" data-index="{{index}}" bindtap="deleteImage">
              <view class="delete-icon"></view>
            </view>
          </view>
          <view wx:if="{{formData.processImages.length < 9}}" 
                class="upload-btn" 
                data-type="processImages"
                bindtap="chooseImages">
            <view class="upload-icon"></view>
            <text class="upload-text">添加图层截图</text>
            <text class="upload-count">{{formData.processImages.length}}/9</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 会员制条款 -->
    <view class="section-card agreement-card">
      <view class="agreement-checkbox" bindtap="toggleAgreement">
        <view class="checkbox {{agreedToTerms ? 'checked' : ''}}">
          <view wx:if="{{agreedToTerms}}" class="checkbox-icon"></view>
        </view>
        <text class="checkbox-text">我已知悉联盟是会员制</text>
      </view>

      <view class="expand-btn" bindtap="toggleTermsDetail">
        <text class="expand-text">{{showTermsDetail ? '收起详情' : '查看详细条款'}}</text>
        <view class="expand-icon {{showTermsDetail ? 'expanded' : ''}}"></view>
      </view>

      <view wx:if="{{showTermsDetail}}" class="agreement-detail">
        <view class="agreement-text">
          1. 联盟采用会员制运营模式，画师需缴纳会员费后方可接单。
        </view>
        <view class="agreement-text">
          2. 会员费首月19.9元用于评估收益，次月起29.9元/月，不可退还。
        </view>
        <view class="agreement-text">
          3. 会员有效期内，画师可自由上架商品、接收订单。
        </view>
        <view class="agreement-text">
          4. 会员到期后，商品将自动下架，需续费后重新上架。
        </view>
        <view class="agreement-text">
          5. 画师需保证作品原创性，不得抄袭、盗用他人作品。
        </view>
        <view class="agreement-text">
          6. 画师需按时交稿，如有延期需提前与客户沟通。
        </view>
        <view class="agreement-text">
          7. 平台会收取一定比例的服务费用于承担工作人员工资。
        </view>
        <view class="agreement-text">
          8. 违反规定的画师将被取消会员资格，不予退费。
        </view>
        <view class="agreement-text final">
          如不同意管理制度请勿投递，直接退出即可。
        </view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <button class="submit-btn {{agreedToTerms ? '' : 'disabled'}}" 
            bindtap="submitApplication"
            disabled="{{!agreedToTerms}}">
      提交申请
    </button>
    
    <view class="submit-hint">提交后请耐心等待管理员审核，我们会在1-3个工作日内给您答复</view>
  </view>
</view>
