# 人员管理分成逻辑说明

## 📋 两个开关的职责

### 1️⃣ **订单分成开关** (`enableShare`)
- **作用**：控制该管理员是否参与订单分成
- **场景**：
  - ✅ **开启**：这个人参与分成（需要配置分成金额）
  - ❌ **关闭**：这个人不参与分成（即使在职也不分钱）
- **典型用途**：
  - 有些管理员是固定工资，不需要订单提成
  - 临时调整某人的分成资格

### 2️⃣ **在职状态开关** (`isActive`)
- **作用**：控制该管理员是否在职
- **场景**：
  - ✅ **开启**：管理员在职，正常工作
  - ❌ **关闭**：管理员已离职/停职，完全停止参与分成
- **典型用途**：
  - 员工离职时关闭
  - 临时停职时关闭

---

## 🎯 分成条件（AND 逻辑）

**只有同时满足以下三个条件，才会参与【新完成】的订单分成：**

```
✅ isActive = true       (在职)
AND
✅ enableShare = true    (开启分成)
AND  
✅ shareAmount > 0       (分成金额大于0)
```

---

## ⏰ 时间逻辑（关键！）

### **只影响未来，不追溯历史**

```
订单A：2025-01-01 完成 → 当时管理员【已启用分成】→ ✅ 已分成
订单B：2025-01-05 完成 → 当时管理员【未启用分成】→ ❌ 不分成
    
👉 2025-01-10 新加入管理员C，开启分成

订单C：2025-01-15 完成 → C 参与分成 ✅
订单A/B：历史订单 → C 不参与 ❌ (不会追溯)
```

### **防止新人分走老订单收入**

- ❌ **不会**：新员工入职后，把之前已完成的订单重新分一遍
- ✅ **只会**：新员工从入职后完成的新订单开始分成

---

## 🔄 调整分成的场景

| 场景 | 操作 | 结果 |
|------|------|------|
| 员工离职 | 关闭"在职状态" | 从关闭时刻起，新订单不再分成 |
| 调整分成金额 | 修改"每单分成金额" | 只影响修改后完成的订单 |
| 临时取消分成 | 关闭"订单分成"开关 | 暂停分成，不影响在职状态 |
| 恢复分成 | 重新开启"订单分成" | 从开启时刻起恢复分成 |

---

## 💡 实际例子

### 例1：新员工入职
```
时间轴：
01-01: 订单1 完成（老员工A分成¥5）
01-05: 新员工B入职，开启分成¥3
01-10: 订单2 完成（老员工A分成¥5，新员工B分成¥3）

结果：
- 订单1：只有A分成 ✅
- 订单2：A和B都分成 ✅
- B不会分走订单1的钱 ✅
```

### 例2：调整分成金额
```
时间轴：
员工C原本每单¥5
01-01: 订单1 完成（C分成¥5）
01-05: 调整C的分成为¥8
01-10: 订单2 完成（C分成¥8）

结果：
- 订单1：按调整前的¥5 ✅
- 订单2：按调整后的¥8 ✅
- 不会回头把订单1改成¥8 ✅
```

### 例3：临时停职
```
时间轴：
01-01: 员工D分成正常（订单1，分成¥4）
01-05: 关闭D的"订单分成"开关
01-10: 订单2 完成（D不分成）
01-15: 重新开启D的"订单分成"
01-20: 订单3 完成（D分成¥4）

结果：
- 订单1：D分成 ✅
- 订单2：D不分成 ✅
- 订单3：D分成 ✅
```

---

## 🛡️ 防重复机制

- 每个订单 + 每个管理员 = 唯一分成记录
- 即使多次调用分成函数，同一订单对同一人只会分成一次
- 代码通过 `buildLedgerKey(orderId, staffId)` 实现去重

---

## 📊 查看分成记录

### 管理员视角
- 登录后进入"提现页"
- 可查看自己的分成收入明细
- 余额 = 打赏收入 + 订单分成 - 已提现

### 后台视角
- 人员管理页可看到每个人的配置
- 收入明细页可看到所有分成记录

---

## ⚙️ 技术实现

### 数据结构
```javascript
{
  _id: '1234567890_abc123',
  name: '张三',
  role: '视频专员',
  userId: '1001',
  enableShare: true,       // 🎯 订单分成开关
  shareAmount: 5.00,       // 每单分成金额
  isActive: true,          // 🎯 在职状态开关
  description: '负责视频剪辑',
  createdAt: '2025-01-01T00:00:00.000Z',
  updatedAt: '2025-01-10T10:30:00.000Z'
}
```

### 分成记录
```javascript
{
  id: '1736745600000_xyz789',
  orderId: '202501150001',
  staffId: '1234567890_abc123',
  staffName: '张三',
  userId: '1001',
  amount: 5.00,
  type: 'order_share',
  orderCompletedAt: '2025-01-15T14:30:00.000Z',
  createdAt: '2025-01-15T14:30:05.000Z',
  note: '视频专员分成'
}
```

---

## ✅ 总结

1. **两个开关独立但都有效**：
   - "订单分成" = 是否参与分成
   - "在职状态" = 是否在职

2. **只影响未来，不追溯历史**：
   - 所有配置变更只对之后完成的订单生效
   - 已分成的历史订单不会改变

3. **防重复机制**：
   - 同一订单对同一人只分成一次
   - 不会重复扣款

4. **灵活控制**：
   - 可以让在职员工不分成（固定工资）
   - 可以临时停止某人的分成资格
   - 可以随时调整分成金额

