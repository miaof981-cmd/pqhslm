# 🛡️ 防误删代码工作流程规范

## 📋 问题回顾

### 本次误删事件
**时间**: 2025-10-28  
**事件**: 在回退到 `428c197` 版本后，发现：
1. ❌ 订单状态胶囊样式的**新状态颜色定义**缺失（`inProgress`、`overdue`、`nearDeadline`、`waitingConfirm`）
2. ✅ 精确24小时脱稿计算逻辑**未丢失**（虽然担心了，但实际还在）
3. ❌ 新状态的 UI 显示条件判断缺失，导致功能失效

### 根本原因分析
1. **版本回退时未全面审查差异**：
   - 使用 `git reset --hard` 回退版本时，没有先对比差异文件
   - 没有识别出哪些修改是"新功能"，哪些是"修复bug"
   
2. **新功能迁移时遗漏关联代码**：
   - 迁移到"统一工具函数"时，引入了新的状态名称（`overdue`、`nearDeadline` 等）
   - 但未同步更新所有相关的 UI 判断和样式定义
   
3. **缺乏变更影响分析**：
   - 修改状态名称是一个"破坏性变更"
   - 应该检查所有使用该状态的地方（WXML、WXSS、JS）

---

## 🔒 防误删工作流程

### ✅ 规则 1: 版本回退前必须对比差异

**命令模板**：
```bash
# 1. 先查看要回退的范围
git log --oneline <目标版本>..HEAD

# 2. 对比差异文件列表
git diff --name-status <目标版本> HEAD

# 3. 对比具体差异内容
git diff <目标版本> HEAD

# 4. 识别关键修改，决定是否需要保留
```

**决策标准**：
- ✅ **可以丢弃的修改**：
  - 错误的修复尝试
  - 临时调试代码
  - 完全错误的功能实现
  
- ❌ **不能丢弃的修改**：
  - 样式优化（除非明确要求回退）
  - 精确计算逻辑（如24小时精确脱稿）
  - 新增的必要状态和字段
  - UI 适配和兼容性修复

---

### ✅ 规则 2: 破坏性变更必须全局检查

**什么是破坏性变更**：
- 修改字段名称（如 `processing` → `inProgress`）
- 修改状态值（如增加 `overdue`、`nearDeadline`）
- 修改数据结构
- 修改函数签名

**全局检查清单**：

#### 1️⃣ 搜索所有使用该字段的地方
```bash
# 搜索状态名在 WXML 中的使用
grep -r "status === 'processing'" miniprogram/

# 搜索 WXSS 中的类名
grep -r "status-processing" miniprogram/
```

#### 2️⃣ 更新所有相关文件
- [ ] **WXML**: 条件渲染 (`wx:if`、`wx:elif`)
- [ ] **WXSS**: 状态样式类 (`.status-xxx`)
- [ ] **JS**: 状态判断逻辑
- [ ] **JS**: 状态映射/转换函数

#### 3️⃣ 创建兼容性处理
```javascript
// 示例：同时支持新旧状态名
wx:if="{{item.status === 'processing' || item.status === 'inProgress'}}"
```

---

### ✅ 规则 3: 修改前创建检查清单

**操作步骤**：

1. **识别影响范围**：
   ```
   修改类型：[字段重命名 / 新增状态 / 删除功能]
   影响文件：
   - pages/order-list/index.wxml
   - pages/order-list/index.wxss
   - pages/order-list/index.js
   - pages/workspace/index.js
   - ...
   ```

2. **创建测试点清单**：
   ```
   测试点：
   - [ ] 订单列表页状态显示正确
   - [ ] 进度条颜色根据状态变化
   - [ ] 脱稿天数显示正确
   - [ ] 操作按钮显示正确
   - [ ] 胶囊样式显示正确
   ```

3. **执行变更后逐一验证**：
   - 不能只看代码，必须实际运行测试
   - 检查控制台是否有错误
   - 手动点击每个功能

---

### ✅ 规则 4: Git 提交信息必须详细

**标准格式**：
```
<type>: <简短描述>

🐛 问题诊断:
- 具体问题描述
- 受影响的功能

✅ 修复方案:
1. 文件A: 修改内容
2. 文件B: 修改内容

💡 根本原因:
- 为什么会发生这个问题

⚠️ 影响范围:
- 哪些页面/功能受到影响
```

**示例**：
```
fix: 恢复用户订单页面进度条和状态显示

🐛 问题诊断:
- 工具函数将状态改为 overdue/nearDeadline
- 原有进度条判断条件 status === 'processing' 不再匹配
- 导致进度条完全不显示

✅ 修复方案:
1. WXML: 新增 inProgress/overdue/nearDeadline 状态判断
2. WXSS: 添加新状态的胶囊样式
3. JS: 结合工具函数状态和本地计算

💡 根本原因:
迁移到统一工具后，未同步更新UI的状态判断逻辑

⚠️ 影响范围:
- pages/order-list/index（用户订单页）
```

---

### ✅ 规则 5: 代码审查自查清单

**提交前自查**：

```
代码变更自查清单：

□ 是否有删除现有功能？
  - 如果是，用户是否明确要求？
  - 是否有替代方案？

□ 是否修改了字段名/状态值？
  - 是否检查了所有使用该字段的地方？
  - 是否更新了对应的样式和判断逻辑？

□ 是否有新增状态/类型？
  - 是否添加了对应的样式定义？
  - 是否更新了所有条件判断？

□ 是否修改了计算逻辑？
  - 是否保留了精确性（如24小时精确计算）？
  - 是否考虑了边界情况？

□ 是否有样式变化？
  - 新状态是否有对应的样式？
  - 样式是否与现有风格一致？

□ 提交信息是否完整？
  - 是否说明了修改原因？
  - 是否列出了影响范围？
  - 是否提供了测试建议？
```

---

## 🚀 快速修复流程

**当发现误删时**：

1. **立即停止继续修改**
2. **对比差异，找到丢失的代码**：
   ```bash
   git diff <好的版本> <当前版本> -- <文件路径>
   ```
3. **从历史版本恢复代码**：
   ```bash
   git show <好的版本>:<文件路径>
   ```
4. **手动补全缺失部分**
5. **运行完整测试**
6. **提交修复并详细说明**

---

## 📝 本次修复记录

### 修复内容
1. ✅ 补全订单状态胶囊样式（新增 `inProgress`、`overdue`、`nearDeadline`、`waitingConfirm` 样式）
2. ✅ 确认精确24小时脱稿计算逻辑仍然存在
3. ✅ 更新 WXML 进度条显示条件，支持新状态名称

### 修复文件
- `miniprogram/pages/order-list/index.wxss`：新增状态样式
- `miniprogram/pages/order-list/index.wxml`：已在之前修复
- `miniprogram/pages/order-list/index.js`：已在之前修复

### 测试验证
- [ ] 订单状态胶囊颜色正确显示（绿/橙/红/金）
- [ ] 进度条显示正常
- [ ] 脱稿天数精确计算（满24小时才算1天）
- [ ] 操作按钮正确显示

---

## 💡 总结

**核心原则**：
1. **谨慎回退版本**：先对比差异再决定
2. **全局影响分析**：修改字段/状态必须检查所有关联
3. **详细提交信息**：方便日后追溯
4. **完整测试验证**：不只看代码，要实际运行

**记住**：
> 代码的每一次删除都应该是**有意识的决策**，而不是**无意的疏忽**。

