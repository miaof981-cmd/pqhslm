# 云数据库权限设置 - 最终修正版

> **审查结论**：原方案存在多角色访问缺陷  
> **修正人**：用户精准核对  
> **更新时间**：2025-11-12

---

## 🎯 完整权限配置表（最终版）

| 集合名称 | 业务场景 | 推荐权限 | 权限JSON |
|---------|---------|---------|----------|
| `products` | 商品展示 | 所有用户可读，仅创建者可写 | 默认选项 |
| `banners` | 轮播图 | 所有用户可读，仅创建者可写 | 默认选项 |
| `notices` | 公告 | 所有用户可读，仅创建者可写 | 默认选项 |
| `categories` | 分类 | 所有用户可读，仅创建者可写 | 默认选项 |
| `service_qrcodes` | 客服二维码 | 所有用户可读，仅创建者可写 | 默认选项 |
| `users` | 用户表 | 创建者和管理员可读写 | 见JSON-1 |
| `buyer_shows` | 买家秀 | 所有人可读，作者可写 | 见JSON-2 |
| `orders` | 订单表 | 相关角色可读，部分可写 | 见JSON-3 |
| `artist_applications` | 画师申请 | 创建者和管理员可读写 | 见JSON-4 |
| `income_ledger` | 收入账本 | 创建者和管理员可读写 | 见JSON-5 |
| `withdraw_records` | 提现记录 | 创建者和管理员可读写 | 见JSON-6 |
| `reward_records` | 打赏记录 | 三方可读，部分可写 | 见JSON-7 |

---

## 📋 自定义权限规则（JSON配置）

### JSON-1: users（用户表）
**需求**：管理员查看所有用户，用户可编辑自己资料

```json
{
  "read": true,
  "write": "doc._openid == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- `read: true` - 所有人可读（用于显示昵称头像）
- 写入条件：
  - `doc._openid == auth.openid` - 本人可写
  - `get('database.system_admin.$(auth.openid)').isAdmin == true` - 管理员可写

---

### JSON-2: buyer_shows（买家秀）
**需求**：所有人可查看，作者可编辑自己的秀

```json
{
  "read": true,
  "write": "doc._openid == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- `read: true` - 所有人可读（公开展示）
- 写入条件：
  - `doc._openid == auth.openid` - 作者可编辑自己的秀
  - 管理员可删除不当内容

---

### JSON-3: orders（订单表）⚠️ 最复杂
**需求**：买家、画师、客服、管理员按角色可见

```json
{
  "read": "doc.buyerOpenId == auth.openid || doc.artistOpenId == auth.openid || doc.serviceOpenId == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true",
  "write": "doc.buyerOpenId == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- 读取条件：
  - `doc.buyerOpenId == auth.openid` - 买家可查看自己的订单
  - `doc.artistOpenId == auth.openid` - 画师可查看分配给自己的订单
  - `doc.serviceOpenId == auth.openid` - 客服可查看分配给自己的订单
  - 管理员可查看所有订单
- 写入条件：
  - 买家可修改订单（如取消、确认收货）
  - 管理员可修改订单（如分配客服、退款）
  - ⚠️ 画师/客服修改订单状态建议通过云函数

---

### JSON-4: artist_applications（画师申请）
**需求**：申请人查看自己的申请，管理员审核

```json
{
  "read": "doc._openid == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true",
  "write": "doc._openid == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- 申请人可查看和修改自己的申请
- 管理员可查看所有申请并审核

---

### JSON-5: income_ledger（收入账本）
**需求**：用户查看自己的收入，管理员审核财务

```json
{
  "read": "doc.userId == auth.uid || get('database.system_admin.$(auth.openid)').isAdmin == true",
  "write": "get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- 读取条件：
  - `doc.userId == auth.uid` - 用户可查看自己的收入记录
  - 管理员可查看所有收入记录
- 写入条件：
  - 仅管理员可写（收入由系统自动记录）

---

### JSON-6: withdraw_records（提现记录）
**需求**：用户查看自己的提现，管理员审核

```json
{
  "read": "doc.userId == auth.uid || get('database.system_admin.$(auth.openid)').isAdmin == true",
  "write": "doc.userId == auth.uid || get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- 读取条件：
  - 用户可查看自己的提现记录
  - 管理员可查看所有提现记录
- 写入条件：
  - 用户可提交提现申请
  - 管理员可修改提现状态（审核通过/拒绝）

---

### JSON-7: reward_records（打赏记录）
**需求**：打赏人、画师、管理员可查看

```json
{
  "read": "doc.customerOpenId == auth.openid || doc.artistOpenId == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true",
  "write": "doc.customerOpenId == auth.openid || get('database.system_admin.$(auth.openid)').isAdmin == true"
}
```

**说明**：
- 读取条件：
  - `doc.customerOpenId == auth.openid` - 打赏人可查看自己的打赏记录
  - `doc.artistOpenId == auth.openid` - 画师可查看收到的打赏
  - 管理员可查看所有打赏记录
- 写入条件：
  - 打赏人可提交打赏
  - 管理员可修改/删除不当打赏

---

## 🛠️ 管理员表设计（必需）

由于多个集合使用了管理员权限判断，需要创建管理员表：

### 新增集合：system_admin

**权限设置**：仅创建者可读写

**数据结构**：
```javascript
{
  _id: "auto_generated",
  _openid: "管理员的openid",
  isAdmin: true,
  adminLevel: "super",  // super | normal
  nickName: "管理员昵称",
  createdAt: "2025-11-12 10:00:00"
}
```

**初始化方法**：
1. 在云开发控制台 → 数据库 → 创建 `system_admin` 集合
2. 手动添加第一个管理员记录（填入你的openid）
3. 后续管理员由第一个管理员在后台添加

---

## 📝 简化方案（推荐初期使用）

如果觉得自定义规则太复杂，**初期可以采用简化方案**：

### 方案A：全部使用"仅创建者可读写" + 云函数

**优点**：
- ✅ 数据最安全
- ✅ 权限控制最灵活
- ✅ 不需要配置复杂的JSON规则

**缺点**：
- ⚠️ 所有数据读写都必须通过云函数
- ⚠️ 开发工作量大
- ⚠️ 响应速度稍慢

**适用集合**：
- `users`
- `orders`
- `artist_applications`
- `income_ledger`
- `withdraw_records`
- `reward_records`
- `buyer_shows`（如果需要审核）

**云函数示例**：
```javascript
// 云函数：getUserList
exports.main = async (event, context) => {
  const { OPENID } = cloud.getWXContext()
  const db = cloud.database()
  
  // 检查是否为管理员
  const adminCheck = await db.collection('system_admin')
    .where({ _openid: OPENID, isAdmin: true })
    .get()
  
  if (adminCheck.data.length > 0) {
    // 管理员：返回所有用户
    return await db.collection('users').get()
  } else {
    // 普通用户：只返回自己的信息
    return await db.collection('users')
      .where({ _openid: OPENID })
      .get()
  }
}
```

---

### 方案B：混合模式（推荐）

**公开展示类**（5个）- 使用默认权限
- `products` - 所有用户可读，仅创建者可写
- `banners` - 所有用户可读，仅创建者可写
- `notices` - 所有用户可读，仅创建者可写
- `categories` - 所有用户可读，仅创建者可写
- `service_qrcodes` - 所有用户可读，仅创建者可写

**复杂权限类**（7个）- 使用云函数
- `users`
- `orders`
- `buyer_shows`
- `artist_applications`
- `income_ledger`
- `withdraw_records`
- `reward_records`

**权限设置**：全部设置为"仅创建者可读写"

**访问方式**：通过云函数API

---

## 🎯 最终建议

### 阶段1（当前）：使用简化方案B

**原因**：
1. 自定义JSON规则语法复杂，容易出错
2. 云函数更灵活，可以实现更复杂的权限逻辑
3. 便于后期维护和调整

**操作步骤**：
1. **公开展示类**（5个）→ 选择"所有用户可读，仅创建者可写"
2. **复杂权限类**（7个）→ 选择"仅创建者可读写"
3. 创建 `system_admin` 集合（仅创建者可读写）
4. 开发云函数API处理复杂权限逻辑

---

### 阶段2（1-2周后）：优化为自定义规则

当云函数稳定运行后，可以逐步迁移到自定义规则：

**优点**：
- 减少云函数调用次数
- 提升响应速度
- 降低成本

**操作方法**：
1. 在云开发控制台 → 数据库 → 选择集合
2. 点击"权限设置"
3. 选择"自定义安全规则"
4. 粘贴上面的JSON配置
5. 保存并测试

---

## ⚠️ 重要提醒

### 字段命名统一

自定义规则依赖字段名，确保订单表包含以下字段：
```javascript
{
  buyerOpenId: "买家的openid",    // ⚠️ 必需
  artistOpenId: "画师的openid",   // ⚠️ 必需
  serviceOpenId: "客服的openid"   // ⚠️ 可选
}
```

### openid vs userId

- **openid**：微信用户唯一标识，用于权限判断
- **userId**：业务层用户ID（1001, 1002...），用于显示

**数据库中必须同时存储两者**：
```javascript
{
  userId: "1001",           // 业务ID
  _openid: "oXXXXX...",     // 微信openid
  nickName: "用户昵称"
}
```

---

## 📊 权限对比表

| 方案 | 安全性 | 灵活性 | 开发难度 | 响应速度 | 成本 |
|------|-------|-------|---------|---------|------|
| 全部默认权限 | ⭐⭐ | ⭐ | ⭐ | ⭐⭐⭐⭐⭐ | ⭐ |
| 简化方案B | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| 自定义规则 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ |

**推荐路径**：默认权限（快速上线）→ 简化方案B（稳定运行）→ 自定义规则（性能优化）

---

## 总结

### 修正要点

1. ✅ 公开展示类保持不变
2. ✅ 新增 `system_admin` 集合存储管理员
3. ✅ 复杂权限类改为云函数控制（初期）
4. ✅ 提供自定义规则JSON（后期优化）
5. ✅ 确保数据结构包含openid字段

### 当前操作

**立即执行**：
1. 创建12个集合 + 1个管理员表（共13个）
2. 前5个使用"所有用户可读，仅创建者可写"
3. 后8个使用"仅创建者可读写"
4. 准备开发云函数API

**感谢您的专业审查！这个修正非常关键。**

