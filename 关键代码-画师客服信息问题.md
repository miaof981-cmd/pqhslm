# 关键代码 - 画师客服信息显示问题（已按指导修复）

## 问题根源
**数据来源不统一 + ID类型不匹配 + 页面二次兜底覆盖**
- 有的页面走了归一化，有的没走
- productId/serviceId 有时是字符串、有时是数字，匹配失败
- 页面层二次兜底把已有值又改回"待分配"

---

## 文件1: `miniprogram/utils/order-helper.js` (第21-71行)

```javascript
function normalizeOrders(orders, options = {}) {
  if (!Array.isArray(orders)) return []
  
  const serviceList = options.serviceList || wx.getStorageSync('customer_service_list') || []
  
  // 🎯 获取商品列表（用于补充画师信息和图片）
  const products = wx.getStorageSync('products') || []
  
  return orders.map(order => {
    // 1. 计算订单状态
    let processedOrder = orderStatusUtil.calculateOrderStatus(order)
    
    // 2. 补充客服信息
    processedOrder = orderStatusUtil.withServiceFallback(processedOrder, serviceList)
    
    // 3. 🎯 补充画师信息和商品图片（从商品表统一读取）
    if (processedOrder.productId || processedOrder.productName) {
      // 优先通过 productId 匹配
      let product = products.find(p => p.id === processedOrder.productId)
      
      // 如果没有 productId，尝试通过 productName 匹配
      if (!product && processedOrder.productName) {
        product = products.find(p => p.name === processedOrder.productName)
      }
      
      if (product) {
        // 补充画师信息（优先使用商品表的数据）
        if (product.artistName && (!processedOrder.artistName || processedOrder.artistName === '待分配')) {
          processedOrder.artistName = product.artistName
        }
        if (product.artistAvatar && !processedOrder.artistAvatar) {
          processedOrder.artistAvatar = product.artistAvatar
        }
        
        // 补充商品图片（优先使用商品表的数据）
        if (product.images && product.images.length > 0 && !processedOrder.productImage) {
          processedOrder.productImage = product.images[0]
        }
      }
    }
    
    // 4. 统一状态文本
    processedOrder.statusText = orderStatusUtil.textOf(processedOrder.status)
    
    // 5. 添加CSS类名
    processedOrder.statusClass = orderStatusUtil.classOf(processedOrder.status)
    
    return processedOrder
  })
}
```

**问题点**：
- 商品表 `products` 是否为空？
- `product.artistName` 是否存在？
- 匹配逻辑是否生效？

---

## 文件2: `miniprogram/pages/order-list/index.js` (第73-118行)

```javascript
// 转换为订单列表需要的格式（保留原有的格式化逻辑）
// ✅ 画师信息、客服信息、商品图片已在 order-helper.js 中统一处理

const mockOrders = allOrders.map(order => {
  // 画师信息（已由 order-helper 处理，直接使用）
  const artistName = order.artistName || '匿名画师'
  const artistAvatar = order.artistAvatar || orderStatusUtil.DEFAULT_AVATAR
  
  // ... 其他处理 ...
  
  return {
    _id: order.id,
    orderNo: order.id,
    productId: order.productId || '',
    productName: order.productName,
    productImage: order.productImage || '',  // 已由 order-helper 处理
    artistName: artistName,
    artistAvatar: artistAvatar,
    serviceName: order.serviceName || '待分配',  // 已由 order-helper 处理
    serviceAvatar: order.serviceAvatar || orderStatusUtil.DEFAULT_AVATAR,  // 已由 order-helper 处理
    // ...
  }
})
```

**问题点**：
- `order.artistName` 是否已被 order-helper 补充？
- 如果没有，说明 order-helper 的逻辑未生效

---

## 文件3: `miniprogram/utils/order-status.js` (第205-245行)

```javascript
function withServiceFallback(order, serviceList) {
  const out = { ...order }
  
  if (!serviceList) {
    serviceList = wx.getStorageSync('customer_service_list') || []
  }
  
  // 1️⃣ 如果订单已有客服名称和头像，直接使用
  if (out.serviceName && out.serviceName !== '待分配' && out.serviceAvatar) {
    return out
  }
  
  // 2️⃣ 通过serviceId从客服列表查找
  if (out.serviceId && serviceList.length > 0) {
    const matched = serviceList.find(s => s.userId === out.serviceId || s.id === out.serviceId)
    if (matched) {
      out.serviceName = matched.name || matched.nickName || '客服'
      out.serviceAvatar = matched.avatar || matched.avatarUrl || DEFAULT_AVATAR
      return out
    }
  }
  
  // 3️⃣ 兜底：使用默认值
  if (!out.serviceName || out.serviceName === '待分配') {
    out.serviceName = '待分配'
  }
  out.serviceAvatar = DEFAULT_AVATAR
  
  return out
}
```

**问题点**：
- `customer_service_list` 是否为空？
- `serviceId` 是否正确？

---

## 调试脚本（在控制台运行）

```javascript
// 1. 检查商品表
const products = wx.getStorageSync('products') || []
console.log('商品数:', products.length)
console.log('第一个商品:', products[0])

// 2. 检查订单
const orders = wx.getStorageSync('pending_orders') || []
console.log('订单数:', orders.length)
orders.forEach(o => {
  console.log(`订单 ${o.id}:`, {
    productName: o.productName,
    productId: o.productId || '无',
    artistName: o.artistName || '无',
    serviceName: o.serviceName || '无'
  })
})

// 3. 检查客服列表
const services = wx.getStorageSync('customer_service_list') || []
console.log('客服数:', services.length)
console.log('客服列表:', services)
```

---

## ✅ 修复方案（已实施）

### 1. 统一 ID 类型 + 清洗空格
- 所有 ID 统一转为字符串并 trim
- 避免 `123` 和 `"123"` 匹配失败

### 2. 只补不改
- 只在字段缺失时补充
- 不覆盖已有非空值
- 避免"这页妙妙、那页又被改回画师"

### 3. 客服信息分别兜底
- 名字和头像分别处理
- 有名字不动，只补头像
- 避免"名字被改回待分配"

### 4. 删除页面二次兜底
- 页面层直接信任归一化结果
- 不再写 `|| '匿名画师'` 或 `|| '待分配'`

---

## 🧪 验证方法

### 方法1：运行验证脚本
打开文件：`验证脚本-控制台运行.js`
复制全部内容到微信开发者工具控制台运行

### 方法2：手动检查
1. 编译项目
2. 查看订单列表
3. 确认所有订单显示"妙妙"而不是"画师"
4. 确认客服信息显示正确

---

## ✅ 验收标准

1. 同一订单在四端显示的 artistName/serviceName 完全一致
2. 没有出现"这页妙妙、那页画师/待分配"
3. 所有订单都有 statusText（统一用 textOf()）
4. 旧订单也能正确显示画师信息和图片

