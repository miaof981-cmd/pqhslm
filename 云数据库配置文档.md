# 画师商城 - 云数据库配置文档

## 数据库集合设计

### 1. users（用户表）

存储所有用户（普通用户、画师、管理员）的基本信息。

```javascript
{
  _id: String,           // 自动生成
  _openid: String,       // 用户openid（云数据库自动添加）
  openid: String,        // 用户openid
  role: String,          // 角色：'customer'（普通用户）, 'artist'（画师）, 'admin'（管理员）
  name: String,          // 用户名
  avatar: String,        // 头像URL
  phone: String,         // 联系电话
  createTime: Date,      // 注册时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 所有用户：可读取自己的数据
- 管理员：可读写所有数据

### 2. products（商品表）

存储画师发布的商品信息。

```javascript
{
  _id: String,           // 自动生成
  _openid: String,       // 画师openid
  artistId: String,      // 画师ID
  artistName: String,    // 画师名称
  name: String,          // 商品名称
  price: Number,         // 价格
  originalPrice: Number, // 原价（可选）
  deliveryDays: Number,  // 出稿天数
  category: String,      // 分类：'portrait', 'illustration', 'logo', 'poster', 'emoticon', 'ui', 'animation'
  images: Array,         // 商品图片URL数组
  tags: Array,           // 标签数组
  status: String,        // 状态：'active'（上架）, 'off'（下架）
  sales: Number,         // 销量
  rating: Number,        // 评分
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 所有用户：可读取status为'active'的商品
- 画师：可读写自己的商品
- 管理员：可读写所有商品

### 3. orders（订单表）

存储用户下单信息。

```javascript
{
  _id: String,           // 自动生成
  _openid: String,       // 买家openid
  buyerId: String,       // 买家ID
  buyerName: String,     // 买家名称
  artistId: String,      // 画师ID
  artistName: String,    // 画师名称
  productId: String,     // 商品ID
  productName: String,   // 商品名称
  productImage: String,  // 商品图片
  price: Number,         // 订单金额
  deliveryDays: Number,  // 出稿天数
  status: String,        // 状态：'created'（制作中）, 'completed'（已完成）, 'cancelled'（已取消）
  serviceQR: String,     // 客服二维码URL
  remark: String,        // 备注
  createTime: Date,      // 下单时间
  deadline: Date,        // 截稿时间（自动计算：createTime + deliveryDays）
  completeTime: Date,    // 完成时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 买家：可读取自己的订单
- 画师：可读取自己商品的订单
- 管理员：可读写所有订单

### 4. members（会员表）

存储画师会员信息。

```javascript
{
  _id: String,           // 自动生成
  _openid: String,       // 画师openid
  artistId: String,      // 画师ID
  amount: Number,        // 缴费金额
  months: Number,        // 续费月数
  remark: String,        // 备注
  startDate: Date,       // 开始日期
  endDate: Date,         // 到期日期
  isValid: Boolean,      // 是否有效（today <= endDate）
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 画师：可读取自己的会员信息
- 管理员：可读写所有会员信息

### 5. applications（画师申请表）

存储画师申请信息。

```javascript
{
  _id: String,           // 自动生成
  _openid: String,       // 申请人openid
  name: String,          // 姓名
  phone: String,         // 联系方式
  specialty: String,     // 擅长类型
  portfolio: Array,      // 作品图片URL数组
  status: String,        // 状态：'pending'（待审核）, 'approved'（已通过）, 'rejected'（已驳回）
  reviewerId: String,    // 审核人ID
  reviewTime: Date,      // 审核时间
  createTime: Date,      // 申请时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 申请人：可读取自己的申请
- 管理员：可读写所有申请

### 6. notices（公告表）

存储平台公告信息。

```javascript
{
  _id: String,           // 自动生成
  title: String,         // 公告标题
  content: String,       // 公告内容
  status: String,        // 状态：'active'（显示）, 'inactive'（隐藏）
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 所有用户：可读取status为'active'的公告
- 管理员：可读写所有公告

### 7. serviceQR（客服二维码表）

存储客服二维码信息。

```javascript
{
  _id: String,           // 自动生成
  title: String,         // 二维码标题
  imageUrl: String,      // 二维码图片URL
  isActive: Boolean,     // 是否启用
  assignedCount: Number, // 已分配订单数
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 所有用户：可读取isActive为true的二维码
- 管理员：可读写所有二维码

### 8. banners（轮播图表）

存储首页轮播图信息。

```javascript
{
  _id: String,           // 自动生成
  title: String,         // 轮播图标题
  imageUrl: String,      // 图片URL
  linkUrl: String,       // 跳转链接（可选）
  sort: Number,          // 排序（数字越小越靠前）
  isActive: Boolean,     // 是否启用
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}
```

**权限设置：**
- 所有用户：可读取isActive为true的轮播图
- 管理员：可读写所有轮播图

---

## 配置步骤

### 1. 开通云开发

1. 登录微信小程序后台
2. 进入"开发" → "云开发"
3. 点击"开通"，创建云开发环境
4. 记录环境ID（如：`cloud1-xxx`）

### 2. 创建数据库集合

在云开发控制台 → 数据库，依次创建以上8个集合：
- users
- products
- orders
- members
- applications
- notices
- serviceQR
- banners

### 3. 配置权限

在每个集合的"权限设置"中，根据上述权限说明配置：

**示例：products集合权限配置**

```json
{
  "read": "doc._openid == auth.openid || doc.status == 'active'",
  "write": "doc._openid == auth.openid"
}
```

**管理员权限配置**

对于需要管理员权限的集合，可以使用云函数进行操作，或者配置：

```json
{
  "read": true,
  "write": "get(`database.users.${auth.openid}`).role == 'admin'"
}
```

### 4. 更新小程序代码

在 `miniprogram/app.js` 中，取消云开发初始化的注释，并填入环境ID：

```javascript
wx.cloud.init({
  env: 'cloud1-xxx', // 替换为你的云开发环境ID
  traceUser: true,
})
```

### 5. 创建云函数（可选）

在 `cloudfunctions/` 目录下创建以下云函数：

#### login（获取openid）
已创建，位于 `miniprogram/cloudfunctions/login/`

#### 其他建议的云函数：
- **createOrder**: 创建订单，自动分配客服二维码
- **updateMemberStatus**: 定时检查会员状态，自动下架过期商品
- **reviewApplication**: 审核画师申请，自动更新用户角色

### 6. 部署云函数

```bash
# 在微信开发者工具中
# 右键云函数目录 → 上传并部署：云端安装依赖
```

### 7. 测试

1. 在云开发控制台手动添加测试数据
2. 在小程序中测试各个功能
3. 检查权限是否正确配置

---

## 自动化逻辑实现

### 1. 订单截稿日期自动计算

在创建订单时：

```javascript
const deadline = new Date(Date.now() + deliveryDays * 24 * 60 * 60 * 1000)
```

### 2. 会员状态自动检查

使用云函数定时触发器，每天检查：

```javascript
const today = new Date()
const expiredMembers = await db.collection('members')
  .where({
    endDate: _.lt(today),
    isValid: true
  })
  .get()

// 更新会员状态和商品状态
```

### 3. 客服二维码随机分配

在创建订单时，随机选择一个启用的客服二维码：

```javascript
const qrList = await db.collection('serviceQR')
  .where({ isActive: true })
  .get()

const randomQR = qrList.data[Math.floor(Math.random() * qrList.data.length)]
```

---

## 注意事项

1. **数据安全**：确保敏感信息（如手机号）的权限控制
2. **性能优化**：为常用查询字段添加索引
3. **数据备份**：定期备份重要数据
4. **成本控制**：监控云开发资源使用情况
5. **测试环境**：建议创建独立的测试环境

---

## 后续优化建议

1. 添加数据统计功能（销量、收入等）
2. 实现消息推送（订单状态变更通知）
3. 添加评价系统
4. 实现搜索功能的全文索引
5. 添加数据分析和报表功能

