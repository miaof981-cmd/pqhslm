# 管理员权限与提现功能说明

## 📋 两个开关的明确职责

### 1️⃣ **订单分成开关** (`enableShare`)
- **作用**：控制该管理员是否参与订单分成
- **范围**：只影响分成收入
- **关闭后**：
  - ❌ 不再参与新订单的分成
  - ✅ 仍然可以登录后台（如果后台权限开启）
  - ✅ 可以提现已有的分成收入

### 2️⃣ **后台权限开关** (`isActive`)
- **作用**：控制该管理员是否可以登录后台
- **范围**：全局权限 + 分成资格
- **关闭后**：
  - ❌ 无法登录后台系统
  - ❌ 不再参与新订单的分成
  - ✅ 仍可以提现已有的分成收入（通过个人中心）

---

## 🎯 分成条件（AND 逻辑）

**只有同时满足三个条件，才会参与【新完成】的订单分成：**

```
✅ isActive = true       (有后台权限/在职)
AND
✅ enableShare = true    (开启订单分成)
AND  
✅ shareAmount > 0       (分成金额大于0)
```

---

## 💰 管理员提现功能

### **入口位置**

**个人中心 → 其他功能 → 提现**

- 管理员登录自己的账号后，在个人中心会显示"提现"按钮
- 如果有可提现余额，会显示金额徽章（红色）
- 点击进入提现页面，可查看：
  - 订单分成收入
  - 打赏收入（如果也是画师）
  - 提现记录

### **权限判定**

系统通过以下逻辑判定用户是否为管理员：

```javascript
const staffList = staffFinance.getStaffList()
const staff = staffList.find(s => String(s.userId) === String(当前用户ID))

if (staff && staff.isActive !== false) {
  // 是在职管理员，显示提现入口
  // 计算余额 = 订单分成 - 已提现
}
```

### **余额计算**

```
管理员余额 = 订单分成总收入 - 已提现金额
```

- 只计算该管理员的分成记录
- 不会混淆其他管理员的收入
- 提现后余额自动扣减

---

## 🔄 实际场景

### 场景1：固定工资管理员
```
后台权限：✅ 开启（可登录后台）
订单分成：❌ 关闭（不参与分成）
分成金额：¥0

结果：
- 可以登录后台工作
- 不参与订单分成
- 个人中心不显示提现入口（余额为0）
```

### 场景2：提成管理员
```
后台权限：✅ 开启
订单分成：✅ 开启
分成金额：¥5

结果：
- 可以登录后台工作
- 每单获得¥5分成
- 个人中心显示提现入口 + 余额徽章
- 可以随时提现
```

### 场景3：管理员离职
```
后台权限：❌ 关闭
订单分成：❌ 自动关闭

结果：
- 无法登录后台
- 不再参与新订单分成
- 仍可以登录个人账号，提现历史分成收入
```

### 场景4：临时停止分成
```
后台权限：✅ 开启（仍在职）
订单分成：❌ 关闭（临时不分成）

结果：
- 可以正常登录后台工作
- 不参与新订单分成
- 可以提现之前的分成余额
```

---

## 🛡️ 数据隔离

### **提现记录按用户隔离**

```javascript
// 只显示当前用户的提现记录
const myWithdraws = withdrawRecords.filter(r => 
  String(r.userId) === String(currentUserId) && 
  r.status === 'success'
)
```

### **分成记录按用户隔离**

```javascript
// 只计算当前用户的分成收入
const myIncome = staffFinance.computeIncomeByUserId(currentUserId)
```

### **防止数据混淆**

- ❌ 管理员A不会看到管理员B的收入
- ❌ 管理员A不会提现管理员B的余额
- ✅ 每个管理员只能提现自己的分成收入

---

## 📱 UI 显示

### **个人中心**

```
其他功能区域：

[💰] 提现 ¥128.50    <- 🎯 管理员专属，显示余额徽章
[❤️] 收藏和关注
[🕐] 历史足迹
[💬] 平台售后
[📷] 我的买家秀
[🎁] 打赏
```

### **提现页面**

```
余额卡片：
┌─────────────────────┐
│ 可提现金额           │
│ ¥ 128.50            │
│                     │
│ 打赏收入：¥0.00     │
│ 订单分成：¥128.50   │  <- 🎯 管理员分成显示
│ 总收入：¥128.50     │
└─────────────────────┘

[提现] [查看收入明细]
```

---

## ⚙️ 技术实现

### **管理员判定**

```javascript
// user-center/index.js
checkStaffStatus() {
  const userId = wx.getStorageSync('userId')
  const staffList = staffFinance.getStaffList()
  const staff = staffList.find(s => String(s.userId) === String(userId))
  
  if (staff && staff.isActive !== false) {
    // 计算余额
    const balance = staffFinance.computeIncomeByUserId(userId)
    const withdrawn = this.getWithdrawnAmount(userId)
    const availableBalance = Math.max(0, balance - withdrawn)
    
    this.setData({
      isStaff: true,
      staffBalance: availableBalance.toFixed(2)
    })
  } else {
    this.setData({ isStaff: false, staffBalance: 0 })
  }
}
```

### **提现页面余额计算**

```javascript
// withdraw/index.js
loadBalance() {
  const userId = wx.getStorageSync('userId')
  const userKey = String(userId)
  
  // 打赏收入（如果是画师）
  const myRewards = rewardRecords.filter(r => 
    String(r.artistId) === userKey
  )
  const totalReward = myRewards.reduce((sum, r) => sum + r.amount, 0)
  
  // 管理员分成收入
  const staffIncome = staffFinance.computeIncomeByUserId(userKey)
  
  // 总收入
  const totalIncome = totalReward + staffIncome
  
  // 已提现
  const myWithdraws = withdrawRecords.filter(r => 
    String(r.userId) === userKey && r.status === 'success'
  )
  const totalWithdrawn = myWithdraws.reduce((sum, r) => sum + r.amount, 0)
  
  // 可提现余额
  const balance = totalIncome - totalWithdrawn
}
```

---

## ✅ 总结

### **两个开关的关系**

| 后台权限 | 订单分成 | 结果 |
|---------|---------|------|
| ✅ 开启 | ✅ 开启 | 可登录后台 + 参与分成 + 可提现 |
| ✅ 开启 | ❌ 关闭 | 可登录后台 + 不分成 + 可提现历史余额 |
| ❌ 关闭 | ✅ 开启 | 无法登录后台 + 不分成 + 可提现历史余额 |
| ❌ 关闭 | ❌ 关闭 | 无法登录后台 + 不分成 + 可提现历史余额 |

### **关键特性**

1. **后台权限 ≠ 订单分成**
   - 后台权限控制能否登录后台
   - 订单分成控制是否参与分成

2. **提现权限独立**
   - 即使关闭后台权限，仍可提现历史余额
   - 通过个人账号登录，无需后台权限

3. **数据隔离**
   - 每个管理员只能看到自己的收入
   - 每个管理员只能提现自己的余额

4. **只影响未来**
   - 所有配置变更只对之后的订单生效
   - 已分成的历史订单不会改变

5. **防重复机制**
   - 同一订单对同一人只分成一次
   - 去重机制确保不会重复扣款

