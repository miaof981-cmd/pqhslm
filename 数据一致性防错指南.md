# 数据一致性防错指南

## 📋 问题历史

### 问题1：商品状态字段不一致（2025-10-27）
**页面**: `pages/artist-products-manage/index`
**问题**: 使用了错误的字段名 `status`，实际应为 `isOnSale`
**影响**: 所有商品显示为"已下架"，筛选功能失效
**修复**: 统一使用 `isOnSale` 字段（布尔值）

### 问题2：商品价格显示不一致（2025-10-27）
**页面**: `pages/artist-products-manage/index`
**问题**: 缺少价格处理逻辑，与首页显示不一致
**影响**: 价格显示为 ¥10 而非正确价格
**修复**: 添加与首页一致的价格回退处理逻辑

---

## 🔍 根本原因分析

### 核心问题
**不同页面对同一数据结构的处理逻辑不一致**

### 典型场景
1. ❌ 页面A使用 `status` 字段
2. ❌ 页面B使用 `isOnSale` 字段
3. ❌ 页面C直接使用 `price`
4. ❌ 页面D有 `price` 回退处理

### 为什么会发生
1. 复制粘贴代码时修改不完整
2. 新增页面时参考了错误的示例
3. 数据结构变更后未同步所有页面
4. 缺少统一的工具函数

---

## ✅ 数据字段标准

### 1. 商品状态（上架/下架）

**标准字段**: `isOnSale`

| 值 | 含义 | 显示 |
|---|------|------|
| `true` | 已上架 | "已上架" |
| `undefined` | 默认上架 | "已上架" |
| `false` | 已下架 | "已下架" |

**正确用法**:
```javascript
// ✅ 判断是否上架
if (product.isOnSale !== false) {
  // 商品已上架
}

// ✅ 筛选上架商品
const onlineProducts = products.filter(p => p.isOnSale !== false)

// ✅ 筛选下架商品
const offlineProducts = products.filter(p => p.isOnSale === false)
```

**错误用法**:
```javascript
// ❌ 使用不存在的 status 字段
if (product.status === 'online') { ... }

// ❌ 使用 === true (会漏掉 undefined)
if (product.isOnSale === true) { ... }
```

---

### 2. 商品价格

**标准字段**: `price`, `basePrice`, `specs`

| 字段 | 类型 | 说明 |
|------|------|------|
| `price` | Number | 编辑时计算的最终显示价格 |
| `basePrice` | Number | 基础价格（无规格时） |
| `specs` | Array | 规格数组（有规格时） |

**优先级**:
1. `price` (如果存在且有效)
2. `basePrice` (如果 price 无效)
3. 从 `specs` 计算最低价
4. `0` (默认值)

**正确用法**:
```javascript
// ✅ 使用统一工具函数（推荐）
const priceHelper = require('../../utils/price-helper')
const displayPrice = priceHelper.getProductDisplayPrice(product)

// ✅ 手动实现（不推荐，但需要时可参考）
let displayPrice = parseFloat(product.price) || parseFloat(product.basePrice) || 0
```

**错误用法**:
```javascript
// ❌ 直接使用 price（可能为 undefined）
<text>¥{{item.price}}</text>

// ❌ 不处理字符串转数字
const price = product.price // 可能是 "0" 字符串

// ❌ 不提供默认值
const price = parseFloat(product.price) // 可能是 NaN
```

---

### 3. 画师信息

**标准字段**: `artistId`, `artistName`, `artistAvatar`

| 字段 | 类型 | 说明 |
|------|------|------|
| `artistId` | String/Number | 画师用户ID |
| `artistName` | String | 画师昵称 |
| `artistAvatar` | String | 画师头像URL/base64 |

**正确用法**:
```javascript
// ✅ 保存商品时记录画师信息
const product = {
  artistId: wx.getStorageSync('userId'),
  artistName: userInfo.nickName || '画师',
  artistAvatar: userInfo.avatarUrl || '/assets/default-avatar.png',
  // ... 其他字段
}

// ✅ 筛选画师商品时使用 == (兼容字符串和数字)
const myProducts = products.filter(p => p.artistId == currentUserId)
```

**错误用法**:
```javascript
// ❌ 只保存 artistName，不保存 ID 和头像
const product = {
  artistName: '画师',
  // 缺少 artistId 和 artistAvatar
}

// ❌ 使用 === 严格相等（可能因类型不同导致匹配失败）
products.filter(p => p.artistId === currentUserId) // 如果一个是字符串一个是数字就会失败
```

---

## 🛠️ 统一工具函数

### 价格处理工具

**位置**: `miniprogram/utils/price-helper.js`

**使用方法**:
```javascript
const priceHelper = require('../../utils/price-helper')

// 获取单个商品显示价格
const price = priceHelper.getProductDisplayPrice(product)

// 批量处理商品数组
const processedProducts = priceHelper.processProductsPrices(products)

// 格式化价格显示
const formatted = priceHelper.formatPrice(99.5) // "¥99.50"
const noSymbol = priceHelper.formatPrice(99.5, false) // "99.50"
```

---

## 📝 页面开发检查清单

### 新增商品相关页面时

#### 1. 数据读取检查
- [ ] 使用 `isOnSale` 判断上架状态（不是 `status`）
- [ ] 使用价格工具函数或正确的回退逻辑
- [ ] 使用 `artistId` 筛选时用 `==`（不是 `===`）
- [ ] 读取画师头像使用 `artistAvatar` 字段

#### 2. 数据展示检查
- [ ] 价格显示使用 `getProductDisplayPrice()` 或 `price || basePrice`
- [ ] 状态显示使用 `isOnSale !== false ? '已上架' : '已下架'`
- [ ] 画师头像显示使用 `artistAvatar || '/assets/default-avatar.png'`

#### 3. 数据操作检查
- [ ] 上架/下架操作修改 `isOnSale` 字段（布尔值）
- [ ] 商品保存时记录完整的画师信息（ID、昵称、头像）
- [ ] 价格保存时同时保存 `price` 和 `basePrice`

#### 4. 控制台调试
- [ ] 添加 `console.log` 输出关键数据
- [ ] 显示字段名、类型、值
- [ ] 显示筛选/处理结果

---

## 🎯 最佳实践

### 1. 优先使用工具函数
```javascript
// ✅ 好：统一逻辑，易维护
const price = priceHelper.getProductDisplayPrice(product)

// ❌ 差：重复代码，易出错
const price = parseFloat(product.price) || parseFloat(product.basePrice) || 0
```

### 2. 字段名保持一致
```javascript
// ✅ 好：全项目统一使用 isOnSale
const onlineProducts = products.filter(p => p.isOnSale !== false)

// ❌ 差：有的页面用 status，有的用 isOnSale
const onlineProducts = products.filter(p => p.status === 'online')
```

### 3. 类型转换要明确
```javascript
// ✅ 好：明确转换为数字并提供默认值
const price = parseFloat(product.price) || 0

// ❌ 差：直接使用，可能是字符串或 undefined
const price = product.price
```

### 4. 添加调试日志
```javascript
// ✅ 好：详细的调试信息
console.log('商品价格处理:', {
  原始price: product.price,
  basePrice: product.basePrice,
  最终显示: displayPrice
})

// ❌ 差：没有调试信息，出问题难排查
const price = parseFloat(product.price) || 0
```

---

## 🔄 已知受影响页面

### 需要使用统一逻辑的页面

| 页面路径 | 涉及数据 | 状态 |
|---------|---------|------|
| `pages/home/index` | 商品价格、上架状态 | ✅ 已修复 |
| `pages/product-detail/index` | 商品价格、画师信息 | ✅ 已修复 |
| `pages/artist-products-manage/index` | 商品价格、上架状态 | ✅ 已修复 |
| `pages/product-edit/index` | 价格保存、画师信息 | ✅ 已验证 |
| `pages/order-list/index` | 商品价格 | ⚠️ 待验证 |
| `pages/order-detail/index` | 商品价格、画师信息 | ⚠️ 待验证 |
| `pages/cart/index` | 商品价格 | ✅ 已验证 |
| `pages/admin/product-manage/index` | 商品价格、上架状态 | ⚠️ 待验证 |

---

## 🚨 出现不一致时的排查步骤

### 第一步：确认数据结构
```javascript
// 在控制台运行
const products = wx.getStorageSync('mock_products') || []
const product = products[0]
console.log('商品数据结构:', {
  id: product.id,
  name: product.name,
  price: product.price,
  basePrice: product.basePrice,
  isOnSale: product.isOnSale,
  artistId: product.artistId,
  artistName: product.artistName,
  artistAvatar: product.artistAvatar
})
```

### 第二步：检查字段使用
1. 搜索页面 JS 文件中的字段名
2. 确认是否使用标准字段
3. 确认是否有回退处理

### 第三步：对比正确页面
1. 打开 `pages/home/index.js`（已确认正确）
2. 对比数据处理逻辑
3. 复制正确的逻辑

### 第四步：添加调试日志
```javascript
console.log('=== 数据读取调试 ===')
console.log('原始数据:', product)
console.log('处理后数据:', processedProduct)
console.log('显示价格:', displayPrice)
```

---

## 📚 相关文档

- [商品数据结构](./需求文档.md#商品数据结构)
- [价格计算逻辑](./utils/price-helper.js)
- [订单显示问题排查报告](./订单显示问题完整排查报告.md)

---

## ⚠️ 重要提醒

1. **新增页面时，优先参考 `pages/home/index.js` 的数据处理逻辑**
2. **修改数据结构后，必须同步所有相关页面**
3. **遇到显示问题，先检查字段名是否正确**
4. **价格处理务必使用工具函数或回退逻辑**
5. **添加新功能后，在不同页面都测试一遍**

---

*最后更新: 2025-10-27*
*维护人: AI Assistant*

