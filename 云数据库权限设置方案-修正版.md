# 云数据库权限设置方案（修正版）

> **三阶段工作法复查结果**  
> **更新时间**：2025-11-12  
> **问题**：原方案所有集合统一设置"仅创建者可读写"导致公开数据无法展示

---

## 阶段一：问题诊断

### 原方案的严重问题

❌ **错误1：轮播图不可见**
- 集合：`banners`
- 错误权限：仅创建者可读写
- 后果：首页轮播图空白，所有用户看不到

❌ **错误2：公告不可见**
- 集合：`notices`
- 错误权限：仅创建者可读写
- 后果：首页公告空白，用户看不到任何公告

❌ **错误3：商品列表空白**
- 集合：`products`
- 错误权限：仅创建者可读写
- 后果：首页商品列表空白，搜索无结果，整个小程序不可用

❌ **错误4：分类不可见**
- 集合：`categories`
- 错误权限：仅创建者可读写
- 后果：商品分类筛选功能失效

❌ **错误5：买家秀不可见**
- 集合：`buyer_shows`
- 错误权限：仅创建者可读写
- 后果：商品详情页买家秀展示区空白

❌ **错误6：用户信息读取受限**
- 集合：`users`
- 错误权限：仅创建者可读写
- 后果：订单列表、商品列表无法显示画师昵称头像

### 根本原因分析

**原因1**：未区分"公开数据"和"私有数据"
**原因2**：未理解微信云开发权限模型
**原因3**：一刀切设置所有权限相同

---

## 阶段二：方案设计

### 微信云开发权限类型

1. **所有用户可读，仅创建者可写**（推荐用于公开展示数据）
2. **仅创建者可读写**（用于私有数据，需配合云函数）
3. **所有用户可读写**（❌ 不推荐，不安全）
4. **自定义安全规则**（高级功能，后期优化）

### 业务场景分类

#### 类型1：公开展示数据（🌍 所有用户可读，仅创建者可写）

**特征**：前端直接读取展示，不涉及敏感信息

| 集合名 | 用途 | 访问场景 | 权限设置 |
|--------|------|---------|---------|
| `products` | 商品表 | 首页列表、搜索、详情页 | 所有用户可读，仅创建者可写 |
| `banners` | 轮播图 | 首页轮播展示 | 所有用户可读，仅创建者可写 |
| `notices` | 公告 | 首页公告展示 | 所有用户可读，仅创建者可写 |
| `categories` | 分类 | 商品分类筛选 | 所有用户可读，仅创建者可写 |
| `buyer_shows` | 买家秀 | 商品详情页展示 | 所有用户可读，仅创建者可写 |

**为什么这样设置？**
- ✅ 用户需要直接读取这些数据来展示页面
- ✅ 只有管理员/画师能创建和修改
- ✅ 不涉及敏感信息（价格、图片、文案都是公开的）

---

#### 类型2：用户基础信息（🌍 所有用户可读，仅创建者可写）

| 集合名 | 用途 | 访问场景 | 权限设置 |
|--------|------|---------|---------|
| `users` | 用户表 | 读取其他用户昵称头像 | 所有用户可读，仅创建者可写 |

**为什么这样设置？**
- ✅ 订单列表需要显示买家/画师昵称头像
- ✅ 商品列表需要显示画师昵称头像
- ✅ 昵称头像不是敏感信息（微信本身就是公开的）
- ⚠️ 注意：手机号、OpenID等敏感字段后期通过云函数过滤

---

#### 类型3：客服二维码（🌍 所有用户可读，仅创建者可写）

| 集合名 | 用途 | 访问场景 | 权限设置 |
|--------|------|---------|---------|
| `service_qrcodes` | 客服二维码 | 订单成功页展示 | 所有用户可读，仅创建者可写 |

**为什么这样设置？**
- ✅ 下单后所有买家都需要看到客服二维码
- ✅ 二维码本身不是敏感信息（就是用来让用户添加的）
- ✅ 只有管理员能上传/修改二维码

---

#### 类型4：订单交易数据（🔒 仅创建者可读写 + 云函数控制）

| 集合名 | 用途 | 访问规则 | 权限设置 |
|--------|------|---------|---------|
| `orders` | 订单表 | 买家、画师、客服、管理员根据角色可见 | 仅创建者可读写 |

**为什么这样设置？**
- 🔒 订单包含敏感信息（金额、手机号、地址）
- 🔒 需要复杂的角色权限判断：
  - 买家只能看自己的订单
  - 画师只能看分配给自己的订单
  - 客服只能看分配给自己的订单
  - 管理员可以看所有订单
- ✅ 通过云函数API实现精细控制

**云函数访问示例**：
```javascript
// 云函数：getOrderList
exports.main = async (event) => {
  const { userId, userRoles } = event
  
  // 管理员：查看所有订单
  if (userRoles.includes('admin')) {
    return await db.collection('orders').get()
  }
  
  // 画师：查看分配给自己的订单
  if (userRoles.includes('artist')) {
    return await db.collection('orders')
      .where({ artistId: userId })
      .get()
  }
  
  // 普通用户：查看自己的订单
  return await db.collection('orders')
    .where({ buyerId: userId })
    .get()
}
```

---

#### 类型5：财务敏感数据（🔒 仅创建者可读写 + 云函数控制）

| 集合名 | 用途 | 访问规则 | 权限设置 |
|--------|------|---------|---------|
| `income_ledger` | 收入账本 | 只能查看自己的收入 | 仅创建者可读写 |
| `withdraw_records` | 提现记录 | 只能查看自己的提现 | 仅创建者可读写 |
| `reward_records` | 打赏记录 | 打赏人和被打赏人可见 | 仅创建者可读写 |

**为什么这样设置？**
- 🔒 涉及金额等敏感信息
- 🔒 必须确保用户只能看自己的财务数据
- ✅ 通过云函数API实现访问控制

---

#### 类型6：申请审核数据（🔒 仅创建者可读写 + 云函数控制）

| 集合名 | 用途 | 访问规则 | 权限设置 |
|--------|------|---------|---------|
| `artist_applications` | 画师申请 | 申请人和管理员可见 | 仅创建者可读写 |

**为什么这样设置？**
- 🔒 包含真实姓名、微信号、作品等隐私信息
- 🔒 申请人只能看自己的申请
- 🔒 管理员可以看所有申请
- ✅ 通过云函数API实现访问控制

---

## 阶段三：实施方案

### 完整权限配置表（修正版）

| 序号 | 集合名称 | 用途 | 权限设置 | 前端访问方式 |
|-----|---------|------|---------|-------------|
| 1 | `products` | 商品表 | ✅ 所有用户可读，仅创建者可写 | 直接读取 |
| 2 | `banners` | 轮播图 | ✅ 所有用户可读，仅创建者可写 | 直接读取 |
| 3 | `notices` | 公告 | ✅ 所有用户可读，仅创建者可写 | 直接读取 |
| 4 | `categories` | 分类 | ✅ 所有用户可读，仅创建者可写 | 直接读取 |
| 5 | `buyer_shows` | 买家秀 | ✅ 所有用户可读，仅创建者可写 | 直接读取 |
| 6 | `users` | 用户表 | ✅ 所有用户可读，仅创建者可写 | 直接读取（注意脱敏） |
| 7 | `service_qrcodes` | 客服二维码 | ✅ 所有用户可读，仅创建者可写 | 直接读取 |
| 8 | `orders` | 订单表 | 🔒 仅创建者可读写 | 云函数API |
| 9 | `income_ledger` | 收入账本 | 🔒 仅创建者可读写 | 云函数API |
| 10 | `withdraw_records` | 提现记录 | 🔒 仅创建者可读写 | 云函数API |
| 11 | `reward_records` | 打赏记录 | 🔒 仅创建者可读写 | 云函数API |
| 12 | `artist_applications` | 画师申请 | 🔒 仅创建者可读写 | 云函数API |

---

### 集合遗漏检查

根据业务需求，检查是否有遗漏的集合：

#### 已有集合（12个）✅
- ✅ users - 用户表
- ✅ orders - 订单表
- ✅ products - 商品表
- ✅ artist_applications - 画师申请表
- ✅ categories - 分类表
- ✅ notices - 公告表
- ✅ banners - 轮播图表
- ✅ income_ledger - 收入账本
- ✅ withdraw_records - 提现记录
- ✅ reward_records - 打赏记录
- ✅ service_qrcodes - 客服二维码
- ✅ buyer_shows - 买家秀

#### 可能需要补充的集合（可选）

**1. 系统配置表** `system_config`（可选）
- 用途：存储分成比例、提现最低金额等配置
- 权限：所有用户可读，仅管理员可写
- 是否必需：不必需（可以硬编码在代码中）

**2. 管理员操作日志** `admin_logs`（可选）
- 用途：记录管理员操作（审核、修改、删除等）
- 权限：仅创建者可读写 + 云函数
- 是否必需：不必需（后期优化可加）

**3. 用户反馈** `feedbacks`（可选）
- 用途：用户意见反馈
- 权限：所有用户可写，仅管理员可读
- 是否必需：不必需（可通过客服二维码联系）

**结论**：当前12个集合已覆盖所有核心业务，无遗漏。

---

## 执行步骤

### 步骤1：创建集合时的权限设置

打开云开发控制台 → 数据库 → 创建集合

**公开数据集合（7个）** - 选择"所有用户可读，仅创建者可写"
1. `products`
2. `banners`
3. `notices`
4. `categories`
5. `buyer_shows`
6. `users`
7. `service_qrcodes`

**私有数据集合（5个）** - 选择"仅创建者可读写"
1. `orders`
2. `income_ledger`
3. `withdraw_records`
4. `reward_records`
5. `artist_applications`

---

### 步骤2：权限设置注意事项

#### 对于"所有用户可读"的集合

**优点**：
- ✅ 前端可以直接使用 `db.collection('products').get()` 读取
- ✅ 不需要云函数中转，响应速度快
- ✅ 代码简单，开发效率高

**安全措施**：
- ⚠️ 敏感字段后期需要通过云函数过滤（如用户手机号）
- ⚠️ 写入操作必须通过云函数验证权限
- ⚠️ 定期检查是否有恶意读取

#### 对于"仅创建者可读写"的集合

**优点**：
- ✅ 数据安全性最高
- ✅ 用户无法直接读取他人数据
- ✅ 必须通过云函数控制访问

**注意事项**：
- ⚠️ 所有读写操作都必须通过云函数API
- ⚠️ 云函数中必须验证用户权限
- ⚠️ 开发工作量稍大

---

## 后续优化方向

### 阶段1（当前）：基础权限设置
- 使用上述权限方案创建集合
- 前端直接读取公开数据
- 云函数控制私有数据访问

### 阶段2（1-2周后）：用户表脱敏
- 云函数过滤用户表敏感字段
- 前端只能读取 `userId`, `nickName`, `avatarUrl`
- 不能读取 `phone`, `openid`, `memberLevel` 等

### 阶段3（1个月后）：自定义安全规则
- 使用云开发的自定义权限规则
- 更精细的字段级权限控制
- 降低云函数调用次数，提升性能

---

## 常见问题

### Q1：为什么用户表设置为"所有用户可读"？
**A**：因为订单列表、商品列表需要显示画师昵称头像，如果设置为"仅创建者可读写"，无法读取其他用户信息。但后期会通过云函数过滤敏感字段。

### Q2：轮播图/公告为什么不用云函数？
**A**：因为是公开展示数据，没有敏感信息，前端直接读取速度更快，用户体验更好。

### Q3：订单为什么必须用"仅创建者可读写"？
**A**：因为需要复杂的角色权限判断（买家、画师、客服、管理员看到的订单不同），必须通过云函数来控制。

### Q4：可以后期修改权限吗？
**A**：可以！在云开发控制台 → 数据库 → 选择集合 → 权限设置 → 修改即可。但建议一开始就设置正确，避免后期改动导致功能异常。

---

## 总结

### 修正前的问题
❌ 所有集合统一设置"仅创建者可读写"
❌ 导致轮播图、公告、商品列表全部空白
❌ 小程序完全不可用

### 修正后的方案
✅ 7个公开数据集合设置为"所有用户可读，仅创建者可写"
✅ 5个私有数据集合设置为"仅创建者可读写"
✅ 通过云函数API控制复杂权限逻辑
✅ 保证功能正常的同时确保数据安全

---

**感谢您的细心发现！这是一个非常关键的修正。**

