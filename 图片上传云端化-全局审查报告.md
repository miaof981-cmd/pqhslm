# å›¾ç‰‡ä¸Šä¼ äº‘ç«¯åŒ– - å…¨å±€å®¡æŸ¥æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´ï¼š2025-11-22  
> å®¡æŸ¥èŒƒå›´ï¼šæ•´ä¸ªå°ç¨‹åºé¡¹ç›®ï¼ˆminiprogram + cloudfunctionsï¼‰  
> é—®é¢˜çº§åˆ«ï¼šP0=ä¸¥é‡ï¼ˆçœŸæœºæ— æ³•æ˜¾ç¤ºï¼‰ã€P1=é«˜å±ï¼ˆé¢„è§ˆæ­£å¸¸çœŸæœºå¼‚å¸¸ï¼‰ã€P2=ä¸­å±ï¼ˆå­˜åœ¨éšæ‚£ï¼‰

---

## ğŸ“Š å®¡æŸ¥ç»“æœæ€»è§ˆ

| ç±»åˆ« | æ•°é‡ | çŠ¶æ€ |
|------|------|------|
| âœ… æ­£ç¡®ä½¿ç”¨äº‘å­˜å‚¨ | 3å¤„ | ç¬¦åˆè§„èŒƒ |
| âŒ ç›´æ¥ä½¿ç”¨ä¸´æ—¶è·¯å¾„ï¼ˆP0ï¼‰ | 1å¤„ | éœ€ç«‹å³ä¿®å¤ |
| âš ï¸ ä»…ä½¿ç”¨ä¸´æ—¶è·¯å¾„ï¼ˆP1ï¼‰ | 5å¤„ | éœ€ä¿®å¤ |
| âš ï¸ è½¬base64ä½†é€»è¾‘æ­£ç¡®ï¼ˆP2ï¼‰ | 3å¤„ | å¯ä¿ç•™æˆ–ä¼˜åŒ– |
| ğŸ“ æ³¨é‡Šå¾…å®ç° | 1å¤„ | åç»­å®Œå–„ |

**å…³é”®å‘ç°**ï¼š
- ğŸš¨ **ä¹°å®¶ç§€å‘å¸ƒé¡µé¢**ï¼šç›´æ¥ä½¿ç”¨ä¸´æ—¶è·¯å¾„å­˜å‚¨ï¼ŒçœŸæœº100%æ— æ³•æ˜¾ç¤ºå›¾ç‰‡
- âš ï¸ **å•†å“ç¼–è¾‘é¡µé¢**ï¼š4ä¸ªä½ç½®ä½¿ç”¨ä¸´æ—¶è·¯å¾„ï¼Œå½±å“å•†å“ä¸»å›¾ã€è§„æ ¼å›¾ã€è¯¦æƒ…å›¾
- âœ… **ç”»å¸ˆç”³è¯·ã€å·¥ä½œäººå‘˜äºŒç»´ç **ï¼šæ­£ç¡®ä½¿ç”¨äº‘å­˜å‚¨ï¼Œå¯ä½œä¸ºå‚è€ƒæ¨¡æ¿

---

## ğŸš¨ P0çº§é—®é¢˜ï¼ˆçœŸæœº100%æ— æ³•æ˜¾ç¤ºï¼‰

### é—®é¢˜1ï¼šä¹°å®¶ç§€å‘å¸ƒé¡µé¢ - ç›´æ¥ä½¿ç”¨ä¸´æ—¶è·¯å¾„

**æ–‡ä»¶**ï¼š`miniprogram/pages/buyer-show/publish/index.js`

**é—®é¢˜ä½ç½®**ï¼š
- ç¬¬118-127è¡Œï¼š`wx.chooseImage` åç›´æ¥å°† `tempFilePaths` å­˜å‚¨åˆ° `images` æ•°ç»„
- ç¬¬194è¡Œï¼šå°†åŒ…å«ä¸´æ—¶è·¯å¾„çš„ `images` ç›´æ¥å†™å…¥ `mock_buyer_shows` å­˜å‚¨

```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆç¬¬118-127è¡Œï¼‰
wx.chooseImage({
  count,
  sizeType: ['compressed'],
  success: (res) => {
    const newImages = res.tempFilePaths || []
    this.setData({
      images: images.concat(newImages).slice(0, maxImages)
    })
  }
})

// âŒ é”™è¯¯å†™æ³•ï¼ˆç¬¬194è¡Œï¼‰
const newPost = {
  // ...
  images,  // ğŸš¨ è¿™é‡ŒåŒ…å«çš„æ˜¯ wxfile://tmp/... è·¯å¾„
  // ...
}
buyerShows.unshift(newPost)
wx.setStorageSync('mock_buyer_shows', buyerShows)
```

**é—®é¢˜åŸå› **ï¼š
1. `tempFilePaths` æ˜¯å¾®ä¿¡å°ç¨‹åºä¸´æ—¶è·¯å¾„ï¼ˆæ ¼å¼ï¼š`wxfile://tmp/...`ï¼‰
2. ä¸´æ—¶æ–‡ä»¶åœ¨å°ç¨‹åºé‡å¯åä¼šè¢«æ¸…ç†
3. çœŸæœºç«¯æ— æ³•è®¿é—®ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ

**å½±å“èŒƒå›´**ï¼š
- æ‰€æœ‰ä¹°å®¶ç§€çš„å›¾ç‰‡åœ¨çœŸæœºç«¯æ— æ³•æ˜¾ç¤º
- å¼€å‘å·¥å…·é¢„è§ˆå¯èƒ½æ­£å¸¸ï¼ˆå› ä¸ºä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†ï¼‰
- ç”¨æˆ·å‘å¸ƒçš„ä¹°å®¶ç§€å›¾ç‰‡æ°¸ä¹…ä¸¢å¤±

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸ”´ P0 - ç«‹å³ä¿®å¤

**æ­£ç¡®å†™æ³•**ï¼š
```javascript
// âœ… æ–¹æ¡ˆ1ï¼šä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆæ¨èï¼‰
async chooseImages() {
  const { images, maxImages } = this.data
  const count = maxImages - images.length
  
  if (count <= 0) {
    wx.showToast({ title: 'æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡', icon: 'none' })
    return
  }

  try {
    const res = await wx.chooseImage({
      count,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
    
    // âœ… ä¸Šä¼ åˆ°äº‘å­˜å‚¨
    const cloudAPI = require('../../../utils/cloud-api.js')
    const uploadedUrls = []
    
    for (let i = 0; i < res.tempFilePaths.length; i++) {
      const filePath = res.tempFilePaths[i]
      const cloudPath = `buyer-shows/${Date.now()}_${i}.jpg`
      
      const uploadRes = await cloudAPI.uploadFile(filePath, cloudPath)
      if (uploadRes.success && uploadRes.fileID) {
        uploadedUrls.push(uploadRes.fileID)  // âœ… ä½¿ç”¨ cloud:// å¼€å¤´çš„ fileID
      }
    }
    
    wx.hideLoading()
    
    if (uploadedUrls.length > 0) {
      this.setData({
        images: images.concat(uploadedUrls).slice(0, maxImages)
      })
      wx.showToast({ title: `ä¸Šä¼ æˆåŠŸ ${uploadedUrls.length}/${res.tempFilePaths.length}`, icon: 'success' })
    }
  } catch (error) {
    wx.hideLoading()
    console.error('ä¸Šä¼ å¤±è´¥:', error)
    wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
  }
}

// âœ… æ–¹æ¡ˆ2ï¼šè½¬æ¢ä¸º base64ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼Œä¸æ¨èå¤§å›¾ï¼‰
// è½¬æ¢é€»è¾‘å‚è€ƒ service-qr-manage/index.js ç¬¬209-220è¡Œ
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `miniprogram/pages/apply/index.js` ç¬¬143-188è¡Œï¼ˆæ­£ç¡®çš„äº‘å­˜å‚¨ä¸Šä¼ ç¤ºä¾‹ï¼‰
- `miniprogram/utils/cloud-api.js` ç¬¬1027-1058è¡Œï¼ˆuploadFile å·¥å…·å‡½æ•°ï¼‰

---

## âš ï¸ P1çº§é—®é¢˜ï¼ˆé¢„è§ˆæ­£å¸¸ï¼ŒçœŸæœºå¼‚å¸¸ï¼‰

### é—®é¢˜2ï¼šå•†å“ç¼–è¾‘é¡µé¢ - å•†å“ä¸»å›¾ä½¿ç”¨ä¸´æ—¶è·¯å¾„

**æ–‡ä»¶**ï¼š`miniprogram/pages/product-edit/index.js`

**é—®é¢˜ä½ç½®**ï¼š
- ç¬¬643-679è¡Œï¼š`chooseImages` å‡½æ•°è°ƒç”¨ `compressAndConvertImage`
- ç¬¬692-755è¡Œï¼š`compressAndConvertImage` è¿”å› `canvasRes.tempFilePath`ï¼ˆä¸´æ—¶è·¯å¾„ï¼‰
- ç¬¬666-669è¡Œï¼šå°†ä¸´æ—¶è·¯å¾„å­˜å‚¨åˆ° `formData.images`

```javascript
// âŒ é—®é¢˜ä»£ç ï¼ˆç¬¬643-679è¡Œï¼‰
async chooseImages() {
  try {
    const res = await wx.chooseImage({
      count: 9 - this.data.formData.images.length,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'å¤„ç†å›¾ç‰‡ä¸­...' })
    
    // å‹ç¼©å¹¶è½¬æ¢ä¸º base64
    const promises = res.tempFilePaths.map(tempPath => {
      return this.compressAndConvertImage(tempPath)  // ğŸš¨ è¿”å›ä¸´æ—¶è·¯å¾„
    })
    
    const results = await Promise.all(promises)
    const validImages = results.filter(result => result.success).map(result => result.image)
    
    // ğŸš¨ validImages åŒ…å«ä¸´æ—¶è·¯å¾„
    const newImages = [...this.data.formData.images, ...validImages]
    this.setData({
      'formData.images': newImages,
      previewImages: this.createPreviewImages(newImages)
    })
  } catch (error) {
    // ...
  }
}

// âŒ é—®é¢˜ä»£ç ï¼ˆç¬¬692-755è¡Œï¼‰
async compressAndConvertImage(tempPath) {
  return new Promise((resolve) => {
    wx.getImageInfo({
      src: tempPath,
      success: (imgInfo) => {
        // ... å‹ç¼©é€»è¾‘ ...
        ctx.draw(false, () => {
          wx.canvasToTempFilePath({
            canvasId: 'compressCanvas',
            success: (canvasRes) => {
              resolve({ 
                success: true, 
                image: canvasRes.tempFilePath,  // ğŸš¨ è¿”å›ä¸´æ—¶è·¯å¾„
                size: 0
              })
            },
            fail: (err) => {
              resolve({ 
                success: true, 
                image: tempPath,  // ğŸš¨ é™çº§ä¹Ÿæ˜¯ä¸´æ—¶è·¯å¾„
                size: 0
              })
            }
          }, this)
        })
      }
    })
  })
}
```

**é—®é¢˜åŸå› **ï¼š
1. Canvas å¯¼å‡ºçš„ `tempFilePath` ä»ç„¶æ˜¯ä¸´æ—¶è·¯å¾„
2. å•†å“å‘å¸ƒåï¼Œå›¾ç‰‡è·¯å¾„è¢«å­˜å‚¨åˆ° `mock_products`
3. å°ç¨‹åºé‡å¯æˆ–çœŸæœºç¯å¢ƒä¸‹ï¼Œä¸´æ—¶æ–‡ä»¶è¢«æ¸…ç†

**å½±å“èŒƒå›´**ï¼š
- æ‰€æœ‰é€šè¿‡æ­¤é¡µé¢ä¸Šä¼ çš„å•†å“ä¸»å›¾
- å½±å“é¦–é¡µã€å•†å“è¯¦æƒ…ã€è´­ç‰©è½¦ç­‰æ‰€æœ‰å±•ç¤ºå•†å“å›¾ç‰‡çš„é¡µé¢

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§ä¿®å¤

**æ­£ç¡®å†™æ³•**ï¼š
```javascript
// âœ… ä¿®æ”¹ compressAndConvertImage å‡½æ•°
async compressAndConvertImage(tempPath) {
  return new Promise(async (resolve) => {
    wx.getImageInfo({
      src: tempPath,
      success: async (imgInfo) => {
        const targetSize = 1200
        const sourceSize = Math.min(imgInfo.width, imgInfo.height)
        const offsetX = (imgInfo.width - sourceSize) / 2
        const offsetY = (imgInfo.height - sourceSize) / 2
        
        const ctx = wx.createCanvasContext('compressCanvas', this)
        ctx.drawImage(tempPath, offsetX, offsetY, sourceSize, sourceSize, 0, 0, targetSize, targetSize)
        ctx.draw(false, async () => {
          wx.canvasToTempFilePath({
            canvasId: 'compressCanvas',
            destWidth: targetSize,
            destHeight: targetSize,
            quality: 0.75,
            success: async (canvasRes) => {
              // âœ… ä¸Šä¼ åˆ°äº‘å­˜å‚¨
              try {
                const cloudAPI = require('../../utils/cloud-api.js')
                const cloudPath = `products/${Date.now()}_${Math.random().toString(36).substring(2, 8)}.jpg`
                const uploadRes = await cloudAPI.uploadFile(canvasRes.tempFilePath, cloudPath)
                
                if (uploadRes.success && uploadRes.fileID) {
                  console.log('âœ… å›¾ç‰‡ä¸Šä¼ äº‘å­˜å‚¨æˆåŠŸ:', uploadRes.fileID)
                  resolve({ 
                    success: true, 
                    image: uploadRes.fileID,  // âœ… ä½¿ç”¨ cloud:// å¼€å¤´çš„ fileID
                    size: 0
                  })
                } else {
                  throw new Error('ä¸Šä¼ å¤±è´¥')
                }
              } catch (uploadError) {
                console.error('âŒ äº‘å­˜å‚¨ä¸Šä¼ å¤±è´¥:', uploadError)
                // é™çº§ï¼šè¿”å›å¤±è´¥
                resolve({ success: false, image: null })
              }
            },
            fail: (err) => {
              console.error('âŒ canvaså¯¼å‡ºå¤±è´¥:', err)
              resolve({ success: false, image: null })
            }
          }, this)
        })
      },
      fail: (err) => {
        console.error('âŒ è·å–å›¾ç‰‡ä¿¡æ¯å¤±è´¥:', err)
        resolve({ success: false, image: null })
      }
    })
  })
}
```

**åŒæ—¶å—å½±å“çš„ä½ç½®**ï¼š
1. ç¬¬1010-1044è¡Œï¼š`chooseSpec1Image` - ä¸€çº§è§„æ ¼å›¾ç‰‡
2. ç¬¬1129-1163è¡Œï¼š`chooseSpec2Image` - äºŒçº§è§„æ ¼å›¾ç‰‡
3. ç¬¬1342-1379è¡Œï¼š`chooseSummaryImages` - å•†å“è¯¦æƒ…å›¾ç‰‡

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç»Ÿä¸€è°ƒç”¨ä¿®æ”¹åçš„ `compressAndConvertImage` å‡½æ•°å³å¯ã€‚

---

### é—®é¢˜3ï¼šå•†å“ç¼–è¾‘é¡µé¢ - è§„æ ¼å›¾ç‰‡ä½¿ç”¨ä¸´æ—¶è·¯å¾„

**æ–‡ä»¶**ï¼š`miniprogram/pages/product-edit/index.js`

**é—®é¢˜ä½ç½®1**ï¼šç¬¬1010-1044è¡Œ - ä¸€çº§è§„æ ¼å›¾ç‰‡
```javascript
// âŒ é”™è¯¯å†™æ³•
async chooseSpec1Image(e) {
  const index = e.currentTarget.dataset.index
  try {
    const res = await wx.chooseImage({ count: 1, /* ... */ })
    wx.showLoading({ title: 'å¤„ç†ä¸­...' })
    
    const result = await this.compressAndConvertImage(res.tempFilePaths[0])  // ğŸš¨ è¿”å›ä¸´æ—¶è·¯å¾„
    
    if (result.success) {
      const spec1Values = [...this.data.spec1Values]
      spec1Values[index].image = result.image  // ğŸš¨ å­˜å‚¨ä¸´æ—¶è·¯å¾„
      this.setData({ spec1Values })
    }
  } catch (error) {
    // ...
  }
}
```

**é—®é¢˜ä½ç½®2**ï¼šç¬¬1129-1163è¡Œ - äºŒçº§è§„æ ¼å›¾ç‰‡
```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆåŒä¸Šï¼‰
async chooseSpec2Image(e) {
  // ... ä¸ chooseSpec1Image ç›¸åŒçš„é—®é¢˜
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `compressAndConvertImage` å‡½æ•°åï¼Œè¿™ä¸¤ä¸ªå‡½æ•°è‡ªåŠ¨ä¿®å¤
- æ— éœ€é¢å¤–ä¿®æ”¹

---

### é—®é¢˜4ï¼šå•†å“ç¼–è¾‘é¡µé¢ - å•†å“è¯¦æƒ…å›¾ç‰‡ä½¿ç”¨ä¸´æ—¶è·¯å¾„

**æ–‡ä»¶**ï¼š`miniprogram/pages/product-edit/index.js`

**é—®é¢˜ä½ç½®**ï¼šç¬¬1342-1379è¡Œ

```javascript
// âŒ é”™è¯¯å†™æ³•
async chooseSummaryImages() {
  try {
    const res = await wx.chooseImage({ /* ... */ })
    
    wx.showLoading({ title: 'å¤„ç†å›¾ç‰‡ä¸­...' })
    
    // å‹ç¼©æ‰€æœ‰å›¾ç‰‡
    const promises = res.tempFilePaths.map(tempPath => {
      return this.compressAndConvertImage(tempPath)  // ğŸš¨ è¿”å›ä¸´æ—¶è·¯å¾„
    })
    
    const results = await Promise.all(promises)
    const validImages = results.filter(result => result.success).map(result => result.image)
    
    if (validImages.length > 0) {
      const newImages = [...this.data.formData.summaryImages, ...validImages]  // ğŸš¨ å­˜å‚¨ä¸´æ—¶è·¯å¾„
      this.setData({
        'formData.summaryImages': newImages
      })
    }
  } catch (error) {
    // ...
  }
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `compressAndConvertImage` å‡½æ•°åï¼Œæ­¤å‡½æ•°è‡ªåŠ¨ä¿®å¤
- æ— éœ€é¢å¤–ä¿®æ”¹

---

### é—®é¢˜5ï¼šåˆ†ç±»ç®¡ç†é¡µé¢ - å›¾æ ‡ä½¿ç”¨ä¸´æ—¶è·¯å¾„

**æ–‡ä»¶**ï¼š`miniprogram/pages/category-manage/index.js`

**é—®é¢˜ä½ç½®**ï¼šç¬¬257-269è¡Œ

```javascript
// âŒ é”™è¯¯å†™æ³•ï¼ˆæœ‰æ³¨é‡Šè¯´æ˜å¾…å®ç°ï¼‰
uploadIcon() {
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      // å®é™…åº”ä¸Šä¼ åˆ°äº‘å­˜å‚¨  // ğŸš¨ æ³¨é‡Šæ‰¿è®¤é—®é¢˜ä½†æœªå®ç°
      this.setData({
        'formData.icon': res.tempFilePaths[0]  // ğŸš¨ ç›´æ¥ä½¿ç”¨ä¸´æ—¶è·¯å¾„
      })
      wx.showToast({ title: 'å›¾ç‰‡å·²é€‰æ‹©', icon: 'success' })
    }
  })
}
```

**å½±å“èŒƒå›´**ï¼š
- åˆ†ç±»å›¾æ ‡åœ¨çœŸæœºç«¯æ— æ³•æ˜¾ç¤º
- ç›®å‰åˆ†ç±»ä¸»è¦ä½¿ç”¨ emojiï¼Œå›¾æ ‡åŠŸèƒ½å½±å“è¾ƒå°

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¡ P1 - ä¸­ä¼˜å…ˆçº§ä¿®å¤

**æ­£ç¡®å†™æ³•**ï¼š
```javascript
// âœ… æ­£ç¡®å†™æ³•
async uploadIcon() {
  try {
    const res = await wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
    
    const cloudAPI = require('../../utils/cloud-api.js')
    const cloudPath = `categories/icon_${Date.now()}.jpg`
    const uploadRes = await cloudAPI.uploadFile(res.tempFilePaths[0], cloudPath)
    
    if (uploadRes.success && uploadRes.fileID) {
      this.setData({
        'formData.icon': uploadRes.fileID  // âœ… ä½¿ç”¨ cloud:// fileID
      })
      wx.hideLoading()
      wx.showToast({ title: 'ä¸Šä¼ æˆåŠŸ', icon: 'success' })
    } else {
      throw new Error('ä¸Šä¼ å¤±è´¥')
    }
  } catch (error) {
    wx.hideLoading()
    console.error('ä¸Šä¼ å¤±è´¥:', error)
    wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
  }
}
```

---

## âœ… æ­£ç¡®å®ç°ï¼ˆå¯ä½œä¸ºå‚è€ƒï¼‰

### æ­£ç¡®å®ç°1ï¼šç”»å¸ˆç”³è¯·é¡µé¢

**æ–‡ä»¶**ï¼š`miniprogram/pages/apply/index.js`

**æ­£ç¡®ä½ç½®**ï¼šç¬¬143-188è¡Œ

```javascript
// âœ… æ­£ç¡®å†™æ³•
async uploadImages(e) {
  const type = e.currentTarget.dataset.type
  const currentImages = this.data.formData[type]
  
  try {
    const res = await wx.chooseImage({
      count: 9 - currentImages.length,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
    
    // âœ… ä¸Šä¼ åˆ°äº‘å­˜å‚¨
    const cloudAPI = require('../../utils/cloud-api.js')
    const uploadedUrls = []
    
    for (let i = 0; i < res.tempFilePaths.length; i++) {
      const filePath = res.tempFilePaths[i]
      const cloudPath = `artist-applications/${type}/${Date.now()}_${i}.${filePath.split('.').pop()}`
      
      try {
        const uploadRes = await cloudAPI.uploadFile(filePath, cloudPath)
        if (uploadRes.success && uploadRes.fileID) {
          uploadedUrls.push(uploadRes.fileID)  // âœ… ä½¿ç”¨ cloud:// å¼€å¤´çš„ fileID
          console.log(`âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ (${i + 1}/${res.tempFilePaths.length}):`, uploadRes.fileID)
        } else {
          console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', uploadRes)
        }
      } catch (uploadError) {
        console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¼‚å¸¸:', uploadError)
      }
    }
    
    if (uploadedUrls.length > 0) {
      this.setData({
        [`formData.${type}`]: [...currentImages, ...uploadedUrls]
      })
      
      wx.hideLoading()
      wx.showToast({
        title: `ä¸Šä¼ æˆåŠŸ ${uploadedUrls.length}/${res.tempFilePaths.length}`,
        icon: 'success'
      })
    } else {
      wx.hideLoading()
      wx.showToast({
        title: 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
    }
  } catch (error) {
    // ...
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `cloudAPI.uploadFile` ç»Ÿä¸€å·¥å…·å‡½æ•°
- âœ… æ‰¹é‡ä¸Šä¼ ï¼Œæ”¯æŒå¤±è´¥é‡è¯•
- âœ… å­˜å‚¨çš„æ˜¯ `cloud://` å¼€å¤´çš„ fileID
- âœ… çœŸæœºç«¯æ°¸ä¹…æœ‰æ•ˆ

---

### æ­£ç¡®å®ç°2ï¼šå·¥ä½œäººå‘˜äºŒç»´ç ç®¡ç†

**æ–‡ä»¶**ï¼š`miniprogram/pages/staff-qrcode-manage/index.js`

**æ­£ç¡®ä½ç½®1**ï¼šç¬¬52-99è¡Œ - å·¥ä½œäººå‘˜è”ç³»äºŒç»´ç 

```javascript
// âœ… æ­£ç¡®å†™æ³•
chooseQRCode() {
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: async (res) => {
      const tempFilePath = res.tempFilePaths[0]
      
      wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
      
      try {
        // âœ… ä¸Šä¼ åˆ°äº‘å­˜å‚¨
        const cloudPath = `qrcodes/staff_contact_${Date.now()}.jpg`
        const uploadRes = await wx.cloud.uploadFile({  // âœ… ç›´æ¥è°ƒç”¨äº‘API
          cloudPath,
          filePath: tempFilePath
        })
        
        console.log('â˜ï¸ äº‘å­˜å‚¨ä¸Šä¼ æˆåŠŸ:', uploadRes.fileID)
        
        // âœ… ä¿å­˜åˆ°äº‘æ•°æ®åº“
        const saveRes = await cloudAPI.uploadStaffQRCode(uploadRes.fileID, cloudPath)
        
        if (saveRes.success) {
          this.setData({
            currentQRCode: uploadRes.fileID  // âœ… ä½¿ç”¨ cloud:// fileID
          })
          
          wx.hideLoading()
          wx.showToast({ title: 'è®¾ç½®æˆåŠŸ', icon: 'success' })
          console.log('âœ… å·¥ä½œäººå‘˜è”ç³»äºŒç»´ç å·²æ›´æ–°ï¼ˆäº‘ç«¯ï¼‰')
        } else {
          throw new Error(saveRes.message || 'ä¿å­˜å¤±è´¥')
        }
      } catch (error) {
        console.error('âŒ ä¸Šä¼ å¤±è´¥:', error)
        wx.hideLoading()
        wx.showToast({
          title: 'ä¸Šä¼ å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'),
          icon: 'none',
          duration: 2000
        })
      }
    }
  })
}
```

**æ­£ç¡®ä½ç½®2**ï¼šç¬¬112-159è¡Œ - å”®åäºŒç»´ç 

```javascript
// âœ… æ­£ç¡®å†™æ³•ï¼ˆåŒä¸Šï¼‰
chooseServiceQRCode() {
  // ... ä¸ chooseQRCode ç›¸åŒçš„æ­£ç¡®é€»è¾‘
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç›´æ¥ä½¿ç”¨ `wx.cloud.uploadFile` API
- âœ… ä¸Šä¼ æˆåŠŸåå†™å…¥äº‘æ•°æ®åº“
- âœ… æ”¯æŒè·¨è®¾å¤‡åŒæ­¥
- âœ… çœŸæœºç«¯æ°¸ä¹…æœ‰æ•ˆ

---

### æ­£ç¡®å®ç°3ï¼šäº‘å­˜å‚¨å·¥å…·å‡½æ•°

**æ–‡ä»¶**ï¼š`miniprogram/utils/cloud-api.js`

**æ­£ç¡®ä½ç½®**ï¼šç¬¬1027-1058è¡Œ

```javascript
// âœ… ç»Ÿä¸€çš„äº‘å­˜å‚¨ä¸Šä¼ å·¥å…·å‡½æ•°
async uploadFile(filePath, cloudPath) {
  try {
    // å¦‚æœæ²¡æœ‰æŒ‡å®šäº‘è·¯å¾„ï¼Œè‡ªåŠ¨ç”Ÿæˆ
    if (!cloudPath) {
      const timestamp = Date.now()
      const random = Math.random().toString(36).substring(2, 8)
      const ext = filePath.split('.').pop() || 'jpg'
      cloudPath = `uploads/${timestamp}_${random}.${ext}`
    }

    const result = await wx.cloud.uploadFile({
      cloudPath: cloudPath,
      filePath: filePath
    })

    console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result.fileID)
    
    return {
      success: true,
      fileID: result.fileID,  // âœ… è¿”å› cloud:// å¼€å¤´çš„ fileID
      cloudPath: cloudPath
    }
  } catch (error) {
    console.error('âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error)
    return {
      success: false,
      message: error.errMsg || 'ä¸Šä¼ å¤±è´¥'
    }
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```javascript
const cloudAPI = require('../../utils/cloud-api.js')
const uploadRes = await cloudAPI.uploadFile(tempFilePath, 'custom/path.jpg')
if (uploadRes.success) {
  const fileID = uploadRes.fileID  // cloud://xxx
}
```

---

## ğŸ“ P2çº§é—®é¢˜ï¼ˆé€»è¾‘æ­£ç¡®ä½†å¯ä¼˜åŒ–ï¼‰

### é—®é¢˜6ï¼šå®¢æœäºŒç»´ç ç®¡ç† - ä½¿ç”¨ base64

**æ–‡ä»¶**ï¼š`miniprogram/pages/service-qr-manage/index.js`

**ä½ç½®**ï¼š
- ç¬¬140-220è¡Œï¼š`chooseAvatar` / `uploadQrcode` / `convertTempToBase64`
- ç¬¬324-350è¡Œï¼šç¼–è¾‘å®¢æœæ—¶ä¸Šä¼ äºŒç»´ç 

```javascript
// âš ï¸ å½“å‰å†™æ³•ï¼ˆè½¬ä¸º base64ï¼‰
async chooseAvatar() {
  try {
    const res = await wx.chooseImage({ count: 1, /* ... */ })

    if (res.tempFilePaths && res.tempFilePaths.length > 0) {
      const tempPath = res.tempFilePaths[0]
      
      // âš ï¸ è½¬æ¢ä¸º base64
      const base64 = await this.convertTempToBase64(tempPath)
      
      this.setData({
        'newService.qrcodeUrl': base64  // âš ï¸ å­˜å‚¨ base64
      })
    }
  } catch (error) {
    // ...
  }
}

convertTempToBase64(tempPath) {
  return new Promise((resolve, reject) => {
    wx.getFileSystemManager().readFile({
      filePath: tempPath,
      encoding: 'base64',
      success: (res) => {
        resolve(`data:image/jpeg;base64,${res.data}`)  // âš ï¸ è¿”å› base64
      },
      fail: reject
    })
  })
}
```

**å½“å‰çŠ¶æ€**ï¼šâœ… å¯ä»¥å·¥ä½œ
- base64 å¯ä»¥åœ¨çœŸæœºç«¯æ˜¾ç¤º
- æ•°æ®å­˜å‚¨åœ¨äº‘æ•°æ®åº“ `service_qrcodes` è¡¨ä¸­
- è·¨è®¾å¤‡åŒæ­¥æ­£å¸¸

**æ½œåœ¨é—®é¢˜**ï¼š
- base64 å­—ç¬¦ä¸²å¾ˆé•¿ï¼Œå ç”¨æ•°æ®åº“å­˜å‚¨ç©ºé—´
- æ•°æ®åº“æœ‰å•æ¡è®°å½•å¤§å°é™åˆ¶ï¼ˆé€šå¸¸2MBï¼‰
- ä¼ è¾“æ—¶å ç”¨æ›´å¤šå¸¦å®½

**ä¼˜åŒ–å»ºè®®**ï¼ˆå¯é€‰ï¼‰ï¼š
```javascript
// âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šæ”¹ä¸ºä¸Šä¼ äº‘å­˜å‚¨
async chooseAvatar() {
  try {
    const res = await wx.chooseImage({ count: 1, /* ... */ })

    if (res.tempFilePaths && res.tempFilePaths.length > 0) {
      const tempPath = res.tempFilePaths[0]
      
      wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
      
      // âœ… ä¸Šä¼ åˆ°äº‘å­˜å‚¨
      const cloudAPI = require('../../utils/cloud-api.js')
      const cloudPath = `service-qrcodes/${Date.now()}.jpg`
      const uploadRes = await cloudAPI.uploadFile(tempPath, cloudPath)
      
      wx.hideLoading()
      
      if (uploadRes.success) {
        this.setData({
          'newService.qrcodeUrl': uploadRes.fileID  // âœ… ä½¿ç”¨ cloud:// fileID
        })
        console.log('âœ… äºŒç»´ç ä¸Šä¼ æˆåŠŸï¼ˆäº‘å­˜å‚¨ï¼‰')
      } else {
        wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
      }
    }
  } catch (error) {
    wx.hideLoading()
    console.error('ä¸Šä¼ å¤±è´¥:', error)
    wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
  }
}
```

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¢ P2 - ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆå¯ä¿ç•™å½“å‰æ–¹æ¡ˆï¼‰

---

### é—®é¢˜7ï¼šè½®æ’­å›¾ç®¡ç† - ä½¿ç”¨ base64

**æ–‡ä»¶**ï¼š`miniprogram/pages/banner-manage/index.js`

**ä½ç½®**ï¼šç¬¬33-71è¡Œ

```javascript
// âš ï¸ å½“å‰å†™æ³•ï¼ˆè½¬ä¸º base64 åé€šè¿‡äº‘å‡½æ•°ä¸Šä¼ ï¼‰
showAddModal() {
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      const tempPath = res.tempFilePaths[0]
      
      // âš ï¸ è½¬æ¢ä¸º base64
      wx.getFileSystemManager().readFile({
        filePath: tempPath,
        encoding: 'base64',
        success: async (fileRes) => {
          const base64 = 'data:image/jpeg;base64,' + fileRes.data
          const cloudAPI = require('../../utils/cloud-api.js')
          
          // âš ï¸ åˆ›å»ºè½®æ’­å›¾ï¼ˆä¼ å…¥ base64ï¼‰
          const result = await cloudAPI.createBanner({
            image: base64,  // âš ï¸ ä¼  base64 ç»™äº‘å‡½æ•°
            title: 'è½®æ’­å›¾',
            link: '',
            sort: 0
          })
          
          if (result.success) {
            wx.showToast({ title: 'æ·»åŠ æˆåŠŸ', icon: 'success' })
            this.loadData()
          }
        },
        fail: (err) => {
          console.error('è¯»å–å¤±è´¥:', err)
          wx.showToast({ title: 'æ·»åŠ å¤±è´¥', icon: 'none' })
        }
      })
    }
  })
}
```

**å½“å‰çŠ¶æ€**ï¼šâœ… å¯ä»¥å·¥ä½œ
- base64 é€šè¿‡äº‘å‡½æ•°ä¼ é€’
- æœ€ç»ˆå­˜å‚¨åœ¨äº‘æ•°æ®åº“
- çœŸæœºç«¯å¯ä»¥æ˜¾ç¤º

**æ½œåœ¨é—®é¢˜**ï¼š
- base64 å­—ç¬¦ä¸²å¾ˆé•¿ï¼Œäº‘å‡½æ•°ä¼ å‚æœ‰å¤§å°é™åˆ¶
- æ•°æ®åº“å­˜å‚¨ç©ºé—´å ç”¨å¤§

**ä¼˜åŒ–å»ºè®®**ï¼ˆå¯é€‰ï¼‰ï¼š
```javascript
// âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šç›´æ¥ä¸Šä¼ äº‘å­˜å‚¨
async showAddModal() {
  try {
    const res = await wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    })

    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
    
    const cloudAPI = require('../../utils/cloud-api.js')
    const cloudPath = `banners/${Date.now()}.jpg`
    const uploadRes = await cloudAPI.uploadFile(res.tempFilePaths[0], cloudPath)
    
    if (uploadRes.success) {
      // âœ… åˆ›å»ºè½®æ’­å›¾ï¼ˆä¼ å…¥ fileIDï¼‰
      const result = await cloudAPI.createBanner({
        image: uploadRes.fileID,  // âœ… ä¼  cloud:// fileID
        title: 'è½®æ’­å›¾',
        link: '',
        sort: 0
      })
      
      wx.hideLoading()
      
      if (result.success) {
        wx.showToast({ title: 'æ·»åŠ æˆåŠŸ', icon: 'success' })
        this.loadData()
      } else {
        wx.showToast({ title: 'æ·»åŠ å¤±è´¥', icon: 'none' })
      }
    }
  } catch (error) {
    wx.hideLoading()
    console.error('ä¸Šä¼ å¤±è´¥:', error)
    wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
  }
}
```

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¢ P2 - ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆå¯ä¿ç•™å½“å‰æ–¹æ¡ˆï¼‰

---

### é—®é¢˜8ï¼šç™»å½•é¡µé¢ - å¤´åƒä½¿ç”¨ base64

**æ–‡ä»¶**ï¼š`miniprogram/pages/login/index.js`

**ä½ç½®**ï¼šç¬¬73-85è¡Œ

```javascript
// âš ï¸ å½“å‰å†™æ³•ï¼ˆè½¬ä¸º base64ï¼‰
try {
  let finalAvatarUrl = avatarUrl
  if (avatarUrl && avatarUrl.startsWith('http://tmp/')) {
    console.log('âš ï¸ æ£€æµ‹åˆ°ä¸´æ—¶å¤´åƒï¼Œæ­£åœ¨è½¬æ¢ä¸º base64...')
    try {
      const fs = wx.getFileSystemManager()
      const fileData = fs.readFileSync(avatarUrl, 'base64')
      finalAvatarUrl = 'data:image/jpeg;base64,' + fileData  // âš ï¸ è½¬ä¸º base64
      console.log('âœ… ä¸´æ—¶å¤´åƒè½¬æ¢æˆåŠŸ')
    } catch (err) {
      console.error('âŒ ä¸´æ—¶å¤´åƒè½¬æ¢å¤±è´¥:', err)
      finalAvatarUrl = this.data.avatarUrl  // ä½¿ç”¨é»˜è®¤å¤´åƒ
    }
  }
  
  // âœ… è°ƒç”¨äº‘å‡½æ•°ç™»å½•
  const loginRes = await cloudAPI.login(nickName.trim(), finalAvatarUrl)  // âš ï¸ ä¼  base64
  // ...
} catch (error) {
  // ...
}
```

**å½“å‰çŠ¶æ€**ï¼šâœ… å¯ä»¥å·¥ä½œ
- ä¸´æ—¶å¤´åƒè½¬ä¸º base64 åé€šè¿‡äº‘å‡½æ•°ä¸Šä¼ 
- äº‘å‡½æ•° `login` å¤„ç†å¹¶å­˜å‚¨åˆ°æ•°æ®åº“
- çœŸæœºç«¯å¯ä»¥æ˜¾ç¤º

**æ½œåœ¨é—®é¢˜**ï¼š
- base64 å ç”¨æ•°æ®åº“å­˜å‚¨
- äº‘å‡½æ•°ä¼ å‚æœ‰å¤§å°é™åˆ¶

**ä¼˜åŒ–å»ºè®®**ï¼ˆå¯é€‰ï¼‰ï¼š
```javascript
// âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šå…ˆä¸Šä¼ äº‘å­˜å‚¨ï¼Œå†è°ƒç”¨ç™»å½•
try {
  let finalAvatarUrl = avatarUrl
  
  if (avatarUrl && avatarUrl.startsWith('http://tmp/')) {
    console.log('âš ï¸ æ£€æµ‹åˆ°ä¸´æ—¶å¤´åƒï¼Œä¸Šä¼ åˆ°äº‘å­˜å‚¨...')
    
    wx.showLoading({ title: 'ä¸Šä¼ å¤´åƒ...' })
    
    try {
      const cloudAPI = require('../../utils/cloud-api.js')
      const cloudPath = `avatars/user_${Date.now()}.jpg`
      const uploadRes = await cloudAPI.uploadFile(avatarUrl, cloudPath)
      
      if (uploadRes.success) {
        finalAvatarUrl = uploadRes.fileID  // âœ… ä½¿ç”¨ cloud:// fileID
        console.log('âœ… å¤´åƒä¸Šä¼ äº‘å­˜å‚¨æˆåŠŸ:', finalAvatarUrl)
      } else {
        console.error('âŒ å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ')
        finalAvatarUrl = this.data.avatarUrl
      }
    } catch (err) {
      console.error('âŒ å¤´åƒä¸Šä¼ å¼‚å¸¸:', err)
      finalAvatarUrl = this.data.avatarUrl
    }
    
    wx.hideLoading()
  }
  
  // âœ… è°ƒç”¨äº‘å‡½æ•°ç™»å½•
  const loginRes = await cloudAPI.login(nickName.trim(), finalAvatarUrl)  // âœ… ä¼  fileID
  // ...
} catch (error) {
  // ...
}
```

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¢ P2 - ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆå¯ä¿ç•™å½“å‰æ–¹æ¡ˆï¼‰

---

### é—®é¢˜9ï¼šå·¥ä½œå°é¡µé¢ - å®¢æœäºŒç»´ç ä¸Šä¼ ï¼ˆå·²åºŸå¼ƒï¼‰

**æ–‡ä»¶**ï¼š`miniprogram/pages/workspace/index.js`

**ä½ç½®**ï¼šç¬¬618-658è¡Œ

```javascript
// âš ï¸ å·²åºŸå¼ƒçš„ä»£ç 
uploadQRCode() {
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      const tempFilePath = res.tempFilePaths[0]
      
      wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
      
      // è½¬æ¢ä¸º base64
      const fs = wx.getFileSystemManager()
      fs.readFile({
        filePath: tempFilePath,
        encoding: 'base64',
        success: (fileRes) => {
          const base64 = 'data:image/jpeg;base64,' + fileRes.data
          
          // âœ… å·²åºŸå¼ƒï¼šä¸å†ä¿å­˜åˆ°æœ¬åœ°
          console.warn('[DEPRECATED] å®¢æœäºŒç»´ç åº”é€šè¿‡äº‘ç«¯service_qrcodesè¡¨ç®¡ç†')
          
          wx.hideLoading()
          wx.showToast({ title: 'ä¸Šä¼ æˆåŠŸ', icon: 'success' })
        },
        fail: () => {
          wx.hideLoading()
          wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' })
        }
      })
    }
  })
}
```

**å½“å‰çŠ¶æ€**ï¼šâœ… å·²åºŸå¼ƒï¼Œä¸å½±å“åŠŸèƒ½

**å»ºè®®**ï¼š
- ä»£ç ä¸­å·²æ³¨é‡Šä¸º `[DEPRECATED]`
- å»ºè®®åˆ é™¤æ­¤å‡½æ•°ï¼Œé¿å…æ··æ·†
- æˆ–è€…é‡å®šå‘åˆ°æ­£ç¡®çš„å®¢æœç®¡ç†é¡µé¢

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸŸ¢ P2 - ä»£ç æ¸…ç†ï¼ˆå¯é€‰ï¼‰

---

## ğŸ› ï¸ ä¿®å¤ä¼˜å…ˆçº§æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜ | æ–‡ä»¶ | è¡Œå· | ä¿®å¤å¤æ‚åº¦ |
|--------|------|------|------|-----------|
| ğŸ”´ P0 | ä¹°å®¶ç§€å›¾ç‰‡ç›´æ¥ä½¿ç”¨ä¸´æ—¶è·¯å¾„ | `buyer-show/publish/index.js` | 118-127, 194 | â­â­ ä¸­ç­‰ |
| ğŸŸ¡ P1 | å•†å“ä¸»å›¾ä½¿ç”¨ä¸´æ—¶è·¯å¾„ | `product-edit/index.js` | 643-679, 692-755 | â­â­â­ è¾ƒé«˜ |
| ğŸŸ¡ P1 | å•†å“è§„æ ¼å›¾ä½¿ç”¨ä¸´æ—¶è·¯å¾„ | `product-edit/index.js` | 1010-1044, 1129-1163 | â­ ä½ï¼ˆä¿®æ”¹åè‡ªåŠ¨ä¿®å¤ï¼‰ |
| ğŸŸ¡ P1 | å•†å“è¯¦æƒ…å›¾ä½¿ç”¨ä¸´æ—¶è·¯å¾„ | `product-edit/index.js` | 1342-1379 | â­ ä½ï¼ˆä¿®æ”¹åè‡ªåŠ¨ä¿®å¤ï¼‰ |
| ğŸŸ¡ P1 | åˆ†ç±»å›¾æ ‡ä½¿ç”¨ä¸´æ—¶è·¯å¾„ | `category-manage/index.js` | 257-269 | â­ ä½ |
| ğŸŸ¢ P2 | å®¢æœäºŒç»´ç ä½¿ç”¨ base64 | `service-qr-manage/index.js` | 140-220 | â­â­ ä¸­ç­‰ï¼ˆå¯é€‰ï¼‰ |
| ğŸŸ¢ P2 | è½®æ’­å›¾ä½¿ç”¨ base64 | `banner-manage/index.js` | 33-71 | â­â­ ä¸­ç­‰ï¼ˆå¯é€‰ï¼‰ |
| ğŸŸ¢ P2 | ç™»å½•å¤´åƒä½¿ç”¨ base64 | `login/index.js` | 73-85 | â­â­ ä¸­ç­‰ï¼ˆå¯é€‰ï¼‰ |
| ğŸŸ¢ P2 | å·¥ä½œå°åºŸå¼ƒä»£ç æ¸…ç† | `workspace/index.js` | 618-658 | â­ ä½ï¼ˆå¯é€‰ï¼‰ |

---

## ğŸ“‹ ä¿®å¤æ­¥éª¤å»ºè®®

### é˜¶æ®µä¸€ï¼šP0 ç´§æ€¥ä¿®å¤ï¼ˆ1å¤©ï¼‰

**1. ä¿®å¤ä¹°å®¶ç§€å›¾ç‰‡ä¸Šä¼ **
- æ–‡ä»¶ï¼š`miniprogram/pages/buyer-show/publish/index.js`
- ä¿®æ”¹ï¼š`chooseImages` å‡½æ•°æ”¹ä¸ºä¸Šä¼ äº‘å­˜å‚¨
- æµ‹è¯•ï¼šå‘å¸ƒä¹°å®¶ç§€ â†’ é‡å¯å°ç¨‹åº â†’ éªŒè¯å›¾ç‰‡æ˜¾ç¤º
- é¢„è®¡æ—¶é—´ï¼š2å°æ—¶

---

### é˜¶æ®µäºŒï¼šP1 æ ¸å¿ƒä¿®å¤ï¼ˆ2-3å¤©ï¼‰

**2. ä¿®å¤å•†å“ç¼–è¾‘æ ¸å¿ƒå‡½æ•°**
- æ–‡ä»¶ï¼š`miniprogram/pages/product-edit/index.js`
- æ­¥éª¤ï¼š
  1. ä¿®æ”¹ `compressAndConvertImage` å‡½æ•°ï¼ˆç¬¬692-755è¡Œï¼‰
  2. åœ¨ Canvas å¯¼å‡ºåå¢åŠ äº‘å­˜å‚¨ä¸Šä¼ é€»è¾‘
  3. è¿”å› `cloud://` å¼€å¤´çš„ fileID
- å½±å“ï¼šè‡ªåŠ¨ä¿®å¤ä¸»å›¾ã€è§„æ ¼å›¾ã€è¯¦æƒ…å›¾æ‰€æœ‰é—®é¢˜
- æµ‹è¯•ï¼š
  - å‘å¸ƒæ–°å•†å“ï¼ŒéªŒè¯å›¾ç‰‡ä¿å­˜ä¸º `cloud://` æ ¼å¼
  - é‡å¯å°ç¨‹åºï¼ŒéªŒè¯å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
  - çœŸæœºæµ‹è¯•
- é¢„è®¡æ—¶é—´ï¼š4-6å°æ—¶

**3. ä¿®å¤åˆ†ç±»å›¾æ ‡ä¸Šä¼ **
- æ–‡ä»¶ï¼š`miniprogram/pages/category-manage/index.js`
- ä¿®æ”¹ï¼š`uploadIcon` å‡½æ•°æ”¹ä¸ºä¸Šä¼ äº‘å­˜å‚¨
- æµ‹è¯•ï¼šä¸Šä¼ åˆ†ç±»å›¾æ ‡ â†’ é‡å¯å°ç¨‹åº â†’ éªŒè¯æ˜¾ç¤º
- é¢„è®¡æ—¶é—´ï¼š1å°æ—¶

**4. æ•°æ®è¿ç§»**
- ç›®æ ‡ï¼šå°†å·²å­˜åœ¨çš„ä¸´æ—¶è·¯å¾„å›¾ç‰‡è½¬ä¸º base64 æˆ–äº‘å­˜å‚¨
- è„šæœ¬ï¼šåˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰
- é¢„è®¡æ—¶é—´ï¼š2-4å°æ—¶

---

### é˜¶æ®µä¸‰ï¼šP2 ä¼˜åŒ–ï¼ˆå¯é€‰ï¼Œ1-2å¤©ï¼‰

**5. ä¼˜åŒ– base64 å­˜å‚¨æ–¹æ¡ˆ**
- æ–‡ä»¶ï¼š
  - `service-qr-manage/index.js`
  - `banner-manage/index.js`
  - `login/index.js`
- ä¿®æ”¹ï¼šæ”¹ä¸ºäº‘å­˜å‚¨
- ä¼˜ç‚¹ï¼šèŠ‚çœæ•°æ®åº“ç©ºé—´ï¼Œæå‡æ€§èƒ½
- é¢„è®¡æ—¶é—´ï¼š3-4å°æ—¶

**6. ä»£ç æ¸…ç†**
- åˆ é™¤åºŸå¼ƒä»£ç ï¼ˆ`workspace/index.js` ç¬¬618-658è¡Œï¼‰
- ç»Ÿä¸€å›¾ç‰‡ä¸Šä¼ é€»è¾‘
- é¢„è®¡æ—¶é—´ï¼š1å°æ—¶

---

## ğŸ” æµ‹è¯•æ£€æŸ¥æ¸…å•

### âœ… åŠŸèƒ½æµ‹è¯•

- [ ] ä¹°å®¶ç§€å‘å¸ƒ â†’ é‡å¯å°ç¨‹åº â†’ å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- [ ] å•†å“å‘å¸ƒï¼ˆä¸»å›¾ï¼‰ â†’ é‡å¯å°ç¨‹åº â†’ é¦–é¡µ/è¯¦æƒ…é¡µå›¾ç‰‡æ­£å¸¸
- [ ] å•†å“å‘å¸ƒï¼ˆè§„æ ¼å›¾ï¼‰ â†’ é‡å¯å°ç¨‹åº â†’ è§„æ ¼é€‰æ‹©å™¨å›¾ç‰‡æ­£å¸¸
- [ ] å•†å“å‘å¸ƒï¼ˆè¯¦æƒ…å›¾ï¼‰ â†’ é‡å¯å°ç¨‹åº â†’ è¯¦æƒ…é¡µå›¾ç‰‡æ­£å¸¸
- [ ] åˆ†ç±»å›¾æ ‡ä¸Šä¼  â†’ é‡å¯å°ç¨‹åº â†’ åˆ†ç±»åˆ—è¡¨å›¾æ ‡æ­£å¸¸
- [ ] å®¢æœäºŒç»´ç ä¸Šä¼  â†’ è·¨è®¾å¤‡ç™»å½• â†’ äºŒç»´ç åŒæ­¥æ˜¾ç¤º
- [ ] å·¥ä½œäººå‘˜äºŒç»´ç ä¸Šä¼  â†’ è·¨è®¾å¤‡ç™»å½• â†’ äºŒç»´ç åŒæ­¥æ˜¾ç¤º
- [ ] è½®æ’­å›¾ä¸Šä¼  â†’ é‡å¯å°ç¨‹åº â†’ é¦–é¡µè½®æ’­æ­£å¸¸

### âœ… çœŸæœºæµ‹è¯•

- [ ] iOS çœŸæœºæµ‹è¯•æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
- [ ] Android çœŸæœºæµ‹è¯•æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
- [ ] å°ç¨‹åºé‡å¯åå›¾ç‰‡ä»ç„¶æ˜¾ç¤º
- [ ] è·¨è®¾å¤‡ç™»å½•å›¾ç‰‡åŒæ­¥æ­£å¸¸

### âœ… æ•°æ®æ£€æŸ¥

- [ ] æ•°æ®åº“ä¸­å›¾ç‰‡å­—æ®µæ ¼å¼ä¸º `cloud://...`
- [ ] æœ¬åœ°å­˜å‚¨ä¸­å›¾ç‰‡å­—æ®µæ ¼å¼ä¸º `cloud://...`
- [ ] æ—  `wxfile://tmp/...` æˆ– `http://tmp/...` è·¯å¾„
- [ ] base64 ä»…ç”¨äºæ— æ³•äº‘å­˜å‚¨çš„åœºæ™¯

---

## ğŸ“š å‚è€ƒèµ„æ–™

### äº‘å­˜å‚¨ API

```javascript
// ä¸Šä¼ æ–‡ä»¶
wx.cloud.uploadFile({
  cloudPath: 'example.jpg',  // äº‘ç«¯è·¯å¾„
  filePath: tempFilePath,    // æœ¬åœ°ä¸´æ—¶è·¯å¾„
  success: res => {
    console.log('fileID:', res.fileID)  // cloud://xxx
  }
})

// åˆ é™¤æ–‡ä»¶
wx.cloud.deleteFile({
  fileList: ['cloud://xxx']
})

// ä¸‹è½½æ–‡ä»¶
wx.cloud.downloadFile({
  fileID: 'cloud://xxx',
  success: res => {
    console.log('tempFilePath:', res.tempFilePath)
  }
})

// è·å–ä¸´æ—¶é“¾æ¥ï¼ˆç”¨äºåˆ†äº«ç­‰åœºæ™¯ï¼‰
wx.cloud.getTempFileURL({
  fileList: ['cloud://xxx'],
  success: res => {
    console.log('ä¸´æ—¶é“¾æ¥:', res.fileList[0].tempFileURL)
  }
})
```

### å·¥å…·å‡½æ•°

```javascript
// å°è£…çš„äº‘å­˜å‚¨ä¸Šä¼ å‡½æ•°ï¼ˆå·²å®ç°ï¼‰
const cloudAPI = require('../../utils/cloud-api.js')
const uploadRes = await cloudAPI.uploadFile(tempFilePath, cloudPath)
if (uploadRes.success) {
  const fileID = uploadRes.fileID  // cloud://xxx
}
```

### æ­£ç¡®ç¤ºä¾‹

- `miniprogram/pages/apply/index.js` ç¬¬143-188è¡Œ
- `miniprogram/pages/staff-qrcode-manage/index.js` ç¬¬52-99è¡Œ
- `miniprogram/utils/cloud-api.js` ç¬¬1027-1058è¡Œ

---

## âš ï¸ é‡è¦æç¤º

1. **ä¸´æ—¶è·¯å¾„çš„æœ‰æ•ˆæœŸ**ï¼š
   - å°ç¨‹åºé‡å¯åå¤±æ•ˆ
   - åˆ‡åå°ä¸€æ®µæ—¶é—´åå¯èƒ½å¤±æ•ˆ
   - çœŸæœºç«¯è®¿é—®é™åˆ¶æ›´ä¸¥æ ¼

2. **base64 çš„é€‚ç”¨åœºæ™¯**ï¼š
   - å°å›¾æ ‡ï¼ˆ< 100KBï¼‰
   - éœ€è¦å†…åµŒçš„å›¾ç‰‡
   - ä¸é¢‘ç¹å˜åŠ¨çš„å›¾ç‰‡
   - **ä¸é€‚åˆ**ï¼šå•†å“å›¾ã€ç”¨æˆ·å¤´åƒã€ä¹°å®¶ç§€ç­‰å¤§å›¾

3. **äº‘å­˜å‚¨çš„ä¼˜åŠ¿**ï¼š
   - æ°¸ä¹…æœ‰æ•ˆ
   - è·¨è®¾å¤‡åŒæ­¥
   - CDN åŠ é€Ÿ
   - èŠ‚çœæ•°æ®åº“ç©ºé—´
   - çœŸæœºç«¯å®Œå…¨æ”¯æŒ

4. **è¿ç§»å»ºè®®**ï¼š
   - ä¼˜å…ˆä¿®å¤ P0ã€P1 é—®é¢˜
   - P2 é—®é¢˜å¯æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æ€§ä¼˜åŒ–
   - é€æ­¥è¿ç§»ç°æœ‰æ•°æ®

---

## ğŸ“Š å®¡æŸ¥ç»“è®º

**ä¸¥é‡é—®é¢˜**ï¼š1å¤„ï¼ˆä¹°å®¶ç§€ï¼‰  
**é«˜å±é—®é¢˜**ï¼š4å¤„ï¼ˆå•†å“ç¼–è¾‘ï¼‰  
**ä¸­å±é—®é¢˜**ï¼š3å¤„ï¼ˆbase64 æ–¹æ¡ˆï¼‰  
**ä»£ç æ¸…ç†**ï¼š1å¤„

**å»ºè®®ä¿®å¤é¡ºåº**ï¼š
1. ğŸ”´ ç«‹å³ä¿®å¤ï¼šä¹°å®¶ç§€å›¾ç‰‡ä¸Šä¼ ï¼ˆP0ï¼‰
2. ğŸŸ¡ ä¼˜å…ˆä¿®å¤ï¼šå•†å“ç¼–è¾‘å›¾ç‰‡ä¸Šä¼ ï¼ˆP1ï¼‰
3. ğŸŸ¢ åç»­ä¼˜åŒ–ï¼šbase64 æ”¹äº‘å­˜å‚¨ï¼ˆP2ï¼‰

**é¢„è®¡ä¿®å¤æ—¶é—´**ï¼š
- P0 ä¿®å¤ï¼š1å¤©
- P1 ä¿®å¤ï¼š2-3å¤©
- P2 ä¼˜åŒ–ï¼š1-2å¤©ï¼ˆå¯é€‰ï¼‰
- **æ€»è®¡**ï¼š3-6å¤©

---

**ç”Ÿæˆæ—¶é—´**ï¼š2025-11-22  
**å®¡æŸ¥äººå‘˜**ï¼šAIåŠ©æ‰‹  
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šè¯·æ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œä¿®å¤ï¼Œä¼˜å…ˆè§£å†³ P0 å’Œ P1 é—®é¢˜ã€‚

